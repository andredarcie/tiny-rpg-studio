var TinyRPGExport=(function(Fe){"use strict";const lt={default:[[null,null,1,1,1,1,null,null],[null,1,15,15,15,15,1,null],[1,6,15,12,15,12,1,null],[1,6,15,15,15,15,1,null],[1,9,9,4,4,9,9,1],[1,15,9,9,9,4,15,1],[null,1,5,5,5,5,1,null],[null,1,5,1,1,5,1,null]]},ot={default:[[null,null,null,5,5,5,null,null],[null,null,5,5,5,5,5,null],[null,null,7,1,7,1,7,null],[5,null,7,7,7,7,7,null],[5,null,5,5,5,5,5,null],[5,7,6,5,5,5,6,null],[5,null,6,6,5,6,6,null],[5,null,6,6,6,6,6,null]],"default-elf":[[null,null,null,11,11,11,null,null],[null,null,11,7,11,7,11,null],[null,null,10,1,10,1,10,null],[11,null,10,11,11,10,11,null],[11,null,10,7,7,10,10,null],[11,10,11,10,10,11,10,null],[11,null,10,10,11,10,10,null],[11,null,10,10,10,10,10,null]],"default-dwarf":[[null,null,null,4,4,4,null,null],[null,null,4,4,4,4,4,null],[null,null,9,9,9,9,9,null],[4,null,9,4,4,9,4,null],[4,null,9,4,4,9,4,null],[4,9,4,9,4,9,4,null],[4,null,9,9,4,9,9,null],[4,null,9,9,9,9,9,null]],"old-mage":[[null,1,1,1,1,1,null,null],[1,4,6,6,6,6,1,null],[1,4,15,12,15,12,1,null],[1,4,15,15,15,15,5,1],[1,15,5,6,6,6,15,1],[1,4,5,6,6,6,1,null],[1,4,5,5,6,6,1,null],[1,4,5,5,5,5,1,null]],"old-mage-elf":[[1,15,10,10,10,10,15,1],[1,15,15,12,15,12,15,1],[1,4,15,15,15,15,1,null],[1,4,10,10,10,10,5,1],[1,4,5,10,10,10,5,1],[1,15,5,5,10,10,15,null],[1,4,5,5,5,5,1,null],[1,4,5,5,5,5,1,null]],"old-mage-dwarf":[[null,1,null,null,null,null,null,null],[1,2,1,1,1,1,null,null],[1,4,6,6,6,6,1,null],[1,4,15,9,15,9,1,null],[1,4,15,15,15,15,1,null],[1,4,5,6,6,6,5,1],[1,15,5,5,6,6,15,1],[1,4,13,1,1,13,1,null]],"villager-man":[[null,null,1,1,1,1,null,null],[null,1,15,15,15,15,1,null],[null,1,15,12,15,12,1,null],[null,1,15,15,15,15,1,null],[1,4,4,4,4,4,4,1],[1,15,4,4,4,4,15,1],[null,1,9,9,9,9,1,null],[null,1,9,1,1,9,1,null]],"villager-man-elf":[[1,15,10,10,10,10,15,1],[1,10,15,12,15,12,10,1],[null,1,15,15,15,15,1,null],[1,11,11,9,9,11,11,1],[1,11,11,11,9,11,11,1],[1,15,11,11,9,11,15,1],[null,1,11,11,9,11,1,null],[null,1,11,11,9,11,1,null]],"villager-man-dwarf":[[null,null,null,null,null,null,null,null],[null,null,1,1,1,1,null,null],[null,1,5,5,5,5,1,null],[null,1,15,9,15,9,1,null],[null,1,15,15,15,15,1,null],[1,4,4,5,5,5,4,1],[1,15,4,4,5,5,15,1],[null,1,9,1,1,9,1,null]],"villager-woman":[[null,null,1,1,1,1,null,null],[null,1,4,4,4,4,1,null],[null,1,4,12,15,12,1,null],[null,1,4,15,15,15,1,null],[1,14,4,14,14,14,14,1],[1,15,4,14,14,14,15,1],[null,1,14,14,14,14,1,null],[null,1,14,14,14,14,1,null]],"villager-woman-elf":[[1,15,10,10,10,10,15,1],[1,10,15,12,15,12,10,1],[1,10,15,15,15,15,10,1],[1,10,10,9,15,10,10,1],[1,11,10,11,9,10,11,1],[1,15,11,11,9,11,15,1],[null,1,11,11,9,11,1,null],[1,11,11,11,9,11,11,1]],"villager-woman-dwarf":[[null,null,null,null,null,null,null,null],[null,null,1,1,1,1,null,null],[null,1,5,5,5,5,1,null],[1,5,15,9,15,9,1,null],[1,5,15,15,15,15,1,null],[1,4,5,4,4,4,4,1],[1,15,5,4,4,4,15,1],[null,1,4,4,4,4,1,null]],child:[[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,1,1,1,1,null,null],[null,1,15,15,15,15,1,null],[null,1,15,12,15,12,1,null],[1,9,9,9,9,9,9,1],[1,15,9,9,9,9,15,1],[null,1,2,1,1,2,1,null]],"child-elf":[[null,null,null,null,null,null,null,null],[null,null,1,1,1,1,null,null],[null,1,10,10,10,10,1,null],[null,1,15,12,15,12,1,null],[null,1,15,15,15,15,1,null],[1,11,11,11,11,11,11,1],[1,15,11,11,11,11,15,1],[null,1,9,1,1,9,1,null]],"child-dwarf":[[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,1,1,1,1,null,null],[null,1,15,9,15,9,1,null],[null,1,15,15,15,15,1,null],[1,15,13,13,13,13,15,1],[null,1,2,1,1,2,1,null]],king:[[1,10,1,10,1,10,1,1],[1,9,9,9,9,9,1,10],[1,15,15,12,15,12,1,9],[1,15,15,15,15,15,1,9],[1,8,7,15,15,7,1,9],[1,8,8,7,8,8,8,15],[1,8,8,7,8,8,1,9],[1,7,7,7,7,7,1,9]],"king-elf":[[15,10,9,10,9,10,1,10],[15,10,15,12,15,12,1,9],[1,10,15,15,15,15,1,9],[1,11,9,15,15,9,1,9],[1,11,11,15,11,11,11,15],[1,11,11,10,11,11,1,9],[1,11,11,10,11,11,1,9],[1,10,10,10,10,10,1,9]],"king-dwarf":[[null,1,1,1,1,1,null,null],[1,10,9,10,9,10,1,1],[1,9,9,9,9,9,1,10],[1,5,15,9,15,9,1,9],[1,5,15,15,15,15,1,9],[1,4,4,5,5,5,4,15],[1,4,4,9,4,4,1,9],[1,9,9,9,9,9,1,9]],knight:[[null,null,1,1,1,1,null,null],[null,1,6,6,6,6,1,null],[null,1,6,12,15,12,1,null],[null,1,6,6,6,6,1,null],[1,5,5,6,6,5,5,1],[1,6,5,5,5,5,6,1],[null,1,6,6,6,6,1,null],[null,1,6,1,1,6,1,null]],"knight-elf":[[1,15,10,10,10,10,1,null],[1,15,10,12,15,12,1,null],[1,4,11,15,15,15,1,null],[4,11,11,15,15,11,11,1],[1,11,11,11,15,11,11,1],[1,15,11,11,11,11,15,1],[null,1,11,11,11,11,4,null],[null,1,11,1,1,11,1,null]],"knight-dwarf":[[null,null,null,null,null,null,null,null],[null,null,1,1,1,1,null,null],[null,1,4,4,4,4,1,null],[null,1,4,9,15,9,1,null],[1,4,4,4,4,4,4,1],[1,5,4,4,4,4,5,1],[null,1,9,9,9,9,1,null],[null,1,9,1,1,9,1,null]],thief:[[null,null,1,1,1,1,null,null],[null,1,5,5,5,5,1,null],[null,1,5,12,15,12,1,null],[null,1,5,5,5,5,1,null],[1,5,5,5,5,5,5,1],[1,15,5,5,5,5,15,1],[null,1,13,13,13,13,1,null],[null,1,13,1,1,13,1,null]],"thief-elf":[[1,15,10,10,10,10,15,1],[1,15,10,12,15,12,15,1],[1,10,15,15,15,15,10,1],[1,3,5,5,5,5,3,1],[1,5,5,5,5,5,5,1],[1,0,5,5,5,5,0,1],[1,10,5,5,5,5,10,1],[null,1,5,1,1,5,1,null]],"thief-dwarf":[[null,null,null,null,null,null,null,null],[null,null,1,1,1,1,null,null],[null,1,5,5,5,5,1,null],[null,1,5,9,15,9,1,null],[1,5,5,5,5,5,5,1],[1,15,5,5,5,5,15,1],[null,1,4,4,4,4,1,null],[null,1,4,1,1,4,1,null]],blacksmith:[[null,null,1,1,1,1,null,null],[null,1,15,15,15,15,1,null],[null,1,15,12,15,12,1,null],[null,1,15,15,15,15,1,null],[1,6,4,6,6,4,6,1],[1,15,4,4,4,4,15,1],[null,1,4,4,4,4,1,null],[null,1,5,1,1,5,1,null]],"blacksmith-elf":[[1,15,10,10,10,10,1,null],[1,15,10,12,15,12,1,null],[1,10,15,15,15,15,1,null],[1,6,11,6,6,11,6,1],[1,6,11,11,11,11,6,1],[1,15,11,11,11,11,15,1],[null,1,11,11,11,11,1,null],[null,1,11,1,1,11,1,null]],"blacksmith-dwarf":[[null,null,null,null,null,null,null,null],[null,null,1,1,1,1,null,null],[null,1,5,5,5,5,1,null],[null,1,15,9,15,9,1,null],[null,1,5,15,15,15,1,null],[1,6,4,5,5,5,6,1],[1,15,4,4,5,5,15,1],[null,1,4,1,1,4,1,null]],"wooden-sign":[[null,1,1,1,1,1,1,null],[1,4,4,4,4,4,4,1],[1,4,5,5,5,5,4,1],[1,4,4,4,4,4,4,1],[1,4,5,5,5,4,4,1],[1,4,4,4,4,4,4,1],[1,4,1,1,1,1,4,1],[1,4,1,null,null,1,4,1]],"thought-bubble":[[null,1,1,1,1,1,1,null],[1,6,6,6,6,6,6,1],[1,6,1,1,1,1,6,1],[1,6,6,6,6,6,6,1],[1,6,1,1,1,6,6,1],[1,6,6,6,6,6,6,1],[null,1,6,6,1,1,1,null],[null,1,6,1,null,null,null,null]]},ct={default:[[null,null,6,null,null,null,6,null],[null,null,6,6,6,6,6,null],[null,null,6,6,8,6,8,null],[null,null,6,6,6,6,6,null],[null,null,1,1,6,1,1,null],[null,null,6,1,1,1,6,null],[null,null,null,1,1,1,null,null],[null,null,null,6,null,6,null,null]],"giant-rat":[[null,1,15,15,1,15,15,1],[null,1,15,15,1,15,15,1],[1,15,13,13,13,13,13,1],[1,15,13,8,13,8,13,1],[1,15,5,13,13,13,1,null],[1,5,5,5,15,1,null,null],[1,5,5,5,5,1,null,null],[1,15,1,1,15,1,null,null]],bandit:[[null,1,1,1,1,1,6,1],[1,15,15,15,15,1,7,1],[1,15,8,15,8,1,7,1],[1,4,4,4,4,5,6,1],[1,5,4,4,4,2,2,2],[1,5,5,4,5,1,4,1],[1,13,13,13,13,1,1,null],[1,13,1,1,13,1,null,null]],"dark-knight":[[null,1,1,1,1,null,1,null],[1,5,5,5,5,1,2,1],[1,5,8,5,8,1,2,1],[1,5,13,5,13,5,2,1],[1,13,5,13,5,14,14,1],[1,5,13,5,13,1,5,1],[1,5,5,13,5,1,1,null],[1,5,1,1,5,1,null,null]],necromancer:[[null,1,1,1,1,null,1,null],[1,15,15,15,15,1,8,1],[1,15,8,15,8,1,4,1],[1,15,15,15,15,1,4,1],[1,2,2,2,2,2,2,1],[1,2,2,2,2,2,4,1],[1,2,2,2,2,1,4,1],[1,2,2,2,2,2,4,1]],dragon:[[null,1,1,1,1,1,1,null],[1,3,11,11,11,11,11,1],[1,11,11,11,8,11,8,1],[1,3,3,11,11,11,11,1],[1,11,3,11,7,1,7,1],[1,11,11,11,11,3,1,null],[1,3,3,3,1,3,1,null],[1,11,1,11,1,1,null,null]],skeleton:[[null,1,7,7,7,7,1,null],[null,1,7,8,7,8,1,null],[null,1,7,7,7,7,1,null],[1,7,1,7,7,1,7,1],[1,7,7,7,7,7,7,1],[1,7,1,7,1,1,7,1],[null,1,7,7,7,7,1,null],[null,1,7,1,1,7,1,null]],"fallen-king":[[1,10,1,10,1,10,1,1],[1,9,9,9,9,9,1,10],[1,5,15,8,15,8,1,9],[1,5,5,15,15,5,1,9],[1,2,7,5,5,7,1,9],[1,2,2,7,2,2,2,15],[1,2,2,7,2,2,1,9],[1,7,7,7,7,7,1,9]],"ancient-demon":[[null,1,8,1,1,8,1,null],[null,1,8,8,8,8,1,null],[null,1,8,0,8,0,1,null],[1,8,8,8,8,8,8,1],[8,8,8,8,8,8,8,8],[8,1,8,8,8,8,1,8],[1,1,8,8,8,8,1,1],[null,1,8,1,1,8,1,null]]},dt={"player-start":[[null,null,null,null,null,null,null,null],[null,1,1,1,1,1,1,null],[null,1,3,3,3,3,1,null],[null,1,3,3,11,3,1,null],[null,1,3,11,3,3,1,null],[null,1,3,3,3,3,1,null],[null,1,1,1,1,1,1,null],[null,null,null,null,null,null,null,null]],"player-end":[[null,null,null,null,null,null,null,null],[null,1,1,1,1,1,1,null],[null,1,2,2,2,2,1,null],[null,1,2,2,14,2,1,null],[null,1,2,14,2,2,1,null],[null,1,2,2,2,2,1,null],[null,1,1,1,1,1,1,null],[null,null,null,null,null,null,null,null]],switch:[[null,null,null,null,null,null,null,null],[8,null,null,null,null,null,null,null],[null,6,null,null,null,null,null,null],[null,null,6,null,null,null,null,null],[null,null,null,6,null,null,null,null],[null,null,6,1,1,6,null,null],[null,6,6,6,6,6,6,null],[null,null,null,null,null,null,null,null]],"switch--on":[[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,12],[null,null,null,null,null,null,6,null],[null,null,null,null,null,6,null,null],[null,null,null,null,6,null,null,null],[null,null,6,1,1,6,null,null],[null,6,6,6,6,6,6,null],[null,null,null,null,null,null,null,null]],key:[[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[10,10,7,null,null,null,null,null],[10,null,10,10,10,10,10,10],[9,9,9,null,null,9,null,9],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null]],door:[[null,4,4,4,4,4,4,null],[4,9,9,9,9,9,9,4],[4,9,9,9,9,9,9,4],[4,9,9,9,0,0,9,4],[4,9,9,9,0,0,9,4],[4,9,9,9,9,0,9,4],[4,9,9,9,9,9,9,4],[4,9,9,9,9,9,9,4]],"door-variable":[[null,7,null,7,null,7,null,7],[null,6,6,6,6,6,6,6],[null,6,13,6,13,6,13,6],[null,6,null,6,null,6,null,6],[null,6,null,6,null,6,null,5],[null,6,6,6,6,6,6,6],[null,6,13,6,13,6,13,6],[null,6,null,6,null,6,null,6]],"life-potion":[[null,null,1,1,1,1,null,null],[null,1,1,1,1,1,1,null],[null,null,6,null,null,6,null,null],[null,null,6,8,8,6,null,null],[null,6,8,8,8,8,6,null],[6,8,8,8,6,8,8,6],[null,6,8,6,8,8,6,null],[null,null,6,6,6,6,null,null]],"xp-scroll":[[null,null,null,null,null,null,null,null],[null,null,6,6,6,6,6,6],[null,null,6,1,1,1,6,0],[null,null,6,6,6,6,6,null],[null,null,6,1,1,1,6,null],[null,null,6,6,6,6,6,null],[null,0,6,1,1,6,6,null],[null,6,6,6,6,6,6,null]],sword:[[null,null,null,null,null,null,null,null],[6,6,null,null,null,null,null,null],[6,6,6,null,null,null,null,null],[null,6,6,6,null,null,null,null],[null,null,6,6,6,null,1,null],[null,null,null,6,8,1,1,null],[null,null,null,null,1,1,null,null],[null,null,null,1,1,null,1,null]],"sword-bronze":[[null,null,null,null,null,null,null,null],[9,9,null,null,null,null,null,null],[9,10,9,null,null,null,null,null],[null,9,9,10,null,null,null,null],[null,null,9,9,10,null,1,null],[null,null,null,9,9,1,1,null],[null,null,null,null,1,1,null,null],[null,null,null,1,1,null,1,null]],"sword-wood":[[null,null,null,null,null,null,null,null],[4,4,null,null,null,null,null,null],[4,5,4,null,null,null,null,null],[null,4,4,5,null,null,null,null],[null,null,4,4,5,null,1,null],[null,null,null,4,9,1,1,null],[null,null,null,null,1,1,null,null],[null,null,null,1,1,null,1,null]]};class I{static get(e,t="default"){const n={player:lt,npc:ot,enemy:ct,object:dt},a=String(e||"").toLowerCase(),i=n[a];if(!i)throw new Error(`SpriteMatrixRegistry: registry not found for "${e}"`);const r=t,s=i[r];if(!s)throw new Error(`SpriteMatrixRegistry: sprite "${r}" not found for group "${a}"`);return s}}class ut{type;id;name;nameKey;description;damage;missChance;experience;hasEyes;sprite;aliases;boss;defeatActivationMessage;defeatActivationMessageKey;constructor(e){this.type=e.type,this.id=e.id,this.name=e.name,this.nameKey=e.nameKey,this.description=e.description,this.damage=e.damage,this.missChance=e.missChance,this.experience=e.experience,this.hasEyes=e.hasEyes,this.sprite=e.sprite,this.aliases=e.aliases,this.boss=e.boss,this.defeatActivationMessage=e.defeatActivationMessage,this.defeatActivationMessageKey=e.defeatActivationMessageKey}matchesType(e){return e?this.type===e?!0:Array.isArray(this.aliases)&&this.aliases.includes(e):!1}getExperienceReward(){const e=Number(this.experience);return Number.isFinite(e)?Math.max(0,Math.floor(e)):0}getMissChance(){const e=Number(this.missChance);return Number.isFinite(e)?Math.max(0,Math.min(1,e)):null}}class te{static ENEMY_DEFINITION_DATA=[{type:"giant-rat",id:"enemy-giant-rat",name:"ðŸ€ Rato Gigante",nameKey:"enemies.names.giantRat",description:"o primeiro inimigo fraco.",damage:1,missChance:.1,experience:3,hasEyes:!0,sprite:I.get("enemy","giant-rat")},{type:"bandit",id:"enemy-bandit",name:"ðŸ§” Bandido",nameKey:"enemies.names.bandit",description:"inimigo humano comum.",damage:2,missChance:.25,experience:4,hasEyes:!0,sprite:I.get("enemy","bandit")},{type:"skeleton",id:"enemy-skeleton",name:"ðŸ’€ Esqueleto",nameKey:"enemies.names.skeleton",description:"o morto-vivo clÃ¡ssico.",damage:3,missChance:.25,experience:5,aliases:["skull"],hasEyes:!1,sprite:I.get("enemy","skeleton")},{type:"dark-knight",id:"enemy-dark-knight",name:"âš”ï¸ Cavaleiro Negro",nameKey:"enemies.names.darkKnight",description:"o guerreiro corrompido.",damage:4,missChance:.18,experience:7,hasEyes:!0,sprite:I.get("enemy","dark-knight")},{type:"necromancer",id:"enemy-necromancer",name:"ðŸ§™â€â™‚ï¸ Necro",nameKey:"enemies.names.necromancer",description:"o mago das trevas.",damage:5,missChance:.12,experience:8,hasEyes:!0,sprite:I.get("enemy","necromancer")},{type:"dragon",id:"enemy-dragon",name:"ðŸ‰ DragÃ£o",nameKey:"enemies.names.dragon",description:"o monstro lendÃ¡rio.",damage:6,missChance:.08,defeatActivationMessage:"Selo do DragÃ£o ativado!",defeatActivationMessageKey:"enemies.defeat.dragon",experience:9,hasEyes:!0,boss:!0,sprite:I.get("enemy","dragon")},{type:"fallen-king",id:"enemy-fallen-king",name:"ðŸ‘‘ Rei CaÃ­do",nameKey:"enemies.names.fallenKing",description:"o chefe trÃ¡gico corrompido pelo poder.",damage:7,missChance:.08,defeatActivationMessage:"Selo Real despertou!",defeatActivationMessageKey:"enemies.defeat.fallenKing",experience:10,hasEyes:!0,boss:!0,sprite:I.get("enemy","fallen-king")},{type:"ancient-demon",id:"enemy-ancient-demon",name:"ðŸ˜ˆ DemÃ´nio AnciÃ£o",nameKey:"enemies.names.ancientDemon",description:"o mal primordial e final.",damage:8,missChance:.05,defeatActivationMessage:"Selo DemonÃ­aco ativo!",defeatActivationMessageKey:"enemies.defeat.ancientDemon",aliases:["boss"],experience:11,hasEyes:!1,boss:!0,sprite:I.get("enemy","ancient-demon")}];static ENEMY_DEFINITIONS=te.ENEMY_DEFINITION_DATA.map(e=>new ut(e));static get definitions(){return this.ENEMY_DEFINITIONS}static getDefault(){return this.ENEMY_DEFINITIONS[0]||null}static getEnemyDefinition(e){return typeof e!="string"||!e?null:this.ENEMY_DEFINITIONS.find(t=>t.matchesType(e))||null}static normalizeType(e){const t=this.getEnemyDefinition(e);return t?t.type:this.getDefault()?.type||"giant-rat"}static getExperienceReward(e){const t=this.getEnemyDefinition(e);return t?t.getExperienceReward():0}static getMissChance(e){const t=this.getEnemyDefinition(e);return t?t.getMissChance():null}}class ht{type;id;name;nameKey;behavior;sprite;spriteOn;constructor(e){this.type=e.type,this.id=e.id,this.name=e.name,this.nameKey=e.nameKey,this.behavior=e.behavior??{},this.sprite=e.sprite,this.spriteOn=e.spriteOn}getTags(){return Array.isArray(this.behavior.tags)?this.behavior.tags.slice():[]}hasTag(e){if(!e)return!1;const t=String(e);return this.getTags().includes(t)}getOrder(e){const t=this.behavior.order;return Number.isFinite(t)?t:e}getSwordDurability(){const e=this.behavior.swordDurability;return Number.isFinite(e)?Math.max(0,e):null}}const $={PLAYER_START:"player-start",PLAYER_END:"player-end",SWITCH:"switch",DOOR:"door",DOOR_VARIABLE:"door-variable",KEY:"key",LIFE_POTION:"life-potion",XP_SCROLL:"xp-scroll",SWORD:"sword",SWORD_BRONZE:"sword-bronze",SWORD_WOOD:"sword-wood"},mt=[{type:$.PLAYER_START,id:"object-player-start",name:"Inicio do Jogador",nameKey:"objects.label.playerStart",behavior:{order:10,tags:["placeable","player-start","global-unique","hidden-in-runtime"]},sprite:I.get("object","player-start")},{type:$.PLAYER_END,id:"object-player-end",name:"Fim do Jogo",nameKey:"objects.label.playerEnd",behavior:{order:20,tags:["placeable","player-end","per-room-unique"]},sprite:I.get("object","player-end")},{type:$.SWITCH,id:"object-switch",name:"Alavanca",nameKey:"objects.label.switch",behavior:{order:30,tags:["placeable","switch","requires-variable"]},sprite:I.get("object","switch"),spriteOn:I.get("object","switch--on")},{type:$.KEY,id:"object-key",name:"Chave",nameKey:"objects.label.key",behavior:{order:60,tags:["placeable","collectible","hide-when-collected"]},sprite:I.get("object","key")},{type:$.DOOR,id:"object-door",name:"Porta",nameKey:"objects.label.door",behavior:{order:40,tags:["placeable","door","locked-door","hide-when-opened"]},sprite:I.get("object","door")},{type:$.DOOR_VARIABLE,id:"object-door-variable",name:"Porta Magica",nameKey:"objects.label.doorVariable",behavior:{order:50,tags:["placeable","door","requires-variable","variable-door","hide-when-variable-open"]},sprite:I.get("object","door-variable")},{type:$.LIFE_POTION,id:"object-life-potion",name:"Pocao de Vida",nameKey:"objects.label.lifePotion",behavior:{order:70,tags:["placeable","collectible","hide-when-collected"]},sprite:I.get("object","life-potion")},{type:$.XP_SCROLL,id:"object-xp-scroll",name:"Pergaminho de XP",nameKey:"objects.label.xpScroll",behavior:{order:110,tags:["placeable","collectible","hide-when-collected"]},sprite:I.get("object","xp-scroll")},{type:$.SWORD,id:"object-sword",name:"Espada de AÃ§o",nameKey:"objects.label.sword",behavior:{order:80,swordDurability:5,tags:["placeable","collectible","sword","hide-when-collected"]},sprite:I.get("object","sword")},{type:$.SWORD_BRONZE,id:"object-sword-bronze",name:"Espada de Bronze",nameKey:"objects.label.swordBronze",behavior:{order:90,swordDurability:4,tags:["placeable","collectible","sword","hide-when-collected"]},sprite:I.get("object","sword-bronze")},{type:$.SWORD_WOOD,id:"object-sword-wood",name:"Espada de Madeira",nameKey:"objects.label.swordWood",behavior:{order:100,swordDurability:3,tags:["placeable","collectible","sword","hide-when-collected"]},sprite:I.get("object","sword-wood")}];class Ve{static ITEM_DEFINITIONS=mt.map(e=>new ht(e));static get definitions(){return this.ITEM_DEFINITIONS}static get TYPES(){return $}static getItemDefinition(e){return this.ITEM_DEFINITIONS.find(t=>t.type===e)||null}}class gt{items;behaviorMap;constructor(e){this.items=e}get definitions(){return this.items}getItemDefinition(e){return this.items.find(t=>t.type===e)||null}getTags(e){return this.getBehaviorMap().get(e)?.tags||[]}hasTag(e,t){if(!t)return!1;const n=String(t),a=this.getBehaviorMap().get(e);return a?a.tagSet.has(n):!1}getTypesByTag(e){if(!e)return[];const t=String(e),n=[];return this.items.forEach(a=>{this.hasTag(a.type,t)&&n.push(a.type)}),n}getEditorTypeOrder(){return[...this.items].sort((e,t)=>{const n=this.getBehaviorMap().get(e.type),a=this.getBehaviorMap().get(t.type),i=n?n.order:0,r=a?a.order:0;return i-r}).map(e=>e.type)}getPlaceableTypes(){const e=this.getTypesByTag("placeable");if(e.length)return e;const t=$;return[t.DOOR,t.DOOR_VARIABLE,t.KEY,t.LIFE_POTION,t.XP_SCROLL,t.SWORD,t.SWORD_BRONZE,t.SWORD_WOOD,t.PLAYER_START,t.PLAYER_END,t.SWITCH].filter(Boolean)}getCollectibleTypes(){const e=this.getTypesByTag("collectible");if(e.length)return e;const t=$;return[t.KEY,t.LIFE_POTION,t.XP_SCROLL,t.SWORD,t.SWORD_BRONZE,t.SWORD_WOOD].filter(Boolean)}isCollectible(e){return this.hasTag(e,"collectible")}shouldHideWhenCollected(e){return this.hasTag(e,"hide-when-collected")}shouldHideWhenOpened(e){return this.hasTag(e,"hide-when-opened")}shouldHideWhenVariableOpen(e){return this.hasTag(e,"hide-when-variable-open")}isHiddenInRuntime(e){return this.hasTag(e,"hidden-in-runtime")}requiresVariable(e){return this.hasTag(e,"requires-variable")}isDoor(e){return this.hasTag(e,"door")}isVariableDoor(e){return this.hasTag(e,"variable-door")}isLockedDoor(e){return this.hasTag(e,"locked-door")}isSwitch(e){return this.hasTag(e,"switch")}isPlayerStart(e){return this.hasTag(e,"player-start")}isPlayerEnd(e){return this.hasTag(e,"player-end")}getSwordDurability(e){const t=this.getBehaviorMap().get(e);return t&&Number.isFinite(t.swordDurability)?t.swordDurability:null}getBehaviorMap(){if(!this.behaviorMap){const e=new Map;this.items.forEach((t,n)=>{const a=t.behavior,i=Array.isArray(a.tags)?a.tags.slice():[];e.set(t.type,{order:t.getOrder(100+n),tags:i,tagSet:new Set(i),swordDurability:t.getSwordDurability()})}),this.behaviorMap=e}return this.behaviorMap}}const Q=new gt(Ve.definitions);class he{static _objectDefinitions=null;static _enemyDefinitions=null;static get OBJECT_DEFINITIONS(){return this._objectDefinitions||(this._objectDefinitions=Ve.definitions),this._objectDefinitions}static get ENEMY_DEFINITIONS(){return this._enemyDefinitions||(this._enemyDefinitions=te.definitions),this._enemyDefinitions}static get OBJECT_TYPE_ORDER(){return Q.getEditorTypeOrder()}}class pt{root;editorCanvas;mapPosition;mapNavButtons;mobileNavButtons;mobilePanels;selectedTilePreview;tileSummary;tileList;npcsList;npcText;npcConditionalText;npcConditionalVariable;npcRewardVariable;npcConditionalRewardVariable;btnToggleNpcConditional;npcConditionalSection;npcVariantButtons;worldGrid;titleInput;authorInput;fileInput;objectTypes;objectsList;btnNpcDelete;npcEditor;btnGenerateUrl;shareUrlInput;btnUndo;btnRedo;enemyTypes;enemiesList;projectVariablesContainer;projectVariablesToggle;projectVariableList;projectVariableSummary;projectSkillsContainer;projectSkillsToggle;projectSkillsList;projectTestContainer;projectTestToggle;projectTestPanel;projectTestStartLevel;projectTestSkillList;projectTestGodMode;projectPaletteContainer;projectPaletteToggle;projectPalettePanel;paletteGrid;paletteResetButton;colorPickerModal;colorPickerInput;colorPickerConfirm;colorPickerCancel;colorPreviewCurrent;colorPreviewNew;colorPickerIndex;jsonArea;constructor(e=typeof document<"u"?document:null){if(this.root=e||null,!e){this.editorCanvas=null,this.mapPosition=null,this.mapNavButtons=[],this.mobileNavButtons=[],this.mobilePanels=[],this.selectedTilePreview=null,this.tileSummary=null,this.tileList=null,this.npcsList=null,this.npcText=null,this.npcConditionalText=null,this.npcConditionalVariable=null,this.npcRewardVariable=null,this.npcConditionalRewardVariable=null,this.btnToggleNpcConditional=null,this.npcConditionalSection=null,this.npcVariantButtons=[],this.worldGrid=null,this.titleInput=null,this.authorInput=null,this.fileInput=null,this.objectTypes=null,this.objectsList=null,this.btnNpcDelete=null,this.npcEditor=null,this.btnGenerateUrl=null,this.shareUrlInput=null,this.btnUndo=null,this.btnRedo=null,this.enemyTypes=null,this.enemiesList=null,this.projectVariablesContainer=null,this.projectVariablesToggle=null,this.projectVariableList=null,this.projectVariableSummary=null,this.projectSkillsContainer=null,this.projectSkillsToggle=null,this.projectSkillsList=null,this.projectTestContainer=null,this.projectTestToggle=null,this.projectTestPanel=null,this.projectTestStartLevel=null,this.projectTestSkillList=null,this.projectTestGodMode=null,this.projectPaletteContainer=null,this.projectPaletteToggle=null,this.projectPalettePanel=null,this.paletteGrid=null,this.paletteResetButton=null,this.colorPickerModal=null,this.colorPickerInput=null,this.colorPickerConfirm=null,this.colorPickerCancel=null,this.colorPreviewCurrent=null,this.colorPreviewNew=null,this.colorPickerIndex=null,this.jsonArea=null;return}this.editorCanvas=e.querySelector("#editor-canvas"),this.mapPosition=e.querySelector("#editor-map-position"),this.mapNavButtons=Array.from(e.querySelectorAll(".map-nav-button")),this.mobileNavButtons=Array.from(e.querySelectorAll(".editor-mobile-nav-button")),this.mobilePanels=Array.from(e.querySelectorAll(".editor-section[data-mobile-panel]")),this.selectedTilePreview=e.querySelector("#selected-tile-preview"),this.tileSummary=e.querySelector("#tile-preset-summary"),this.tileList=e.querySelector("#tile-list"),this.npcsList=e.querySelector("#npcs-list"),this.npcText=e.querySelector("#npc-text"),this.npcConditionalText=e.querySelector("#npc-conditional-text"),this.npcConditionalVariable=e.querySelector("#npc-conditional-variable"),this.npcRewardVariable=e.querySelector("#npc-reward-variable"),this.npcConditionalRewardVariable=e.querySelector("#npc-conditional-reward-variable"),this.btnToggleNpcConditional=e.querySelector("#btn-toggle-npc-conditional"),this.npcConditionalSection=e.querySelector("#npc-conditional-section"),this.npcVariantButtons=Array.from(e.querySelectorAll("[data-npc-variant-filter]")),this.worldGrid=e.querySelector("#world-grid"),this.titleInput=e.querySelector("#game-title"),this.authorInput=e.querySelector("#game-author"),this.fileInput=e.querySelector("#file-input"),this.objectTypes=e.querySelector("#object-types"),this.objectsList=e.querySelector("#objects-list"),this.btnNpcDelete=e.querySelector("#npc-delete"),this.npcEditor=e.querySelector(".npc-editor"),this.btnGenerateUrl=e.querySelector("#btn-generate-url"),this.shareUrlInput=e.querySelector("#project-share-url"),this.btnUndo=e.querySelector("#btn-undo"),this.btnRedo=e.querySelector("#btn-redo"),this.enemyTypes=e.querySelector("#enemy-types"),this.enemiesList=e.querySelector("#enemies-list"),this.projectVariablesContainer=e.querySelector("#project-variables-container"),this.projectVariablesToggle=e.querySelector("#project-variables-toggle"),this.projectVariableList=e.querySelector("#project-variable-usage-list"),this.projectVariableSummary=e.querySelector("#project-variable-usage-summary"),this.projectSkillsContainer=e.querySelector("#project-skills-container"),this.projectSkillsToggle=e.querySelector("#project-skills-toggle"),this.projectSkillsList=e.querySelector("#project-skills-list"),this.projectTestContainer=e.querySelector("#project-test-container"),this.projectTestToggle=e.querySelector("#project-test-toggle"),this.projectTestPanel=e.querySelector("#project-test-panel"),this.projectTestStartLevel=e.querySelector("#project-test-start-level"),this.projectTestSkillList=e.querySelector("#project-test-skill-list"),this.projectTestGodMode=e.querySelector("#project-test-god-mode"),this.projectPaletteContainer=e.querySelector("#project-palette-container"),this.projectPaletteToggle=e.querySelector("#project-palette-toggle"),this.projectPalettePanel=e.querySelector("#project-palette-panel"),this.paletteGrid=e.querySelector("#palette-grid"),this.paletteResetButton=e.querySelector("#palette-reset-button"),this.colorPickerModal=e.querySelector("#color-picker-modal"),this.colorPickerInput=e.querySelector("#color-picker-input"),this.colorPickerConfirm=e.querySelector("#color-picker-confirm"),this.colorPickerCancel=e.querySelector("#color-picker-cancel"),this.colorPreviewCurrent=e.querySelector("#color-preview-current .color-preview-swatch"),this.colorPreviewNew=e.querySelector("#color-preview-new .color-preview-swatch"),this.colorPickerIndex=e.querySelector("#color-picker-index"),this.jsonArea=e.querySelector("#json-area")}}const K={defaultLocale:"en-US",locale:"en-US",bundles:{"pt-BR":{"app.title":"Tiny RPG Studio","intro.byline":"por {author}","intro.startAdventure":"Iniciar aventura","tabs.game":"Jogo","tabs.editor":"Editor","sections.tiles":"Tiles","sections.world":"Mundo","sections.objects":"Objetos","sections.npcs":"NPCs","sections.enemies":"Inimigos","sections.project":"Projeto","buttons.reset":"Reiniciar","buttons.newGame":"Novo jogo","buttons.remove":"Remover","aria.reset":"Reiniciar a partida atual","aria.newGame":"Criar um novo jogo do zero em outra aba","touchControls.show":"Exibir controles","touchControls.hide":"Ocultar controles","touchControls.upLabel":"Mover para cima","touchControls.downLabel":"Mover para baixo","touchControls.leftLabel":"Mover para a esquerda","touchControls.rightLabel":"Mover para a direita","doors.variableLocked":"NÃ£o abre com chave.","doors.openedRemaining":"VocÃª usou uma chave para abrir a porta. Restam: {value}.","doors.opened":"VocÃª usou uma chave para abrir a porta.","doors.locked":"Porta trancada. Precisa de uma chave.","doors.unlockedSkill":"Sua habilidade abriu a porta sem usar chave.","log.engineReady":"Tiny RPG Studio engine initialized successfully.","npc.dialog.defaultLabel":"DiÃ¡logo padrÃ£o:","npc.dialog.placeholder":"Digite o diÃ¡logo do NPC...","npc.reward.defaultLabel":"Ao concluir o diÃ¡logo padrÃ£o, ativar variÃ¡vel:","npc.toggle.create":"Criar diÃ¡logo alternativo","npc.toggle.hide":"Ocultar diÃ¡logo alternativo","npc.conditional.variableLabel":"VariÃ¡vel para diÃ¡logo alternativo:","npc.conditional.textLabel":"Texto alternativo:","npc.conditional.placeholder":"Mensagem exibida quando a variÃ¡vel estiver ON.","npc.conditional.rewardLabel":"Ao concluir o diÃ¡logo alternativo, ativar variÃ¡vel:","npc.delete":"Remover NPC","npc.defaultName":"NPC","npc.variant.label":"AparÃªncia dos NPCs","npc.variant.human":"Humano","npc.variant.elf":"Elfo","npc.variant.dwarf":"AnÃ£o","npc.variant.fixed":"Extras","npcs.names.oldMage":"Velho Mago","npcs.names.oldMage.human":"Velho Mago","npcs.names.oldMage.elf":"Velho Mago","npcs.names.oldMage.dwarf":"Velho Mago","npcs.names.villagerMan":"Homem comum","npcs.names.villagerMan.human":"Homem comum","npcs.names.villagerMan.elf":"Homem comum","npcs.names.villagerMan.dwarf":"Homem comum","npcs.names.villagerWoman":"Mulher comum","npcs.names.villagerWoman.human":"Mulher comum","npcs.names.villagerWoman.elf":"Mulher comum","npcs.names.villagerWoman.dwarf":"Mulher comum","npcs.names.child":"CrianÃ§a curiosa","npcs.names.child.human":"CrianÃ§a curiosa","npcs.names.child.elf":"CrianÃ§a curiosa","npcs.names.child.dwarf":"CrianÃ§a curiosa","npcs.names.thoughtBubble":"BalÃ£o","npcs.names.woodenSign":"Placa de madeira","npcs.names.king":"Rei","npcs.names.king.human":"Rei","npcs.names.king.elf":"Rei","npcs.names.king.dwarf":"Rei","npcs.names.knight":"Cavaleiro","npcs.names.knight.human":"Cavaleiro","npcs.names.knight.elf":"Cavaleiro","npcs.names.knight.dwarf":"Cavaleiro","npcs.names.thief":"Ladra","npcs.names.thief.human":"Ladra","npcs.names.thief.elf":"Ladra","npcs.names.thief.dwarf":"Ladra","npcs.names.blacksmith":"Ferreira","npcs.names.blacksmith.human":"Ferreira","npcs.names.blacksmith.elf":"Ferreira","npcs.names.blacksmith.dwarf":"Ferreira","npcs.dialog.oldMage":"Eu guardo segredos antigos.","npcs.dialog.oldMage.human":"Eu guardo segredos antigos.","npcs.dialog.oldMage.elf":"As Ã¡rvores contam histÃ³rias para quem escuta.","npcs.dialog.oldMage.dwarf":"Lendas ecoam nas cavernas profundas.","npcs.dialog.villagerMan":"Bom dia! Posso ajudar?","npcs.dialog.villagerMan.human":"Bom dia! Posso ajudar?","npcs.dialog.villagerMan.elf":"Que a floresta guie seus passos.","npcs.dialog.villagerMan.dwarf":"Minhas mÃ£os conhecem martelo e picareta.","npcs.dialog.villagerWoman":"Que dia lindo para explorar.","npcs.dialog.villagerWoman.human":"Que dia lindo para explorar.","npcs.dialog.villagerWoman.elf":"As flores florescem com boas intenÃ§Ãµes.","npcs.dialog.villagerWoman.dwarf":"O som das forjas acalma o coraÃ§Ã£o.","npcs.dialog.child":"Vamos brincar de aventura!","npcs.dialog.child.human":"Vamos brincar de aventura!","npcs.dialog.child.elf":"Quer correr pelos bosques comigo?","npcs.dialog.child.dwarf":"Vamos cavar um tÃºnel secreto!","npcs.dialog.thoughtBubble":" ... ","npcs.dialog.woodenSign":"AtenÃ§Ã£o aos perigos Ã  frente.","npcs.dialog.king":"Proteja nosso reino!","npcs.dialog.king.human":"Proteja nosso reino!","npcs.dialog.king.elf":"Honre a natureza acima de tudo.","npcs.dialog.king.dwarf":"Defenda as minas com honra e aÃ§o.","npcs.dialog.knight":"Estou pronto para lutar.","npcs.dialog.knight.human":"Estou pronto para lutar.","npcs.dialog.knight.elf":"Luto para manter o verde vivo.","npcs.dialog.knight.dwarf":"Minha armadura ressoa como um tambor de guerra.","npcs.dialog.thief":"NinguÃ©m me pega no ato.","npcs.dialog.thief.human":"NinguÃ©m me pega no ato.","npcs.dialog.thief.elf":"Sou sombra entre galhos e folhas.","npcs.dialog.thief.dwarf":"Entre pedras e ouro, ninguÃ©m me vÃª chegar.","npcs.dialog.blacksmith":"Minhas forjas estÃ£o em brasas.","npcs.dialog.blacksmith.human":"Minhas forjas estÃ£o em brasas.","npcs.dialog.blacksmith.elf":"Forjo com madeira viva e aÃ§o leve.","npcs.dialog.blacksmith.dwarf":"AÃ§o e pedra; Ã© assim que se constrÃ³i.","npc.status.available":"DisponÃ­vel","npc.status.position":"Mapa ({col}, {row}) - ({x}, {y})","project.titleLabel":"Nome do jogo","project.titlePlaceholder":"Ex.: Lendas do Vale","project.authorLabel":"Autor","project.authorPlaceholder":"Seu nome ou estÃºdio","project.languageLabel":"Idioma","project.generateUrl":"Gerar URL do jogo","project.shareUrlLabel":"URL do jogo","project.generateHTML":"Exportar Projeto","project.variables.title":"VariÃ¡veis do jogo","project.variables.usage":"{used}/{total} usadas","project.variables.used":"Em uso","project.variables.unused":"Sem uso","project.variables.toggle.show":"Mostrar variÃ¡veis","project.variables.toggle.hide":"Esconder variÃ¡veis","project.skills.title":"Skills do jogo","project.skills.toggle.show":"Mostrar skills","project.skills.toggle.hide":"Esconder skills","project.skills.level":"NÃ­vel {value}","project.test.title":"Ajuda nos testes","project.test.toggle.show":"Mostrar","project.test.toggle.hide":"Esconder","project.test.hint":"Apenas para testar: essas opÃ§Ãµes nÃ£o entram na URL gerada.","project.test.startLevel":"Inicia com nÃ­vel","project.test.levelOption":"NÃ­vel {value}","project.test.skills":"Ativar skills no teste","project.test.godMode":"God mode (imortal)","project.shareHint":"Gere uma URL e compartilhe com seus amigos!","project.paletteExpand":"Mostrar paleta de cores","project.paletteCollapse":"Esconder paleta de cores","project.paletteDescription":"Clique em uma cor para customizar","project.paletteReset":"Resetar PadrÃ£o","project.colorPickerTitle":"Escolher Cor","project.colorCurrent":"Atual","project.colorNew":"Nova","project.colorCancel":"Cancelar","project.colorConfirm":"Confirmar","language.option.ptBR":"PortuguÃªs (Brasil)","language.option.enUS":"English (US)","history.undo":"Desfazer","history.redo":"Refazer","alerts.npc.full":"Todos os NPCs jÃ¡ estÃ£o no mapa.","alerts.npc.createError":"NÃ£o foi possÃ­vel criar o NPC.","alerts.npc.selectFirst":"Selecione um NPC para colocar.","alerts.npc.placeError":"NÃ£o foi possÃ­vel posicionar o NPC.","alerts.share.unavailable":"FunÃ§Ã£o de compartilhar nÃ£o estÃ¡ disponÃ­vel.","alerts.share.copied":"URL do jogo copiada para a Ã¡rea de transferÃªncia!","alerts.share.copyPrompt":"Copie a URL do seu jogo:","alerts.share.generateError":"NÃ£o foi possÃ­vel gerar a URL do jogo.","alerts.share.loadError":"NÃ£o foi possÃ­vel carregar o arquivo.","enemies.damageInfo":" - Dano: {value}","enemies.variableLabel":"VariÃ¡vel:","enemies.xpBarLabel":"Inimigos colocados","enemies.xpBarValue":"{current} / {total} inimigos","enemies.limitReached":"MÃ¡ximo de inimigos atingido","enemies.names.giantRat":"ðŸ€ Rato Gigante","enemies.names.bandit":"ðŸ§” Bandido","enemies.names.darkKnight":"âš”ï¸ Cavaleiro Negro","enemies.names.necromancer":"ðŸ§™â€â™‚ï¸ Necro","enemies.names.dragon":"ðŸ‰ DragÃ£o","enemies.names.skeleton":"ðŸ’€ Esqueleto","enemies.names.fallenKing":"ðŸ‘‘ Rei CaÃ­do","enemies.names.ancientDemon":"ðŸ˜ˆ DemÃ´nio AnciÃ£o","enemies.defeat.dragon":"Selo do DragÃ£o ativado!","enemies.defeat.fallenKing":"Selo Real despertou!","enemies.defeat.ancientDemon":"Selo DemonÃ­aco ativo!","variables.none":"Nenhuma","variables.skill.bard":"Habilidade: Bardo (falas extras)","objects.info.available":"DisponÃ­vel (1 por cenÃ¡rio)","objects.info.placed":"JÃ¡ no mapa (1 por cenÃ¡rio)","variables.names.var1":"Preto","variables.names.var2":"Azul Escuro","variables.names.var3":"Roxo","variables.names.var4":"Verde","variables.names.var5":"Marrom","variables.names.var6":"Cinza","variables.names.var7":"Azul Claro","variables.names.var8":"Rosa Choque","variables.names.var9":"Amarelo","objects.switch.variableLabel":"VariÃ¡vel associada:","objects.switch.stateLabel":"Estado atual: {state}","objects.state.on":"ON","objects.state.off":"OFF","objects.status.doorOpened":"Porta aberta","objects.status.keyCollected":"Chave coletada","objects.status.potionCollected":"PoÃ§Ã£o coletada","objects.status.scrollUsed":"Pergaminho usado","objects.status.swordBroken":"Espada quebrada","objects.status.gameEnd":"Final do jogo","objects.end.textLabel":"Mensagem final:","objects.end.placeholder":'Escreva a mensagem exibida antes de "The End"...',"objects.end.hint":"MÃ¡x. {max} caracteres.","objects.status.startMarker":"Marcador inicial","objects.label.door":"Porta","objects.label.doorVariable":"Porta mÃ¡gica","objects.label.playerStart":"InÃ­cio do Jogador","objects.label.playerEnd":"Fim do Jogo","objects.label.switch":"Alavanca","objects.label.key":"Chave","objects.label.lifePotion":"PoÃ§Ã£o de Vida","objects.label.sword":"Espada de AÃ§o","objects.label.swordBronze":"Espada de Bronze","objects.label.swordWood":"Espada de Madeira","objects.label.xpScroll":"Pergaminho de XP","objects.item.pickup":"VocÃª pegou um item.","objects.key.pickup.single":"VocÃª pegou uma chave.","objects.key.pickup.count":"VocÃª pegou uma chave. Agora vocÃª tem {value}.","objects.potion.used":"VocÃª usou uma poÃ§Ã£o de vida.","objects.xpScroll.read":"VocÃª leu um pergaminho de XP e ganhou {value} de experiÃªncia.","objects.xpScroll.levelUp":"NÃ­vel +{value}!","objects.switch.onMessage":"Alavanca ligada.","objects.switch.offMessage":"Alavanca desligada.","objects.sword.pickup.single":"VocÃª pegou uma {name}! Ela bloqueia 1 de dano no prÃ³ximo ataque inimigo.","objects.sword.pickup.multi":"VocÃª pegou uma {name}! Ela bloqueia {value} de dano somando os prÃ³ximos ataques inimigos.","combat.block.full":"Ataque bloqueado!","combat.block.partial":"Bloqueado -{value}","combat.stealthKill":"Abate furtivo!","combat.stealthMiss":"Errou o ataque furtivo!","combat.cooldown":"Invulneravel por um instante!","player.levelUp":"Level Up!","player.levelUp.value":"Level Up! NÃ­vel {value}","skills.levelUpTitle":"Escolha uma skill","skills.levelUpHint":"Use 1/2 ou â†‘ â†“","skills.pendingLabel":"+{value} escolha(s) na fila","skills.allUnlocked":"Todas as habilidades jÃ¡ foram aprendidas.","skills.pickupMessage":"VocÃª aprendeu {name}!","skills.keylessDoors.name":"Ladino","skills.keylessDoors.desc":"Portas sem chave.","skills.charisma.name":"Bardo","skills.charisma.desc":"Falas extras.","skills.necromancer.name":"Necromante","skills.necromancer.desc":"Renasce ao morrer.","skills.necromancer.revive":"VocÃª voltou da morte!","skills.necromancer.revivePrompt":"Voltar Ã  vida","gameOver.retryVictory":"Jogar de novo?","gameOver.retryDefeat":"Tentar novamente?","skills.stealth.name":"Assassino","skills.stealth.desc":"Toque inimigos fracos para abatÃª-los.","skills.waterWalker.name":"Monge das Ãguas","skills.waterWalker.desc":"Anda sobre Ã¡gua.","skills.lavaWalker.name":"Mago de Fogo","skills.lavaWalker.desc":"Anda sobre lava.","skills.potionMaster.name":"Alquimista","skills.potionMaster.desc":"PoÃ§Ãµes curam tudo.","skills.xpBoost.name":"Estudioso","skills.xpBoost.desc":"+50% de XP ganho.","skills.ironBody.name":"Cavaleiro de AÃ§o","skills.ironBody.desc":"-1 em todo dano recebido.","game.clearAllEnemies":"Matou todos os inimigos! As terras estÃ£o purificadas e sua forÃ§a de vida floresce.","enemy.defaultName":"Inimigo","world.badge.start":"Start","world.cell.title":"Mapa ({col}, {row})","editor.map.title":"Mapa","editor.mapNav.up":"Ir para cena acima","editor.mapNav.down":"Ir para cena abaixo","editor.mapNav.left":"Ir para cena Ã  esquerda","editor.mapNav.right":"Ir para cena Ã  direita","editor.mobileNav.label":"Selecionar seÃ§Ã£o do editor","editor.mobileNav.tiles":"Mostrar tiles","editor.mobileNav.world":"Mostrar mapa do mundo","editor.mobileNav.objects":"Mostrar objetos","editor.mobileNav.npcs":"Mostrar NPCs","editor.mobileNav.enemies":"Mostrar inimigos","editor.mobileNav.project":"Mostrar projeto","tiles.summaryFallback":"Tile {id}"},"en-US":{"app.title":"Tiny RPG Studio","intro.byline":"by {author}","intro.startAdventure":"Start adventure","tabs.game":"Game","tabs.editor":"Editor","sections.tiles":"Tiles","sections.world":"World","sections.objects":"Objects","sections.npcs":"NPCs","sections.enemies":"Enemies","sections.project":"Project","buttons.reset":"Reset","buttons.newGame":"New Game","buttons.remove":"Remove","aria.reset":"Restart the current run","aria.newGame":"Spin up a fresh project in a new tab","touchControls.show":"Show controls","touchControls.hide":"Hide controls","touchControls.upLabel":"Move up","touchControls.downLabel":"Move down","touchControls.leftLabel":"Move left","touchControls.rightLabel":"Move right","doors.variableLocked":"This door does not open with a key.","doors.openedRemaining":"You used a key to open the door. Remaining: {value}.","doors.opened":"You used a key to open the door.","doors.locked":"Door locked. You need a key.","doors.unlockedSkill":"Your skill opens the door without a key.","log.engineReady":"Tiny RPG Studio engine initialized successfully.","npc.dialog.defaultLabel":"Default dialogue:","npc.dialog.placeholder":"Type the NPC dialogue...","npc.reward.defaultLabel":"After the default dialogue, enable variable:","npc.toggle.create":"Create alternate dialogue","npc.toggle.hide":"Hide alternate dialogue","npc.conditional.variableLabel":"Variable for alternate dialogue:","npc.conditional.textLabel":"Alternate text:","npc.conditional.placeholder":"Message displayed when the variable is ON.","npc.conditional.rewardLabel":"After the alternate dialogue, enable variable:","npc.delete":"Remove NPC","npc.defaultName":"NPC","npc.variant.label":"NPC appearance","npc.variant.human":"Human","npc.variant.elf":"Elf","npc.variant.dwarf":"Dwarf","npc.variant.fixed":"Extras","npcs.names.oldMage":"Old Mage","npcs.names.villagerMan":"Common man","npcs.names.villagerMan.human":"Common man","npcs.names.villagerMan.elf":"Common man","npcs.names.villagerMan.dwarf":"Common man","npcs.names.villagerWoman":"Common woman","npcs.names.villagerWoman.human":"Common woman","npcs.names.villagerWoman.elf":"Common woman","npcs.names.villagerWoman.dwarf":"Common woman","npcs.names.child":"Curious child","npcs.names.child.human":"Curious child","npcs.names.child.elf":"Curious child","npcs.names.child.dwarf":"Curious child","npcs.names.thoughtBubble":"Balloon","npcs.names.woodenSign":"Wooden sign","npcs.names.king":"King","npcs.names.king.human":"King","npcs.names.king.elf":"King","npcs.names.king.dwarf":"King","npcs.names.knight":"Knight","npcs.names.knight.human":"Knight","npcs.names.knight.elf":"Knight","npcs.names.knight.dwarf":"Knight","npcs.names.thief":"Thief","npcs.names.thief.human":"Thief","npcs.names.thief.elf":"Thief","npcs.names.thief.dwarf":"Thief","npcs.names.blacksmith":"Blacksmith","npcs.names.blacksmith.human":"Blacksmith","npcs.names.blacksmith.elf":"Blacksmith","npcs.names.blacksmith.dwarf":"Blacksmith","npcs.dialog.oldMage":"I guard old secrets.","npcs.dialog.oldMage.human":"I guard old secrets.","npcs.dialog.oldMage.elf":"Trees whisper stories to careful ears.","npcs.dialog.oldMage.dwarf":"Legends echo through the deep caverns.","npcs.dialog.villagerMan":"Good morning! Can I help?","npcs.dialog.villagerMan.human":"Good morning! Can I help?","npcs.dialog.villagerMan.elf":"May the forest guide your steps.","npcs.dialog.villagerMan.dwarf":"My hands know hammers and pickaxes.","npcs.dialog.villagerWoman":"What a lovely day to explore.","npcs.dialog.villagerWoman.human":"What a lovely day to explore.","npcs.dialog.villagerWoman.elf":"Flowers bloom with good intentions.","npcs.dialog.villagerWoman.dwarf":"The sound of the forge calms my heart.","npcs.dialog.child":"Let's play adventure!","npcs.dialog.child.human":"Let's play adventure!","npcs.dialog.child.elf":"Want to race through the woods with me?","npcs.dialog.child.dwarf":"Let's dig a secret tunnel!","npcs.dialog.thoughtBubble":" ... ","npcs.dialog.woodenSign":"Beware of the dangers ahead.","npcs.dialog.king":"Defend our kingdom!","npcs.dialog.king.human":"Defend our kingdom!","npcs.dialog.king.elf":"Honor nature above all.","npcs.dialog.king.dwarf":"Guard the mines with steel and honor.","npcs.dialog.knight":"I am ready to fight.","npcs.dialog.knight.human":"I am ready to fight.","npcs.dialog.knight.elf":"I fight to keep the green alive.","npcs.dialog.knight.dwarf":"My armor thunders like a war drum.","npcs.dialog.thief":"No one catches me in the act.","npcs.dialog.thief.human":"No one catches me in the act.","npcs.dialog.thief.elf":"I am a shadow between leaves and branches.","npcs.dialog.thief.dwarf":"Among stone and gold, no one sees me coming.","npcs.dialog.blacksmith":"My forges are blazing hot.","npcs.dialog.blacksmith.human":"My forges are blazing hot.","npcs.dialog.blacksmith.elf":"I forge with living wood and light steel.","npcs.dialog.blacksmith.dwarf":"Steel and stone; that is how you build.","npc.status.available":"Available","npc.status.position":"Map ({col}, {row}) - ({x}, {y})","project.titleLabel":"Game name","project.titlePlaceholder":"Eg: Legends of the Vale","project.authorLabel":"Author","project.authorPlaceholder":"Your name or studio","project.languageLabel":"Language","project.generateUrl":"Generate share URL","project.shareUrlLabel":"Game URL","project.generateHTML":"Export Project","project.variables.title":"Game variables","project.variables.usage":"{used}/{total} used","project.variables.used":"In use","project.variables.unused":"Not used","project.variables.toggle.show":"Show variables","project.variables.toggle.hide":"Hide variables","project.skills.title":"Game skills","project.skills.toggle.show":"Show skills","project.skills.toggle.hide":"Hide skills","project.skills.level":"Level {value}","project.test.title":"Test helpers","project.test.toggle.show":"Show","project.test.toggle.hide":"Hide","project.test.hint":"Testing only: these options are not included in the share URL.","project.test.startLevel":"Start at level","project.test.levelOption":"Level {value}","project.test.skills":"Enable skills for testing","project.test.godMode":"God mode (immortal)","project.shareHint":"Generate a URL and share it with friends!","project.paletteExpand":"Show color palette","project.paletteCollapse":"Hide color palette","project.paletteDescription":"Click on a color to customize","project.paletteReset":"Reset to Default","project.colorPickerTitle":"Choose Color","project.colorCurrent":"Current","project.colorNew":"New","project.colorCancel":"Cancel","project.colorConfirm":"Confirm","language.option.ptBR":"Portuguese (Brazil)","language.option.enUS":"English (US)","history.undo":"Undo","history.redo":"Redo","alerts.npc.full":"All NPCs are already on the map.","alerts.npc.createError":"Could not create this NPC.","alerts.npc.selectFirst":"Select an NPC before placing.","alerts.npc.placeError":"Could not place the NPC.","alerts.share.unavailable":"Share feature is not available.","alerts.share.copied":"Game URL copied to your clipboard!","alerts.share.copyPrompt":"Copy your game URL:","alerts.share.generateError":"Unable to generate the game URL.","alerts.share.loadError":"Unable to load the file.","enemies.damageInfo":" - Damage: {value}","enemies.variableLabel":"Variable:","enemies.xpBarLabel":"Enemies placed","enemies.xpBarValue":"{current} / {total} enemies","enemies.limitReached":"Max enemies reached","enemies.names.giantRat":"ðŸ€ Giant Rat","enemies.names.bandit":"ðŸ§” Bandit","enemies.names.darkKnight":"âš”ï¸ Dark Knight","enemies.names.necromancer":"ðŸ§™â€â™‚ï¸ Necromancer","enemies.names.dragon":"ðŸ‰ Dragon","enemies.names.skeleton":"ðŸ’€ Skeleton","enemies.names.fallenKing":"ðŸ‘‘ Fallen King","enemies.names.ancientDemon":"ðŸ˜ˆ Ancient Demon","enemies.defeat.dragon":"Dragon Seal activated!","enemies.defeat.fallenKing":"Royal Seal awakened!","enemies.defeat.ancientDemon":"Demonic Seal is active!","variables.none":"None","variables.skill.bard":"Skill: Bard (alternate lines)","objects.info.available":"Available (1 per scene)","objects.info.placed":"Already on the map (1 per scene)","variables.names.var1":"Black","variables.names.var2":"Dark Blue","variables.names.var3":"Purple","variables.names.var4":"Green","variables.names.var5":"Brown","variables.names.var6":"Gray","variables.names.var7":"Light Blue","variables.names.var8":"Hot Pink","variables.names.var9":"Yellow","objects.switch.variableLabel":"Linked variable:","objects.switch.stateLabel":"Current state: {state}","objects.state.on":"ON","objects.state.off":"OFF","objects.status.doorOpened":"Door opened","objects.status.keyCollected":"Key collected","objects.status.potionCollected":"Potion collected","objects.status.scrollUsed":"Scroll used","objects.status.swordBroken":"Sword broken","objects.status.gameEnd":"End of game","objects.end.textLabel":"Final message:","objects.end.placeholder":'Type the message shown before "The End"...',"objects.end.hint":"Max {max} characters.","objects.status.startMarker":"Start marker","objects.label.door":"Door","objects.label.doorVariable":"Magic door","objects.label.playerStart":"Player start","objects.label.playerEnd":"Game end","objects.label.switch":"Switch","objects.label.key":"Key","objects.label.lifePotion":"Health potion","objects.label.sword":"Steel sword","objects.label.swordBronze":"Bronze sword","objects.label.swordWood":"Wooden sword","objects.label.xpScroll":"XP scroll","objects.item.pickup":"You picked up an item.","objects.key.pickup.single":"You picked up a key.","objects.key.pickup.count":"You picked up a key. You now have {value}.","objects.potion.used":"You used a health potion.","objects.xpScroll.read":"You read an XP scroll and gained {value} experience.","objects.xpScroll.levelUp":"Level +{value}!","objects.switch.onMessage":"Switch turned on.","objects.switch.offMessage":"Switch turned off.","objects.sword.pickup.single":"You picked up a {name}! It blocks 1 damage from the next enemy attack.","objects.sword.pickup.multi":"You picked up a {name}! It blocks {value} damage across upcoming enemy attacks.","combat.block.full":"Attack blocked!","combat.block.partial":"Blocked -{value}","combat.stealthKill":"Stealth kill!","combat.stealthMiss":"Stealth strike missed!","combat.cooldown":"Invulnerable for a moment!","player.levelUp":"Level Up!","player.levelUp.value":"Level Up! Level {value}","skills.levelUpTitle":"Pick a skill","skills.levelUpHint":"Use 1/2 or â†‘ â†“","skills.pendingLabel":"+{value} pick(s) queued","skills.allUnlocked":"All skills already unlocked.","skills.pickupMessage":"You learned {name}!","skills.keylessDoors.name":"Rogue","skills.keylessDoors.desc":"Locked doors open without spending keys.","skills.charisma.name":"Bard","skills.charisma.desc":"Unlock alternate NPC dialogues.","skills.necromancer.name":"Necromancer","skills.necromancer.desc":"Automatically revive once after death.","skills.necromancer.revive":"You returned from death!","skills.necromancer.revivePrompt":"Return to life","gameOver.retryVictory":"Play again?","gameOver.retryDefeat":"Try again?","skills.stealth.name":"Assassin","skills.stealth.desc":"Touch weak enemies for an instant kill.","skills.waterWalker.name":"Water Monk","skills.waterWalker.desc":"Water tiles stop blocking your path.","skills.lavaWalker.name":"Fire Mage","skills.lavaWalker.desc":"Stride over lava without harm.","skills.potionMaster.name":"Alchemist","skills.potionMaster.desc":"Health potions restore all HP.","skills.xpBoost.name":"Scholar","skills.xpBoost.desc":"+50% experience gain.","skills.ironBody.name":"Iron Knight","skills.ironBody.desc":"-1 to every incoming hit.","game.clearAllEnemies":"You felled every foe. The land is cleansed and your life force swells.","enemy.defaultName":"Enemy","world.badge.start":"Start","world.cell.title":"Map ({col}, {row})","editor.map.title":"Map","editor.mapNav.up":"Go to scene above","editor.mapNav.down":"Go to scene below","editor.mapNav.left":"Go to scene on the left","editor.mapNav.right":"Go to scene on the right","editor.mobileNav.label":"Select editor section","editor.mobileNav.tiles":"Show tiles","editor.mobileNav.world":"Show world map","editor.mobileNav.objects":"Show objects","editor.mobileNav.npcs":"Show NPCs","editor.mobileNav.enemies":"Show enemies","editor.mobileNav.project":"Show project","tiles.summaryFallback":"Tile {id}"}},getStrings(m=K.locale){const e=this.bundles[m];return e||(this.bundles[this.defaultLocale]??{})},detectBrowserLocale(){if(typeof navigator>"u")return this.defaultLocale;const m=Array.isArray(navigator.languages)&&navigator.languages.length?navigator.languages:[navigator.language||this.defaultLocale];for(const e of m){const t=String(e);if(this.bundles[t])return t;const n=String(e||"").split("-")[0],a=Object.keys(this.bundles).find(i=>i.startsWith(n));if(a)return a}return this.defaultLocale},setLocale(m,{silent:e=!1,root:t}={}){return this.bundles[m]?(this.locale=m,e||(this.apply(t),document.dispatchEvent(new CustomEvent("language-changed",{detail:{locale:this.locale}}))),!0):!1},getLocale(){return this.locale},extend(m,e={}){if(!m||typeof e!="object")return;const t=this.bundles[m];this.bundles[m]={...t,...e},m===this.locale&&this.apply()},get(m,e=""){if(!m)return e||"";const t=this.getStrings(this.locale);if(Object.prototype.hasOwnProperty.call(t,m)){const n=t[m];return(typeof n=="string"?n:e)||""}if(this.locale!==this.defaultLocale){const n=this.getStrings(this.defaultLocale);if(Object.prototype.hasOwnProperty.call(n,m)){const a=n[m];return(typeof a=="string"?a:e)||""}}return e||m||""},format(m,e={},t=""){const n=this.get(m,t);return n?n.replace(/\{(\w+)\}/g,(i,r)=>{if(Object.prototype.hasOwnProperty.call(e,r)){const s=e[r];return s==null?"":String(s)}return""}):t||m||""},apply(m=document){typeof m.querySelectorAll=="function"&&(m.querySelectorAll("[data-text-key]").forEach(e=>{const t=e.getAttribute("data-text-key"),n=e.textContent??"",a=this.get(t,n);e.textContent=a}),m.querySelectorAll("[data-placeholder-key]").forEach(e=>{const t=e.getAttribute("data-placeholder-key"),n=this.get(t,e.getAttribute("placeholder")||"");n&&e.setAttribute("placeholder",n)}),m.querySelectorAll("[data-aria-label-key]").forEach(e=>{const t=e.getAttribute("data-aria-label-key"),n=this.get(t,e.getAttribute("aria-label")||"");n&&e.setAttribute("aria-label",n)}),m.querySelectorAll("[data-title-key]").forEach(e=>{const t=e.getAttribute("data-title-key"),n=this.get(t,e.getAttribute("title")||"");n&&e.setAttribute("title",n)}))}};typeof document<"u"&&document.addEventListener("DOMContentLoaded",()=>{const m=K.detectBrowserLocale();K.setLocale(m,{silent:!0}),K.apply()});class ft{manager;editorIndicator;editorIndicatorTimeout;constructor(e){this.manager=e,this.editorIndicator=null,this.editorIndicatorTimeout=null}get dom(){return this.manager.domCache}get state(){return this.manager.state}get gameEngine(){return this.manager.gameEngine}activatePlacement(){this.getEnemyDefinition(this.manager.selectedEnemyType)&&(this.state.placingEnemy||(this.manager.npcService.clearSelection(),this.state.placingObjectType&&this.manager.objectService.togglePlacement(this.state.placingObjectType,!0),this.state.placingEnemy=!0,this.state.placingNpc=!1,this.state.placingObjectType=null,this.dom.editorCanvas&&(this.dom.editorCanvas.style.cursor="crosshair")))}deactivatePlacement(){this.state.placingEnemy&&(this.state.placingEnemy=!1,!this.state.placingNpc&&!this.state.placingObjectType&&this.dom.editorCanvas&&(this.dom.editorCanvas.style.cursor="default"))}placeEnemyAt(e){const t=this.state.activeRoomIndex;if((this.gameEngine.getEnemyDefinitions()??[]).find(d=>d.roomIndex===t&&d.x===e.x&&d.y===e.y))return;if((this.gameEngine.getActiveEnemies()??[]).reduce((d,u)=>u.roomIndex===t?d+1:d,0)>=6){this.showEnemyLimitFeedback();return}const s=this.getEnemyDefinition(this.state.selectedEnemyType),l=he.ENEMY_DEFINITIONS[0]?.type||"giant-rat",o=s?.type||l;this.gameEngine.addEnemy({x:e.x,y:e.y,roomIndex:t,type:o})&&(this.manager.renderService.renderEnemies(),this.manager.renderService.renderEnemyCatalog(),this.manager.renderService.renderWorldGrid(),this.manager.renderService.renderEditor(),this.manager.gameEngine.draw(),this.manager.updateJSON(),this.manager.history.pushCurrentState())}removeEnemy(e){this.gameEngine.removeEnemy(e),this.manager.renderService.renderEnemies(),this.manager.renderService.renderEnemyCatalog(),this.manager.renderService.renderWorldGrid(),this.manager.renderService.renderEditor(),this.manager.gameEngine.draw(),this.manager.updateJSON(),this.manager.history.pushCurrentState()}handleEnemyVariableChange(e,t){const n=typeof t=="string"&&t.trim().length?t:null;this.gameEngine.setEnemyVariable(e,n)&&(this.manager.renderService.renderEnemies(),this.manager.renderService.renderWorldGrid(),this.manager.updateJSON(),this.manager.history.pushCurrentState())}selectEnemyType(e){const t=this.getEnemyDefinition(e);t&&(this.state.selectedEnemyType!==t.type&&(this.manager.selectedEnemyType=t.type,this.manager.renderEnemyCatalog()),this.activatePlacement())}clearSelection({render:e=!0}={}){return!(this.manager.selectedEnemyType||this.state.placingEnemy)?!1:(this.manager.selectedEnemyType=null,this.deactivatePlacement(),e&&this.manager.renderEnemyCatalog(),!0)}getEditorIndicator(){if(this.editorIndicator)return this.editorIndicator;const e=document.querySelector(".editor-map-wrapper");if(!e)return null;const t=document.createElement("div");return t.className="combat-indicator",t.setAttribute("aria-live","polite"),t.setAttribute("aria-atomic","true"),e.appendChild(t),this.editorIndicator=t,t}showEnemyLimitFeedback(){const e=this.getEditorIndicator();if(this.editorIndicatorTimeout&&(clearTimeout(this.editorIndicatorTimeout),this.editorIndicatorTimeout=null),e){e.textContent=this.getEnemyLimitMessage(),e.classList.remove("visible"),e.setAttribute("data-visible","false"),e.offsetWidth,e.classList.add("visible"),e.setAttribute("data-visible","true"),this.editorIndicatorTimeout=setTimeout(()=>{e.classList.remove("visible"),e.setAttribute("data-visible","false"),e.textContent="",this.editorIndicatorTimeout=null},700);return}this.gameEngine.renderer.showCombatIndicator(this.getEnemyLimitMessage(),{duration:700})}getEnemyLimitMessage(){const e=K.get("enemies.limitReached","").trim();return e||"Max enemies reached"}getEnemyDefinition(e=null){const t=typeof e=="string"&&e.length>0?e:this.state.selectedEnemyType,n=te.getEnemyDefinition(t);if(n)return n;const a=he.ENEMY_DEFINITIONS;return a.find(i=>i.type===t)||(t?a.find(i=>Array.isArray(i.aliases)&&i.aliases.includes(t)):null)||null}}class yt{editorManager;stack;index;constructor(e){this.editorManager=e,this.stack=[],this.index=-1}pushSnapshot(e){this.stack[this.index]!==e&&(this.stack=this.stack.slice(0,this.index+1),this.stack.push(e),this.index=this.stack.length-1)}pushCurrentState(){const e=JSON.stringify(this.editorManager.gameEngine.exportGameData());this.pushSnapshot(e)}canUndo(){return this.index>0}canRedo(){return this.index<this.stack.length-1}undo(){this.canUndo()&&(this.index-=1,this.restoreCurrent())}redo(){this.canRedo()&&(this.index+=1,this.restoreCurrent())}restoreCurrent(){const e=this.stack[this.index];if(!e)return;const t=JSON.parse(e);this.editorManager.restore(t,{skipHistory:!0})}}class vt{manager;constructor(e){this.manager=e}get text(){return K}t(e,t=""){const a=this.text.get(e,t);return a||t||e||""}get gameEngine(){return this.manager.gameEngine}get dom(){return this.manager.domCache}get state(){return this.manager.state}addNpc(){this.gameEngine.npcManager.ensureDefaultNPCs();const e=this.gameEngine.getSprites(),n=this.gameEngine.npcManager.getDefinitions().map(i=>({def:i,npc:e.find(r=>r.type===i.type)||null})).find(i=>!i.npc||!i.npc.placed);if(!n){alert(this.t("alerts.npc.full"));return}const a=n.npc;if(a)this.state.selectedNpcId=a.id,this.state.selectedNpcType=a.type;else{const i=this.gameEngine.npcManager,r=i.createNPC?i.createNPC(n.def.type):null;if(!r){alert(this.t("alerts.npc.createError"));return}this.state.selectedNpcId=r.id,this.state.selectedNpcType=r.type}this.activatePlacement(),this.manager.renderService.renderNpcs(),this.manager.renderService.renderWorldGrid(),this.manager.renderService.renderEditor(),this.manager.gameEngine.draw(),this.manager.updateJSON(),this.manager.history.pushCurrentState()}activatePlacement(){if(!this.state.selectedNpcId){alert(this.t("alerts.npc.selectFirst"));return}this.state.placingNpc||(this.manager.enemyService.deactivatePlacement(),this.state.placingObjectType&&this.manager.objectService.togglePlacement(this.state.placingObjectType,!0),this.state.placingNpc=!0,this.state.placingEnemy=!1,this.state.placingObjectType=null,this.dom.editorCanvas&&(this.dom.editorCanvas.style.cursor="crosshair"))}deactivatePlacement(){this.state.placingNpc&&(this.state.placingNpc=!1,!this.state.placingEnemy&&!this.state.placingObjectType&&this.dom.editorCanvas&&(this.dom.editorCanvas.style.cursor="default"))}clearSelection({render:e=!0}={}){const t=!!(this.state.selectedNpcId||this.state.selectedNpcType||this.state.placingNpc);return this.state.selectedNpcId=null,this.state.selectedNpcType=null,this.state.conditionalDialogueExpanded=!1,this.deactivatePlacement(),e&&t&&this.manager.renderService.renderNpcs(),t}removeSelectedNpc(){!this.state.selectedNpcId||!this.gameEngine.npcManager.removeNPC(this.state.selectedNpcId)||(this.clearSelection({render:!1}),this.manager.renderService.renderNpcs(),this.manager.renderService.renderWorldGrid(),this.manager.renderService.renderEditor(),this.manager.gameEngine.draw(),this.manager.updateJSON(),this.manager.history.pushCurrentState())}updateNpcSelection(e,t){if(!t){this.clearSelection();return}this.state.selectedNpcType=e,this.state.selectedNpcId=t;const a=this.gameEngine.getSprites().find(r=>r.id===t)||null,i=!!(a?.conditionText||a?.conditionVariableId||a?.conditionalRewardVariableId);this.state.conditionalDialogueExpanded=i,this.manager.renderService.renderNpcs(),this.activatePlacement()}placeNpcAt(e){if(!this.state.selectedNpcId){alert(this.t("alerts.npc.selectFirst")),this.deactivatePlacement();return}const t=this.state.activeRoomIndex;if(!this.gameEngine.npcManager.setNPCPosition(this.state.selectedNpcId,e.x,e.y,t)){alert(this.t("alerts.npc.placeError"));return}this.manager.renderService.renderNpcs(),this.manager.renderService.renderWorldGrid(),this.manager.renderService.renderEditor(),this.manager.gameEngine.draw(),this.manager.updateJSON(),this.manager.history.pushCurrentState()}populateVariableSelect(e,t="",n={}){if(!e)return;const a=this.gameEngine.getVariableDefinitions()??[],i=!!n.includeBardSkill;e.innerHTML="";const r=document.createElement("option");if(r.value="",r.textContent=this.t("variables.none"),e.appendChild(r),i){const s=document.createElement("option");s.value="skill:bard",s.textContent=this.t("variables.skill.bard"),e.appendChild(s)}a.forEach(s=>{const l=document.createElement("option");l.value=s.id,l.textContent=s.name||s.id,e.appendChild(l)}),e.value=t||""}updateNpcText(e){if(!this.state.selectedNpcId)return;const n=this.gameEngine.getSprites().find(a=>a.id===this.state.selectedNpcId);n&&(n.text=e,n.textKey=null,this.manager.renderService.renderNpcs(),this.manager.updateJSON(),this.scheduleNpcTextUpdate())}updateNpcConditionalText(e){if(!this.state.selectedNpcId)return;const n=this.gameEngine.getSprites().find(a=>a.id===this.state.selectedNpcId);n&&(n.conditionText=e,this.manager.renderService.renderNpcs(),this.manager.updateJSON(),this.scheduleNpcTextUpdate())}scheduleNpcTextUpdate(){this.state.npcTextUpdateTimer&&clearTimeout(this.state.npcTextUpdateTimer),this.state.npcTextUpdateTimer=setTimeout(()=>{this.manager.history.pushCurrentState()},400)}handleConditionVariableChange(e){if(!this.state.selectedNpcId)return;const n=this.gameEngine.getSprites().find(a=>a.id===this.state.selectedNpcId);n&&(n.conditionVariableId=e||null,this.manager.renderService.renderNpcs(),this.manager.renderService.renderWorldGrid(),this.manager.updateJSON(),this.manager.history.pushCurrentState())}handleRewardVariableChange(e){if(!this.state.selectedNpcId)return;const n=this.gameEngine.getSprites().find(a=>a.id===this.state.selectedNpcId);n&&(n.rewardVariableId=e||null,this.manager.renderService.renderNpcs(),this.manager.renderService.renderWorldGrid(),this.manager.updateJSON(),this.manager.history.pushCurrentState())}handleConditionalRewardVariableChange(e){if(!this.state.selectedNpcId)return;const n=this.gameEngine.getSprites().find(a=>a.id===this.state.selectedNpcId);n&&(n.conditionalRewardVariableId=e||null,this.manager.renderService.renderNpcs(),this.manager.renderService.renderWorldGrid(),this.manager.updateJSON(),this.manager.history.pushCurrentState())}setVariantFilter(e){const n=["human","elf","dwarf","fixed"].includes(e)?e:"human";this.state.npcVariantFilter!==n&&(this.clearSelection({render:!1}),this.state.npcVariantFilter=n,this.manager.renderService.renderNpcs())}}class bt{manager;constructor(e){this.manager=e}get dom(){return this.manager.domCache}get state(){return this.manager.state}get gameEngine(){return this.manager.gameEngine}togglePlacement(e,t=!1){const n=this.normalizeType(e??this.state.placingObjectType??this.manager.selectedObjectType);if(t){if(!this.state.placingObjectType)return;this.state.placingObjectType=null,!this.state.placingNpc&&!this.state.placingEnemy&&this.dom.editorCanvas&&(this.dom.editorCanvas.style.cursor="default"),this.manager.renderObjectCatalog();return}if(n){if(this.state.placingObjectType===n){this.state.placingObjectType=null,!this.state.placingNpc&&!this.state.placingEnemy&&this.dom.editorCanvas&&(this.dom.editorCanvas.style.cursor="default"),this.manager.renderObjectCatalog();return}this.selectObjectType(n)}}updatePlacementButtons(){this.manager.renderObjectCatalog()}placeObjectAt(e,t,n){this.gameEngine.setObjectPosition(e,n,t.x,t.y)&&(this.manager.renderService.renderObjects(),this.manager.renderObjectCatalog(),this.manager.renderService.renderWorldGrid(),this.manager.renderService.renderEditor(),this.manager.gameEngine.draw(),this.manager.updateJSON(),this.manager.history.pushCurrentState())}removeObject(e,t){this.state.placingObjectType===e&&this.togglePlacement(e,!0),this.gameEngine.removeObject(e,t),this.manager.renderService.renderObjects(),this.manager.renderObjectCatalog(),this.manager.renderService.renderWorldGrid(),this.manager.renderService.renderEditor(),this.manager.gameEngine.draw(),this.manager.updateJSON(),this.manager.history.pushCurrentState()}selectObjectType(e){const t=this.normalizeType(e);t&&(this.manager.selectedObjectType!==t&&(this.manager.selectedObjectType=t),this.activatePlacement(t))}activatePlacement(e=null){const t=this.normalizeType(e??this.manager.selectedObjectType);t&&(this.manager.npcService.clearSelection(),this.state.placingEnemy&&this.manager.enemyService.deactivatePlacement(),this.state.placingNpc=!1,this.state.placingObjectType=t,this.manager.selectedObjectType=t,this.dom.editorCanvas&&(this.dom.editorCanvas.style.cursor="crosshair"),this.manager.renderObjectCatalog())}clearSelection({render:e=!0}={}){return!(this.manager.selectedObjectType||this.state.placingObjectType)?!1:(this.state.placingObjectType=null,this.manager.selectedObjectType=null,!this.state.placingNpc&&!this.state.placingEnemy&&this.dom.editorCanvas&&(this.dom.editorCanvas.style.cursor="default"),e&&this.manager.renderObjectCatalog(),!0)}updatePlayerEndText(e,t){this.gameEngine.setPlayerEndText(e,t),this.manager.updateJSON(),this.schedulePlayerEndTextHistory()}schedulePlayerEndTextHistory(){this.state.playerEndTextUpdateTimer&&clearTimeout(this.state.playerEndTextUpdateTimer),this.state.playerEndTextUpdateTimer=setTimeout(()=>{this.manager.history.pushCurrentState()},400)}normalizeType(e){if(typeof e!="string"||!e.length)return null;const t=he.OBJECT_DEFINITIONS;if(Array.isArray(t)&&t.length){const a=t.find(i=>i.type===e)?.type||null;if(a)return a}return new Set(Q.getPlaceableTypes()).has(e)?e:null}}class St{id;name;pixels;frames;animated;collision;category;layouts;constructor(e){this.id=e.id,this.name=e.name,this.pixels=e.pixels,this.frames=e.frames,this.animated=e.frames.length>1,this.collision=e.collision,this.category=e.category,this.layouts=e.layouts}}class ye{static PICO8_COLORS=Object.freeze(["#000000","#1D2B53","#7E2553","#008751","#AB5236","#5F574F","#C2C3C7","#FFF1E8","#FF004D","#FFA300","#FFFF27","#00E756","#29ADFF","#83769C","#FF77A8","#FFCCAA"]);static createTile(e,t,n,a=!1,i="Diversos",r){const s=Array.isArray(n)?n.filter(Boolean):[n],l=(s.length?s:[this.createEmptyLayout()]).map(c=>this.toPixels(c,r)),o={id:e,name:t,pixels:l[0],frames:l,collision:a,category:i,layouts:s};return new St(o)}static createEmptyLayout(){return Array.from({length:8},()=>Array(8).fill(null))}static toPixels(e,t){const n=t||this.PICO8_COLORS;return e.map(a=>a.map(i=>i===null?"transparent":n[i]??"transparent"))}static tile(e,t,n,a=!1,i="Diversos",r=null){const s=[n];return Array.isArray(r)&&s.push(r),this.createTile(e,t,s,a,i)}static TILE_PRESETS=[this.tile(0,"Grama Vibrante",[[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3]],!1,"Terreno"),this.tile(1,"Grama Alta",[[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3],[3,3,3,3,3,11,3,3],[3,3,3,3,11,3,11,3],[3,11,3,3,3,3,3,3],[11,3,11,3,3,3,3,3],[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3]],!1,"Terreno",[[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,11,3],[3,3,3,3,3,11,3,11],[3,3,11,3,3,3,3,3],[3,11,3,11,3,3,3,3],[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3]]),this.tile(2,"Trilha de Terra",[[4,4,4,4,4,4,4,4],[4,9,4,4,4,4,4,4],[4,4,4,4,4,4,4,4],[4,4,4,4,4,4,4,4],[4,4,4,4,4,4,9,4],[4,4,4,4,4,4,4,4],[4,4,4,9,4,4,4,4],[4,4,4,4,4,4,4,4]],!1,"Terreno"),this.tile(3,"Cascalho",[[3,3,3,3,3,3,3,3],[3,5,5,3,3,3,3,3],[5,6,6,5,3,3,3,3],[3,3,3,3,3,5,3,3],[3,3,3,3,5,6,5,3],[3,3,3,5,6,6,5,3],[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3]],!1,"Terreno"),this.tile(4,"Areia Macia",[[15,15,15,15,15,15,15,15],[15,15,10,15,15,10,15,15],[15,15,15,15,15,15,15,15],[15,10,15,15,15,15,10,15],[15,15,15,15,15,15,15,15],[15,15,10,15,15,10,15,15],[15,15,15,15,15,15,15,15],[15,10,15,15,15,15,10,15]],!1,"Terreno"),this.tile(16,"Piso de madeira",[[5,5,4,4,5,5,4,4],[5,5,4,4,5,5,4,4],[4,4,5,5,4,4,5,5],[4,4,5,5,4,4,5,5],[5,5,4,4,5,5,4,4],[5,5,4,4,5,5,4,4],[4,4,5,5,4,4,5,5],[4,4,5,5,4,4,5,5]],!1,"Terreno"),this.tile(17,"Piso de pedra",[[13,5,5,5,5,13,5,5],[5,5,13,5,5,5,13,5],[5,13,5,13,5,5,5,5],[5,5,5,13,5,5,5,5],[5,5,5,5,5,5,5,13],[5,5,5,5,5,5,5,13],[13,5,5,5,13,5,5,5],[13,5,5,5,5,13,5,13]],!1,"Terreno"),this.tile(5,"Agua Brilhante",[[12,12,12,12,12,12,12,7],[12,7,12,12,12,12,12,12],[7,6,7,12,12,12,12,12],[12,12,12,12,12,12,12,12],[12,12,12,12,12,7,12,12],[12,12,12,12,7,12,7,6],[12,7,12,12,12,12,12,12],[12,12,12,12,12,12,12,12]],!0,"Agua",[[12,12,12,12,12,12,12,12],[12,7,12,12,12,12,7,12],[12,12,12,12,12,7,12,7],[12,12,6,7,12,12,12,12],[7,12,12,12,12,12,12,12],[12,7,12,12,12,12,12,7],[12,12,12,12,6,7,12,12],[12,12,12,12,12,12,12,12]]),this.tile(6,"Lava Borbulhante",[[10,10,8,8,8,8,9,8],[8,10,9,10,9,9,8,8],[9,9,10,9,9,10,9,10],[8,8,8,8,9,10,10,8],[8,8,8,8,8,8,8,8],[8,9,10,8,8,10,9,8],[8,10,9,10,9,10,8,8],[10,8,8,8,8,8,9,8]],!0,"Perigo",[[9,10,8,8,10,8,9,8],[8,9,10,9,9,10,8,8],[9,10,9,10,9,10,9,8],[8,8,10,8,9,9,10,8],[8,8,8,8,8,9,8,8],[8,10,9,8,10,8,9,8],[10,9,10,9,10,9,8,8],[10,8,8,9,8,8,10,8]]),this.tile(7,"Pedra Grande",[[null,null,null,null,null,null,null,null],[null,null,null,null,5,null,null,null],[null,null,null,5,7,5,null,null],[null,null,5,13,6,7,5,null],[null,5,13,6,6,6,5,null],[null,5,13,6,6,6,7,5],[null,5,13,6,6,6,6,5],[null,null,null,null,null,null,null,null]],!0,"Natureza"),this.tile(8,"Arvore Verde",[[null,null,1,1,1,1,null,null],[null,1,11,11,11,11,1,null],[1,11,3,11,11,11,11,1],[1,11,11,11,11,3,11,1],[1,11,11,11,11,11,11,1],[null,1,1,4,4,1,1,null],[null,null,null,4,4,null,null,null],[null,null,4,4,4,4,null,null]],!0,"Natureza"),this.tile(9,"Arbusto Denso",[[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,1,1,1,1,null,null],[null,1,11,11,11,11,1,null],[1,11,11,11,11,3,11,1],[1,11,3,11,11,11,11,1],[1,1,1,1,1,1,1,1]],!0,"Natureza"),this.tile(10,"Parede de Pedra",[[6,7,6,5,13,5,13,6],[5,13,6,6,6,5,5,5],[5,5,6,7,6,5,5,13],[6,5,5,5,13,6,6,7],[6,6,13,5,5,7,6,6],[13,5,7,13,5,5,6,5],[5,6,6,6,7,13,13,5],[7,6,6,13,5,5,5,6]],!0,"Construcoes"),this.tile(11,"Parede de Madeira",[[9,9,9,9,9,9,9,9],[9,9,9,9,9,9,9,9],[9,9,9,9,9,9,9,9],[9,9,9,9,9,9,9,9],[9,9,9,9,9,9,9,9],[4,4,4,4,4,4,4,4],[9,9,9,9,9,9,9,9],[4,4,4,4,4,4,4,4]],!0,"Construcoes"),this.tile(12,"Telhado Classico",[[2,2,8,8,2,2,8,8],[8,8,14,14,8,8,14,14],[8,8,2,2,8,8,2,2],[14,14,8,8,14,14,8,8],[2,2,8,8,2,2,8,8],[8,8,14,14,8,8,14,14],[8,8,2,2,8,8,2,2],[14,14,8,8,14,14,8,8]],!0,"Construcoes"),this.tile(13,"Porta de Madeira",[[4,4,4,4,4,4,4,4],[4,9,9,9,9,9,9,4],[4,9,9,9,9,9,9,4],[4,9,9,9,9,9,9,4],[4,9,9,9,9,10,9,4],[4,9,9,9,9,9,9,4],[4,9,9,9,9,9,9,4],[4,9,9,9,9,9,9,4]],!1,"Construcoes"),this.tile(14,"Janela Azul",[[9,9,9,9,9,9,9,9],[9,9,5,5,5,5,9,9],[9,9,5,12,7,5,9,9],[9,9,5,12,12,5,9,9],[9,9,5,5,5,5,9,9],[4,4,4,4,4,4,4,4],[9,9,9,9,9,9,9,9],[4,4,4,4,4,4,4,4]],!0,"Construcoes"),this.tile(15,"Tocha de Parede",[[null,null,null,7,null,null,null,null],[null,null,null,10,7,null,null,null],[null,null,10,10,10,null,null,null],[null,null,10,8,10,null,null,null],[null,null,null,4,null,null,null,null],[null,null,null,4,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null]],!0,"Decoracao")];static get presets(){return this.TILE_PRESETS}}const Ye=ye.PICO8_COLORS,Xe=ye.TILE_PRESETS;class Et{manager;constructor(e){this.manager=e}initialize(){this.renderPaletteGrid(),this.bindEvents(),this.syncPaletteState()}renderPaletteGrid(){const e=this.manager.dom.paletteGrid;if(!e)return;const t=this.getCurrentPalette();e.innerHTML="",t.forEach((n,a)=>{const i=document.createElement("button");i.className="palette-color-button",i.style.backgroundColor=n,i.dataset.colorIndex=String(a),i.setAttribute("aria-label",`Color ${a}: ${n}`),i.title=`Cor ${a}: ${n}`,i.addEventListener("click",()=>{this.openColorPicker(a)}),e.appendChild(i)})}getCurrentPalette(){return this.manager.gameEngine.getCustomPalette()||[...ye.PICO8_COLORS]}openColorPicker(e){const t=this.manager.dom.colorPickerModal,n=this.manager.dom.colorPickerInput,a=this.manager.dom.colorPreviewCurrent,i=this.manager.dom.colorPreviewNew,r=this.manager.dom.colorPickerIndex;if(!t||!n||!a||!i||!r)return;this.manager.state.editingColorIndex=e;const s=this.getCurrentPalette()[e];n.value=s,a.style.backgroundColor=s,i.style.backgroundColor=s,r.textContent=`#${e}`,t.hidden=!1;const l=()=>{i.style.backgroundColor=n.value};n.addEventListener("input",l)}closeColorPicker(){const e=this.manager.dom.colorPickerModal;e&&(e.hidden=!0),this.manager.state.editingColorIndex=null}confirmColorChange(){const e=this.manager.state.editingColorIndex,t=this.manager.dom.colorPickerInput;if(e===null||!t){this.closeColorPicker();return}const n=t.value.toUpperCase();this.setColorAtIndex(e,n),this.closeColorPicker(),this.renderPaletteGrid(),this.manager.renderAll(),this.manager.gameEngine.draw(),this.manager.historyManager.pushCurrentState()}setColorAtIndex(e,t){let n=this.manager.gameEngine.getCustomPalette();n?n=[...n]:n=[...ye.PICO8_COLORS],n[e]=t,this.manager.gameEngine.setCustomPalette(n)}resetToDefault(){this.manager.gameEngine.resetPaletteToDefault(),this.renderPaletteGrid(),this.manager.renderAll(),this.manager.gameEngine.draw(),this.manager.historyManager.pushCurrentState()}togglePanel(){const e=this.manager.dom.projectPalettePanel,t=this.manager.dom.projectPaletteToggle;if(!e||!t)return;const n=e.hidden;e.hidden=!n,t.setAttribute("aria-expanded",String(!n)),this.manager.state.palettePanelCollapsed=!n,this.updateToggleText()}syncPaletteState(){const e=this.manager.dom.projectPalettePanel,t=this.manager.dom.projectPaletteToggle;if(!e||!t)return;const n=this.manager.state.palettePanelCollapsed;e.hidden=n,t.setAttribute("aria-expanded",String(!n)),this.updateToggleText()}updateToggleText(){const e=this.manager.dom.projectPaletteToggle;if(!e)return;const t=this.manager.state.palettePanelCollapsed,n=globalThis.TextResources,a=t?n?.get?n.get("project.paletteExpand","Mostrar paleta de cores"):"Mostrar paleta de cores":n?.get?n.get("project.paletteCollapse","Esconder paleta de cores"):"Esconder paleta de cores";e.textContent=`ðŸŽ¨ ${a}`}bindEvents(){this.manager.dom.projectPaletteToggle?.addEventListener("click",()=>{this.togglePanel()}),this.manager.dom.paletteResetButton?.addEventListener("click",()=>{this.resetToDefault()}),this.manager.dom.colorPickerConfirm?.addEventListener("click",()=>{this.confirmColorChange()}),this.manager.dom.colorPickerCancel?.addEventListener("click",()=>{this.closeColorPicker()}),this.manager.dom.colorPickerModal?.addEventListener("click",e=>{e.target===this.manager.dom.colorPickerModal&&this.closeColorPicker()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&!this.manager.dom.colorPickerModal?.hidden&&this.closeColorPicker()})}}class Mt{id;nameKey;descriptionKey;icon;constructor(e){this.id=e.id,this.nameKey=e.nameKey,this.descriptionKey=e.descriptionKey,this.icon=e.icon}}class de{static SKILL_DEFINITION_DATA=[{id:"keyless-doors",nameKey:"skills.keylessDoors.name",descriptionKey:"skills.keylessDoors.desc",icon:"ðŸ”‘"},{id:"charisma",nameKey:"skills.charisma.name",descriptionKey:"skills.charisma.desc",icon:"ðŸ—£ï¸"},{id:"necromancer",nameKey:"skills.necromancer.name",descriptionKey:"skills.necromancer.desc",icon:"â˜ ï¸"},{id:"stealth",nameKey:"skills.stealth.name",descriptionKey:"skills.stealth.desc",icon:"ðŸ•¶ï¸"},{id:"lava-walker",nameKey:"skills.lavaWalker.name",descriptionKey:"skills.lavaWalker.desc",icon:"ðŸ”¥"},{id:"potion-master",nameKey:"skills.potionMaster.name",descriptionKey:"skills.potionMaster.desc",icon:"ðŸ§ª"}];static SKILLS=de.SKILL_DEFINITION_DATA.map(e=>new Mt(e));static LEVEL_SKILLS={2:["necromancer","charisma"],4:["stealth"],6:["potion-master"],8:["lava-walker"],10:["keyless-doors"]};static getAll(){return this.SKILLS}static getById(e){return typeof e!="string"||!e?null:this.SKILLS.find(t=>t.id===e)||null}static getSkillsForLevel(e){const t=Number.isFinite(e)?Math.max(1,Math.floor(e)):1,n=this.LEVEL_SKILLS[t]||[];if(!Array.isArray(n))return[];const a=[];return n.forEach(i=>{typeof i!="string"||!i||this.getById(i)&&(a.includes(i)||a.push(i))}),a}static buildQueueForLevel(e,t=[],n=[]){const a=Array.isArray(t)?t:[],i=new Set(Array.isArray(n)?n:[]),r=this.getSkillsForLevel(e),s=[];return[...a,...r].forEach(l=>{typeof l!="string"||!l||i.has(l)||this.getById(l)&&(s.includes(l)||s.push(l))}),s.length||this.getAll().forEach(l=>{!i.has(l.id)&&!s.includes(l.id)&&s.push(l.id)}),s}static pickRandom(e=2,t=[]){const n=Array.isArray(t)?t:[],a=this.getAll().filter(r=>!n.includes(r.id));if(!a.length)return[];const i=this.shuffle(a);return i.slice(0,Math.max(1,Math.min(e,i.length)))}static shuffle(e){const t=Array.isArray(e)?e.slice():[];for(let n=t.length-1;n>0;n--){const a=Math.floor(Math.random()*(n+1));[t[n],t[a]]=[t[a],t[n]]}return t}}class Se{service;constructor(e){this.service=e}get manager(){return this.service.manager}get dom(){return this.service.dom}get state(){return this.service.state}get gameEngine(){return this.service.gameEngine}t(e,t=""){return this.service.t(e,t)}tf(e,t={},n=""){return this.service.tf(e,t,n)}}class xt extends Se{renderEditor(){const e=this.manager.ectx,t=this.dom.editorCanvas;if(!e||!t)return;e.clearRect(0,0,t.width,t.height);const n=Math.floor(t.width/8),a=this.state.activeRoomIndex,i=this.gameEngine.getTileMap(a)||{},r=i.ground||[],s=i.overlay||[];for(let l=0;l<8;l++)for(let o=0;o<8;o++){const c=r[l]?.[o];c!==null?this.drawTile(e,c,o*n,l*n,n):(e.fillStyle="#141414",e.fillRect(o*n,l*n,n,n));const d=s[l]?.[o];d!==null&&this.drawTile(e,d,o*n,l*n,n)}e.strokeStyle="rgba(255,255,255,0.1)";for(let l=0;l<=8;l++)e.beginPath(),e.moveTo(l*n,0),e.lineTo(l*n,t.height),e.stroke();for(let l=0;l<=8;l++)e.beginPath(),e.moveTo(0,l*n),e.lineTo(t.width,l*n),e.stroke();this.drawEntities(n)}drawEntities(e){const t=this.manager.ectx;if(!t)return;const n=this.state.activeRoomIndex,a=e/8,i=this.gameEngine.getObjectsForRoom(n)||[];for(const c of i)this.gameEngine.renderer.drawObjectSprite(t,c.type,c.x*e,c.y*e,a);const r=this.gameEngine.getSprites().filter(c=>c.roomIndex===n&&c.placed);for(const c of r){const d=this.gameEngine.renderer.npcSprites[c.type]||this.gameEngine.renderer.npcSprites.default;Array.isArray(d)&&this.gameEngine.renderer.drawSprite(t,d,c.x*e,c.y*e,a)}const s=this.gameEngine.getActiveEnemies().filter(c=>c.roomIndex===n),l=this.gameEngine.renderer,o=l.enemySprites;for(const c of s){const d=o[c.type]||l.enemySprite;Array.isArray(d)&&l.drawSprite(t,d,c.x*e,c.y*e,a)}}drawTile(e,t,n,a,i){const r=this.manager.gameEngine.tileManager,s=r.getTile(t);if(!s)return;const l=r.getTilePixels(s);if(!Array.isArray(l))return;const o=Math.max(1,Math.floor(i/8));for(let c=0;c<8;c++)for(let d=0;d<8;d++){const u=l[c]?.[d];!u||u==="transparent"||(e.fillStyle=u,e.fillRect(n+d*o,a+c*o,o,o))}}}class Tt{type;id;name;nameKey;previewLabel;defaultText;defaultTextKey;sprite;variant;constructor(e){this.type=e.type,this.id=e.id,this.name=e.name,this.nameKey=e.nameKey,this.previewLabel=e.previewLabel,this.defaultText=e.defaultText,this.defaultTextKey=e.defaultTextKey,this.sprite=e.sprite,this.variant=e.variant}}class Ee{static NPC_VARIANTS=["human","elf","dwarf","fixed"];static NPC_DEFINITION_DATA=[{type:"old-mage",id:"npc-old-mage",name:"Velho Mago",nameKey:"npcs.names.oldMage.human",previewLabel:"Mago",defaultText:"",defaultTextKey:"npcs.dialog.oldMage.human",sprite:I.get("npc","old-mage"),variant:"human"},{type:"villager-man",id:"npc-villager-man",name:"Homem comum",nameKey:"npcs.names.villagerMan.human",previewLabel:"Homem",defaultText:"",defaultTextKey:"npcs.dialog.villagerMan.human",sprite:I.get("npc","villager-man"),variant:"human"},{type:"villager-woman",id:"npc-villager-woman",name:"Mulher comum",nameKey:"npcs.names.villagerWoman.human",previewLabel:"Mulher",defaultText:"",defaultTextKey:"npcs.dialog.villagerWoman.human",sprite:I.get("npc","villager-woman"),variant:"human"},{type:"child",id:"npc-child",name:"Crianca curiosa",nameKey:"npcs.names.child.human",previewLabel:"Crianca",defaultText:"",defaultTextKey:"npcs.dialog.child.human",sprite:I.get("npc","child"),variant:"human"},{type:"king",id:"npc-king",name:"Rei",nameKey:"npcs.names.king.human",previewLabel:"Rei",defaultText:"",defaultTextKey:"npcs.dialog.king.human",sprite:I.get("npc","king"),variant:"human"},{type:"knight",id:"npc-knight",name:"Cavaleiro",nameKey:"npcs.names.knight.human",previewLabel:"Cavaleiro",defaultText:"",defaultTextKey:"npcs.dialog.knight.human",sprite:I.get("npc","knight"),variant:"human"},{type:"thief",id:"npc-thief",name:"Ladra",nameKey:"npcs.names.thief.human",previewLabel:"Ladra",defaultText:"",defaultTextKey:"npcs.dialog.thief.human",sprite:I.get("npc","thief"),variant:"human"},{type:"blacksmith",id:"npc-blacksmith",name:"Ferreira",nameKey:"npcs.names.blacksmith.human",previewLabel:"Ferreira",defaultText:"",defaultTextKey:"npcs.dialog.blacksmith.human",sprite:I.get("npc","blacksmith"),variant:"human"},{type:"old-mage-elf",id:"npc-old-mage-elf",name:"Velho Mago",nameKey:"npcs.names.oldMage.elf",previewLabel:"Mago",defaultText:"",defaultTextKey:"npcs.dialog.oldMage.elf",sprite:I.get("npc","old-mage-elf"),variant:"elf"},{type:"villager-man-elf",id:"npc-villager-man-elf",name:"Homem comum",nameKey:"npcs.names.villagerMan.elf",previewLabel:"Homem",defaultText:"",defaultTextKey:"npcs.dialog.villagerMan.elf",sprite:I.get("npc","villager-man-elf"),variant:"elf"},{type:"villager-woman-elf",id:"npc-villager-woman-elf",name:"Mulher comum",nameKey:"npcs.names.villagerWoman.elf",previewLabel:"Mulher",defaultText:"",defaultTextKey:"npcs.dialog.villagerWoman.elf",sprite:I.get("npc","villager-woman-elf"),variant:"elf"},{type:"child-elf",id:"npc-child-elf",name:"Crianca curiosa",nameKey:"npcs.names.child.elf",previewLabel:"Crianca",defaultText:"",defaultTextKey:"npcs.dialog.child.elf",sprite:I.get("npc","child-elf"),variant:"elf"},{type:"king-elf",id:"npc-king-elf",name:"Rei",nameKey:"npcs.names.king.elf",previewLabel:"Rei",defaultText:"",defaultTextKey:"npcs.dialog.king.elf",sprite:I.get("npc","king-elf"),variant:"elf"},{type:"knight-elf",id:"npc-knight-elf",name:"Cavaleiro",nameKey:"npcs.names.knight.elf",previewLabel:"Cavaleiro",defaultText:"",defaultTextKey:"npcs.dialog.knight.elf",sprite:I.get("npc","knight-elf"),variant:"elf"},{type:"thief-elf",id:"npc-thief-elf",name:"Ladra",nameKey:"npcs.names.thief.elf",previewLabel:"Ladra",defaultText:"",defaultTextKey:"npcs.dialog.thief.elf",sprite:I.get("npc","thief-elf"),variant:"elf"},{type:"blacksmith-elf",id:"npc-blacksmith-elf",name:"Ferreira",nameKey:"npcs.names.blacksmith.elf",previewLabel:"Ferreira",defaultText:"",defaultTextKey:"npcs.dialog.blacksmith.elf",sprite:I.get("npc","blacksmith-elf"),variant:"elf"},{type:"old-mage-dwarf",id:"npc-old-mage-dwarf",name:"Velho Mago",nameKey:"npcs.names.oldMage.dwarf",previewLabel:"Mago",defaultText:"",defaultTextKey:"npcs.dialog.oldMage.dwarf",sprite:I.get("npc","old-mage-dwarf"),variant:"dwarf"},{type:"villager-man-dwarf",id:"npc-villager-man-dwarf",name:"Homem comum",nameKey:"npcs.names.villagerMan.dwarf",previewLabel:"Homem",defaultText:"",defaultTextKey:"npcs.dialog.villagerMan.dwarf",sprite:I.get("npc","villager-man-dwarf"),variant:"dwarf"},{type:"villager-woman-dwarf",id:"npc-villager-woman-dwarf",name:"Mulher comum",nameKey:"npcs.names.villagerWoman.dwarf",previewLabel:"Mulher",defaultText:"",defaultTextKey:"npcs.dialog.villagerWoman.dwarf",sprite:I.get("npc","villager-woman-dwarf"),variant:"dwarf"},{type:"child-dwarf",id:"npc-child-dwarf",name:"Crianca curiosa",nameKey:"npcs.names.child.dwarf",previewLabel:"Crianca",defaultText:"",defaultTextKey:"npcs.dialog.child.dwarf",sprite:I.get("npc","child-dwarf"),variant:"dwarf"},{type:"king-dwarf",id:"npc-king-dwarf",name:"Rei",nameKey:"npcs.names.king.dwarf",previewLabel:"Rei",defaultText:"",defaultTextKey:"npcs.dialog.king.dwarf",sprite:I.get("npc","king-dwarf"),variant:"dwarf"},{type:"knight-dwarf",id:"npc-knight-dwarf",name:"Cavaleiro",nameKey:"npcs.names.knight.dwarf",previewLabel:"Cavaleiro",defaultText:"",defaultTextKey:"npcs.dialog.knight.dwarf",sprite:I.get("npc","knight-dwarf"),variant:"dwarf"},{type:"thief-dwarf",id:"npc-thief-dwarf",name:"Ladra",nameKey:"npcs.names.thief.dwarf",previewLabel:"Ladra",defaultText:"",defaultTextKey:"npcs.dialog.thief.dwarf",sprite:I.get("npc","thief-dwarf"),variant:"dwarf"},{type:"blacksmith-dwarf",id:"npc-blacksmith-dwarf",name:"Ferreira",nameKey:"npcs.names.blacksmith.dwarf",previewLabel:"Ferreira",defaultText:"",defaultTextKey:"npcs.dialog.blacksmith.dwarf",sprite:I.get("npc","blacksmith-dwarf"),variant:"dwarf"},{type:"thought-bubble",id:"npc-thought-bubble",name:"Balao",nameKey:"npcs.names.thoughtBubble",previewLabel:"Balao",defaultText:"",defaultTextKey:"npcs.dialog.thoughtBubble",sprite:I.get("npc","thought-bubble"),variant:"fixed"},{type:"wooden-sign",id:"npc-wooden-sign",name:"Placa de madeira",nameKey:"npcs.names.woodenSign",previewLabel:"Placa",defaultText:"",defaultTextKey:"npcs.dialog.woodenSign",sprite:I.get("npc","wooden-sign"),variant:"fixed"}];static NPC_DEFINITIONS=Ee.NPC_DEFINITION_DATA.map(e=>new Tt(e));static get definitions(){return this.NPC_DEFINITIONS}static getNpcDefinition(e){return this.NPC_DEFINITIONS.find(t=>t.type===e)||null}static normalizeVariant(e){const t=String(e||"").toLowerCase();return this.NPC_VARIANTS.includes(t)?t:"human"}static getVariants(){return this.NPC_VARIANTS.slice()}}class Ne{static _npcDefinitions;static _objectDefinitions;static _enemyDefinitions;static get NPC_DEFINITIONS(){return(!this._npcDefinitions||!this._npcDefinitions.length)&&(this._npcDefinitions=Ee.definitions),this._npcDefinitions}static get OBJECT_DEFINITIONS(){return(!this._objectDefinitions||!this._objectDefinitions.length)&&(this._objectDefinitions=Ve.definitions),this._objectDefinitions}static get ENEMY_DEFINITIONS(){return(!this._enemyDefinitions||!this._enemyDefinitions.length)&&(this._enemyDefinitions=te.definitions),this._enemyDefinitions}static get DEFAULT_PALETTE(){return["#000000","#1D2B53","#7E2553","#008751","#AB5236","#5F574F","#C2C3C7","#FFF1E8","#FF004D","#FFA300","#FFFF27","#00E756","#29ADFF","#83769C","#FF77A8","#FFCCAA"]}}class wt extends Se{renderEnemies(){const e=this.dom.enemiesList;if(!e)return;e.innerHTML="";const t=this.state.activeRoomIndex,n=this.gameEngine.getActiveEnemies().filter(s=>s.roomIndex===t);if(this.renderEnemyOverlay(n,t),!n.length)return;const a=he.ENEMY_DEFINITIONS,i=new Map;a.forEach(s=>{i.set(s.type,s),Array.isArray(s.aliases)&&s.aliases.forEach(l=>i.set(l,s))});const r=n.filter(s=>i.get(s.type)?.boss);r.length&&r.forEach(s=>{const l=i.get(s.type)??null,o=document.createElement("div");o.className="enemy-item";const c=document.createElement("span"),d=this.getEnemyDisplayName(l,s.type),u=Number.isFinite(l?.damage)?this.tf("enemies.damageInfo",{value:l?.damage??0}):"";c.textContent=`${d} @ (${s.x}, ${s.y})${u}`;const h=document.createElement("label");h.className="enemy-variable-wrapper",h.textContent=`${this.t("enemies.variableLabel")} `;const g=document.createElement("select");g.className="enemy-variable-select",g.dataset.enemyVariable=s.id,this.manager.npcService.populateVariableSelect(g,s.defeatVariableId||""),h.appendChild(g);const f=document.createElement("button");f.type="button",f.className="enemy-remove",f.dataset.removeEnemy=s.id,f.textContent=this.t("buttons.remove");const v=document.createElement("div");v.className="enemy-controls",v.append(h,f),o.append(c,v),e.appendChild(o)})}renderEnemyCatalog(){const e=this.dom.enemyTypes;if(!e)return;e.innerHTML="";const t=he.ENEMY_DEFINITIONS;if(!t.length)return;const n=this.manager.selectedEnemyType;this.renderEnemyCountProgress(e.parentElement||e,e),t.forEach(a=>{const i=document.createElement("div");i.className="enemy-card",i.dataset.type=a.type,a.boss&&i.classList.add("boss"),a.type===n&&i.classList.add("selected");const r=document.createElement("canvas");r.className="enemy-preview",r.width=48,r.height=48,this.drawEnemyPreview(r,a);const s=document.createElement("div");s.className="enemy-meta";const l=document.createElement("div");l.className="enemy-name",l.textContent=this.getEnemyDisplayName(a,a.type);const o=document.createElement("div");o.className="enemy-damage";const c=Number.isFinite(a.damage)?a.damage:"?";if(o.textContent=`Dano: ${c}`,a.boss){const d=document.createElement("span");d.className="enemy-boss-badge",d.textContent="Boss",s.appendChild(d)}s.append(l,o),i.append(r,s),e.appendChild(i)})}drawEnemyPreview(e,t){if(!(e instanceof HTMLCanvasElement))return;const n=e.getContext("2d");if(!n)return;n.clearRect(0,0,e.width,e.height),n.imageSmoothingEnabled=!1;const a=this.gameEngine.renderer;let i=a.enemySprites[t.type]??null;if(i||(i=a.enemySprite),!i&&Array.isArray(t.sprite)){const s=a.paletteManager.getPalette(),l=s.length?s:Ne.DEFAULT_PALETTE;i=a.spriteFactory.mapPixels(t.sprite,l)}if(!Array.isArray(i))return;const r=e.width/8;for(let s=0;s<i.length;s++){const l=i[s];if(Array.isArray(l))for(let o=0;o<l.length;o++){const c=l[o];c&&(n.fillStyle=c,n.fillRect(o*r,s*r,r,r))}}}getEnemyDisplayName(e,t=""){const n=this.t("enemy.defaultName","Inimigo"),a=e?.name||t||n;return(e?.nameKey?this.t(e.nameKey,a):a).replace(/[^\w\s\u00C0-\u024F'()-]/g," ").replace(/\s+/g," ").trim()||t||n}renderEnemyCountProgress(e,t=null){if(!e)return;e.querySelector(".enemy-xp-block")?.remove();const{currentCount:n,totalCount:a,ratio:i}=this.getEnemyCountProgress(),r=document.createElement("div");r.className="enemy-xp-block";const s=document.createElement("div");s.className="enemy-xp-header";const l=document.createElement("div");l.className="enemy-xp-label",l.textContent=this.t("enemies.xpBarLabel","Inimigos colocados");const o=document.createElement("div");o.className="enemy-xp-value";const c=this.tf("enemies.xpBarValue",{current:n,total:a},`${n} / ${a} inimigos`);o.textContent=c,s.append(l,o);const d=document.createElement("div");d.className="enemy-xp-track";const u=document.createElement("div");u.className="enemy-xp-fill",u.style.width=`${Math.round(i*100)}%`,d.appendChild(u),r.append(s,d),t&&t.parentElement===e?e.insertBefore(r,t):e.appendChild(r)}getEnemyCountProgress(){const t=this.gameEngine.getActiveEnemies().length,a=this.gameEngine.getGame().world??{},i=Number(a.rows)||3,r=Number(a.cols)||3,o=Math.max(1,i*r)*6,c=Math.max(0,Math.min(1,o>0?t/o:0));return{currentCount:t,totalCount:o,ratio:c}}renderEnemyOverlay(e,t){const n=this.dom.editorCanvas;if(!n)return;const a=n.parentElement;if(!a)return;const i=Array.isArray(e)?e.filter(h=>h.roomIndex===t):[];let r=a.querySelector(".enemy-overlay");if(!i.length){r&&(r.innerHTML="",r.remove());return}r||(r=document.createElement("div"),r.className="enemy-overlay",a.appendChild(r));const s=this.gameEngine.gameState.worldManager.roomSize,l=n.offsetWidth||n.clientWidth||n.width||1,o=n.offsetHeight||n.clientHeight||n.height||1,c=l/s,d=o/s,u=r;u.style.width=`${l}px`,u.style.height=`${o}px`,u.style.left=`${n.offsetLeft}px`,u.style.top=`${n.offsetTop}px`,r.innerHTML="",i.forEach(h=>{const g=document.createElement("button");g.type="button",g.className="enemy-overlay-remove",g.textContent="âœ•",g.style.left=`${(h.x+1)*c}px`,g.style.top=`${h.y*d}px`,g.addEventListener("click",f=>{f.stopPropagation(),this.manager.enemyService.removeEnemy(h.id)}),r.appendChild(g)})}}class It extends Se{renderNpcs(){const e=this.dom.npcsList;if(!e)return;this.gameEngine.npcManager.ensureDefaultNPCs(),this.updateVariantButtons();const t=this.gameEngine.getGame(),n=this.manager.state.npcVariantFilter||"human",i=this.gameEngine.npcManager.getDefinitions().filter(s=>(s.variant||"human")===n),r=this.gameEngine.getSprites();e.innerHTML="",i.forEach(s=>{const l=r.find(g=>g.type===s.type),o=document.createElement("div");o.className="npc-card",o.dataset.type=s.type,o.dataset.id=l?.id||"",s.type===this.manager.selectedNpcType&&o.classList.add("selected"),l?.placed?o.classList.add("npc-card-placed"):o.classList.add("npc-card-available");const c=document.createElement("canvas");c.className="npc-preview",c.width=48,c.height=48,this.drawNpcPreview(c,s);const d=document.createElement("div");d.className="meta";const u=document.createElement("div");u.className="npc-name",u.textContent=this.getNpcName(s);const h=document.createElement("div");if(h.className="npc-position",l?.placed){const g=t.world?.cols||1,f=Math.floor(l.roomIndex/g)+1,v=l.roomIndex%g+1;h.textContent=this.tf("npc.status.position",{col:v,row:f,x:l.x,y:l.y},`Mapa (${v}, ${f}) - (${l.x}, ${l.y})`)}else h.textContent=this.t("npc.status.available");d.append(u,h),o.append(c,d),e.appendChild(o)}),this.updateNpcForm()}drawNpcPreview(e,t){if(!(e instanceof HTMLCanvasElement))return;const n=e.getContext("2d");if(!n)return;n.clearRect(0,0,e.width,e.height),n.imageSmoothingEnabled=!1;const a=this.gameEngine.renderer.npcSprites,i=a[t.type]||a.default;if(!Array.isArray(i))return;const r=e.width/8;for(let s=0;s<i.length;s++)for(let l=0;l<i[s].length;l++){const o=i[s][l];o&&(n.fillStyle=o,n.fillRect(l*r,s*r,r,r))}}updateNpcForm(){const e=this.manager.selectedNpcId,t=this.gameEngine.getSprites().find(f=>f.id===e),{npcEditor:n,npcText:a,npcConditionalText:i,npcConditionalVariable:r,npcRewardVariable:s,npcConditionalRewardVariable:l,btnToggleNpcConditional:o,npcConditionalSection:c}=this.dom,d=!!e,u=!!t;n&&(n.hidden=!d),a&&(a.disabled=!u,a.value=this.getNpcDialogueText(t??null)),i&&(i.disabled=!u,i.value=t?.conditionText||""),this.manager.npcService.populateVariableSelect(r,t?.conditionVariableId||"",{includeBardSkill:!0}),this.manager.npcService.populateVariableSelect(s,t?.rewardVariableId||""),this.manager.npcService.populateVariableSelect(l,t?.conditionalRewardVariableId||""),r&&(r.disabled=!u),s&&(s.disabled=!u),l&&(l.disabled=!u);const h=this.dom.btnNpcDelete;h&&"disabled"in h&&(h.disabled=!u||!t?.placed);const g=!!this.manager.state.conditionalDialogueExpanded;c&&(c.hidden=!g),o&&(o.textContent=g?this.t("npc.toggle.hide"):this.t("npc.toggle.create"),o.setAttribute("aria-expanded",g?"true":"false"))}getNpcName(e){if(!e)return this.t("npc.defaultName","NPC");const t=e.name||this.t("npc.defaultName","NPC");return e.nameKey?this.t(e.nameKey,t):t}getNpcDialogueText(e){return e?e.textKey?this.t(e.textKey,e.text||""):e.text||"":""}updateVariantButtons(){const e=Array.isArray(this.dom.npcVariantButtons)?this.dom.npcVariantButtons:[];if(!e.length)return;const t=this.manager.state.npcVariantFilter||"human";e.forEach(n=>{const a=n.dataset.npcVariantFilter===t;n.classList.toggle("active",a),n.setAttribute("aria-pressed",a?"true":"false")})}}const $e=40;class B{static _collectibleSet;game;worldManager;variableManager;static get TYPES(){return $}get types(){return B.TYPES}static get PLAYER_START_TYPE(){return this.TYPES.PLAYER_START}static get PLAYER_END_TYPE(){return this.TYPES.PLAYER_END}static get SWITCH_TYPE(){return this.TYPES.SWITCH}static get PLACEABLE_OBJECT_TYPES(){return this.getPlaceableTypesArray()}static get COLLECTIBLE_OBJECT_TYPES(){return this.getCollectibleTypeSet()}static get PLAYER_END_TEXT_LIMIT(){return $e}static getPlaceableTypesArray(){return Q.getPlaceableTypes()}static getPlaceableTypeSet(){return new Set(this.getPlaceableTypesArray())}static getCollectibleTypeSet(){return this._collectibleSet||(this._collectibleSet=new Set(Q.getCollectibleTypes())),this._collectibleSet}static isCollectibleType(e){return Q.isCollectible(e)}constructor(e,t,n){this.game=e,this.worldManager=t,this.variableManager=n,this.ensurePlayerStartObject()}setGame(e){this.game=e,this.ensurePlayerStartObject()}setWorldManager(e){this.worldManager=e}setVariableManager(e){this.variableManager=e}normalizeObjects(e){if(!Array.isArray(e))return[];const t=this.types,n=B.getPlaceableTypeSet();let a=!1;const i=new Set;return e.map(r=>{const s=r,l=typeof s.type=="string"?s.type:null;if(!l||!n.has(l))return null;const o=l;if(!this.worldManager)return null;const c=this.worldManager.clampRoomIndex(s.roomIndex??0);if(o===B.PLAYER_START_TYPE){if(a)return null;a=!0}if(o===B.PLAYER_END_TYPE){if(i.has(c))return null;i.add(c)}const d=this.worldManager.clampCoordinate(s.x??0),u=this.worldManager.clampCoordinate(s.y??0),h=s.id,g=typeof h=="string"&&h.trim()?h.trim():this.generateObjectId(o,c),f=this.variableManager?.getFirstVariableId?.()??null,S=Q.requiresVariable(o)?this.variableManager?.normalizeVariableId?.(s.variableId)??f:null,M={id:g,type:o,roomIndex:c,x:d,y:u,collected:B.isCollectibleType(o)?!!s.collected:!1,opened:o===t.DOOR?!!s.opened:!1,variableId:S};return o===B.SWITCH_TYPE&&(M.on=!!s.on),o===B.PLAYER_END_TYPE&&(M.endingText=this.normalizePlayerEndText(s.endingText)),this.applyObjectBehavior(M)}).filter(r=>!!r)}normalizePlayerEndText(e){return typeof e!="string"?"":e.replace(/\r\n/g,`
`).slice(0,$e).trim()}resetRuntime(){this.getObjects().forEach(t=>{t.isCollectible&&(t.collected=!1),t.isLockedDoor&&(t.opened=!1),t.type===B.SWITCH_TYPE&&(t.on=!1)}),this.ensurePlayerStartObject()}generateObjectId(e,t){return e===B.PLAYER_START_TYPE?B.PLAYER_START_TYPE:`${e}-${t}`}getObjects(){return this.game?(Array.isArray(this.game.objects)||(this.game.objects=[]),this.game.objects.forEach(e=>this.applyObjectBehavior(e)),this.game.objects):[]}getObjectsForRoom(e){if(!this.worldManager)return[];const t=this.worldManager.clampRoomIndex(e??0);return this.getObjects().filter(n=>n.roomIndex===t)}getObjectAt(e,t,n){if(!this.worldManager)return null;const a=this.worldManager.clampRoomIndex(e??0),i=this.worldManager.clampCoordinate(t??0),r=this.worldManager.clampCoordinate(n??0);return this.getObjects().find(s=>s.roomIndex===a&&s.x===i&&s.y===r)||null}setObjectPosition(e,t,n,a){if(!this.worldManager)return null;const r=B.getPlaceableTypeSet().has(e)?e:null;if(!r)return null;const s=this.worldManager.clampRoomIndex(t),l=this.worldManager.clampCoordinate(n),o=this.worldManager.clampCoordinate(a),c=this.getObjects();let d=null;if(r===B.PLAYER_START_TYPE?d=c.find(u=>u.type===r)||null:d=c.find(u=>u.type===r&&u.roomIndex===s)||null,d?(d.roomIndex=s,d.x=l,d.y=o):(d={id:this.generateObjectId(r,s),type:r,roomIndex:s,x:l,y:o},r===B.SWITCH_TYPE&&(d.on=!1),r===B.PLAYER_END_TYPE&&(d.endingText=""),c.push(d)),B.isCollectibleType(r)&&(d.collected=!1),Q.isLockedDoor(r)&&(d.opened=!1),Q.isVariableDoor(r)){const u=this.variableManager?.getFirstVariableId?.()??null;d.variableId=this.variableManager?.normalizeVariableId?.(d.variableId)??u}if(r===B.PLAYER_START_TYPE&&this.syncPlayerStart(d),r===B.SWITCH_TYPE){const u=this.variableManager?.getFirstVariableId?.()??null;d.variableId=this.variableManager?.normalizeVariableId?.(d.variableId)??u,d.on=!!d.on}return r===B.PLAYER_END_TYPE&&(d.endingText=this.normalizePlayerEndText(d.endingText)),this.applyObjectBehavior(d)}removeObject(e,t){const a=B.getPlaceableTypeSet().has(e)?e:null;if(!a||a===B.PLAYER_START_TYPE||!this.worldManager||!this.game)return;const i=this.worldManager.clampRoomIndex(t);this.game.objects=this.getObjects().filter(r=>!(r.type===a&&r.roomIndex===i))}setObjectVariable(e,t,n){if(!this.worldManager||!Q.requiresVariable(e))return null;const i=this.worldManager.clampRoomIndex(t),r=this.getObjects().find(o=>o.type===e&&o.roomIndex===i);if(!r)return null;const s=this.variableManager?.getFirstVariableId?.()??null,l=this.variableManager?.normalizeVariableId?.(n);return r.variableId=l??s,r.variableId}syncSwitchState(e,t){if(!e)return!1;let n=!1;const a=this.variableManager?.normalizeVariableId?.(e)??null;if(!a)return!1;const i=!!t;return this.getObjects().forEach(r=>{r.type===B.SWITCH_TYPE&&r.variableId===a&&r.on!==i&&(r.on=i,n=!0)}),n}ensurePlayerStartObject(){if(!this.game||!this.worldManager)return null;const e=this.getObjects(),t=this.game.start||{x:1,y:1,roomIndex:0},n=this.worldManager.clampRoomIndex(t.roomIndex),a=this.worldManager.clampCoordinate(t.x),i=this.worldManager.clampCoordinate(t.y);let r=e.find(s=>s.type===B.PLAYER_START_TYPE)||null;return r?(r.roomIndex=n,r.x=a,r.y=i):(r={id:B.PLAYER_START_TYPE,type:B.PLAYER_START_TYPE,roomIndex:n,x:a,y:i},e.unshift(r)),this.applyObjectBehavior(r)}getPlayerEndObject(e=null){const t=this.getObjects();if(e===null)return t.find(a=>a.type===B.PLAYER_END_TYPE)||null;if(!this.worldManager)return null;const n=this.worldManager.clampRoomIndex(e);return t.find(a=>a.type===B.PLAYER_END_TYPE&&a.roomIndex===n)||null}getPlayerEndText(e=null){const t=this.getPlayerEndObject(e);return typeof t?.endingText=="string"?t.endingText:""}setPlayerEndText(e,t){const n=this.getPlayerEndObject(e);if(!n)return"";const a=this.normalizePlayerEndText(t);return n.endingText=a,a}syncPlayerStart(e){if(!e||!this.worldManager||!this.game)return;const t=this.worldManager.clampCoordinate(e.x),n=this.worldManager.clampCoordinate(e.y),a=this.worldManager.clampRoomIndex(e.roomIndex);this.game.start={x:t,y:n,roomIndex:a},e.x=t,e.y=n,e.roomIndex=a}applyObjectBehavior(e){if(!e)return e;const t=e.type,n=B.isCollectibleType(t);return e.isCollectible=n,e.hideWhenCollected=Q.shouldHideWhenCollected(t),e.hiddenInRuntime=Q.isHiddenInRuntime(t),e.isLockedDoor=Q.isLockedDoor(t),e.hideWhenOpened=Q.shouldHideWhenOpened(t),e.isVariableDoor=Q.isVariableDoor(t),e.hideWhenVariableOpen=Q.shouldHideWhenVariableOpen(t),e.requiresVariable=Q.requiresVariable(t),e.swordDurability=Q.getSwordDurability(t),e}checkOpenedMagicDoor(e,t){const n=this.types;for(const a of this.getObjects())if(t&&a.type===n.DOOR_VARIABLE&&a.variableId===e)return!0;return!1}}const q=$,Pt=q.PLAYER_END,Rt=q.DOOR_VARIABLE;class Ct extends Se{renderObjectCatalog(){const e=this.dom.objectTypes;if(!e)return;e.innerHTML="";const t=he.OBJECT_DEFINITIONS;if(!Array.isArray(t)||!t.length)return;const n=this.manager.selectedObjectType,a=this.gameEngine.getObjectsForRoom(this.state.activeRoomIndex)||[],i=new Set(a.map(r=>r.type));t.forEach(r=>{const s=document.createElement("div");s.className="object-type-card",s.dataset.type=r.type,r.type===n&&s.classList.add("selected"),i.has(r.type)&&s.classList.add("placed");const l=document.createElement("canvas");l.width=48,l.height=48,l.className="object-type-preview",this.drawObjectPreview(l,r.type);const o=document.createElement("div");o.className="object-type-meta";const c=document.createElement("div");c.className="object-type-name",c.textContent=this.getObjectLabel(r.type,t);const d=document.createElement("div");d.className="object-type-info",d.textContent=i.has(r.type)?this.t("objects.info.placed"):this.t("objects.info.available"),o.append(c,d),s.append(l,o),e.appendChild(s)})}renderObjects(){const e=this.dom.objectsList;if(!e)return;e.innerHTML="";const t=this.gameEngine.getObjectsForRoom(this.state.activeRoomIndex)||[],n=he.OBJECT_DEFINITIONS;t.forEach(a=>{const i=document.createElement("div");i.className="object-card",i.dataset.type=a.type,i.dataset.roomIndex=String(a.roomIndex);const r=document.createElement("canvas");r.className="object-preview",r.width=48,r.height=48,this.drawObjectPreview(r,a.type);const s=document.createElement("div");s.className="object-body";const l=document.createElement("div");l.className="object-header";const o=document.createElement("h4");o.className="object-name",o.textContent=this.getObjectLabel(a.type,n),l.appendChild(o);const c=document.createElement("span");if(c.className="object-position",c.textContent=`(${a.x}, ${a.y})`,l.appendChild(c),s.appendChild(l),a.type===q.SWITCH||a.type===Rt){const u=document.createElement("div");u.className="object-config";const h=document.createElement("label");h.className="object-config-label";const g=document.createElement("select");g.className="object-config-select",this.manager.npcService.populateVariableSelect(g,a.variableId||""),g.addEventListener("change",()=>{this.gameEngine.setObjectVariable(a.type,a.roomIndex,g.value),this.renderObjects(),this.service.worldRenderer.renderWorldGrid(),this.manager.updateJSON(),this.manager.history.pushCurrentState()}),h.append(`${this.t("objects.switch.variableLabel")} `,g),u.appendChild(h);const f=document.createElement("div");f.className="object-status";const v=a.type===q.SWITCH?!!a.on:!!this.gameEngine.isVariableOn(a.variableId||"");f.textContent=this.tf("objects.switch.stateLabel",{state:v?this.t("objects.state.on"):this.t("objects.state.off")}),u.appendChild(f),s.appendChild(u)}if(a.type===q.DOOR&&a.opened){const u=document.createElement("div");u.className="object-status",u.textContent=this.t("objects.status.doorOpened"),s.appendChild(u)}if(a.type===q.KEY&&a.collected){const u=document.createElement("div");u.className="object-status",u.textContent=this.t("objects.status.keyCollected"),s.appendChild(u)}if(a.type===q.LIFE_POTION&&a.collected){const u=document.createElement("div");u.className="object-status",u.textContent=this.t("objects.status.potionCollected"),s.appendChild(u)}if(a.type===q.XP_SCROLL&&a.collected){const u=document.createElement("div");u.className="object-status",u.textContent=this.t("objects.status.scrollUsed"),s.appendChild(u)}if((a.type===q.SWORD||a.type===q.SWORD_BRONZE||a.type===q.SWORD_WOOD)&&a.collected){const u=document.createElement("div");u.className="object-status",u.textContent=this.t("objects.status.swordBroken"),s.appendChild(u)}const d=a.type===Pt;if(d){const u=document.createElement("div");u.className="object-config";const h=document.createElement("label");h.className="object-config-label",h.textContent=this.t("objects.end.textLabel");const g=document.createElement("textarea");g.className="object-config-textarea",g.rows=4;const f=typeof B.PLAYER_END_TEXT_LIMIT=="number"?B.PLAYER_END_TEXT_LIMIT:40;g.maxLength=f,g.placeholder=this.t("objects.end.placeholder"),g.value=a.endingText||"",g.addEventListener("input",()=>{this.manager.objectService.updatePlayerEndText(a.roomIndex,g.value)}),h.appendChild(g),u.appendChild(h);const v=document.createElement("div");v.className="object-config-hint",v.textContent=this.tf("objects.end.hint",{max:f}),u.appendChild(v),s.appendChild(u)}if(d){const u=document.createElement("div");u.className="object-status",u.textContent=this.t("objects.status.gameEnd"),s.appendChild(u)}if(a.type!==q.PLAYER_START){const u=document.createElement("button");u.type="button",u.className="object-remove",u.dataset.type=a.type,u.dataset.roomIndex=String(a.roomIndex),u.textContent=this.t("buttons.remove"),s.appendChild(u)}else{const u=document.createElement("div");u.className="object-status",u.textContent=this.t("objects.status.startMarker"),s.appendChild(u)}i.append(r,s),e.appendChild(i)})}drawObjectPreview(e,t){if(!(e instanceof HTMLCanvasElement))return;const n=e.getContext("2d");if(!n)return;n.clearRect(0,0,e.width,e.height),n.imageSmoothingEnabled=!1,n.fillStyle="#111827",n.fillRect(0,0,e.width,e.height);const a=this.gameEngine.renderer,i=e.width/8;a.drawObjectSprite(n,t,0,0,i)}getObjectLabel(e,t){const n=t.find(a=>a.type===e);if(n?.nameKey)return this.t(n.nameKey,n.name||e);if(n?.name)return n.name;switch(e){case q.DOOR:return this.t("objects.label.door");case q.DOOR_VARIABLE:return this.t("objects.label.doorVariable");case q.PLAYER_START:return this.t("objects.label.playerStart");case q.PLAYER_END:return this.t("objects.label.playerEnd");case q.SWITCH:return this.t("objects.label.switch");case q.KEY:return this.t("objects.label.key");case q.LIFE_POTION:return this.t("objects.label.lifePotion");case q.SWORD:return this.t("objects.label.sword");case q.SWORD_BRONZE:return this.t("objects.label.swordBronze");case q.SWORD_WOOD:return this.t("objects.label.swordWood");case q.XP_SCROLL:return this.t("objects.label.xpScroll");default:return e}}}class Nt extends Se{renderTileList(){const e=this.dom.tileList;if(!e)return;const t=this.gameEngine.getTiles(),n=new Map;t.forEach(l=>{const o=l.category||"Diversos";n.has(o)||n.set(o,[]),n.get(o)?.push(l)});const a=["Terreno","Natureza","Agua","Construcoes","Interior","Decoracao","Objetos","Diversos"],i=Array.from(n.keys()).sort((l,o)=>{const c=a.indexOf(l),d=a.indexOf(o);return c===-1&&d===-1?l.localeCompare(o):c===-1?1:d===-1?-1:c-d}),r=[];i.forEach(l=>{(n.get(l)||[]).forEach(c=>r.push(c))}),e.innerHTML="";const s=document.createElement("div");s.className="tile-grid",r.forEach(l=>{const o=document.createElement("button");o.type="button",o.className="tile-card",o.dataset.tileId=String(l.id),l.id===this.manager.selectedTileId&&o.classList.add("selected");const c=document.createElement("canvas");c.width=64,c.height=64;const d=c.getContext("2d");d&&(d.imageSmoothingEnabled=!1,this.gameEngine.renderer.drawTileOnCanvas(c,l)),o.appendChild(c),s.appendChild(o)}),e.appendChild(s)}updateSelectedTilePreview(){const e=this.dom.selectedTilePreview,t=this.gameEngine.getTiles().find(n=>n.id===this.manager.selectedTileId);!e||!t||(e instanceof HTMLCanvasElement&&this.gameEngine.renderer.drawTileOnCanvas(e,t),this.dom.tileSummary&&(this.dom.tileSummary.textContent=t.name||this.tf("tiles.summaryFallback",{id:t.id})))}}class At extends Se{renderWorldGrid(){const e=this.dom.worldGrid;if(!e)return;const t=this.gameEngine.getGame(),n=t.world?.rows||1,a=t.world?.cols||1,i=t.start?.roomIndex??0;e.innerHTML="",e.style.setProperty("--world-cols",String(a));for(let r=0;r<n;r++)for(let s=0;s<a;s++){const l=r*a+s,o=document.createElement("button");o.type="button",o.className="world-cell",o.setAttribute("data-room-index",String(l)),l===this.state.activeRoomIndex&&o.classList.add("active");const c=document.createElement("span");c.className="world-cell-label",c.textContent=`${s+1},${r+1}`,o.appendChild(c);const d=document.createElement("div");if(d.className="world-cell-badges",l===i){const u=document.createElement("span");u.classList.add("world-cell-badge","badge-start"),u.textContent=this.t("world.badge.start"),d.appendChild(u),o.classList.add("start")}d.children.length&&o.appendChild(d),o.title=this.tf("world.cell.title",{col:s+1,row:r+1}),e.appendChild(o)}this.renderMapNavigation()}renderMapNavigation(){const e=Array.isArray(this.dom.mapNavButtons)?this.dom.mapNavButtons:[],t=this.gameEngine.getGame(),n=Math.max(1,Number(t.world?.rows)||1),a=Math.max(1,Number(t.world?.cols)||1),r=Math.max(1,t.rooms?.length||n*a)-1,s=Math.max(0,Math.min(r,this.state.activeRoomIndex)),l=Math.floor(s/a),o=s%a;if(this.updateMapPosition(o+1,l+1),!e.length)return;const c=(d,u)=>{const h=l+d,g=o+u;if(h<0||h>=n||g<0||g>=a)return!1;const f=h*a+g;return f>=0&&f<=r};e.forEach(d=>{const u=d.dataset.direction;let h=!1;switch(u){case"up":h=c(-1,0);break;case"down":h=c(1,0);break;case"left":h=c(0,-1);break;case"right":h=c(0,1);break;default:h=!1}d.disabled=!h})}renderGameMinimap(e=null,t=null){const n=this.dom.mapPosition;if(n){n.innerHTML="";for(let a=1;a<=3;a++)for(let i=1;i<=3;i++){const r=document.createElement("div");r.className="game-minimap-cell",r.dataset.mmRow=String(a),r.dataset.mmCol=String(i),a===t&&i===e?r.classList.add("game-minimap-cell-active"):r.classList.add("game-minimap-cell"),n.appendChild(r)}}}updateMapPosition(e,t){if(this.dom.mapPosition)try{this.renderGameMinimap(e,t)}catch{}}}class Lt{manager;canvasRenderer;tilePanelRenderer;npcRenderer;enemyRenderer;worldRenderer;objectRenderer;handleTileAnimationFrame;constructor(e){this.manager=e,this.canvasRenderer=new xt(this),this.tilePanelRenderer=new Nt(this),this.npcRenderer=new It(this),this.enemyRenderer=new wt(this),this.worldRenderer=new At(this),this.objectRenderer=new Ct(this),this.handleTileAnimationFrame=()=>{this.renderEditor(),this.updateSelectedTilePreview()},globalThis.addEventListener("tile-animation-frame",this.handleTileAnimationFrame)}get textResources(){return K}t(e,t=""){const a=this.textResources.get(e,t);return a||t||e||""}tf(e,t={},n=""){return this.textResources.format(e,t,n)}get dom(){return this.manager.domCache}get gameEngine(){return this.manager.gameEngine}get state(){return this.manager.state}get picoPalette(){return Ye}resolvePicoColor(e){const t=this.picoPalette;if(!t.length)return e||"#000000";if(Number.isInteger(e))return t[e]??t[0];if(typeof e!="string")return t[0];const n=r=>String(r||"").replace("#","").trim().toUpperCase(),a=n(e),i=t.findIndex(r=>n(r)===a);return i!==-1?t[i]:t[0]}renderEditor(){this.canvasRenderer.renderEditor(),this.worldRenderer.renderMapNavigation()}renderTileList(){this.tilePanelRenderer.renderTileList()}renderNpcs(){this.npcRenderer.renderNpcs()}updateNpcForm(){this.npcRenderer.updateNpcForm()}renderEnemies(){this.enemyRenderer.renderEnemies()}renderEnemyCatalog(){this.enemyRenderer.renderEnemyCatalog()}renderObjectCatalog(){this.objectRenderer.renderObjectCatalog()}renderObjects(){this.objectRenderer.renderObjects()}renderWorldGrid(){this.worldRenderer.renderWorldGrid()}renderMapNavigation(){this.worldRenderer.renderMapNavigation()}updateMapPosition(e,t){this.worldRenderer.updateMapPosition(e,t)}updateSelectedTilePreview(){this.tilePanelRenderer.updateSelectedTilePreview()}renderVariableUsage(){const e=this.dom.projectVariableList;if(!e)return;const t=this.dom.projectVariablesContainer,n=this.dom.projectVariablesToggle;e.innerHTML="";const a=this.gameEngine.getVariableDefinitions(),i=this.collectVariableUsage(),r=a.reduce((o,c)=>o+(i.has(c.id)?1:0),0),s=this.tf("project.variables.usage",{used:r,total:a.length},`${r}/${a.length}`),l=!!this.state.variablePanelCollapsed;if(n){const o=l?this.t("project.variables.toggle.show","Mostrar variÃ¡veis"):this.t("project.variables.toggle.hide","Esconder variÃ¡veis");n.textContent=`${s} Â· ${o}`}if(t&&t.classList.toggle("is-collapsed",l),!a.length){const o=document.createElement("div");o.className="project-variable-item";const c=document.createElement("span");c.className="project-variable-name",c.textContent=this.t("variables.none","Nenhuma"),o.appendChild(c),e.appendChild(o);return}a.forEach(o=>{const c=document.createElement("div");c.className="project-variable-item";const d=document.createElement("span");d.className="project-variable-color",d.style.background=String(this.resolvePicoColor(o.color??null));const u=document.createElement("span");u.className="project-variable-name",u.textContent=o.name||o.id;const h=document.createElement("span"),g=i.has(o.id);h.className=`project-variable-badge ${g?"in-use":"unused"}`,h.textContent=g?this.t("project.variables.used","Em uso"):this.t("project.variables.unused","Sem uso"),c.append(d,u,h),e.appendChild(c)})}renderSkillList(){const e=this.dom.projectSkillsList;if(!e)return;const t=this.dom.projectSkillsContainer,n=this.dom.projectSkillsToggle;e.innerHTML="";const a=de.getAll(),i=this.buildSkillLevelMap(),r=this.groupSkillsByLevel(a,i),s=!!this.state.skillPanelCollapsed;if(n){const l=s?this.t("project.skills.toggle.show","Mostrar skills"):this.t("project.skills.toggle.hide","Esconder skills"),o=this.t("project.skills.title","Skills do jogo");n.textContent=`${o} Â· ${l}`}if(t&&t.classList.toggle("is-collapsed",s),!s){if(!a.length){const l=document.createElement("div");l.className="project-skill-item";const o=document.createElement("span");o.className="project-skill-name",o.textContent=this.t("variables.none","Nenhuma"),l.appendChild(o),e.appendChild(l);return}r.forEach(({level:l,items:o})=>{const c=document.createElement("div");c.className="project-skill-group";const d=document.createElement("div");d.className="project-skill-group-title";const u=Number.isFinite(l)?this.tf("project.skills.level",{value:l},`NÃ­vel ${l}`):this.t("project.skills.level","NÃ­vel -");d.textContent=u,c.appendChild(d),o.forEach(h=>{const g=document.createElement("div");g.className="project-skill-item";const f=document.createElement("span");f.className="project-skill-icon",f.textContent=h.icon||"âœ¨";const v=document.createElement("div");v.className="project-skill-name";const S=h.nameKey?this.t(h.nameKey,h.name||h.id||""):h.name||h.id||"";v.textContent=S||h.id||"";const M=document.createElement("div");M.className="project-skill-desc";const x=h.descriptionKey?this.t(h.descriptionKey,h.description||""):h.description||"";M.textContent=x,g.append(f,v,M),c.appendChild(g)}),e.appendChild(c)})}}collectVariableUsage(){const e=new Set,t=this.gameEngine.getGame(),n=this.gameEngine.getVariableDefinitions(),a=new Set(n.map(o=>o.id)),i=o=>{if(typeof o!="string")return;const c=o.trim();c&&a.has(c)&&e.add(c)};return(Array.isArray(t.sprites)?t.sprites:[]).forEach(o=>{[o.conditionVariableId,o.conditionalVariableId,o.rewardVariableId,o.activateVariableId,o.onCompleteVariableId,o.conditionalRewardVariableId,o.alternativeRewardVariableId].forEach(i)}),(Array.isArray(t.enemies)?t.enemies:[]).forEach(o=>i(o.defeatVariableId)),(Array.isArray(t.objects)?t.objects:[]).forEach(o=>i(o.variableId)),e}buildSkillLevelMap(){const e=new Map,t=de.LEVEL_SKILLS;return Object.entries(t).forEach(([n,a])=>{const i=Number(n);Number.isFinite(i)&&(Array.isArray(a)?a:[]).forEach(r=>{if(typeof r!="string")return;const s=e.get(r);(s===void 0||i<s)&&e.set(r,i)})}),e}groupSkillsByLevel(e,t){const n=new Map;return e.forEach(i=>{const r=t.get(i.id)??null,s=Number.isFinite(r)?r:"other";n.has(s)||n.set(s,[]);const l=n.get(s);l&&l.push(i)}),Array.from(n.keys()).sort((i,r)=>(typeof i=="number"?i:1/0)-(typeof r=="number"?r:1/0)).map(i=>({level:Number.isFinite(i)?i:null,items:n.get(i)||[]}))}renderTestTools(){const e=this.dom.projectTestContainer,t=this.dom.projectTestToggle,n=this.dom.projectTestPanel,a=this.dom.projectTestStartLevel,i=this.dom.projectTestSkillList,r=this.dom.projectTestGodMode;if(!e||!t||!n)return;const s=!!this.state.testPanelCollapsed,l=this.t("project.test.title","Ajuda nos testes"),o=s?this.t("project.test.toggle.show","Mostrar"):this.t("project.test.toggle.hide","Esconder");t.textContent=`${l} Â· ${o}`,e.classList.toggle("is-collapsed",s);const c=this.gameEngine.getTestSettings(),d=this.gameEngine.getMaxPlayerLevel(),u=e.querySelector(".project-test__hint");if(u&&(u.textContent=this.t("project.test.hint","Apenas para testar: estas opÃ§Ãµes nÃ£o vÃ£o para a URL.")),a){a.innerHTML="";for(let h=1;h<=d;h++){const g=document.createElement("option");g.value=String(h),g.textContent=this.tf("project.test.levelOption",{value:h},`NÃ­vel ${h}`),h===c.startLevel&&(g.selected=!0),a.appendChild(g)}}if(r&&(r.checked=!!c.godMode),i){i.innerHTML="";const h=de.getAll(),g=new Set(Array.isArray(c.skills)?c.skills:[]);if(!h.length){const f=document.createElement("div");f.className="project-test__skill",f.textContent=this.t("variables.none","Nenhuma"),i.appendChild(f);return}h.forEach(f=>{const v=document.createElement("label");v.className="project-test__skill";const S=document.createElement("input");S.type="checkbox",S.dataset.skillId=f.id,S.checked=g.has(f.id);const M=document.createElement("div");M.className="project-test__skill-label";const x=document.createElement("span");x.className="project-test__skill-icon",x.textContent=f.icon||"âœ¨";const T=document.createElement("span");T.textContent=f.nameKey?this.t(f.nameKey,f.name||f.id||""):f.name||f.id||"",M.append(x,T),v.append(S,M),i.appendChild(v)})}}}const we=globalThis;class _e{config;collection;app;db;mode;firestoreHelpers;constructor(e=null,t={}){this.config=e||null,this.collection=t.collection||"shareUrls",this.app=null,this.db=null,this.mode=null,this.firestoreHelpers=null,this.init()}static fromGlobal(){const e=we.TinyRPGFirebaseConfig??null,t=we.TinyRPGFirebaseCollection??null;return new _e(e,{collection:t})}get firebase(){return we.firebase??null}init(){return this.initFromModule()?!0:this.config?this.initFromCompat():!1}initFromModule(){const e=we.TinyRPGFirebaseDb??null,t=we.TinyRPGFirebaseFirestore;return!e||!t||!t.addDoc||!t.collection?!1:(this.db=e,this.firestoreHelpers=t,this.mode="modular",console.info("[TinyRPG] Firebase tracker initialized (modular)."),!0)}initFromCompat(){const e=this.firebase;if(!e||!e.initializeApp)return console.warn("[TinyRPG] Firebase SDK not available."),!1;let t=null;try{if(e.apps&&e.apps.length){const i=e.app;t=i?i():null}else{const i=e.initializeApp;t=i(this.config)}}catch(i){return console.warn("[TinyRPG] Firebase init failed.",i),!1}this.app=t;const n=e.firestore;if(!n)return console.warn("[TinyRPG] Firebase Firestore not available."),!1;const a=n();return this.db=a,this.mode="compat",console.info("[TinyRPG] Firebase tracker initialized (compat)."),!0}buildPayload(e,t={}){const n=this.mode==="modular"?this.firestoreHelpers?.serverTimestamp:this.firebase?.FieldValue?.serverTimestamp;return{url:e,createdAt:n?n():new Date().toISOString(),userAgent:typeof navigator<"u"?navigator.userAgent:"",language:typeof navigator<"u"?navigator.language:"",referrer:typeof document<"u"?document.referrer:"",...t}}async trackShareUrl(e,t={}){if(!e||(this.db||this.init(),!this.db))return!1;try{const n=this.buildPayload(e,t);if(this.mode==="modular"){const{addDoc:a,collection:i}=this.firestoreHelpers??{};if(a&&i){const r=i(this.db,this.collection);await a(r,n)}}else typeof this.db.collection=="function"&&await this.db.collection(this.collection).add(n);return console.info("[TinyRPG] Share URL tracked.",{url:e,collection:this.collection}),!0}catch(n){return console.warn("[TinyRPG] Failed to track share URL.",n),!1}}}class Ot{_canvas;_world;_player;_enemy;_animation;_effects;_transitions;_timing;_input;_hud;_tiles;_palette;constructor(e){this._canvas=this.validateCanvas(e.canvas),this._world=this.validateWorld(e.world),this._player=this.validatePlayer(e.player),this._enemy=this.validateEnemy(e.enemy),this._animation=this.validateAnimation(e.animation),this._effects=this.validateEffects(e.effects),this._transitions=this.validateTransitions(e.transitions),this._timing=this.validateTiming(e.timing),this._input=this.validateInput(e.input),this._hud=this.validateHud(e.hud),this._tiles=this.validateTiles(e.tiles),this._palette=this.validatePalette(e.palette)}get canvas(){return{...this._canvas}}get world(){return{...this._world}}get player(){return{...this._player}}get enemy(){return{movementInterval:this._enemy.movementInterval,fallbackMissChance:this._enemy.fallbackMissChance,stealthMissChance:this._enemy.stealthMissChance,vision:{...this._enemy.vision}}}get animation(){return{...this._animation}}get effects(){return{...this._effects}}get transitions(){return{...this._transitions}}get timing(){return{...this._timing}}get input(){return{...this._input}}get hud(){return{...this._hud}}get tiles(){return{...this._tiles}}get palette(){return{colors:[...this._palette.colors]}}validateCanvas(e){return this.assertPositiveInteger(e.width,"canvas width"),this.assertPositiveInteger(e.height,"canvas height"),this.assertPositiveInteger(e.minTileSize,"min tile size"),this.assertPositiveInteger(e.minHudHeight,"min HUD height"),this.assertPositiveNumber(e.hudHeightMultiplier,"HUD height multiplier"),this.assertPositiveInteger(e.minInventoryHeight,"min inventory height"),this.assertPositiveNumber(e.inventoryHeightMultiplier,"inventory height multiplier"),Object.freeze({...e})}validateWorld(e){return this.assertPositiveInteger(e.rows,"world rows"),this.assertPositiveInteger(e.cols,"world cols"),this.assertPositiveInteger(e.roomSize,"room size"),this.assertPositiveInteger(e.matrixSize,"matrix size"),Object.freeze({...e})}validatePlayer(e){if(this.assertNonNegativeInteger(e.startX,"start X"),this.assertNonNegativeInteger(e.startY,"start Y"),this.assertNonNegativeInteger(e.startRoomIndex,"start room index"),this.assertPositiveInteger(e.startLevel,"start level"),this.assertPositiveInteger(e.maxLevel,"max level"),this.assertPositiveInteger(e.baseMaxLives,"base max lives"),this.assertPositiveInteger(e.startLives,"start lives"),this.assertPositiveNumber(e.experienceBase,"experience base"),this.assertPositiveNumber(e.experienceGrowth,"experience growth"),this.assertNonNegativeInteger(e.maxKeys,"max keys"),this.assertNonNegativeInteger(e.roomChangeDamageCooldown,"room change damage cooldown"),e.startLevel>e.maxLevel)throw new Error(`Start level (${e.startLevel}) cannot exceed max level (${e.maxLevel})`);if(e.startLives>e.baseMaxLives)throw new Error(`Start lives (${e.startLives}) cannot exceed base max lives (${e.baseMaxLives})`);return Object.freeze({...e})}validateEnemy(e){return this.assertPositiveInteger(e.movementInterval,"enemy movement interval"),this.assertProbability(e.fallbackMissChance,"fallback miss chance"),this.assertProbability(e.stealthMissChance,"stealth miss chance"),this.assertNonNegativeInteger(e.vision.range,"enemy vision range"),this.assertPositiveInteger(e.vision.alertDuration,"enemy vision alert duration"),Object.freeze({movementInterval:e.movementInterval,fallbackMissChance:e.fallbackMissChance,stealthMissChance:e.stealthMissChance,vision:Object.freeze({...e.vision})})}validateAnimation(e){if(this.assertPositiveInteger(e.tileInterval,"tile interval"),this.assertPositiveInteger(e.minInterval,"min animation interval"),this.assertPositiveInteger(e.iconOverPlayerDuration,"icon over player duration"),this.assertPositiveInteger(e.overlayFPS,"overlay FPS"),this.assertPositiveInteger(e.blinkInterval,"blink interval"),this.assertProbability(e.blinkMinOpacity,"blink min opacity"),this.assertProbability(e.blinkMaxOpacity,"blink max opacity"),e.blinkMinOpacity>e.blinkMaxOpacity)throw new Error(`Blink min opacity (${e.blinkMinOpacity}) cannot exceed max opacity (${e.blinkMaxOpacity})`);return Object.freeze({...e})}validateEffects(e){return this.assertPositiveInteger(e.combatIndicatorDuration,"combat indicator duration"),this.assertPositiveInteger(e.screenFlashMinDuration,"screen flash min duration"),this.assertPositiveInteger(e.screenFlashDuration,"screen flash duration"),this.assertPositiveInteger(e.edgeFlashMinDuration,"edge flash min duration"),this.assertPositiveInteger(e.edgeFlashDuration,"edge flash duration"),Object.freeze({...e})}validateTransitions(e){return this.assertPositiveInteger(e.roomMinDuration,"room min duration"),this.assertPositiveInteger(e.roomDuration,"room duration"),this.assertPositiveInteger(e.blockedMovementDuration,"blocked movement duration"),Object.freeze({...e})}validateTiming(e){if(this.assertPositiveInteger(e.resetAfterIntro,"reset after intro"),this.assertPositiveInteger(e.resetAfterGameOver,"reset after game over"),this.assertPositiveInteger(e.levelUpCelebration,"level up celebration"),this.assertPositiveInteger(e.celebrationMinDuration,"celebration min duration"),this.assertPositiveInteger(e.celebrationMaxDuration,"celebration max duration"),e.celebrationMinDuration>e.celebrationMaxDuration)throw new Error(`Celebration min duration (${e.celebrationMinDuration}) cannot exceed max duration (${e.celebrationMaxDuration})`);return Object.freeze({...e})}validateInput(e){return this.assertPositiveInteger(e.maxDuration,"input max duration"),Object.freeze({...e})}validateHud(e){if(this.assertNonNegativeInteger(e.padding,"HUD padding"),this.assertNonNegativeInteger(e.gap,"HUD gap"),typeof e.backgroundColor!="string"||!this.isValidColor(e.backgroundColor))throw new Error(`Invalid HUD background color: ${e.backgroundColor}`);return Object.freeze({...e})}validateTiles(e){return this.assertPositiveInteger(e.legacyMax,"legacy max tile value"),this.assertPositiveInteger(e.valueMax,"max tile value"),Object.freeze({...e})}validatePalette(e){if(!Array.isArray(e.colors)||e.colors.length===0)throw new Error("Palette colors must be a non-empty array");e.colors.forEach((a,i)=>{if(typeof a!="string"||!this.isValidColor(a))throw new Error(`Invalid color at palette index ${i}: ${a}`)});const t=e.colors.slice(),n=Object.freeze(t);return Object.freeze({colors:n})}assertPositiveInteger(e,t){if(!Number.isInteger(e)||e<=0)throw new Error(`Invalid ${t}: ${e}. Must be a positive integer.`)}assertNonNegativeInteger(e,t){if(!Number.isInteger(e)||e<0)throw new Error(`Invalid ${t}: ${e}. Must be a non-negative integer.`)}assertPositiveNumber(e,t){if(typeof e!="number"||e<=0||!isFinite(e))throw new Error(`Invalid ${t}: ${e}. Must be a positive number.`)}assertProbability(e,t){if(typeof e!="number"||e<0||e>1||!isFinite(e))throw new Error(`Invalid ${t}: ${e}. Must be a number between 0 and 1.`)}isValidColor(e){return/^#[0-9A-Fa-f]{3}([0-9A-Fa-f]{3})?$/.test(e)||/^[a-z]+$/i.test(e)}toJSON(){return{canvas:this.canvas,world:this.world,player:this.player,enemy:this.enemy,animation:this.animation,effects:this.effects,transitions:this.transitions,timing:this.timing,input:this.input,hud:this.hud,tiles:this.tiles,palette:this.palette}}}const E=new Ot({canvas:{width:128,height:152,minTileSize:8,minHudHeight:28,hudHeightMultiplier:1.75,minInventoryHeight:40,inventoryHeightMultiplier:2},world:{rows:3,cols:3,roomSize:8,matrixSize:8},player:{startX:1,startY:1,startRoomIndex:0,startLevel:1,maxLevel:10,baseMaxLives:3,startLives:3,experienceBase:6,experienceGrowth:1.35,maxKeys:9,roomChangeDamageCooldown:1e3},enemy:{movementInterval:600,fallbackMissChance:.25,stealthMissChance:.25,vision:{range:2,alertDuration:1e3}},animation:{tileInterval:320,minInterval:60,iconOverPlayerDuration:2e3,overlayFPS:30,blinkInterval:500,blinkMinOpacity:.3,blinkMaxOpacity:.95},effects:{combatIndicatorDuration:600,screenFlashMinDuration:16,screenFlashDuration:140,edgeFlashMinDuration:32,edgeFlashDuration:220},transitions:{roomMinDuration:120,roomDuration:320,blockedMovementDuration:240},timing:{resetAfterIntro:2e3,resetAfterGameOver:2e3,levelUpCelebration:3e3,celebrationMinDuration:300,celebrationMaxDuration:3e3},input:{maxDuration:600},hud:{padding:4,gap:6,backgroundColor:"#000000"},tiles:{legacyMax:15,valueMax:255},palette:{colors:["#000000","#1D2B53","#7E2553","#008751","#AB5236","#5F574F","#C2C3C7","#FFF1E8","#FF004D","#FFA300","#FFFF27","#00E756","#29ADFF","#83769C","#FF77A8","#FFCCAA"]}});class p{static _supportedVersions;static _npcDefinitions=[];static _enemyDefinitions=[];static get VERSION_1(){return 1}static get VERSION_2(){return 2}static get VERSION_3(){return 3}static get VERSION_4(){return 4}static get VERSION_5(){return 5}static get VERSION_6(){return 6}static get VERSION_7(){return 7}static get VERSION_8(){return 8}static get VERSION_9(){return 9}static get VERSION_10(){return 10}static get VERSION_11(){return 11}static get VERSION_12(){return 12}static get VERSION_13(){return 13}static get VERSION_14(){return 14}static get VERSION_15(){return 15}static get VERSION_16(){return 16}static get VERSION_17(){return 17}static get VERSION_18(){return 18}static get VERSION_19(){return 19}static get VERSION(){return p.VERSION_19}static get LEGACY_VERSION(){return p.VERSION_1}static get OBJECTS_VERSION(){return p.VERSION_4}static get VARIABLES_VERSION(){return p.VERSION_5}static get WORLD_MULTIMAP_VERSION(){return p.VERSION_6}static get NPC_VARIABLE_TEXT_VERSION(){return p.VERSION_6}static get MAGIC_DOOR_VERSION(){return p.VERSION_7}static get NPC_CONDITIONAL_REWARD_VERSION(){return p.VERSION_8}static get ENEMY_TYPE_VERSION(){return p.VERSION_9}static get ENEMY_VARIABLE_VERSION(){return p.VERSION_10}static get LIFE_POTION_VERSION(){return p.VERSION_11}static get XP_SCROLL_VERSION(){return p.VERSION_12}static get SWORD_VERSION(){return p.VERSION_13}static get PLAYER_END_VERSION(){return p.VERSION_14}static get SWITCH_VERSION(){return p.VERSION_15}static get TILE_EXTENDED_VERSION(){return p.VERSION_16}static get PLAYER_END_TEXT_VERSION(){return p.VERSION_17}static get PLAYER_END_TEXT_ARRAY_VERSION(){return p.VERSION_18}static get TIERED_SWORD_VERSION(){return p.VERSION_19}static get MATRIX_SIZE(){return E.world.matrixSize}static get TILE_COUNT(){return p.MATRIX_SIZE*p.MATRIX_SIZE}static get WORLD_ROWS(){return E.world.rows}static get WORLD_COLS(){return E.world.cols}static get WORLD_ROOM_COUNT(){return p.WORLD_ROWS*p.WORLD_COLS}static get MAX_ROOM_INDEX(){return p.WORLD_ROOM_COUNT-1}static get NULL_CHAR(){return"z"}static get TILE_LEGACY_MAX(){return E.tiles.legacyMax}static get TILE_VALUE_MAX(){return E.tiles.valueMax}static get GROUND_SPARSE_PREFIX(){return"x"}static get OVERLAY_BINARY_PREFIX(){return"y"}static get POSITION_WIDE_PREFIX(){return"~"}static get DEFAULT_TITLE(){return"My Tiny RPG Game"}static get DEFAULT_PALETTE(){return[...E.palette.colors]}static get VARIABLE_IDS(){return["var-1","var-2","var-3","var-4","var-5","var-6","var-7","var-8","var-9","skill:bard"]}static get VARIABLE_NAMES(){return["1 - Preto","2 - Azul Escuro","3 - Roxo","4 - Verde","5 - Marrom","6 - Cinza","7 - Azul Claro","8 - Rosa Choque","9 - Amarelo","Habilidade: Bardo"]}static get VARIABLE_COLORS(){return["#000000","#1D2B53","#7E2553","#008751","#AB5236","#5F574F","#29ADFF","#FF77A8","#FFCCAA","#FFD700"]}static get SUPPORTED_VERSIONS(){return this._supportedVersions||(this._supportedVersions=new Set([p.VERSION_1,p.VERSION_2,p.VERSION_3,p.VERSION_4,p.VERSION_5,p.VERSION_6,p.VERSION_7,p.VERSION_8,p.VERSION_9,p.VERSION_10,p.VERSION_11,p.VERSION_12,p.VERSION_13,p.VERSION_14,p.VERSION_15,p.VERSION_16,p.VERSION_17,p.VERSION_18,p.VERSION_19])),this._supportedVersions}static get NPC_DEFINITIONS(){return this._npcDefinitions.length||(this._npcDefinitions=Ee.definitions),this._npcDefinitions}static get ENEMY_DEFINITIONS(){return this._enemyDefinitions.length||(this._enemyDefinitions=te.definitions),this._enemyDefinitions}}class D{static clamp(e,t,n,a){return Number.isFinite(e)?Math.max(t,Math.min(n,e)):a}static clampRoomIndex(e){return D.clamp(Number(e),0,p.MAX_ROOM_INDEX,0)}}class U{static toBase64Url(e){if(!e||!e.length)return"";if(typeof Buffer<"u")return Buffer.from(e).toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"");let t="";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}static fromBase64Url(e){if(!e)return new Uint8Array(0);const t=String(e).replace(/[\s\r\n]+/g,"");if(!t)return new Uint8Array(0);if(/[^0-9a-zA-Z\-_]/.test(t))return U.logInvalidInput(t),new Uint8Array(0);const n=t.replace(/-/g,"+").replace(/_/g,"/"),a=(4-n.length%4)%4,i=n+"=".repeat(a);try{if(typeof Buffer<"u")return Uint8Array.from(Buffer.from(i,"base64"));const r=atob(i),s=new Uint8Array(r.length);for(let l=0;l<r.length;l++)s[l]=r.charCodeAt(l);return s}catch(r){return U.logInvalidInput(t,r),new Uint8Array(0)}}static logInvalidInput(e,t){console.warn("[TinyRPG] Invalid base64 segment ignored.",{input:e,error:t})}}class O{static encodeVariables(e){if(!Array.isArray(e)||!e.length)return"";const t=p.VARIABLE_IDS,n=new Map;e.forEach(s=>{typeof s.id=="string"&&n.set(s.id,!!s.value)});const a=Math.ceil(t.length/8),i=new Uint8Array(a);return t.forEach((s,l)=>{if(!n.get(s))return;const o=l>>3,c=l&7;i[o]|=1<<c}),i.some(s=>s!==0)?U.toBase64Url(i):""}static decodeVariables(e){const t=p.VARIABLE_IDS,n=new Array(t.length).fill(!1);if(!e)return n;const a=U.fromBase64Url(e);return t.forEach((i,r)=>{const s=r>>3,l=r&7,o=a[s]??0;n[r]=!!(o&1<<l)}),n}static variableIdToNibble(e){if(typeof e!="string")return 0;const t=p.VARIABLE_IDS.indexOf(e);return t>=0?t+1:0}static nibbleToVariableId(e){if(!Number.isFinite(e)||e<=0)return null;const t=e-1;return p.VARIABLE_IDS[t]||null}static encodeVariableNibbleArray(e){return!Array.isArray(e)||!e.length||!e.some(n=>typeof n=="number"&&Number.isFinite(n)&&n>0)?"":U.toBase64Url(O.packNibbles(e.map(n=>Number(n)&15)))}static decodeVariableNibbleArray(e,t){const n=Number.isFinite(t)&&t>0?t:0;if(!e||!n)return new Array(n).fill(0);const a=U.fromBase64Url(e);return O.unpackNibbles(a,n).map(r=>Number.isFinite(r)?r:0)}static buildVariableEntries(e){const t=p.VARIABLE_IDS,n=p.VARIABLE_NAMES,a=p.VARIABLE_COLORS,i=Array.isArray(e)&&e.length===t.length?e:new Array(t.length).fill(!1);return t.map((r,s)=>({id:r,order:s+1,name:n[s]||r,color:a[s]||"#000000",value:!!i[s]}))}static packNibbles(e){const t=Math.ceil(e.length/2),n=new Uint8Array(t);for(let a=0;a<e.length;a+=2){const i=e[a]&15,s=(typeof e[a+1]=="number"?e[a+1]:0)&15,l=a>>1;n[l]=i<<4|s}return n}static unpackNibbles(e,t){const n=new Array(t);for(let a=0;a<t;a++){const i=e[a>>1]||0;n[a]=a%2===0?i>>4&15:i&15}return n}static getFirstVariableId(){const e=p.VARIABLE_IDS;return e.length?e[0]:null}}class R{static get Types(){return $}static normalizeStart(e){return{x:D.clamp(Number(e?.x),0,p.MATRIX_SIZE-1,1),y:D.clamp(Number(e?.y),0,p.MATRIX_SIZE-1,1),roomIndex:D.clampRoomIndex(e?.roomIndex)}}static resolveNpcType(e){if(typeof e?.type=="string")return e.type;const t=p.NPC_DEFINITIONS;if(typeof e?.id=="string"){const n=t.find(a=>a.id===e.id);if(n)return n.type}if(typeof e?.name=="string"){const n=t.find(a=>a.name===e.name);if(n)return n.type}return null}static normalizeSprites(e){if(!Array.isArray(e))return[];const t=new Set,n=[],a=p.NPC_DEFINITIONS;for(const i of e){const r=i,s=R.resolveNpcType(r);if(!s||t.has(s))continue;const l=a.find(M=>M.type===s);if(!l||!(r.placed!==!1))continue;const c=D.clamp(Number(r.x),0,p.MATRIX_SIZE-1,0),d=D.clamp(Number(r.y),0,p.MATRIX_SIZE-1,0);if(!Number.isFinite(c)||!Number.isFinite(d))continue;const u=typeof r.conditionVariableId=="string"?r.conditionVariableId:typeof r.conditionalVariableId=="string"?r.conditionalVariableId:null,h=typeof r.rewardVariableId=="string"?r.rewardVariableId:typeof r.activateVariableId=="string"?r.activateVariableId:null,g=typeof r.conditionalRewardVariableId=="string"?r.conditionalRewardVariableId:typeof r.alternativeRewardVariableId=="string"?r.alternativeRewardVariableId:null,f=typeof u=="string"&&p.VARIABLE_IDS.includes(u),v=typeof h=="string"&&p.VARIABLE_IDS.includes(h),S=typeof g=="string"&&p.VARIABLE_IDS.includes(g);n.push({type:s,id:l.id,name:l.name,x:c,y:d,roomIndex:D.clampRoomIndex(r.roomIndex),text:typeof r.text=="string"?r.text:l.defaultText||"",textKey:typeof r.textKey=="string"&&r.textKey.length?r.textKey:l.defaultTextKey||null,conditionVariableId:f?u:null,conditionText:typeof r.conditionText=="string"?r.conditionText:typeof r.conditionalText=="string"?r.conditionalText:"",rewardVariableId:v?h:null,conditionalRewardVariableId:S?g:null}),t.add(s)}return n}static normalizeEnemies(e){if(!Array.isArray(e))return[];const t=p.ENEMY_DEFINITIONS,n=new Map;return e.map((a,i)=>{const r=a,s=R.normalizeEnemyType(r.type),l=Array.isArray(t)&&t.length?t.findIndex(c=>c.type===s):-1,o=R.normalizeEnemyVariable(r.defeatVariableId);return{x:D.clamp(Number(r.x),0,p.MATRIX_SIZE-1,0),y:D.clamp(Number(r.y),0,p.MATRIX_SIZE-1,0),roomIndex:D.clampRoomIndex(r.roomIndex),type:s,id:r.id||`enemy-${i+1}`,typeIndex:l,defeatVariableId:o,variableNibble:O.variableIdToNibble(o)}}).filter(a=>{if(!Number.isFinite(a.x)||!Number.isFinite(a.y))return!1;const i=n.get(a.roomIndex)||0;return i>=9?!1:(n.set(a.roomIndex,i+1),!0)})}static normalizeObjectPositions(e,t){if(!Array.isArray(e))return[];const n=new Set,a=[];for(const i of e){const r=i;if(r.type!==t)continue;const s=D.clamp(Number(r.x),0,p.MATRIX_SIZE-1,0),l=D.clamp(Number(r.y),0,p.MATRIX_SIZE-1,0);if(!Number.isFinite(s)||!Number.isFinite(l))continue;const o=D.clampRoomIndex(r.roomIndex);n.has(o)||(n.add(o),a.push({x:s,y:l,roomIndex:o}))}return a.sort((i,r)=>i.roomIndex!==r.roomIndex?i.roomIndex-r.roomIndex:i.y!==r.y?i.y-r.y:i.x-r.x)}static normalizeVariableDoorObjects(e){if(!Array.isArray(e))return[];const t=new Set,n=O.variableIdToNibble(O.getFirstVariableId())||1,a=[];for(const i of e){const r=i;if(r.type!==R.Types.DOOR_VARIABLE)continue;const s=D.clamp(Number(r.x),0,p.MATRIX_SIZE-1,0),l=D.clamp(Number(r.y),0,p.MATRIX_SIZE-1,0);if(!Number.isFinite(s)||!Number.isFinite(l))continue;const o=D.clampRoomIndex(r.roomIndex);if(t.has(o))continue;t.add(o);const c=O.variableIdToNibble(typeof r.variableId=="string"?r.variableId:null)||n;a.push({x:s,y:l,roomIndex:o,variableNibble:c})}return a.sort((i,r)=>i.roomIndex!==r.roomIndex?i.roomIndex-r.roomIndex:i.y!==r.y?i.y-r.y:i.x-r.x)}static normalizeSwitchObjects(e){if(!Array.isArray(e))return[];const t=new Set,n=O.variableIdToNibble(O.getFirstVariableId())||1,a=[];for(const i of e){const r=i;if(r.type!==R.Types.SWITCH)continue;const s=D.clamp(Number(r.x),0,p.MATRIX_SIZE-1,0),l=D.clamp(Number(r.y),0,p.MATRIX_SIZE-1,0);if(!Number.isFinite(s)||!Number.isFinite(l))continue;const o=D.clampRoomIndex(r.roomIndex);if(t.has(o))continue;t.add(o);const c=O.variableIdToNibble(typeof r.variableId=="string"?r.variableId:null)||n,d=r.on?1:0;a.push({x:s,y:l,roomIndex:o,variableNibble:c,stateNibble:d})}return a.sort((i,r)=>i.roomIndex!==r.roomIndex?i.roomIndex-r.roomIndex:i.y!==r.y?i.y-r.y:i.x-r.x)}static buildObjectEntries(e,t,n={}){if(!Array.isArray(e)||!e.length)return[];const a=Array.isArray(n.variableNibbles)?n.variableNibbles:[],i=Array.isArray(n.endingTexts)?n.endingTexts:[],r=O.getFirstVariableId();return e.map((s,l)=>{const o=s,c=D.clampRoomIndex(o.roomIndex),d=D.clamp(Number(o.x),0,p.MATRIX_SIZE-1,0),u=D.clamp(Number(o.y),0,p.MATRIX_SIZE-1,0),h={id:`${t}-${c}`,type:t,roomIndex:c,x:d,y:u};if(t===R.Types.KEY&&(h.collected=!1),t===R.Types.LIFE_POTION&&(h.collected=!1),t===R.Types.XP_SCROLL&&(h.collected=!1),(t===R.Types.SWORD||t===R.Types.SWORD_BRONZE||t===R.Types.SWORD_WOOD)&&(h.collected=!1),t===R.Types.DOOR&&(h.opened=!1),t===R.Types.DOOR_VARIABLE){const g=a[l]??O.variableIdToNibble(r),f=O.nibbleToVariableId(g)||r;f&&(h.variableId=f)}if(t===R.Types.SWITCH){const g=a[l]??O.variableIdToNibble(r),f=O.nibbleToVariableId(g)||r;f&&(h.variableId=f);const v=Array.isArray(n.stateBits)?n.stateBits[l]:null;h.on=!!v}if(t===R.Types.PLAYER_END){const g=R.normalizeEndingTextValue(i[l]??"");g&&(h.endingText=g)}return h})}static getPlayerEndTextLimit(){return typeof B.PLAYER_END_TEXT_LIMIT=="number"?B.PLAYER_END_TEXT_LIMIT:40}static normalizeEndingTextValue(e){if(typeof e!="string")return"";const t=e.replace(/\r\n/g,`
`),n=R.getPlayerEndTextLimit();return t.slice(0,n).trim()}static collectPlayerEndTexts(e){if(!Array.isArray(e))return[];const t=[],n=new Set;for(const a of e){const i=a;if(i.type!==R.Types.PLAYER_END)continue;const r=D.clampRoomIndex(i.roomIndex);if(n.has(r))continue;n.add(r);const s=D.clamp(Number(i.x),0,p.MATRIX_SIZE-1,0),l=D.clamp(Number(i.y),0,p.MATRIX_SIZE-1,0);!Number.isFinite(s)||!Number.isFinite(l)||t.push({roomIndex:r,x:s,y:l,text:R.normalizeEndingTextValue(i.endingText)})}return t.sort((a,i)=>a.roomIndex!==i.roomIndex?a.roomIndex-i.roomIndex:a.y!==i.y?a.y-i.y:a.x-i.x),t.map(a=>a.text)}static normalizeEnemyType(e){return te.normalizeType(e)}static normalizeEnemyVariable(e){return typeof e!="string"?null:p.VARIABLE_IDS.includes(e)?e:null}}class V{static _tileMaskLengthCache=null;static normalizeGround(e){const t=p.MATRIX_SIZE,n=[],a=p.TILE_VALUE_MAX;for(let i=0;i<t;i++){const r=[];for(let s=0;s<t;s++){const l=V.coerceTileValue(e?.[i]?.[s],0);r.push(D.clamp(l,0,a,0))}n.push(r)}return n}static normalizeOverlay(e){const t=p.MATRIX_SIZE,n=[],a=p.TILE_VALUE_MAX;for(let i=0;i<t;i++){const r=[];for(let s=0;s<t;s++){const l=e?.[i]?.[s];if(l==null)r.push(null);else{const o=V.coerceTileValue(l,0);r.push(D.clamp(o,0,a,0))}}n.push(r)}return n}static collectGroundMatrices(e,t){const n=Array.isArray(e?.tileset?.maps)?e.tileset.maps:[],a=e?.tileset?.map?.ground??null,i=[];for(let r=0;r<t;r++){const s=n[r]?.ground??(r===0?a:null);i.push(s??[])}return i}static collectOverlayMatrices(e,t){const n=Array.isArray(e?.tileset?.maps)?e.tileset.maps:[],a=e?.tileset?.map?.overlay??null,i=[];for(let r=0;r<t;r++){const s=n[r]?.overlay??(r===0?a:null);i.push(s??[])}return i}static encodeGround(e){const t=V.normalizeGround(e),n=[],a=[],i=p.TILE_COUNT,r=new Uint8Array(Math.ceil(i/8));let s=!1,l=0;const o=p.MATRIX_SIZE,c=V.shouldUseExtendedTileEncoding(t);for(let f=0;f<o;f++)for(let v=0;v<o;v++){const S=t[f][v]&255;if(!s&&S!==0&&(s=!0),S!==0){const M=l>>3,x=l&7;r[M]|=1<<x,a.push(S)}n.push(S),l++}if(!s)return"";const d=U.toBase64Url(V.packTileValues(n,c));if(!a.length)return d;const u=U.toBase64Url(r),h=U.toBase64Url(V.packTileValues(a,c));return 1+u.length+h.length<d.length?`${p.GROUND_SPARSE_PREFIX}${u}${h}`:d}static decodeGround(e,t=0){const n=p.TILE_COUNT,a=p.MATRIX_SIZE,i=p.TILE_VALUE_MAX,r=t>=p.TILE_EXTENDED_VERSION,s=e??"",l=t===p.LEGACY_VERSION||s.length===n&&/^[0-9a-f]+$/i.test(s),o=[];if(l){let g=0;for(let f=0;f<a;f++){const v=[];for(let S=0;S<a;S++){const M=e?.[g++]??"0",x=parseInt(M,16);v.push(Number.isFinite(x)?D.clamp(x,0,p.TILE_LEGACY_MAX,0):0)}o.push(v)}return o}if(s[0]===p.GROUND_SPARSE_PREFIX&&t!==p.LEGACY_VERSION){const g=V.getTileMaskBase64Length(n),f=s.slice(1,1+g),v=s.slice(1+g),S=U.fromBase64Url(f),M=V.countSetBits(S),x=v?U.fromBase64Url(v):new Uint8Array(0),T=V.unpackTileValues(x,M,r);let L=0,C=0;for(let _=0;_<a;_++){const z=[];for(let Y=0;Y<a;Y++){const H=C>>3,w=C&7,Z=(S[H]&1<<w)!==0?T[L++]??0:0;z.push(D.clamp(Z,0,i,0)),C++}o.push(z)}return o}const d=U.fromBase64Url(s),u=V.unpackTileValues(d,n,r);let h=0;for(let g=0;g<a;g++){const f=[];for(let v=0;v<a;v++){const S=u[h++]??0;f.push(D.clamp(S,0,i,0))}o.push(f)}return o}static encodeOverlay(e){const t=V.normalizeOverlay(e),n=p.TILE_COUNT,a=new Uint8Array(Math.ceil(n/8)),i=[];let r=!1,s=0;const l=p.MATRIX_SIZE,o=V.shouldUseExtendedTileEncoding(t);for(let u=0;u<l;u++)for(let h=0;h<l;h++){const g=t[u][h],f=s++;if(g===null)continue;r=!0;const v=f>>3,S=f&7;a[v]|=1<<S,i.push(g&255)}if(!r)return{text:"",hasData:!1};const c=U.toBase64Url(a),d=i.length?U.toBase64Url(V.packTileValues(i,o)):"";return{text:`${p.OVERLAY_BINARY_PREFIX}${c}${d}`,hasData:!0}}static decodeOverlay(e,t=0){const n=p.MATRIX_SIZE,a=p.TILE_COUNT,i=p.TILE_VALUE_MAX,r=e??"",s=r[0]===p.OVERLAY_BINARY_PREFIX&&t!==p.LEGACY_VERSION,l=t>=p.TILE_EXTENDED_VERSION,o=[];if(s){const d=V.getTileMaskBase64Length(a),u=r.slice(1,1+d),h=r.slice(1+d),g=U.fromBase64Url(u),f=V.countSetBits(g),v=h?U.fromBase64Url(h):new Uint8Array(0),S=V.unpackTileValues(v,f,l);let M=0,x=0;for(let T=0;T<n;T++){const L=[];for(let C=0;C<n;C++){const _=M>>3,z=M&7;if((g[_]&1<<z)!==0){const H=S[x++]??0;L.push(D.clamp(H,0,i,0))}else L.push(null);M++}o.push(L)}return o}let c=0;for(let d=0;d<n;d++){const u=[];for(let h=0;h<n;h++){const g=e?.[c++]??p.NULL_CHAR;if(g===p.NULL_CHAR)u.push(null);else{const f=parseInt(g,16);u.push(Number.isFinite(f)?D.clamp(f,0,p.TILE_LEGACY_MAX,0):null)}}o.push(u)}return o}static decodeWorldGround(e,t,n){if(t>=p.WORLD_MULTIMAP_VERSION){const a=e?e.split(","):[],i=[];for(let r=0;r<n;r++){const s=a[r]??"";i.push(V.decodeGround(s,t))}return i}return[V.decodeGround(e??"",t)]}static decodeWorldOverlay(e,t,n){if(t>=p.WORLD_MULTIMAP_VERSION){const a=e?e.split(","):[],i=[];for(let r=0;r<n;r++){const s=a[r]??"";i.push(V.decodeOverlay(s,t))}return i}return[V.decodeOverlay(e||"",t)]}static coerceTileValue(e,t=0){if(typeof e=="number"&&Number.isFinite(e))return e;if(typeof e=="string"&&e.trim()!==""){const n=Number(e);if(Number.isFinite(n))return n}return t}static shouldUseExtendedTileEncoding(e){return!0}static matrixHasExtendedTiles(e){const t=p.TILE_LEGACY_MAX,n=p.MATRIX_SIZE;for(let a=0;a<n;a++)for(let i=0;i<n;i++){const r=e?.[a]?.[i];if(r==null)continue;const s=typeof r=="number"?r:typeof r=="string"?Number(r):NaN;if(Number.isFinite(s)&&s>t)return!0}return!1}static packTileValues(e,t){if(t){const n=new Uint8Array(e.length);for(let a=0;a<e.length;a++){const i=Number.isFinite(e[a])?e[a]:0;n[a]=i&255}return n}return O.packNibbles(e.map(n=>Number(n)&15))}static unpackTileValues(e,t,n){if(n){const a=new Array(t).fill(0);for(let i=0;i<t;i++)a[i]=e[i]??0;return a}return O.unpackNibbles(e,t)}static countSetBits(e){let t=0;for(let n=0;n<e.length;n++){let a=e[n]||0;for(;a;)a&=a-1,t++}return t}static getTileMaskBase64Length(e){if(V._tileMaskLengthCache||(V._tileMaskLengthCache=new Map),!V._tileMaskLengthCache.has(e)){const t=new Uint8Array(Math.ceil(e/8));V._tileMaskLengthCache.set(e,U.toBase64Url(t).length)}return V._tileMaskLengthCache.get(e)??0}}class G{static positionToByte(e){const t=D.clamp(Number(e.roomIndex),0,p.MAX_ROOM_INDEX,0)&15,n=D.clamp(Number(e.y),0,p.MATRIX_SIZE-1,0)&7,a=D.clamp(Number(e.x),0,p.MATRIX_SIZE-1,0)&7;return(t&3)<<6|n<<3|a}static byteToPosition(e){return{x:e&7,y:e>>3&7,roomIndex:D.clamp(e>>6&3,0,p.MAX_ROOM_INDEX,0)}}static encodePositions(e){if(!e.length)return"";if(e.reduce((i,r)=>Math.max(i,D.clamp(Number(r.roomIndex),0,p.MAX_ROOM_INDEX,0)),0)>3){const i=new Uint8Array(e.length*2);for(let r=0;r<e.length;r++){const s=e[r],l=D.clamp(Number(s.roomIndex),0,p.MAX_ROOM_INDEX,0)&15,o=D.clamp(Number(s.y),0,p.MATRIX_SIZE-1,0)&7,c=D.clamp(Number(s.x),0,p.MATRIX_SIZE-1,0)&7,d=r*2;i[d]=(l&3)<<6|o<<3|c,i[d+1]=l>>2&15}return p.POSITION_WIDE_PREFIX+U.toBase64Url(i)}const a=new Uint8Array(e.length);for(let i=0;i<e.length;i++)a[i]=G.positionToByte(e[i]);return U.toBase64Url(a)}static decodePositions(e){if(!e)return[];if(e[0]===p.POSITION_WIDE_PREFIX){const n=U.fromBase64Url(e.slice(1)),a=[];for(let i=0;i<n.length;i+=2){const r=n[i]??0,s=n[i+1]??0,l=r&7,o=r>>3&7,c=r>>6&3,d=s&15,u=D.clamp(d<<2|c,0,p.MAX_ROOM_INDEX,0);a.push({x:l,y:o,roomIndex:u})}return a}const t=U.fromBase64Url(e);return Array.from(t,n=>G.byteToPosition(n))}static encodeNpcTypeIndexes(e){if(!e.length)return"";const t=p.NPC_DEFINITIONS,n=new Uint8Array(e.length);let a=!1;for(let i=0;i<e.length;i++){const r=e[i],s=t.findIndex(l=>l.type===r.type);n[i]=s>=0?s:255,!a&&n[i]!==i&&(a=!0)}return a?U.toBase64Url(n):""}static decodeNpcTypeIndexes(e){return e?Array.from(U.fromBase64Url(e),t=>t):[]}static encodeEnemyTypeIndexes(e){if(!e.length)return"";const t=p.ENEMY_DEFINITIONS;if(!Array.isArray(t)||!t.length)return"";const n=new Uint8Array(e.length);for(let a=0;a<e.length;a++){const i=e[a]||{};let r=typeof i.typeIndex=="number"&&Number.isInteger(i.typeIndex)?i.typeIndex:-1;if(r<0||r>=t.length){const s=typeof i.type=="string"?i.type:null;r=s?t.findIndex(l=>l.type===s):-1}n[a]=r>=0?r:255}return U.toBase64Url(n)}static decodeEnemyTypeIndexes(e,t=0){if(!e)return Array.from({length:t},()=>255);const n=Array.from(U.fromBase64Url(e),a=>a);if(t>0&&n.length<t)for(;n.length<t;)n.push(255);return n}}class ne{static encodeUtf8(e){if(typeof TextEncoder<"u")return new TextEncoder().encode(e);const t=unescape(encodeURIComponent(e)),n=new Uint8Array(t.length);for(let a=0;a<t.length;a++)n[a]=t.charCodeAt(a);return n}static decodeUtf8(e){if(typeof TextDecoder<"u")return new TextDecoder().decode(e);let t="";const n="length"in e?e.length:0;for(let a=0;a<n;a++)t+=String.fromCharCode(e[a]??0);return decodeURIComponent(escape(t))}static encodeText(e){return e?U.toBase64Url(ne.encodeUtf8(e)):""}static decodeText(e,t=""){if(!e)return t;try{return ne.decodeUtf8(U.fromBase64Url(e))}catch(n){return console.warn("Failed to decode text payload",n),t}}static encodeTextArray(e){if(!e.length)return"";const t=JSON.stringify(e);return U.toBase64Url(ne.encodeUtf8(t))}static decodeTextArray(e){if(!e)return[];try{const t=ne.decodeUtf8(U.fromBase64Url(e)),n=JSON.parse(t);return Array.isArray(n)?n.map(a=>typeof a=="string"?a:""):[]}catch(t){return console.warn("Failed to decode text array payload",t),[]}}}class qe{static decodeCustomPalette(e){if(!e||e.length===0)return;if(e.includes(",")){const a=e.split(",").map(s=>`#${s.toUpperCase()}`);if(a.length!==16){console.warn("Invalid custom palette segment, expected 16 colors");return}const i=/^#[0-9A-F]{6}$/;if(!a.every(s=>i.test(s))){console.warn("Invalid hex colors in custom palette");return}return a}const t=U.fromBase64Url(e);if(t.length!==48){console.warn("Invalid custom palette segment, expected 48 bytes");return}const n=[];for(let a=0;a<16;a++){const i=a*3,r=t[i].toString(16).padStart(2,"0"),s=t[i+1].toString(16).padStart(2,"0"),l=t[i+2].toString(16).padStart(2,"0");n.push(`#${(r+s+l).toUpperCase()}`)}return n}static decodeShareCode(e){const t=$;if(!e)return null;const n=e.split("."),a={};for(const j of n){if(!j)continue;const X=j[0],re=j.slice(1);a[X]=re}const i=a.v?parseInt(a.v,36):NaN;if(!Number.isFinite(i)||!p.SUPPORTED_VERSIONS.has(i))return null;const r=i>=p.VERSION_3?p.WORLD_ROOM_COUNT:1,s=V.decodeWorldGround(a.g||"",i,r),l=V.decodeWorldOverlay(a.o||"",i,r),c=G.decodePositions(a.s||"")[0]??R.normalizeStart({}),d=G.decodePositions(a.p||""),u=ne.decodeTextArray(a.t||""),h=G.decodeNpcTypeIndexes(a.i||""),g=i>=p.NPC_VARIABLE_TEXT_VERSION?ne.decodeTextArray(a.u||""):[],f=i>=p.NPC_VARIABLE_TEXT_VERSION?O.decodeVariableNibbleArray(a.c||"",d.length):[],v=i>=p.NPC_VARIABLE_TEXT_VERSION?O.decodeVariableNibbleArray(a.r||"",d.length):[],S=i>=p.NPC_CONDITIONAL_REWARD_VERSION?O.decodeVariableNibbleArray(a.h||"",d.length):[],M=G.decodePositions(a.e||""),x=i>=p.ENEMY_TYPE_VERSION?G.decodeEnemyTypeIndexes(a.f||"",M.length):[],T=i>=p.ENEMY_VARIABLE_VERSION?O.decodeVariableNibbleArray(a.w||"",M.length):new Array(M.length).fill(0),L=i>=p.OBJECTS_VERSION?G.decodePositions(a.d||""):[],C=i>=p.OBJECTS_VERSION?G.decodePositions(a.k||""):[],_=i>=p.MAGIC_DOOR_VERSION?G.decodePositions(a.m||""):[],z=i>=p.MAGIC_DOOR_VERSION?O.decodeVariableNibbleArray(a.q||"",_.length):[],Y=i>=p.LIFE_POTION_VERSION?G.decodePositions(a.l||""):[],H=i>=p.XP_SCROLL_VERSION?G.decodePositions(a.x||""):[],w=i>=p.SWORD_VERSION?G.decodePositions(a.a||""):[],k=i>=p.TIERED_SWORD_VERSION?G.decodePositions(a.B||""):[],Z=i>=p.TIERED_SWORD_VERSION?G.decodePositions(a.W||""):[],J=i>=p.PLAYER_END_VERSION?G.decodePositions(a.z||""):[];let N=[];if(i>=p.PLAYER_END_TEXT_ARRAY_VERSION)N=ne.decodeTextArray(a.E||"");else if(i>=p.PLAYER_END_TEXT_VERSION){const j=ne.decodeText(a.E||"","");j&&(N=[j])}const b=i>=p.VARIABLES_VERSION?O.decodeVariables(a.b||""):[],W=i>=p.SWITCH_VERSION?G.decodePositions(a.J||""):[],ae=i>=p.SWITCH_VERSION?O.decodeVariableNibbleArray(a.K||"",W.length):[],Te=i>=p.SWITCH_VERSION?O.decodeVariableNibbleArray(a.L||"",W.length):[],pe=(ne.decodeText(a.n,p.DEFAULT_TITLE)||p.DEFAULT_TITLE).slice(0,18),fe=(ne.decodeText(a.y,"")||"").slice(0,18),le=j=>`npc-${j+1}`,y=p.NPC_DEFINITIONS,A=y.length>0&&(h.length>0||d.length<=y.length),P=[];if(A)for(let j=0;j<d.length;j++){const X=h[j]??j,re=y[X];if(!re)continue;const ce=d[j],We=O.nibbleToVariableId(f[j]??0),Cn=O.nibbleToVariableId(v[j]??0),Nn=O.nibbleToVariableId(S[j]??0);P.push({id:le(j),type:re.type,name:re.name,x:ce.x,y:ce.y,roomIndex:ce.roomIndex,text:u[j]??(re.defaultText||""),placed:!0,conditionVariableId:We,conditionText:g[j]??"",rewardVariableId:Cn,conditionalRewardVariableId:Nn})}else for(let j=0;j<d.length;j++){const X=d[j],re=O.nibbleToVariableId(f[j]??0),ce=O.nibbleToVariableId(v[j]??0),We=O.nibbleToVariableId(S[j]??0);P.push({id:le(j),name:`NPC ${j+1}`,x:X.x,y:X.y,roomIndex:X.roomIndex,text:u[j]??"",placed:!0,conditionVariableId:re,conditionText:g[j]??"",rewardVariableId:ce,conditionalRewardVariableId:We})}const F=R.normalizeEnemyType(),ee=p.ENEMY_DEFINITIONS,oe=M.map((j,X)=>{const re=T[X]??0;return{id:`enemy-${X+1}`,type:(()=>{const ce=x[X];return Number.isFinite(ce)&&ce>=0&&ce<ee.length?R.normalizeEnemyType(ee[ce].type):F})(),x:j.x,y:j.y,roomIndex:j.roomIndex,defeatVariableId:O.nibbleToVariableId(re)}}),Ke=Array.from({length:r},()=>({bg:0})),Pe=[];for(let j=0;j<r;j++){const X=s[j]??V.normalizeGround([]),re=l[j]??V.normalizeOverlay([]);Pe.push({ground:X,overlay:re})}const je=R.buildObjectEntries(J,t.PLAYER_END,{endingTexts:N}),De=[...R.buildObjectEntries(L,t.DOOR),...R.buildObjectEntries(C,t.KEY),...R.buildObjectEntries(_,t.DOOR_VARIABLE,{variableNibbles:z}),...R.buildObjectEntries(Y,t.LIFE_POTION),...R.buildObjectEntries(H,t.XP_SCROLL),...R.buildObjectEntries(w,t.SWORD),...R.buildObjectEntries(k,t.SWORD_BRONZE),...R.buildObjectEntries(Z,t.SWORD_WOOD),...je,...R.buildObjectEntries(W,t.SWITCH,{variableNibbles:ae,stateBits:Te})],Re=a.P?this.decodeCustomPalette(a.P):void 0,Ce={title:pe,author:fe,start:c,sprites:P,enemies:oe,world:i>=p.VERSION_3?{rows:p.WORLD_ROWS,cols:p.WORLD_COLS}:{rows:1,cols:1},rooms:Ke,objects:De,variables:O.buildVariableEntries(b),tileset:{tiles:[],maps:Pe,map:Pe[0]||{ground:V.normalizeGround([]),overlay:V.normalizeOverlay([])}}};return Re&&(Ce.customPalette=Re),Ce}}class Je{static buildShareCode(e){const t=$,n=p.WORLD_ROOM_COUNT,a=e,i=V.collectGroundMatrices(a,n),r=V.collectOverlayMatrices(a,n),s=e&&e.start?e.start:{},l=R.normalizeStart(s),o=R.normalizeSprites(e?.sprites),c=y=>typeof y=="number"&&Number.isFinite(y)?y:0,d=R.normalizeEnemies(e?.enemies),u=Array.isArray(e?.objects)?e.objects:[],h=R.normalizeObjectPositions(u,t.DOOR),g=R.normalizeObjectPositions(u,t.KEY),f=R.normalizeObjectPositions(u,t.LIFE_POTION),v=R.normalizeObjectPositions(u,t.XP_SCROLL),S=R.normalizeObjectPositions(u,t.SWORD),M=R.normalizeObjectPositions(u,t.SWORD_BRONZE),x=R.normalizeObjectPositions(u,t.SWORD_WOOD),T=R.normalizeObjectPositions(u,t.PLAYER_END),L=R.collectPlayerEndTexts(u),C=R.normalizeSwitchObjects(u),_=R.normalizeVariableDoorObjects(u),z=_.map(y=>({x:y.x,y:y.y,roomIndex:y.roomIndex})),Y=_.map(y=>c(y.variableNibble)),H=Array.isArray(e?.variables)?e.variables:[],w=O.encodeVariables(H),k=i.map(y=>V.encodeGround(y)),Z=k.some(y=>!!y),J=[];let N=!1;for(let y=0;y<n;y++){const{text:A,hasData:P}=V.encodeOverlay(r[y]??[]);J.push(A),P&&(N=!0)}const b=[];b.push("v"+p.VERSION.toString(36)),Z&&b.push("g"+k.join(",")),N&&b.push("o"+J.join(","));const W=R.normalizeStart({});if(l.x!==W.x||l.y!==W.y||l.roomIndex!==W.roomIndex){const y=G.encodePositions([l]);y&&b.push("s"+y)}if(o.length){const y=G.encodePositions(o),A=G.encodeNpcTypeIndexes(o),P=o.map(X=>typeof X.text=="string"?X.text:""),F=o.map(X=>typeof X.conditionText=="string"?X.conditionText:""),ee=o.map(X=>O.variableIdToNibble(X.conditionVariableId)),oe=o.map(X=>O.variableIdToNibble(X.rewardVariableId)),Ke=o.map(X=>O.variableIdToNibble(X.conditionalRewardVariableId)),Pe=F.some(X=>typeof X=="string"&&X.trim().length),je=ne.encodeTextArray(P),De=Pe?ne.encodeTextArray(F):"",Re=O.encodeVariableNibbleArray(ee),Ce=O.encodeVariableNibbleArray(oe),j=O.encodeVariableNibbleArray(Ke);y&&b.push("p"+y),A&&b.push("i"+A),je&&b.push("t"+je),De&&b.push("u"+De),Re&&b.push("c"+Re),Ce&&b.push("r"+Ce),j&&b.push("h"+j)}if(d.length){const y=G.encodePositions(d),A=G.encodeEnemyTypeIndexes(d),P=d.map(ee=>c(ee.variableNibble)),F=O.encodeVariableNibbleArray(P);y&&b.push("e"+y),A&&b.push("f"+A),F&&b.push("w"+F)}if(h.length){const y=G.encodePositions(h);y&&b.push("d"+y)}if(z.length){const y=G.encodePositions(z);y&&b.push("m"+y);const A=O.encodeVariableNibbleArray(Y);A&&b.push("q"+A)}if(g.length){const y=G.encodePositions(g);y&&b.push("k"+y)}if(f.length){const y=G.encodePositions(f);y&&b.push("l"+y)}if(v.length){const y=G.encodePositions(v);y&&b.push("x"+y)}if(S.length){const y=G.encodePositions(S);y&&b.push("a"+y)}if(M.length){const y=G.encodePositions(M);y&&b.push("B"+y)}if(x.length){const y=G.encodePositions(x);y&&b.push("W"+y)}if(T.length){const y=G.encodePositions(T);y&&b.push("z"+y)}if(Array.isArray(L)&&L.some(y=>typeof y=="string"&&y.length)&&b.push("E"+ne.encodeTextArray(L)),C.length){const y=C.map(P=>({x:P.x,y:P.y,roomIndex:P.roomIndex})),A=G.encodePositions(y);if(A){b.push("J"+A);const P=O.encodeVariableNibbleArray(C.map(ee=>c(ee.variableNibble))),F=O.encodeVariableNibbleArray(C.map(ee=>c(ee.stateNibble)));P&&b.push("K"+P),F&&b.push("L"+F)}}w&&b.push("b"+w);const pe=typeof e?.title=="string"?e.title.trim():"";pe&&pe!==p.DEFAULT_TITLE&&b.push("n"+ne.encodeText(pe.slice(0,80)));const fe=typeof e?.author=="string"?e.author.trim():"";fe&&b.push("y"+ne.encodeText(fe.slice(0,60)));const le=Array.isArray(e?.customPalette)?e.customPalette:void 0;if(le&&le.length===16&&!le.every((A,P)=>A.toUpperCase()===ye.PICO8_COLORS[P].toUpperCase())){const A=new Uint8Array(48);le.forEach((P,F)=>{const ee=P.replace("#","").toUpperCase(),oe=F*3;A[oe]=parseInt(ee.slice(0,2),16),A[oe+1]=parseInt(ee.slice(2,4),16),A[oe+2]=parseInt(ee.slice(4,6),16)}),b.push("P"+U.toBase64Url(A))}return b.join(".")}}class Ae{static getLocation(){return globalThis.location??null}static getBaseUrl(){const e=this.getLocation();return e?e.hostname==="localhost"||e.hostname==="127.0.0.1"||e.hostname===""?`${e.origin}${e.pathname}`:"https://andredarcie.github.io/tiny-rpg-studio/":""}static buildShareUrl(e){const t=Je.buildShareCode(e),n=Ae.getBaseUrl();return t?`${n}#${t}`:n}static extractGameDataFromLocation(e){if(!e)return null;const t=e.hash||"";if(!t||t.length<=1)return null;const n=t.startsWith("#")?t.substring(1):t;try{return qe.decodeShareCode(n)}catch(a){return console.warn("[TinyRPG] Unable to decode shared game data.",a),null}}}class Le{static buildShareUrl(e){return Ae.buildShareUrl(e)}static extractGameDataFromLocation(e){return Ae.extractGameDataFromLocation(e)}static encode(e){return Je.buildShareCode(e)}static decode(e){return qe.decodeShareCode(e)}}class kt{manager;shareTracker;constructor(e){this.manager=e,this.shareTracker=this.createShareTracker()}get text(){return K}t(e,t=""){const a=this.text.get(e,t);return a||t||e||""}buildShareUrl(){const e=this.manager.gameEngine.exportGameData(),t=Le.buildShareUrl(e);try{globalThis.history.replaceState(null,"",t)}catch{}return t}updateShareUrlField(e){const t=this.manager.dom.shareUrlInput;t&&(t.value=e||"")}async generateShareableUrl(){try{const e=await this.buildShareUrl();if(!e)return;this.updateShareUrlField(e);const n=(typeof navigator<"u"?navigator:null)?.clipboard;n?(await n.writeText(e),alert(this.t("alerts.share.copied"))):prompt(this.t("alerts.share.copyPrompt"),e),this.trackShareUrl(e)}catch(e){console.error(e),alert(this.t("alerts.share.generateError"))}}createShareTracker(){const e=globalThis.TinyRPGFirebaseConfig??null,t=globalThis.TinyRPGFirebaseCollection??null;return e?new _e(e,{collection:t}):null}async trackShareUrl(e){if(!this.shareTracker)return;console.info("[TinyRPG] Tracking share URL...",{url:e});const t=await this.shareTracker.trackShareUrl(e,{source:"editor"});console.info("[TinyRPG] Share URL tracking result:",t?"ok":"failed")}saveGame(){const e=new Blob([JSON.stringify(this.manager.gameEngine.exportGameData(),null,2)],{type:"application/json"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="tiny-rpg-maker.json",document.body.appendChild(n),n.click(),n.remove(),URL.revokeObjectURL(t)}loadGameFile(e){const t=e.target,n=t.files?.[0];if(!n)return;const a=new FileReader;a.onload=()=>{try{const i=JSON.parse(a.result);this.manager.restore(i,{skipHistory:!0}),this.manager.history.pushCurrentState()}catch{alert(this.t("alerts.share.loadError"))}},a.readAsText(n),t.value=""}}class jt{selectedTileId;selectedNpcId;selectedNpcType;activeRoomIndex;placingNpc;placingEnemy;placingObjectType;selectedObjectType;selectedEnemyType;mapPainting;skipMapHistory;npcTextUpdateTimer;suppressNpcFormUpdates;conditionalDialogueExpanded;activeMobilePanel;npcVariantFilter;playerEndTextUpdateTimer;variablePanelCollapsed;skillPanelCollapsed;testPanelCollapsed;palettePanelCollapsed;editingColorIndex;constructor(){this.selectedTileId=null,this.selectedNpcId=null,this.selectedNpcType=null,this.activeRoomIndex=0,this.placingNpc=!1,this.placingEnemy=!1,this.placingObjectType=null,this.selectedObjectType=null,this.selectedEnemyType=null,this.mapPainting=!1,this.skipMapHistory=!1,this.npcTextUpdateTimer=null,this.suppressNpcFormUpdates=!1,this.conditionalDialogueExpanded=!1,this.activeMobilePanel="tiles",this.npcVariantFilter="human",this.playerEndTextUpdateTimer=null,this.variablePanelCollapsed=!0,this.skillPanelCollapsed=!0,this.testPanelCollapsed=!0,this.palettePanelCollapsed=!0,this.editingColorIndex=null}}class Dt{manager;constructor(e){this.manager=e}get dom(){return this.manager.domCache}get state(){return this.manager.state}startPaint(e){const t=this.dom.editorCanvas;t&&(e.preventDefault(),this.state.mapPainting=!0,t.setPointerCapture(e.pointerId),this.applyPaint(e))}continuePaint(e){this.state.mapPainting&&this.applyPaint(e)}finishPaint(e){if(!this.state.mapPainting)return;this.state.mapPainting=!1;const t=this.dom.editorCanvas;if(!t){this.state.mapPainting=!1;return}if(t.hasPointerCapture(e.pointerId)&&t.releasePointerCapture(e.pointerId),this.state.skipMapHistory){this.state.skipMapHistory=!1;return}this.manager.renderService.renderEditor(),this.manager.gameEngine.draw(),this.manager.updateJSON(),this.manager.history.pushCurrentState()}applyPaint(e){const t=this.getTileFromEvent(e);if(!t)return;const n=this.state.activeRoomIndex;if(this.state.placingNpc){this.manager.npcService.placeNpcAt(t),this.state.skipMapHistory=!0;return}if(this.state.placingEnemy){this.manager.enemyService.placeEnemyAt(t),this.state.skipMapHistory=!0;return}if(this.state.placingObjectType){this.manager.objectService.placeObjectAt(this.state.placingObjectType,t,n),this.state.skipMapHistory=!0;return}this.state.selectedTileId!==null&&(this.manager.gameEngine.setMapTile(t.x,t.y,this.state.selectedTileId,n),this.manager.renderService.renderEditor(),this.manager.gameEngine.draw())}clearSelection({render:e=!0}={}){return this.state.selectedTileId!==null?(this.state.selectedTileId=null,e&&(this.manager.renderService.renderTileList(),this.manager.renderService.updateSelectedTilePreview()),!0):!1}getTileFromEvent(e){const t=this.dom.editorCanvas;if(!t)return null;const n=t.getBoundingClientRect();if(!n.width||!n.height)return null;const a=(e.clientX-n.left)/n.width,i=(e.clientY-n.top)/n.height;return a<0||a>1||i<0||i>1?null:{x:Math.min(7,Math.floor(a*8)),y:Math.min(7,Math.floor(i*8))}}}class Ft{manager;constructor(e){this.manager=e}get dom(){return this.manager.domCache}get gameEngine(){return this.manager.gameEngine}toggle(e,t=null){if(!e)return;const n=this.gameEngine.getVariableDefinitions().find(r=>r.id===e),a=t!==null?!!t:!n?.value;this.gameEngine.setVariableDefault(e,a)&&(this.manager.renderService.renderObjects(),this.manager.npcService.updateNpcSelection(this.manager.state.selectedNpcType,this.manager.state.selectedNpcId),this.gameEngine.draw(),this.manager.updateJSON(),this.manager.history.pushCurrentState())}}class Vt{manager;constructor(e){this.manager=e}get dom(){return this.manager.domCache}get state(){return this.manager.state}get gameEngine(){return this.manager.gameEngine}setActiveRoom(e){const t=Number(e);if(!Number.isFinite(t))return;const n=this.gameEngine.getGame().rooms?.length||1,a=Math.max(0,Math.min(n-1,Math.floor(t)));a!==this.state.activeRoomIndex&&((this.state.placingNpc||this.state.selectedNpcId||this.state.selectedNpcType)&&this.manager.npcService.clearSelection(),this.state.placingEnemy&&this.manager.enemyService.deactivatePlacement(),this.state.activeRoomIndex=a,this.manager.renderService.renderWorldGrid(),this.manager.renderService.renderObjects(),this.manager.renderObjectCatalog(),this.manager.renderService.renderEditor(),this.manager.renderService.renderEnemies())}moveActiveRoom(e){if(!e)return;const t=String(e).toLowerCase(),n=this.gameEngine.getGame(),a=Math.max(1,Number(n.world?.rows)||1),i=Math.max(1,Number(n.world?.cols)||1),r=Math.max(1,n.rooms?.length||a*i);if(!a||!i||!r)return;const s=Math.max(0,Math.min(r-1,this.state.activeRoomIndex)),l=Math.floor(s/i),o=s%i;let c=l,d=o;if(t==="up"&&(c-=1),t==="down"&&(c+=1),t==="left"&&(d-=1),t==="right"&&(d+=1),c<0||c>=a||d<0||d>=i)return;const u=c*i+d;u<0||u>=r||this.setActiveRoom(u)}}class Be{manager;constructor(e){this.manager=e}get gameEngine(){return this.manager.gameEngine}get state(){return this.manager.state}get dom(){return this.manager.dom}get renderService(){return this.manager.renderService}}class _t extends Be{bind(){const{btnNpcDelete:e,btnGenerateUrl:t,btnUndo:n,btnRedo:a,titleInput:i,authorInput:r,npcText:s,npcConditionalText:l,npcConditionalVariable:o,npcRewardVariable:c,npcConditionalRewardVariable:d,btnToggleNpcConditional:u,fileInput:h,editorCanvas:g,npcVariantButtons:f,enemyTypes:v,enemiesList:S,objectTypes:M,objectsList:x,tileList:T,npcsList:L,mapNavButtons:C,mobileNavButtons:_,worldGrid:z,projectVariablesToggle:Y,projectSkillsToggle:H,projectTestToggle:w,projectTestStartLevel:k,projectTestSkillList:Z,projectTestGodMode:J,shareUrlInput:N}=this.dom,b=this.manager,W=b.npcService,ae=b.enemyService,Te=b.objectService,pe=b.shareService,fe=b.tileService,le=b.worldService;e?.addEventListener("click",()=>W.removeSelectedNpc()),u?.addEventListener("click",()=>{this.state.conditionalDialogueExpanded=!this.state.conditionalDialogueExpanded,this.renderService.updateNpcForm()}),t?.addEventListener("click",()=>{pe.generateShareableUrl()}),n?.addEventListener("click",()=>b.undo()),a?.addEventListener("click",()=>b.redo()),Y?.addEventListener("click",()=>b.toggleVariablePanel()),H?.addEventListener("click",()=>b.toggleSkillPanel()),w?.addEventListener("click",()=>b.toggleTestPanel()),i?.addEventListener("input",()=>b.updateGameMetadata()),r?.addEventListener("input",()=>b.updateGameMetadata()),k?.addEventListener("change",y=>{const A=y.target,P=Number(A.value);b.setTestStartLevel(P)}),J?.addEventListener("change",y=>{const A=y.target;b.setGodMode(A.checked)}),N?.addEventListener("focus",()=>N.select()),N?.addEventListener("click",()=>N.select()),Z?.addEventListener("change",y=>{if(y.target.tagName!=="INPUT")return;const P=Array.from(Z.querySelectorAll('input[type="checkbox"][data-skill-id]')).filter(F=>F.checked).map(F=>F.dataset.skillId).filter(Boolean);b.setTestSkills(P)}),s?.addEventListener("input",()=>W.updateNpcText(s.value)),l?.addEventListener("input",()=>W.updateNpcConditionalText(l.value)),o?.addEventListener("change",y=>W.handleConditionVariableChange(y.target.value)),c?.addEventListener("change",y=>W.handleRewardVariableChange(y.target.value)),d?.addEventListener("change",y=>W.handleConditionalRewardVariableChange(y.target.value)),Array.isArray(f)&&f.forEach(y=>{y.addEventListener("click",()=>{const A=y.dataset.npcVariantFilter;A&&W.setVariantFilter(A)})}),h?.addEventListener("change",y=>pe.loadGameFile(y)),T?.addEventListener("click",y=>{const P=y.target.closest("[data-tile-id]");if(!P)return;const F=Number(P.dataset.tileId);Number.isFinite(F)&&(this.state.placingObjectType&&Te.togglePlacement(this.state.placingObjectType,!0),b.desselectAllAndRender(),b.selectedTileId=F,this.renderService.updateSelectedTilePreview(),this.renderService.renderTileList())}),L?.addEventListener("click",y=>{const P=y.target.closest(".npc-card");if(!P)return;const F=P.dataset.type||null,ee=P.dataset.id||null;b.desselectAllAndRender(),W.updateNpcSelection(F,ee)}),M?.addEventListener("click",y=>{const P=y.target.closest(".object-type-card");if(!P)return;const F=P.dataset.type||null;F&&(b.desselectAllAndRender(),Te.selectObjectType(F))}),x?.addEventListener("click",y=>{const P=y.target.closest(".object-remove");if(!P)return;const F=P.closest(".object-card");if(!F)return;const ee=F.dataset.type,oe=Number(F.dataset.roomIndex);!ee||!Number.isFinite(oe)||Te.removeObject(ee,oe)}),v?.addEventListener("click",y=>{const P=y.target.closest(".enemy-card");if(!P)return;const F=P.dataset.type||null;F&&(b.desselectAllAndRender(),ae.selectEnemyType(F))}),S?.addEventListener("click",y=>{const P=y.target.closest("[data-remove-enemy]");if(!P)return;const F=P.dataset.removeEnemy;F&&ae.removeEnemy(F)}),S?.addEventListener("change",y=>{const A=y.target;if(A.tagName!=="SELECT")return;const P=A.dataset.enemyVariable;if(!P)return;const F=A.value||"";ae.handleEnemyVariableChange(P,F)}),z?.addEventListener("click",y=>{const P=y.target.closest("[data-room-index]");if(!P)return;const F=Number(P.dataset.roomIndex);le.setActiveRoom(F)}),Array.isArray(C)&&C.forEach(y=>{y.addEventListener("click",()=>{const A=y.dataset.direction;A&&le.moveActiveRoom(A)})}),g&&(g.addEventListener("pointerdown",y=>fe.startPaint(y)),g.addEventListener("pointermove",y=>fe.continuePaint(y))),Array.isArray(_)&&_.forEach(y=>{y.addEventListener("click",()=>{const A=y.dataset.mobileTarget;A&&b.setActiveMobilePanel(A)})}),document.addEventListener("keydown",y=>b.handleKey(y)),globalThis.addEventListener("resize",()=>{b.handleCanvasResize(),b.updateMobilePanels()}),document.addEventListener("editor-tab-activated",()=>requestAnimationFrame(()=>{b.handleCanvasResize(!0),b.updateMobilePanels()})),globalThis.addEventListener("pointerup",y=>fe.finishPaint(y))}}class Bt extends Be{handleCanvasResize(e=!1){const t=this.manager.editorCanvas;if(!t)return;const n=t.parentElement;if(!n)return;const a=n.offsetWidth||n.clientWidth||0,i=512,r=128,s=Math.floor((a+r-1)/r)*r,l=Math.min(Math.max(s,r),i);!e&&Math.abs(t.width-l)<1||(t.style.width=`${l}px`,t.width=l,t.height=l,this.renderService.renderEditor(),this.renderService.renderEnemies())}handleKey(e){if(!e.defaultPrevented){if(e.key==="Escape"){if(this.state.placingNpc||this.manager.selectedNpcId||this.manager.selectedNpcType){this.manager.npcService.clearSelection(),e.preventDefault();return}if(this.state.placingEnemy){this.manager.enemyService.deactivatePlacement(),e.preventDefault();return}if(this.state.placingObjectType){this.manager.objectService.togglePlacement(this.state.placingObjectType,!0),e.preventDefault();return}}(e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="z"&&(e.preventDefault(),e.shiftKey?this.manager.redo():this.manager.undo()),(e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="y"&&(e.preventDefault(),this.manager.redo())}}}class Gt extends Be{updateGameMetadata(){const e=this.gameEngine.getGame(),t=this.normalizeTitle(this.dom.titleInput?.value||""),n=this.normalizeAuthor(this.dom.authorInput?.value||"");e.title=t,e.author=n,this.gameEngine.syncDocumentTitle(),this.gameEngine.refreshIntroScreen(),this.updateJSON()}updateJSON(){this.dom.jsonArea&&(this.dom.jsonArea.value=JSON.stringify(this.gameEngine.exportGameData(),null,2)),this.renderService.renderVariableUsage(),this.renderService.renderSkillList(),this.renderService.renderTestTools()}toggleVariablePanel(){this.state.variablePanelCollapsed=!this.state.variablePanelCollapsed,this.renderService.renderVariableUsage()}toggleSkillPanel(){this.state.skillPanelCollapsed=!this.state.skillPanelCollapsed,this.renderService.renderSkillList()}toggleTestPanel(){this.state.testPanelCollapsed=!this.state.testPanelCollapsed,this.renderService.renderTestTools()}setTestStartLevel(e){const t=this.gameEngine.getMaxPlayerLevel(),n=Number.isFinite(e)?Math.max(1,Math.min(t,Math.floor(e))):1;this.gameEngine.updateTestSettings({startLevel:n}),this.renderService.renderTestTools()}setTestSkills(e){const t=Array.isArray(e)?Array.from(new Set(e.filter(n=>typeof n=="string"&&n))):[];this.gameEngine.updateTestSettings({skills:t}),this.renderService.renderTestTools()}setGodMode(e=!1){this.gameEngine.updateTestSettings({godMode:!!e}),this.renderService.renderTestTools()}syncUI(){const e=this.gameEngine.getGame();this.dom.titleInput&&(this.dom.titleInput.value=e.title||""),this.dom.authorInput&&(this.dom.authorInput.value=e.author||""),this.updateJSON()}setActiveMobilePanel(e){if(e){if(this.state.activeMobilePanel===e){this.updateMobilePanels();return}this.state.activeMobilePanel=e,this.updateMobilePanels()}}updateMobilePanels(){const e=this.state.activeMobilePanel||"tiles";(Array.isArray(this.dom.mobileNavButtons)?this.dom.mobileNavButtons:[]).forEach(i=>{const r=i.dataset.mobileTarget===e;i.classList.toggle("active",r)});const n=Array.isArray(this.dom.mobilePanels)?this.dom.mobilePanels:[],a=typeof globalThis.matchMedia=="function"?globalThis.matchMedia("(max-width: 920px)").matches:!1;n.forEach(i=>{if(!a){i.classList.remove("is-mobile-active");return}const r=i.dataset.mobilePanel===e;i.classList.toggle("is-mobile-active",r)})}handleLanguageChange(){K.apply(),this.gameEngine.gameState.variableManager.refreshPresetNames(),this.refreshNpcLocalizedText(),this.manager.renderAll(),this.updateJSON()}refreshNpcLocalizedText(){const e=this.gameEngine.getSprites();if(!Array.isArray(e))return;const t=this.gameEngine.npcManager.getDefinitions(),n=new Map(t.map(a=>[a.type,a]));e.forEach(a=>{const i=a.type?n.get(a.type):null;i&&i.nameKey&&(a.name=K.get(i.nameKey,i.name||a.name||"")||a.name||""),a.textKey&&(a.text=K.get(a.textKey,a.text||"")||a.text||"")})}normalizeTitle(e){return String(e||"").slice(0,18).replace(/\s+/g," ").trim()||"Tiny RPG Studio"}normalizeAuthor(e){return String(e||"").slice(0,18).replace(/\s+/g," ").trim()}}class Ut{gameEngine;state;domCache;editorCanvas;ectx;history;renderService;tileService;shareService;npcService;enemyService;objectService;variableService;paletteService;worldService;uiController;eventBinder;interactionController;constructor(e){this.gameEngine=e,this.state=new jt,this.domCache=new pt(typeof document<"u"?document:null),this.editorCanvas=this.domCache.editorCanvas||null,this.ectx=this.editorCanvas?.getContext("2d")??null,this.ectx&&(this.ectx.imageSmoothingEnabled=!1),this.history=new yt(this),this.renderService=new Lt(this),this.tileService=new Dt(this),this.shareService=new kt(this),this.npcService=new vt(this),this.enemyService=new ft(this),this.objectService=new bt(this),this.variableService=new Ft(this),this.paletteService=new Et(this),this.worldService=new Vt(this),this.uiController=new Gt(this),this.eventBinder=new _t(this),this.interactionController=new Bt(this),this.bindEvents(),this.initialize(),typeof document<"u"&&document.addEventListener("language-changed",()=>this.handleLanguageChange())}get dom(){return this.domCache}get historyManager(){return this.history}get selectedTileId(){return this.state.selectedTileId}set selectedTileId(e){this.state.selectedTileId=e}get selectedNpcId(){return this.state.selectedNpcId}set selectedNpcId(e){this.state.selectedNpcId=e}get selectedNpcType(){return this.state.selectedNpcType}set selectedNpcType(e){this.state.selectedNpcType=e}get activeRoomIndex(){return this.state.activeRoomIndex}set activeRoomIndex(e){this.state.activeRoomIndex=e}get placingNpc(){return this.state.placingNpc}set placingNpc(e){this.state.placingNpc=e}get placingEnemy(){return this.state.placingEnemy}set placingEnemy(e){this.state.placingEnemy=e}get placingObjectType(){return this.state.placingObjectType}set placingObjectType(e){this.state.placingObjectType=e}get selectedObjectType(){return this.state.selectedObjectType}set selectedObjectType(e){this.state.selectedObjectType=e}get selectedEnemyType(){return this.state.selectedEnemyType}set selectedEnemyType(e){this.state.selectedEnemyType=e}get mapPainting(){return this.state.mapPainting}set mapPainting(e){this.state.mapPainting=e}bindEvents(){this.eventBinder.bind()}initialize(){this.gameEngine.tileManager.ensureDefaultTiles();const e=this.gameEngine.getTiles();e.length>0&&(this.selectedTileId=e[0].id??null),this.syncUI();const t=this.gameEngine.getGame(),n=t.start?.roomIndex??0,a=t.rooms?.length||1;this.activeRoomIndex=Math.max(0,Math.min(a-1,n)),this.gameEngine.npcManager.ensureDefaultNPCs(),this.paletteService.initialize(),this.renderAll(),this.updateMobilePanels(),this.handleCanvasResize(!0),this.history.pushCurrentState()}desselectAllAndRender(){const e=!!this.tileService.clearSelection({render:!1}),t=!!this.npcService.clearSelection({render:!1}),n=!!this.enemyService.clearSelection({render:!1}),a=!!this.objectService.clearSelection({render:!1});return e&&(this.renderService.renderTileList(),this.renderService.updateSelectedTilePreview()),t&&this.renderService.renderNpcs(),n&&this.renderService.renderEnemyCatalog(),a&&this.renderService.renderObjectCatalog(),e||t||n||a}renderAll(){this.renderService.renderTileList(),this.renderService.renderWorldGrid(),this.renderService.renderNpcs(),this.renderService.renderEnemyCatalog(),this.renderService.renderEnemies(),this.renderService.renderObjectCatalog(),this.renderService.renderObjects(),this.renderService.renderEditor(),this.renderService.updateSelectedTilePreview()}renderEditor(){this.renderService.renderEditor()}renderTileList(){this.renderService.renderTileList()}updateSelectedTilePreview(){this.renderService.updateSelectedTilePreview()}renderNpcs(){this.renderService.renderNpcs()}renderEnemies(){this.renderService.renderEnemies()}renderEnemyCatalog(){this.renderService.renderEnemyCatalog()}renderObjectCatalog(){this.renderService.renderObjectCatalog()}renderObjects(){this.renderService.renderObjects()}renderWorldGrid(){this.renderService.renderWorldGrid()}toggleVariablePanel(){this.uiController.toggleVariablePanel()}toggleSkillPanel(){this.uiController.toggleSkillPanel()}toggleTestPanel(){this.uiController.toggleTestPanel()}setTestStartLevel(e){this.uiController.setTestStartLevel(e)}setTestSkills(e){this.uiController.setTestSkills(e)}setGodMode(e){this.uiController.setGodMode(e)}setActiveMobilePanel(e){this.uiController.setActiveMobilePanel(e)}updateMobilePanels(){this.uiController.updateMobilePanels()}startMapPaint(e){this.tileService.startPaint(e)}continueMapPaint(e){this.tileService.continuePaint(e)}finishMapPaint(e){this.tileService.finishPaint(e)}addNPC(){this.npcService.addNpc()}removeSelectedNpc(){this.npcService.removeSelectedNpc()}updateNpcSelection(){this.npcService.updateNpcSelection(this.selectedNpcType,this.selectedNpcId)}updateNpcText(){this.dom.npcText&&this.npcService.updateNpcText(this.dom.npcText.value)}updateNpcConditionalText(){this.dom.npcConditionalText&&this.npcService.updateNpcConditionalText(this.dom.npcConditionalText.value)}handleNpcConditionVariableChange(){const e=this.dom.npcConditionalVariable;e&&this.npcService.handleConditionVariableChange(e.value)}handleNpcRewardVariableChange(){const e=this.dom.npcRewardVariable;e&&this.npcService.handleRewardVariableChange(e.value)}handleNpcConditionalRewardVariableChange(){const e=this.dom.npcConditionalRewardVariable;e&&this.npcService.handleConditionalRewardVariableChange(e.value)}removeEnemy(e){this.enemyService.removeEnemy(e)}removeObject(e,t){this.objectService.removeObject(e,t)}toggleVariableDefault(e,t=null){this.variableService.toggle(e,t)}setActiveRoom(e){this.worldService.setActiveRoom(e)}generateShareableUrl(){return this.shareService.generateShareableUrl()}saveGame(){this.shareService.saveGame()}loadGameFile(e){this.shareService.loadGameFile(e)}pushHistory(){this.history.pushCurrentState()}undo(){this.history.undo()}redo(){this.history.redo()}updateGameMetadata(){this.uiController.updateGameMetadata()}updateJSON(){this.uiController.updateJSON()}syncUI(){this.uiController.syncUI()}restore(e,t={}){const{skipHistory:n=!1}=t;this.gameEngine.importGameData(e),this.gameEngine.tileManager.ensureDefaultTiles();const a=e.customPalette;a?this.gameEngine.setCustomPalette(a):this.gameEngine.resetPaletteToDefault(),this.paletteService.renderPaletteGrid();const i=this.gameEngine.getTiles();i.length&&!i.find(o=>o.id===this.selectedTileId)&&(this.selectedTileId=i[0].id??null),this.gameEngine.getSprites().find(o=>o.id===this.selectedNpcId)||(this.selectedNpcId=null,this.selectedNpcType=null,this.placingNpc=!1);const s=he.ENEMY_DEFINITIONS,l=te.normalizeType(this.selectedEnemyType);l!==this.selectedEnemyType?this.selectedEnemyType=l:s.some(o=>o.type===this.selectedEnemyType)||(this.selectedEnemyType=s[0]?.type||"giant-rat"),this.renderAll(),this.gameEngine.draw(),this.syncUI(),n||this.history.pushCurrentState()}handleCanvasResize(e=!1){this.interactionController.handleCanvasResize(e)}handleLanguageChange(){this.uiController.handleLanguageChange()}refreshNpcLocalizedText(){this.uiController.refreshNpcLocalizedText()}handleKey(e){this.interactionController.handleKey(e)}createNewGame(){const e=()=>Array.from({length:8},()=>Array(8).fill(null)),t={title:"Novo Jogo",palette:["#0e0f13","#2e3140","#f4f4f8"],roomSize:8,rooms:[{size:8,bg:0,tiles:Array.from({length:8},()=>Array(8).fill(0)),walls:Array.from({length:8},()=>Array(8).fill(!1))}],start:{x:1,y:1,roomIndex:0},sprites:[],items:[],exits:[],objects:[],enemies:[],variables:[],tileset:{tiles:[],map:{ground:e(),overlay:e()}}};this.restore(t)}}let Ze=null;const zt=m=>{Ze=m},Qe=()=>Ze;class Ht{btn;constructor(){this.btn=typeof document<"u"?document.getElementById("btn-generate-html"):null,this.btn&&this.btn.addEventListener("click",e=>{setTimeout(()=>this.exportProjectAsHtml(),0)})}async exportProjectAsHtml(){try{const e=Qe();if(!e){alert("Unable to export: engine API is not available.");return}const t=e.exportGameData();if(!t){alert("Unable to read current project data.");return}const n=Le.encode(t),a="Unable to download project assets. Please run Tiny RPG Studio from an HTTP/HTTPS server (not file://) to export HTML.";let i="";const r=Array.from(document.querySelectorAll('link[rel="stylesheet"][href]'));for(const N of r){const b=N.getAttribute("href");if(b&&!b.startsWith("http://")&&!b.startsWith("https://"))try{const W=await fetch(b);if(W.ok)i+=await W.text()+`
`;else{alert(a);return}}catch{alert(a);return}}const s={},l=[];let o="";const c=Date.now().toString(36),d="export.bundle.js";try{const N=await fetch(`${d}?v=${c}`);N.ok&&(o=await N.text(),s[d]=o)}catch{}const u=K.getLocale()||"en-US",h="legacy/index.html",g=["js/runtime/adapters/TextResources.js","js/runtime/domain/definitions/SkillDefinitions.js","js/runtime/domain/state/StateWorldManager.js","js/runtime/domain/state/StateSkillManager.js","js/runtime/domain/state/StatePlayerManager.js","js/runtime/domain/state/StateDialogManager.js","js/runtime/domain/state/StateVariableManager.js","js/runtime/domain/state/StateEnemyManager.js","js/runtime/domain/state/StateObjectManager.js","js/runtime/domain/state/StateItemManager.js","js/runtime/domain/state/GameStateLifecycle.js","js/runtime/domain/state/GameStateScreenManager.js","js/runtime/domain/state/GameStateWorldFacade.js","js/runtime/domain/state/GameStateDataFacade.js","js/runtime/domain/state/StateDataManager.js","js/runtime/domain/GameState.js","js/runtime/domain/sprites/PlayerSprites.js","js/runtime/domain/sprites/NpcSprites.js","js/runtime/domain/sprites/EnemySprites.js","js/runtime/domain/sprites/ObjectSprites.js","js/runtime/domain/sprites/SpriteMatrixRegistry.js","js/runtime/adapters/renderer/RendererConstants.js","js/runtime/adapters/renderer/RendererPalette.js","js/runtime/adapters/renderer/RendererSpriteFactory.js","js/runtime/adapters/renderer/RendererCanvasHelper.js","js/runtime/adapters/renderer/RendererTileRenderer.js","js/runtime/adapters/renderer/RendererEntityRenderer.js","js/runtime/adapters/renderer/RendererDialogRenderer.js","js/runtime/adapters/renderer/RendererHudRenderer.js","js/runtime/adapters/renderer/RendererMinimapRenderer.js","js/runtime/adapters/renderer/RendererModuleBase.js","js/runtime/adapters/renderer/RendererEffectsManager.js","js/runtime/adapters/renderer/RendererTransitionManager.js","js/runtime/adapters/renderer/RendererOverlayRenderer.js","js/runtime/infra/share/ShareConstants.js","js/runtime/infra/share/ShareMath.js","js/runtime/infra/share/ShareBase64.js","js/runtime/infra/share/ShareTextCodec.js","js/runtime/infra/share/ShareVariableCodec.js","js/runtime/infra/share/ShareMatrixCodec.js","js/runtime/infra/share/SharePositionCodec.js","js/runtime/infra/share/ShareDataNormalizer.js","js/runtime/infra/share/ShareEncoder.js","js/runtime/infra/share/ShareDecoder.js","js/runtime/infra/share/ShareUrlHelper.js","js/runtime/domain/definitions/TileDefinitions.js","js/runtime/domain/definitions/NPCDefinitions.js","js/runtime/domain/definitions/EnemyDefinitions.js","js/runtime/domain/definitions/ItemDefinitions.js","js/editor/modules/EditorConstants.js","js/editor/modules/EditorDomCache.js","js/editor/modules/EditorState.js","js/editor/modules/EditorHistoryManager.js","js/editor/modules/EditorShareService.js","js/editor/manager/EditorManagerModule.js","js/editor/manager/EditorEventBinder.js","js/editor/manager/EditorUIController.js","js/editor/manager/EditorInteractionController.js","js/editor/modules/renderers/EditorRendererBase.js","js/editor/modules/renderers/EditorCanvasRenderer.js","js/editor/modules/renderers/EditorTilePanelRenderer.js","js/editor/modules/renderers/EditorNpcRenderer.js","js/editor/modules/renderers/EditorEnemyRenderer.js","js/editor/modules/renderers/EditorObjectRenderer.js","js/editor/modules/renderers/EditorWorldRenderer.js","js/editor/modules/EditorRenderService.js","js/editor/modules/EditorTileService.js","js/editor/modules/EditorNpcService.js","js/editor/modules/EditorEnemyService.js","js/editor/modules/EditorObjectService.js","js/editor/modules/EditorVariableService.js","js/editor/modules/EditorWorldService.js","js/editor/EditorManager.js","js/runtime/infra/share/ShareUtils.js","js/runtime/services/TileManager.js","js/runtime/services/NPCManager.js","js/runtime/adapters/InputManager.js","js/runtime/adapters/Renderer.js","js/runtime/services/engine/DialogManager.js","js/runtime/services/engine/InteractionManager.js","js/runtime/services/engine/EnemyManager.js","js/runtime/services/engine/MovementManager.js","js/runtime/services/GameEngine.js","js/main.js","js/editor/modules/EditorExportService.js"],f=[];if(!o)try{const N=await fetch(h);if(N.ok){const b=await N.text(),W=new DOMParser().parseFromString(b,"text/html");f.push(...Array.from(W.querySelectorAll("script[src]")).filter(ae=>ae.getAttribute("type")!=="module").map(ae=>ae.getAttribute("src")).filter(ae=>ae?(ae.startsWith("js/")||ae.startsWith("./js/"))&&!ae.includes("/editor/"):!1))}}catch{}const v=f.length&&f.some(N=>N&&N.includes("js/main.js"))?f.filter(N=>!!N):g;for(const N of v){if(o)break;if(N)try{const b=await fetch(`${N}?v=${c}`);if(b.ok){const W=await b.text();/^(?:\s*import\s+[\w*{]|\s*export\s+)/m.test(W)?l.push(N):s[N]=W}else{alert(a);return}}catch{alert(a);return}}const S=document.getElementById("game-container");if(!S){alert("game-container not found");return}const M=S.cloneNode(!0),x=document.getElementById("btn-reset"),T=x?x.cloneNode(!0):null,L=Object.values(s).join(""),C=`<!DOCTYPE html>
                <html lang="${u}">
                <head>
                <meta charset="utf-8">
                <meta name="viewport" content="width=device-width, initial-scale=1">
                <title>Tiny RPG</title>
                <link rel="preconnect" href="https://fonts.googleapis.com">
                <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
                <style>${i}
                body{background-color:#000}
                #game-container{position:relative;display:flex;flex-direction:column;justify-content:center;align-items:center;background-color:#000;overflow:hidden}
                .game-controls{display:flex;justify-content:center;margin-top:1rem}
                canvas{image-rendering:pixelated;image-rendering:crisp-edges}
                .touch-controls-toggle{display:inline-flex !important;align-items:center;gap:6px}
                body.touch-controls-visible .touch-controls-toggle{display:none !important}
                </style>
                <script>
                console.log('[TinyRPG Export] Booting exported build');
                globalThis.__TINY_RPG_EXPORT_MODE = true;
                globalThis.__TINY_RPG_SHARED_CODE = ${JSON.stringify(n)};
                console.log('[TinyRPG Export] Share code ready', { length: (globalThis.__TINY_RPG_SHARED_CODE || '').length });
                if(!location.hash) try{ location.hash = '#' + globalThis.__TINY_RPG_SHARED_CODE; }catch{}
                <\/script>
                </head>
                <body class="game-mode">
                <div class="app">
                <main>
                <div class="tabs">
                    <div class="tabs-links">
                        ${T?T.outerHTML:""}
                    </div>
                </div>
                <div class="tab-content active" id="tab-game">
                ${M.outerHTML}
                </div>
                </main>
                </div>
                <script>
            console.log('[TinyRPG Export] Loading scripts', { count: ${Object.keys(s).length}, requested: ${v.length}, skipped: ${JSON.stringify(l)}, bundle: ${!!o} });
                ${L}
                console.log('[TinyRPG Export] Scripts executed');
                <\/script>
                </body>
            </html>`,_=t,Y=(typeof _.title=="string"?_.title:"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9]+/g,"-").replace(/^-+|-+$/g,"").toLowerCase(),H=p.VERSION,w=`${Y||"tiny-rpg"}-v${H}.html`,k=new Blob([C],{type:"text/html;charset=utf-8"}),Z=URL.createObjectURL(k),J=document.createElement("a");J.href=Z,J.download=w,document.body.appendChild(J),J.click(),J.remove(),URL.revokeObjectURL(Z)}catch(e){console.error("Export failed",e),alert("Export failed. See console for details.")}}}class Kt{gameState;renderer;pendingDialogAction;constructor(e,t){this.gameState=e,this.renderer=t,this.pendingDialogAction=null}showDialog(e,t={}){const a=Object.keys(t).length>0?{...t}:null,i=a?.pauseReason||"dialog";a&&(a.pauseReason=i),this.gameState.pauseGame(i),this.pendingDialogAction=a,this.gameState.setDialog(!0,e,a)}completeDialog(){const e=$;if(this.pendingDialogAction?.setVariableId&&this.pendingDialogAction.rewardAllowed!==!1){const[,t]=this.gameState.setVariableValue?.(this.pendingDialogAction.setVariableId,!0)||[];t&&this.renderer.setIconOverPlayer(e.DOOR_VARIABLE)}this.pendingDialogAction=null}closeDialog(){if(!this.gameState.getDialog().active)return;const e=this.pendingDialogAction;this.completeDialog(),this.gameState.setDialog(!1);const t=e?.pauseReason||"dialog";this.gameState.resumeGame(t),this.renderer.draw()}reset(){const e=this.pendingDialogAction;this.pendingDialogAction=null;const t=e?.pauseReason||"dialog";this.gameState.resumeGame(t)}}const ie={None:"none",Moved:"moved",Collided:"collided"},me=(m,e="")=>K.get(m,e)||e||"",Wt=(m,e={},t="")=>K.format(m,e,t)||t||"";class Yt{gameState;renderer;tileManager;onPlayerDefeated;interval;enemyMoveTimer;directions;dialogManager;fallbackMissChance;constructor(e,t,n,a={}){this.gameState=e,this.renderer=t,this.tileManager=n,this.onPlayerDefeated=a.onPlayerDefeated||(()=>{}),this.interval=a.interval||E.enemy.movementInterval,this.enemyMoveTimer=null,this.directions=a.directions||this.defaultDirections(),this.dialogManager=a.dialogManager||null,this.fallbackMissChance=this.normalizeMissChance(a.missChance===void 0?E.enemy.fallbackMissChance:a.missChance)}getEnemyDefinitions(){return this.gameState.getEnemyDefinitions()}getActiveEnemies(){return this.gameState.getEnemies()}addEnemy(e){const t=e.id||this.generateEnemyId(),n=this.normalizeEnemyType(e.type),a=this.gameState.addEnemy({id:t,type:n,roomIndex:e.roomIndex??0,x:e.x,y:e.y,lastX:e.lastX??e.x,defeatVariableId:e.defeatVariableId??null});return a?(this.renderer.draw(),a):null}removeEnemy(e){this.gameState.removeEnemy(e),this.renderer.draw()}generateEnemyId(){const e=typeof crypto<"u"?crypto:globalThis.crypto;if(e){const t=e.randomUUID;if(typeof t=="function")return t.call(e)}return`enemy-${Math.random().toString(36).slice(2,10)}`}start(){this.enemyMoveTimer&&clearInterval(this.enemyMoveTimer),this.enemyMoveTimer=setInterval(()=>this.tick(),this.interval)}stop(){this.enemyMoveTimer&&(clearInterval(this.enemyMoveTimer),this.enemyMoveTimer=null)}tick(){if(!this.gameState.playing||this.gameState.isEditorModeActive())return;const e=this.gameState.getEnemies();if(!this.hasMovableEnemies(e))return;const t=this.gameState.getGame(),n=this.gameState.getPlayer();this.evaluateVision(n);let a=!1;for(let i=0;i<e.length;i++){const r=e[i],s=r.playerInVision?this.tryChaseEnemy(r,i,t,n,e):this.tryMoveEnemy(e,i,t);if(s===ie.Moved)a=!0;else if(s===ie.Collided){a=!0;break}}a&&this.renderer.draw()}handleEnemyCollision(e){if(this.gameState.isPlayerOnDamageCooldown()){this.renderer.showCombatIndicator(me("combat.cooldown",""),{duration:700});return}const t=this.gameState.getEnemies();if(e<0||e>=t.length)return;const n=t[e];if(n.type=this.normalizeEnemyType(n.type),this.canAssassinate(n)){this.assassinateEnemy(e);return}const a=this.getEnemyMissChance(n.type),i=this.attackMissed(a);if(t.splice(e,1),i)this.showMissFeedback();else{const l=this.getEnemyDamage(n.type),o=this.gameState.damagePlayer(l),c=this.gameState.consumeLastDamageReduction();if(this.gameState.consumeRecentReviveFlag()&&this.renderer.showCombatIndicator(me("skills.necromancer.revive",""),{duration:900}),c>0){const u=c>=l?me("combat.block.full",""):Wt("combat.block.partial",{value:c},"");this.renderer.showCombatIndicator(u,{duration:700})}if(o<=0){this.onPlayerDefeated();return}}const r=this.getExperienceReward(n.type);this.gameState.handleEnemyDefeated(r)?.leveledUp&&this.shouldStartLevelOverlay()&&this.gameState.startLevelUpSelectionIfNeeded(),this.tryTriggerDefeatVariable(n),this.renderer.flashScreen({intensity:.8,duration:160}),this.checkAllEnemiesCleared(),this.renderer.draw()}checkCollisionAt(e,t){const n=this.gameState.getEnemies(),a=this.gameState.getPlayer().roomIndex,i=n.findIndex(r=>r.roomIndex===a&&r.x===e&&r.y===t);if(i!==-1){const r=n[i];if(this.canAssassinate(r)){this.assassinateEnemy(i);return}this.handleEnemyCollision(i)}}clamp(e,t,n){return Math.max(t,Math.min(n,e))}getRoomSize(){return 8}defaultDirections(){return[[0,0],[1,0],[-1,0],[0,1],[0,-1]]}hasMovableEnemies(e){return Array.isArray(e)&&e.length>0}tryMoveEnemy(e,t,n){if(t<0||t>=e.length)return ie.None;const a=e[t];if(a.type=this.normalizeEnemyType(a.type),a.playerInVision)return ie.None;const i=this.pickRandomDirection(),r=this.getTargetPosition(a,i),s=a.roomIndex;return this.canEnterTile(s,r.x,r.y,n,e,t)?(a.lastX=a.x,a.x=r.x,a.y=r.y,this.resolvePostMove(s,r.x,r.y,t)?ie.Collided:ie.Moved):ie.None}pickRandomDirection(){const e=this.directions;return e[Math.floor(Math.random()*e.length)]}getTargetPosition(e,t){const n=this.getRoomSize();return{x:this.clamp(e.x+t[0],0,n-1),y:this.clamp(e.y+t[1],0,n-1)}}tryChaseEnemy(e,t,n,a,i){const r=this.getChaseDirections(e,a);for(const s of r){const l=this.getTargetPosition(e,s),o=e.roomIndex;if(this.canEnterTile(o,l.x,l.y,n,i,t))return e.lastX=e.x,e.x=l.x,e.y=l.y,this.resolvePostMove(o,l.x,l.y,t)?ie.Collided:ie.Moved}return ie.None}moveChasingEnemies(e){if(!e)return;const t=this.getActiveEnemies(),n=this.gameState.getGame();let a=!1;for(let i=0;i<t.length;i+=1){const r=t[i];if(!r.playerInVision)continue;const s=this.tryChaseEnemy(r,i,n,e,t);if(s===ie.Moved)a=!0;else if(s===ie.Collided){a=!0;break}}a&&this.renderer.draw()}evaluateVision(e){if(!e)return;const t=this.getNow(),n=this.getActiveEnemies(),a=E.enemy.vision.range,i=E.enemy.vision.alertDuration;for(const r of n){if(r.roomIndex!==e.roomIndex){r.playerInVision=!1,r.alertStart=null,r.alertUntil=null;continue}const s=Math.abs(e.x-r.x),l=Math.abs(e.y-r.y);s<=a&&l<=a?r.playerInVision||(r.playerInVision=!0,r.alertStart=t,r.alertUntil=t+i):(r.playerInVision=!1,r.alertStart=null,r.alertUntil=null)}}getChaseDirections(e,t){const n=t.x-e.x,a=t.y-e.y,i=[],r=Math.sign(n),s=Math.sign(a);return Math.abs(n)>=Math.abs(a)?(r&&i.push([r,0]),s&&i.push([0,s])):(s&&i.push([0,s]),r&&i.push([r,0])),r&&!i.some(l=>l[0]===r&&l[1]===0)&&i.push([r,0]),s&&!i.some(l=>l[0]===0&&l[1]===s)&&i.push([0,s]),i.length||i.push([0,0]),i}canEnterTile(e,t,n,a,i,r){if(e<0||e>=a.rooms.length)return!1;const l=a.rooms[e].walls;return l&&Array.isArray(l[n])&&l[n][t]||this.isTileBlocked(e,t,n)||this.hasBlockingObject(e,t,n)?!1:!this.isOccupied(i,r,e,t,n)}isTileBlocked(e,t,n){const a=this.tileManager.getTileMap(e);if(!a)return!1;const i=Array.isArray(a.ground)?a.ground[n]:void 0,r=Array.isArray(a.overlay)?a.overlay[n]:void 0,s=i?i[t]:null,o=(r?r[t]:null)??s;if(o===null)return!1;const c=this.tileManager.getTile(o);return!!(c&&c.collision)}hasBlockingObject(e,t,n){const a=$,i=this.gameState.getObjectAt(e,t,n);return i?i.type===a.DOOR&&!i.opened?!0:i.type===a.DOOR_VARIABLE?!(i.variableId?this.gameState.isVariableOn(i.variableId):!1):!1:!1}isOccupied(e,t,n,a,i){return e.some((r,s)=>s!==t&&r.roomIndex===n&&r.x===a&&r.y===i)}resolvePostMove(e,t,n,a){const i=this.gameState.getPlayer();return i.roomIndex===e&&i.x===t&&i.y===n?(this.tryStealthAssassination(a)||this.handleEnemyCollision(a),!0):!1}collideAt(e,t,n){const i=this.gameState.getEnemies().findIndex(r=>r.roomIndex===e&&r.x===t&&r.y===n);return i===-1?!1:(this.handleEnemyCollision(i),!0)}normalizeEnemyType(e){return te.normalizeType(e)}getEnemyDefinition(e){return te.getEnemyDefinition(e)}enemyHasEyes(e){const t=this.getEnemyDefinition(e.type);return t?t.hasEyes!==!1:!0}canAssassinate(e){return this.gameState.hasSkill("stealth")?this.getEnemyDamage(e.type)<=2:!1}tryStealthAssassination(e){const t=this.gameState.getEnemies();if(e<0||e>=t.length)return!1;const n=t[e];return this.canAssassinate(n)?Math.random()<E.enemy.stealthMissChance?(this.showStealthMissFeedback(),!1):(this.assassinateEnemy(e),!0):!1}assassinateEnemy(e){const t=this.gameState.getEnemies();if(e<0||e>=t.length)return;const n=t[e],a=this.normalizeEnemyType(n.type);t.splice(e,1);const i=this.getExperienceReward(a);this.gameState.handleEnemyDefeated(i)?.leveledUp&&this.shouldStartLevelOverlay()&&this.gameState.startLevelUpSelectionIfNeeded(),this.tryTriggerDefeatVariable({...n,type:a}),this.showStealthKillFeedback(),this.renderer.flashScreen({intensity:.4,duration:120}),this.checkAllEnemiesCleared(),this.renderer.draw()}showStealthKillFeedback(){const e=me("combat.stealthKill","");e&&this.renderer.showCombatIndicator(e,{duration:800})}showStealthMissFeedback(){const e=me("combat.stealthMiss","");e&&this.renderer.showCombatIndicator(e,{duration:800})}shouldStartLevelOverlay(){return this.gameState.getPendingLevelUpChoices()>0}getEnemyDamage(e){const t=this.getEnemyDefinition(e);return t&&typeof t.damage=="number"&&Number.isFinite(t.damage)?Math.max(1,t.damage):1}getExperienceReward(e){return te.getExperienceReward(e)}getEnemyMissChance(e){const t=te.getMissChance(e);return t!==null?this.normalizeMissChance(t):this.fallbackMissChance}checkAllEnemiesCleared(){if(this.gameState.getEnemies().length<=0){const t=me("game.clearAllEnemies","");t&&this.dialogManager&&this.dialogManager.showDialog&&this.dialogManager.showDialog(t)}}normalizeMissChance(e){const t=Number(e);return Number.isFinite(t)?Math.max(0,Math.min(1,t)):.25}attackMissed(e){let t;return e===void 0?(t=this.normalizeMissChance(this.fallbackMissChance),this.fallbackMissChance=t):t=this.normalizeMissChance(e),t<=0?!1:t>=1?!0:Math.random()<t}getDefeatVariableConfig(e){const t=this.getEnemyDefinition(e.type),n=t?.activateVariableOnDefeat&&typeof t.activateVariableOnDefeat=="object"?t.activateVariableOnDefeat:null;let a=typeof e.defeatVariableId=="string"?e.defeatVariableId:null;if(a||(a=typeof n?.variableId=="string"?n.variableId:null),a=this.gameState.normalizeVariableId(a),!a)return null;const i=n?.persist!==void 0?!!n.persist:!0;let r=null;return typeof n?.message=="string"&&n.message.trim().length?r=n.message.trim():n?.messageKey?r=me(n.messageKey,n.message||""):t?.defeatActivationMessageKey?r=me(t.defeatActivationMessageKey,t.defeatActivationMessage?.trim()||""):typeof t?.defeatActivationMessage=="string"&&t.defeatActivationMessage.trim().length&&(r=t.defeatActivationMessage.trim()),{variableId:a,persist:i,message:r}}tryTriggerDefeatVariable(e){const t=this.getDefeatVariableConfig(e);if(!t)return!1;const[n]=this.gameState.setVariableValue(t.variableId,!0,t.persist),a=this.gameState.isVariableOn(t.variableId);return!n&&!a?!1:(t.message&&this.renderer.showCombatIndicator(t.message,{duration:900}),!0)}showMissFeedback(){this.renderer.showCombatIndicator("Miss",{duration:500})}getNow(){const e=globalThis.performance;return e?e.now():Date.now()}}class Xt{gameState;dialogManager;options;constructor(e,t,n={}){this.gameState=e,this.dialogManager=t,this.options=n}get types(){return $}handlePlayerInteractions(){const e=this.gameState.getGame(),t=this.gameState.getPlayer();if(!t)return;const n=Array.isArray(e.items)?e.items:[],a=Array.isArray(e.sprites)?e.sprites:[],i=Array.isArray(e.exits)?e.exits:[],r=Array.isArray(e.rooms)?e.rooms:[];this.checkItems(n,t),this.checkObjects(t),this.checkNpcs(a,t),this.checkRoomExits(i,r,t)}checkItems(e,t){if(Array.isArray(e))for(const n of e){if(!(n.roomIndex===t.roomIndex&&n.x===t.x&&n.y===t.y)||n.collected)continue;n.collected=!0;const i=typeof n.text=="string"?n.text:this.getInteractionText("objects.item.pickup","");i&&this.dialogManager.showDialog(i);break}}checkObjects(e){const t=this.gameState.getObjectsForRoom?.(e.roomIndex)||[];for(const n of t)if(!(n.x!==e.x||n.y!==e.y)&&(this.handleCollectibleObject(n)||this.handleSwitch(n)||this.handlePlayerEnd(n)))break}handleCollectibleObject(e){if(e.collected)return!1;const t=this.types;switch(e.type){case t.KEY:return e.collected=!0,this.showPickupOverlay(e.type,()=>{this.gameState.addKeys?.(1)}),!0;case t.LIFE_POTION:{const n=this.gameState.getLives?.(),a=this.gameState.getMaxLives?.(),i=this.gameState.hasSkill?.("potion-master");return typeof n=="number"&&typeof a=="number"&&Number.isFinite(n)&&Number.isFinite(a)&&n>=a?!1:(e.collected=!0,this.showPickupOverlay(e.type,()=>{i?this.gameState.healPlayerToFull?.():this.gameState.addLife?.(1)}),!0)}case t.XP_SCROLL:return e.collected=!0,this.showPickupOverlay(e.type,()=>{const n=this.gameState.getExperienceToNext?.()??0,a=n>0?Math.max(1,Math.floor(n*.5)):0;this.gameState.addExperience?.(a)}),!0;case t.SWORD:case t.SWORD_BRONZE:case t.SWORD_WOOD:{if(!this.shouldPickupSword(e.type))return!1;const n=this.getSwordDurability(e.type);return e.collected=!0,this.showPickupOverlay(e.type,()=>{this.gameState.addDamageShield?.(n,e.type)}),!0}default:return!1}}getSwordDurability(e){const t=Q.getSwordDurability(e);return typeof t=="number"&&Number.isFinite(t)?Math.max(0,t):0}getSwordPriority(e){const t=this.types;return{[t.SWORD_WOOD]:1,[t.SWORD_BRONZE]:2,[t.SWORD]:3}[e]||0}shouldPickupSword(e){const t=this.gameState.getSwordType?.()||null,n=this.getSwordPriority(t||"");return this.getSwordPriority(e)>n}showPickupOverlay(e,t=null){const n=this.getObjectDisplayName(e);this.gameState.showPickupOverlay?.({name:n,spriteGroup:"object",spriteType:e,effect:t})}getObjectDisplayName(e){const t=Q.getItemDefinition(e);return t?t.nameKey?K.get(t.nameKey,t.name||e):t.name?t.name:e:e}getInteractionText(e,t=""){return K.get(e,t)||t||""}formatInteractionText(e,t={},n=""){return K.format(e,t,n)||n||""}handleSwitch(e){const t=this.types;if(e.type!==t.SWITCH)return!1;e.on=!e.on;const n=this.gameState.normalizeVariableId?.(e.variableId??null)??null;n&&this.gameState.setVariableValue?.(n,e.on);const a=e.on?this.getInteractionText("objects.switch.onMessage",""):this.getInteractionText("objects.switch.offMessage","");return a&&this.dialogManager.showDialog(a),!0}handlePlayerEnd(e){const t=this.types;if(e.type!==t.PLAYER_END)return!1;const n=this.gameState.getPlayerEndText(e.roomIndex);return this.gameState.setActiveEndingText?.(n||""),this.options?.onPlayerVictory?.(),!0}checkNpcs(e,t){for(const n of e){if(!n.placed||!(n.roomIndex===t.roomIndex&&n.x===t.x&&n.y===t.y))continue;const i=this.getNpcDialogText(n),r=this.getNpcDialogMeta(n);this.dialogManager.showDialog(i,r);break}}getNpcDialogText(e){const t=e.conditionVariableId||null,n=t==="skill:bard",a=n?null:this.gameState.normalizeVariableId?.(t)??null,i=typeof e.conditionText=="string"&&e.conditionText.trim().length>0,r=this.gameState.hasSkill?.("charisma");return i&&(n&&r||a&&this.gameState.isVariableOn?.(a))&&i?e.conditionText??"":typeof e.text=="string"&&e.text.trim()?e.text:e.text||"Hello!"}getNpcDialogMeta(e){const t=e.conditionVariableId||null,n=t==="skill:bard",a=n?null:this.gameState.normalizeVariableId?.(t)??null,i=this.gameState.normalizeVariableId?.(e.rewardVariableId??null)??null,r=this.gameState.normalizeVariableId?.(e.conditionalRewardVariableId??null)??null,s=typeof e.conditionText=="string"&&e.conditionText.trim().length>0,l=this.gameState.hasSkill?.("charisma"),o=s&&(n&&l||a&&this.gameState.isVariableOn?.(a));if(o&&r)return{setVariableId:r,rewardAllowed:!0};if(!o&&i)return{setVariableId:i,rewardAllowed:!0}}checkRoomExits(e,t,n){if(Array.isArray(e)){for(const a of e)if(a.roomIndex===n.roomIndex&&a.x===n.x&&a.y===n.y){t[a.targetRoomIndex]&&this.gameState.setPlayerPosition(this.clamp(a.targetX,0,7),this.clamp(a.targetY,0,7),a.targetRoomIndex);break}}}clamp(e,t,n){return Math.max(t,Math.min(n,e))}}const Ie=(m,e="")=>K.get(m,e)||e||"",$t=(m,e={},t="")=>K.format(m,e,t)||t||"";class qt{gameState;tileManager;renderer;dialogManager;interactionManager;enemyManager;transitioning;constructor({gameState:e,tileManager:t,renderer:n,dialogManager:a,interactionManager:i,enemyManager:r}){this.gameState=e,this.tileManager=t,this.renderer=n,this.dialogManager=a,this.interactionManager=i,this.enemyManager=r,this.transitioning=!1}tryMove(e,t){if(this.transitioning||this.gameState.isGameOver()||this.gameState.isLevelUpCelebrationActive?.()||this.gameState.isLevelUpOverlayActive?.()||this.gameState.isPickupOverlayActive?.())return;const n=this.gameState.getDialog();if(n.active){if(n.page>=n.maxPages){this.dialogManager.closeDialog();return}this.gameState.setDialogPage(n.page+1),this.renderer.draw();return}const a=this.gameState.getPlayer();if(!a)return;const i=this.getDirectionFromDelta(e,t),r=a.roomIndex,s={x:a.x,y:a.y,roomIndex:r,lastX:a.lastX??a.x,facingLeft:a.x<(a.lastX??a.x)},l=this.gameState.getRoomCoords(r),o=this.gameState.game.roomSize-1;let c=r,d=a.x+e,u=a.y+t;if(d<0){const w=l.col-1,k=this.gameState.getRoomIndex(l.row,w);k!==null?(c=k,d=o):d=0}else if(d>o){const w=l.col+1,k=this.gameState.getRoomIndex(l.row,w);k!==null?(c=k,d=0):d=o}if(u<0){const w=l.row-1,k=this.gameState.getRoomIndex(w,l.col);k!==null?(c=k,u=o):u=0}else if(u>o){const w=l.row+1,k=this.gameState.getRoomIndex(w,l.col);k!==null?(c=k,u=0):u=o}const h=c!==r,f=this.gameState.getGame().rooms?.[c];if(!f){h&&this.flashBlockedEdge(i,{x:d,y:u});return}if(f.walls?.[u]?.[d]){h&&this.flashBlockedEdge(i,{x:d,y:u});return}const v=this.gameState.getObjectAt(c,d,u)??null;if(!!v?.isVariableDoor){const w=v?.variableId;if(!(w?this.gameState.isVariableOn(w):!1)){this.dialogManager.showDialog(Ie("doors.variableLocked")),this.renderer.draw();return}}if(!!v?.isLockedDoor&&!v?.opened){const w=this.gameState.hasSkill?.("keyless-doors");let k=!1,Z=!1;if(w?k=!0:Z=this.gameState.consumeKey(),k||Z){v&&(v.opened=!0);const J=Number(this.gameState.getKeys()),N=k?Ie("doors.unlockedSkill",Ie("doors.opened","")):Number.isFinite(J)?$t("doors.openedRemaining",{value:J}):Ie("doors.opened");N&&this.dialogManager.showDialog(N)}else{this.dialogManager.showDialog(Ie("doors.locked")),this.renderer.draw();return}}const x=this.tileManager.getTileMap(c),T=x?.overlay?.[u]?.[d]??null,L=x?.ground?.[u]?.[d]??null,C=T??L;if(C!==null){const w=this.tileManager.getTile(C);if(w?.collision&&!this.canTraverseCollisionTile(w)){h&&this.flashBlockedEdge(i,{x:d,y:u});return}}const _=this.findNpcAt(c,d,u);if(_){const w=this.interactionManager.getNpcDialogText?this.interactionManager.getNpcDialogText(_):_.text||"",k=this.interactionManager.getNpcDialogMeta?this.interactionManager.getNpcDialogMeta(_):void 0;w&&(this.dialogManager.showDialog(w,k),this.renderer.draw());return}if(!h&&(this.enemyManager.collideAt(c,d,u)||!1)){this.renderer.draw();return}const z=h,Y=z?this.renderer.captureGameplayFrame():null;if(this.gameState.setPlayerPosition(d,u,c!==r?c:null),h){const w=this.gameState.getPlayer();w&&(e!==0?w.lastX=w.x-Math.sign(e):w.lastX=s.lastX,w.lastRoomChangeTime=Date.now())}this.interactionManager.handlePlayerInteractions();const H=this.gameState.getPlayer();if(H&&(this.enemyManager.checkCollisionAt(H.x,H.y),this.enemyManager.evaluateVision?.(H)),z&&Y){this.renderer.draw();const w=this.renderer.captureGameplayFrame();if(w&&this.renderer.startRoomTransition({direction:i,fromFrame:Y,toFrame:w,playerPath:{from:s,to:{x:d,y:u,roomIndex:c},facingLeft:e<0?!0:e>0?!1:s.facingLeft},onComplete:()=>{this.transitioning=!1,this.renderer.draw()}})){this.transitioning=!0;return}}this.renderer.draw()}getDirectionFromDelta(e,t){return e<0?"left":e>0?"right":t<0?"up":t>0?"down":""}canTraverseCollisionTile(e=null){if(!e?.collision)return!0;const t=(s="")=>s.toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""),n=t(e.category||""),a=t(e.name||""),i=n==="agua"||a.includes("agua"),r=n==="perigo"||a.includes("lava");return!!(i&&this.gameState.hasSkill?.("water-walker")||r&&this.gameState.hasSkill?.("lava-walker"))}flashBlockedEdge(e,t=null){e&&(this.renderer.flashEdge(e,{duration:E.transitions.blockedMovementDuration,tileX:t?.x,tileY:t?.y}),this.renderer.draw())}findNpcAt(e,t,n){return(this.gameState.getGame().sprites||[]).find(i=>i.placed&&i.roomIndex===e&&i.x===t&&i.y===n)||null}}class Jt{gameState;screenManager;pauseReasons;timeToResetAfterGameOver;constructor(e,t,n={}){this.gameState=e,this.screenManager=t,this.pauseReasons=new Set;const a=n.timeToResetAfterGameOver;typeof a=="number"&&Number.isFinite(a)?this.timeToResetAfterGameOver=Math.max(0,a):this.timeToResetAfterGameOver=2e3}pauseGame(e="manual"){const t=e||"manual";this.pauseReasons.add(t),this.updatePlayingLock()}resumeGame(e="manual"){e==null?this.pauseReasons.clear():this.pauseReasons.delete(e),this.updatePlayingLock()}updatePlayingLock(){this.gameState.playing=this.pauseReasons.size===0}setGameOver(e=!0,t="defeat"){const n=this.gameState.state,a=!!e;a&&this.screenManager.startGameOverCooldown(this.timeToResetAfterGameOver),n.gameOver=a,n.gameOverReason=a?t||"defeat":null}isGameOver(){return!!this.gameState.state.gameOver}getGameOverReason(){return this.gameState.state.gameOverReason||"defeat"}}class Zt{gameState;canResetAfterGameOver;lastEndingText;gameOverResetTimer;constructor(e){this.gameState=e,this.canResetAfterGameOver=!1,this.lastEndingText="",this.gameOverResetTimer=null}reset(){this.lastEndingText="",this.clearGameOverCooldown(),this.canResetAfterGameOver=!1}setActiveEndingText(e=""){const t=typeof e=="string"?e.trim():"";return this.lastEndingText=t,this.lastEndingText}getActiveEndingText(){return this.lastEndingText}startGameOverCooldown(e){this.canResetAfterGameOver=!1,this.clearGameOverCooldown();const t=Number.isFinite(e)?Math.max(0,e):0;this.gameOverResetTimer=setTimeout(()=>{this.canResetAfterGameOver=!0,this.gameOverResetTimer=null},t)}clearGameOverCooldown(){this.gameOverResetTimer&&(clearTimeout(this.gameOverResetTimer),this.gameOverResetTimer=null)}}class Qt{gameState;dataManager;constructor(e,t){this.gameState=e,this.dataManager=t}exportGameData(){return this.dataManager.exportGameData()}importGameData(e){this.dataManager.importGameData(e),this.gameState.enemyManager.setGame(this.gameState.game),this.gameState.itemManager.setGame(this.gameState.game),this.gameState.objectManager.setGame(this.gameState.game),this.gameState.variableManager.setGame(this.gameState.game),this.gameState.ensureDefaultVariables(),this.gameState.resetGame()}}class en{gameState;worldManager;constructor(e,t){this.gameState=e,this.worldManager=t}createEmptyRoom(e,t=0,n=1){return this.worldManager.createEmptyRoom(e,t,n)}createWorldRooms(e,t,n){return this.worldManager.createWorldRooms(e,t,n)}createEmptyTileMap(e){return this.worldManager.createEmptyTileMap(e)}normalizeRooms(e,t,n){return this.worldManager.normalizeRooms(e,t,n)}normalizeTileMaps(e,t){return this.worldManager.normalizeTileMaps(e,t)}}class tn{game;worldManager;objectManager;variableManager;constructor({game:e,worldManager:t,objectManager:n,variableManager:a}){this.game=e,this.worldManager=t,this.objectManager=n,this.variableManager=a}setGame(e){this.game=e}setWorldManager(e){this.worldManager=e}setObjectManager(e){this.objectManager=e}setVariableManager(e){this.variableManager=e}exportGameData(){return{title:this.game.title,author:this.game.author,palette:this.game.palette,customPalette:this.game.customPalette,roomSize:this.game.roomSize,world:this.game.world,rooms:this.game.rooms,start:this.game.start,sprites:this.game.sprites,enemies:this.game.enemies,items:this.game.items,objects:this.game.objects,variables:this.game.variables,exits:this.game.exits,tileset:this.game.tileset}}importGameData(e){if(!e)return null;const t=3,n=3,a=t*n,i=Array.isArray(this.game.tileset.tiles)?this.game.tileset.tiles:[],r=Array.isArray(e.tileset?.tiles)?e.tileset.tiles:i,s=this.worldManager.normalizeRooms(e.rooms,a,n),l=this.worldManager.normalizeTileMaps(e.tileset?.maps??e.tileset?.map??null,a),o=this.objectManager.normalizeObjects(e.objects),c=this.variableManager.normalizeVariables(e.variables),d=Array.isArray(e.customPalette)&&e.customPalette.length===16?e.customPalette.slice(0,16):void 0;Object.assign(this.game,{title:typeof e.title=="string"?e.title.slice(0,18):"My Tiny RPG Game",author:typeof e.author=="string"?e.author.slice(0,18):"",palette:Array.isArray(e.palette)&&e.palette.length>=3?e.palette.slice(0,3):["#000000","#1D2B53","#FFF1E8"],customPalette:d,roomSize:8,world:{rows:t,cols:n},rooms:s,start:e.start||{x:1,y:1,roomIndex:0},sprites:Array.isArray(e.sprites)?e.sprites:[],enemies:Array.isArray(e.enemies)?e.enemies:[],items:Array.isArray(e.items)?e.items:[],objects:o,variables:c,exits:Array.isArray(e.exits)?e.exits:[],tileset:{tiles:r,maps:l}}),this.game.tileset.map=this.game.tileset.maps[0];const u={x:this.worldManager.clampCoordinate(e.start?.x??1),y:this.worldManager.clampCoordinate(e.start?.y??1),roomIndex:this.worldManager.clampRoomIndex(e.start?.roomIndex??0)};return this.game.start=u,this.worldManager.setGame(this.game),this.objectManager.setGame(this.game),this.variableManager.setGame(this.game),u}}class nn{state;constructor(e){this.state=e}setState(e){this.state=e}get dialog(){return this.state?.dialog??null}getDialog(){return this.dialog??{active:!1,text:"",page:1,maxPages:1,meta:null}}setDialog(e,t="",n=null){const a=this.dialog;if(a){if(!e){a.active=!1,a.text="",a.page=1,a.maxPages=1,a.meta=null;return}a.active=!0,a.text=t,a.page=1,a.maxPages=1,a.meta=n||null}}setPage(e){const t=this.dialog;if(!t)return;const n=Number(e);if(!Number.isFinite(n))return;const a=Math.max(1,t.maxPages||1),i=Math.min(Math.max(1,Math.floor(n)),a);t.page=i}reset(){this.setDialog(!1)}}class an{game;state;worldManager;constructor(e,t,n){this.game=e,this.state=t,this.worldManager=n}setGame(e){this.game=e}setState(e){this.state=e}setWorldManager(e){this.worldManager=e}cloneEnemies(e){const t=[];return(e||[]).forEach(n=>{const a=this.normalizeEnemyType(n.type);if(this.isBossType(a)){const i=t.findIndex(r=>r.type===a);i!==-1&&t.splice(i,1)}t.push({id:n.id,type:a,roomIndex:this.worldManager.clampRoomIndex(n.roomIndex),x:this.worldManager.clampCoordinate(n.x),y:this.worldManager.clampCoordinate(n.y),lastX:this.worldManager.clampCoordinate(n.x),lives:n.lives,defeatVariableId:this.normalizeEnemyVariableId(n.defeatVariableId),playerInVision:!1,alertUntil:null,alertStart:null})}),t}resetRuntime(){return!this.state||!this.game?[]:(this.state.enemies=this.cloneEnemies(this.game.enemies),this.state.enemies)}getEnemies(){return this.state?.enemies??[]}getEnemyDefinitions(){return this.game?.enemies??[]}addEnemy(e){if(!this.game||!this.state)return null;const t=this.normalizeEnemyType(e.type);this.isBossType(t)&&(this.game.enemies=this.game.enemies.filter(l=>this.normalizeEnemyType(l.type)!==t),this.state.enemies=this.state.enemies.filter(l=>this.normalizeEnemyType(l.type)!==t));const n=this.worldManager.clampRoomIndex(e.roomIndex);if(this.game.enemies.reduce((l,o)=>this.worldManager.clampRoomIndex(o.roomIndex)===n?l+1:l,0)>=6)return null;const r={id:e.id,type:t,roomIndex:n,x:this.worldManager.clampCoordinate(e.x),y:this.worldManager.clampCoordinate(e.y),lastX:this.worldManager.clampCoordinate(e.x),defeatVariableId:this.normalizeEnemyVariableId(e.defeatVariableId)},s={...r,playerInVision:!1,alertUntil:null,alertStart:null};return this.game.enemies.push(r),this.state.enemies.push(s),r.id}removeEnemy(e){!this.game||!this.state||(this.game.enemies=this.game.enemies.filter(t=>t.id!==e),this.state.enemies=this.state.enemies.filter(t=>t.id!==e))}setEnemyPosition(e,t,n,a=null){const i=this.getEnemies().find(r=>r.id===e);i&&(i.lastX=i.x,i.x=this.worldManager.clampCoordinate(t),i.y=this.worldManager.clampCoordinate(n),a!==null&&(i.roomIndex=this.worldManager.clampRoomIndex(a)))}setEnemyVariable(e,t=null){if(!this.game||!this.state)return!1;const n=this.normalizeEnemyVariableId(t);let a=!1;const i=this.game.enemies.find(s=>s.id===e);i&&i.defeatVariableId!==n&&(i.defeatVariableId=n,a=!0);const r=this.state.enemies.find(s=>s.id===e);return r&&r.defeatVariableId!==n&&(r.defeatVariableId=n,a=!0),a}normalizeEnemyType(e){return te.normalizeType(e)}isBossType(e){return!!te.getEnemyDefinition(e)?.boss}normalizeEnemyVariableId(e){return typeof e!="string"||!this.game?null:this.game.variables.some(n=>n.id===e)?e:null}}class rn{game;constructor(e){this.game=e}setGame(e){this.game=e}resetItems(){Array.isArray(this.game.items)&&this.game.items.forEach(e=>{e.collected=!1})}}class sn{state;worldManager;skillManager;maxLevel;baseMaxLives;experienceBase;experienceGrowth;maxKeys;roomChangeDamageCooldown;constructor(e,t,n=null){this.state=e,this.worldManager=t,this.skillManager=n,this.maxLevel=E.player.maxLevel,this.baseMaxLives=E.player.baseMaxLives,this.experienceBase=E.player.experienceBase,this.experienceGrowth=E.player.experienceGrowth,this.maxKeys=E.player.maxKeys,this.roomChangeDamageCooldown=E.player.roomChangeDamageCooldown}setState(e){this.state=e}setWorldManager(e){this.worldManager=e}setSkillManager(e){this.skillManager=e}get player(){return this.state?.player??null}getPlayer(){return this.player}setPosition(e,t,n=null){this.player&&(this.player.lastX=this.player.x,this.player.x=this.worldManager.clampCoordinate(e),this.player.y=this.worldManager.clampCoordinate(t),n!==null&&(this.player.roomIndex=this.worldManager.clampRoomIndex(n)),this.ensurePlayerStats())}reset(e){const t=e||{x:1,y:1,roomIndex:0};this.setPosition(t.x,t.y,t.roomIndex),this.player&&(this.player.level=1,this.player.maxLives=this.calculateMaxLives(this.player.level),this.player.currentLives=this.player.maxLives,this.player.lives=this.player.currentLives,this.player.keys=0,this.player.experience=0,this.player.damageShield=0,this.player.damageShieldMax=0,this.player.swordType=null,this.player.lastDamageReduction=0,this.player.godMode=!1)}setLevel(e=1){if(!this.player)return 1;const t=this.clampLevel(e);return this.player.level=t,this.player.experience=0,this.player.maxLives=this.calculateMaxLives(t),this.player.currentLives=this.player.maxLives,this.player.lives=this.player.currentLives,this.ensurePlayerStats(),t}setGodMode(e=!1){return this.player?(this.player.godMode=!!e,this.player.godMode&&(this.player.currentLives=this.player.maxLives,this.player.lives=this.player.currentLives),this.player.godMode):!1}isGodMode(){return!!this.player?.godMode}addKeys(e=1){if(!this.player)return 0;const t=Number(e);if(!Number.isFinite(t))return this.player.keys;const n=Math.floor(t),a=Math.max(0,this.player.keys+n);return this.player.keys=Math.min(this.maxKeys,a),this.player.keys}consumeKey(){return!this.player||this.player.keys<=0?!1:(this.player.keys-=1,!0)}getKeys(){return this.player?.keys??0}getMaxKeys(){return this.maxKeys}damage(e=1){if(!this.player)return 0;this.ensurePlayerStats();let t=Number.isFinite(e)?Math.max(0,e):1;if(this.skillManager?.hasSkill?.("iron-body")&&(t=Math.max(0,t-1)),this.player.godMode)return this.player.lastDamageReduction=t,this.player.currentLives=this.player.maxLives,this.player.lives=this.player.currentLives,this.player.currentLives;const n=Math.max(0,Number(this.player.damageShield)||0),a=Math.min(n,t),i=Math.max(0,t-a);return this.player.damageShield=Math.max(0,n-a),this.player.damageShield===0&&(this.player.damageShieldMax=0,this.player.swordType=null),this.player.lastDamageReduction=a,this.player.currentLives=Math.max(0,this.player.currentLives-i),this.player.currentLives<=0&&this.skillManager?.attemptRevive?.(this.player),this.player.lives=this.player.currentLives,this.player.currentLives}isOnDamageCooldown(){const e=Date.now(),t=this.player?.lastRoomChangeTime;return typeof t=="number"&&e-t<this.roomChangeDamageCooldown}addDamageShield(e=1,t=null){if(!this.player)return 0;const n=Number.isFinite(e)?Math.max(0,Math.floor(e)):0;if(n<=0)return Number.isFinite(this.player.damageShield)?Math.max(0,Math.floor(this.player.damageShield)):0;this.ensurePlayerStats();const a=Math.max(0,Number(this.player.damageShield)||0)+n;return this.player.damageShield=a,this.player.damageShieldMax=Math.max(a,n,Number(this.player.damageShieldMax)||0),t&&(this.player.swordType=t),a}getDamageShield(){return Math.max(0,Number(this.player?.damageShield)||0)}getDamageShieldMax(){return Math.max(0,Number(this.player?.damageShieldMax)||0)}getSwordType(){return typeof this.player?.swordType=="string"?this.player.swordType:null}consumeLastDamageReduction(){if(!this.player)return 0;this.ensurePlayerStats();const e=Math.max(0,Number(this.player.lastDamageReduction)||0);return this.player.lastDamageReduction=0,e}gainLives(e=1){if(!this.player)return 0;this.ensurePlayerStats();const t=Number.isFinite(e)?Math.max(0,Math.floor(e)):0;return t<=0?this.player.currentLives:(this.player.currentLives=Math.min(this.player.maxLives,this.player.currentLives+t),this.player.lives=this.player.currentLives,this.player.currentLives)}getLives(){return this.ensurePlayerStats(),this.player?.currentLives??0}getMaxLives(){return this.ensurePlayerStats(),this.player?.maxLives??0}getLevel(){return this.ensurePlayerStats(),this.player?.level??1}calculateMaxLives(e){const t=Number.isFinite(e)?Math.floor(e):1,n=this.skillManager?.getBonusMaxLives?.()||0;return this.baseMaxLives+Math.max(0,t-1)+n}clampLevel(e){const t=Number.isFinite(e)?Math.floor(e):1;return Math.max(1,Math.min(this.maxLevel,t))}ensurePlayerStats(){if(!this.player)return;const e=typeof this.player.level=="number"?this.player.level:1,t=this.clampLevel(e);this.player.level=t;const n=this.calculateMaxLives(t);this.player.maxLives=n;const a=Number.isFinite(this.player.currentLives)?Math.floor(this.player.currentLives):this.player.maxLives;this.player.currentLives=Math.max(0,Math.min(this.player.maxLives,a)),this.player.lives=this.player.currentLives;const i=Number.isFinite(this.player.experience)?Math.max(0,Math.floor(this.player.experience)):0;if(t>=this.maxLevel)this.player.experience=0;else{const r=this.getExperienceForNextLevel(t);this.player.experience=Math.min(i,Math.max(0,r-1))}Number.isFinite(this.player.damageShield)?this.player.damageShield=Math.max(0,Math.floor(this.player.damageShield)):this.player.damageShield=0,Number.isFinite(this.player.damageShieldMax)?this.player.damageShieldMax=Math.max(this.player.damageShield,Math.floor(this.player.damageShieldMax)):this.player.damageShieldMax=0,typeof this.player.swordType!="string"&&(this.player.swordType=null),this.player.damageShield<=0&&(this.player.swordType=null),Number.isFinite(this.player.lastDamageReduction)||(this.player.lastDamageReduction=0),this.player.godMode=!!this.player.godMode}healToFull(){return this.player?(this.ensurePlayerStats(),this.player.currentLives=this.player.maxLives,this.player.lives=this.player.currentLives,this.player.currentLives):this.getLives()}getExperience(){return this.ensurePlayerStats(),this.player?.experience??0}getExperienceForNextLevel(e){const t=this.clampLevel(e);if(t>=this.maxLevel)return 0;const n=Math.floor(this.experienceBase*Math.pow(this.experienceGrowth,t-1));return Math.max(5,n)}getExperienceToNext(){this.ensurePlayerStats();const e=this.player?.level??1;return this.getExperienceForNextLevel(e)}addExperience(e=0){if(!this.player)return{leveledUp:!1,levelsGained:0,level:0,experience:0,experienceToNext:0,currentLives:0,maxLives:0};this.ensurePlayerStats();let t=Number.isFinite(e)?Math.max(0,Math.floor(e)):0;const n=this.skillManager;if(n?.hasSkill?.("xp-boost")){const r=n.getXpBoost,s=r?r():0;s>0&&(t=Math.floor(t*(1+s)))}if(t<=0||this.player.level>=this.maxLevel)return this.player.level>=this.maxLevel&&(this.player.experience=0),{leveledUp:!1,levelsGained:0,level:this.player.level,experience:this.player.experience,experienceToNext:this.getExperienceToNext(),currentLives:this.player.currentLives,maxLives:this.player.maxLives};let a=this.player.experience+t,i=0;for(;this.player.level<this.maxLevel;){const r=this.getExperienceForNextLevel(this.player.level);if(a<r)break;a-=r,this.player.level+=1,i+=1,this.player.maxLives=this.calculateMaxLives(this.player.level),this.player.currentLives=this.player.maxLives,this.player.lives=this.player.currentLives}return this.player.level>=this.maxLevel?(this.player.level=this.maxLevel,this.player.experience=0):this.player.experience=a,{leveledUp:i>0,levelsGained:i,level:this.player.level,experience:this.player.experience,experienceToNext:this.getExperienceToNext(),currentLives:this.player.currentLives,maxLives:this.player.maxLives}}handleEnemyDefeated(e=0){return this.addExperience(e)}}class ln{state;constructor(e){this.state=e,this.resetRuntime()}setState(e){this.state=e,this.ensureRuntime(),this.ensureOverlay()}ensureRuntime(){if(!this.state)return{owned:[],bonusMaxLives:0,xpBoost:0,pendingSelections:0,necromancerCharges:0,pendingManualRevive:!1,recentRevive:!1,carryoverSkills:[],currentChoicePool:[],pendingLevelQueue:[]};this.state.skillRuntime||(this.state.skillRuntime={owned:[],bonusMaxLives:0,xpBoost:0,pendingSelections:0,necromancerCharges:0,pendingManualRevive:!1,recentRevive:!1,carryoverSkills:[],currentChoicePool:[],pendingLevelQueue:[]});const e=this.state.skillRuntime;return e.owned=Array.isArray(e.owned)?Array.from(new Set(e.owned.filter(t=>typeof t=="string"&&t))):[],e.bonusMaxLives=Number.isFinite(e.bonusMaxLives)?Math.max(0,Math.floor(e.bonusMaxLives)):0,e.xpBoost=Number.isFinite(e.xpBoost)?Math.max(0,e.xpBoost):0,e.pendingSelections=Number.isFinite(e.pendingSelections)?Math.max(0,Math.floor(e.pendingSelections)):0,e.necromancerCharges=Number.isFinite(e.necromancerCharges)?Math.max(0,Math.floor(e.necromancerCharges)):0,e.pendingManualRevive=!!e.pendingManualRevive,e.recentRevive=!!e.recentRevive,e.carryoverSkills=Array.isArray(e.carryoverSkills)?Array.from(new Set(e.carryoverSkills.filter(t=>typeof t=="string"&&t))):[],e.currentChoicePool=Array.isArray(e.currentChoicePool)?Array.from(new Set(e.currentChoicePool.filter(t=>typeof t=="string"&&t))):[],e.pendingLevelQueue=Array.isArray(e.pendingLevelQueue)?e.pendingLevelQueue.map(t=>typeof t=="number"&&Number.isFinite(t)?Math.max(1,Math.floor(t)):null).filter(t=>t!==null):[],e.pendingSelections=e.pendingLevelQueue.length,e}ensureOverlay(){if(!this.state)return{active:!1,choices:[],cursor:0};const e=this.state;let t=e.levelUpOverlay;return t||(t={active:!1,choices:[],cursor:0},e.levelUpOverlay=t),t.active=!!t.active,t.choices=Array.isArray(t.choices)?t.choices:[],t.cursor=Number.isFinite(t.cursor)?Math.max(0,Math.floor(t.cursor)):0,t}resetRuntime(){const e=this.ensureRuntime();e.owned=[],e.bonusMaxLives=0,e.xpBoost=0,e.pendingSelections=0,e.necromancerCharges=0,e.pendingManualRevive=!1,e.recentRevive=!1,e.carryoverSkills=[],e.currentChoicePool=[],e.pendingLevelQueue=[],this.resetOverlay()}resetOverlay(){const e=this.ensureOverlay();e.active=!1,e.choices=[],e.cursor=0}getOwnedSkills(){return this.ensureRuntime().owned.slice()}hasSkill(e){return e?this.ensureRuntime().owned.includes(e):!1}addSkill(e){const t=this.ensureRuntime(),n=de.getById(e);return n?(t.owned.includes(e)||(t.owned.push(e),this.applyImmediateEffects(n)),n):null}applyImmediateEffects(e){const t=this.ensureRuntime();switch(e.id){case"xp-boost":t.xpBoost=.5;break;case"necromancer":t.necromancerCharges=Math.min(1,(t.necromancerCharges||0)+1);break}}getBonusMaxLives(){const e=this.ensureRuntime();return Math.max(0,e.bonusMaxLives||0)}addBonusMaxLife(e=1){const t=this.ensureRuntime(),n=Number.isFinite(e)?Math.max(0,Math.floor(e)):0;return n<=0||(t.bonusMaxLives=Math.max(0,(t.bonusMaxLives||0)+n)),t.bonusMaxLives}getXpBoost(){const e=this.ensureRuntime();return Math.max(0,Number(e.xpBoost)||0)}queueLevelUps(e=1,t=null){const n=this.ensureRuntime(),a=Number.isFinite(e)?Math.max(0,Math.floor(e)):0;if(a<=0)return n.pendingSelections=n.pendingLevelQueue.length,n.pendingSelections;const i=typeof this.state?.player?.level=="number"?Math.max(1,Math.floor((this.state?.player).level??1)):1,r=typeof t=="number"&&Number.isFinite(t)?Math.max(1,Math.floor(t)):null,s=[];if(r!==null){const l=Math.max(1,r-a+1);for(let o=l;o<=r;o++)s.push(o)}else for(let l=0;l<a;l++)s.push(i+l);return s.forEach(l=>{l%2===0&&n.pendingLevelQueue.push(l)}),n.pendingSelections=n.pendingLevelQueue.length,n.pendingSelections}getPendingSelections(){const e=this.ensureRuntime();return e.pendingSelections=e.pendingLevelQueue.length,e.pendingSelections}hasPendingSelections(){return this.getPendingSelections()>0}startLevelSelection(){if(!this.hasPendingSelections())return null;const e=this.ensureOverlay();if(e.active)return e;const t=this.ensureRuntime(),n=Math.max(1,t.pendingLevelQueue.length||1);for(let a=0;a<n;a++){const i=t.pendingLevelQueue.shift(),r=typeof this.state?.player?.level=="number"?Math.max(1,Math.floor((this.state?.player).level??1)):1,s=typeof i=="number"?i:r,l=this.pickChoices(2,s);if(l.length)return e.active=!0,e.choices=l.map(o=>({id:o.id,nameKey:o.nameKey,descriptionKey:o.descriptionKey,icon:o.icon})),e.cursor=0,t.pendingSelections=t.pendingLevelQueue.length,e}return t.pendingSelections=t.pendingLevelQueue.length,t.carryoverSkills=[],t.currentChoicePool=[],null}pickChoices(e=2,t=null){const n=this.ensureRuntime(),a=typeof t=="number"&&Number.isFinite(t)?Math.max(1,Math.floor(t)):typeof this.state?.player?.level=="number"?Math.max(1,Math.floor((this.state?.player).level??1)):1,i=de.buildQueueForLevel(a,n.carryoverSkills,n.owned);if(n.currentChoicePool=i,!i.length)return n.carryoverSkills=[],[];const r=Math.max(1,Math.min(e,i.length));return i.slice(0,r).map(l=>de.getById(l)).filter(l=>l!==null)}moveCursor(e=0){const t=this.ensureOverlay();if(!t.active)return t.cursor;const n=t.choices.length;if(n<=1)return t.cursor=0,t.cursor;const a=Number.isFinite(e)?Math.floor(e):0,i=(t.cursor+a+n)%n;return t.cursor=i,t.cursor}completeSelection(e=null){const t=this.ensureOverlay();if(!t.active)return null;const n=typeof e=="number"&&Number.isFinite(e)?Math.max(0,Math.min(t.choices.length-1,Math.floor(e))):t.cursor,a=t.choices[n]??null;t.active=!1,t.choices=[],t.cursor=0,a&&this.addSkill(a.id);const i=this.ensureRuntime(),r=a?a.id:null,s=Array.isArray(i.currentChoicePool)?i.currentChoicePool:[];return i.carryoverSkills=s.filter(l=>l&&l!==r&&!i.owned.includes(l)),i.currentChoicePool=[],i.pendingSelections=i.pendingLevelQueue.length,a}isOverlayActive(){return!!this.ensureOverlay().active}getOverlay(){return this.ensureOverlay()}attemptRevive(e=null){if(!e||!this.hasSkill("necromancer"))return!1;const t=this.ensureRuntime();return t.necromancerCharges<=0||(t.pendingManualRevive=!0,t.recentRevive=!1),!1}consumeRecentReviveFlag(){const e=this.ensureRuntime();return e.recentRevive=!1,!1}hasPendingManualRevive(){const e=this.ensureRuntime();return this.hasSkill("necromancer")&&e.necromancerCharges>0&&e.pendingManualRevive}consumeManualRevive(){const e=this.ensureRuntime();return this.hasPendingManualRevive()?(e.necromancerCharges=Math.max(0,e.necromancerCharges-1),e.pendingManualRevive=!1,e.recentRevive=!1,!0):!1}clearManualReviveFlag(){const e=this.ensureRuntime();e.pendingManualRevive=!1}}const on=(m,e="")=>K.get(m,e)||e||m||"",ue=(m,e,t,n,a)=>Object.freeze({id:m,order:e,nameKey:t,fallbackName:n,color:a}),et=Object.freeze([ue("var-1",1,"variables.names.var1","","#000000"),ue("var-2",2,"variables.names.var2","","#1D2B53"),ue("var-3",3,"variables.names.var3","","#7E2553"),ue("var-4",4,"variables.names.var4","","#008751"),ue("var-5",5,"variables.names.var5","","#AB5236"),ue("var-6",6,"variables.names.var6","","#5F574F"),ue("var-7",7,"variables.names.var7","","#29ADFF"),ue("var-8",8,"variables.names.var8","","#FF77A8"),ue("var-9",9,"variables.names.var9","","#FFFF27")]);class cn{game;state;presets;constructor(e=null,t=null,n=et){this.game=e,this.state=t,this.presets=n}setGame(e){this.game=e}setState(e){this.state=e}ensureDefaultVariables(){return this.game?(this.game.variables=this.normalizeVariables(this.game.variables),this.game.variables):[]}resetRuntime(){return this.state?(this.state.variables=this.cloneVariables(this.game?.variables),this.state.variables):[]}cloneVariables(e){return(Array.isArray(e)&&e.every(n=>!!n.order&&!!n.name)?e:this.normalizeVariables(e)).map(n=>({id:n.id,order:n.order,name:n.name,color:n.color,value:!!n.value}))}normalizeVariables(e){const t=Array.isArray(e)?e:[],n=new Map;for(const a of t){const i=a;n.set(i.id,i)}return this.presets.map(a=>{const i=n.get(a.id)||{};return{id:a.id,order:a.order,name:typeof i.name=="string"&&i.name.trim()?i.name.trim():this.getPresetDefaultName(a),color:typeof i.color=="string"&&i.color.trim()?i.color.trim():a.color,value:!!i.value}})}getVariableDefinitions(){return this.game?.variables??[]}getVariables(){return this.state?.variables??[]}normalizeVariableId(e){return typeof e!="string"?null:new Set(["skill:bard"]).has(e)||this.getVariableDefinitions().some(n=>n.id===e)?e:null}getVariable(e){return e&&this.getVariables().find(t=>t.id===e)||null}isVariableOn(e){const t=this.getVariable(e);return t?!!t.value:!1}setVariableValue(e,t,n=!1){let a=!1;const i=!!t;return this.getVariables().forEach(r=>{r.id===e&&r.value!==i&&(r.value=i,a=!0)}),n&&this.getVariableDefinitions().forEach(r=>{r.id===e&&r.value!==i&&(r.value=i,a=!0)}),a}getFirstVariableId(){const e=this.getVariableDefinitions();return e.length?e[0].id:this.presets[0]?.id??null}getPresetDefaultName(e){if(!e)return"";const t=e.fallbackName||"";return e.nameKey?on(e.nameKey,t):t}getPresetTranslationSet(e){const t=new Set;if(!e)return t;const n=i=>{typeof i=="string"&&i.trim()&&t.add(i.trim())};n(e.fallbackName);const a=K.bundles;return e.nameKey&&Object.values(a).forEach(i=>{if(!i)return;const r=i[e.nameKey];n(r)}),n(this.getPresetDefaultName(e)),t}refreshPresetNames(){const e=new Map(this.presets.map(n=>[n.id,n])),t=n=>{Array.isArray(n)&&n.forEach(a=>{const i=e.get(a.id);if(!i)return;const r=this.getPresetTranslationSet(i);if(!a.name||r.has(a.name)){const s=this.getPresetDefaultName(i);a.name!==s&&(a.name=s)}})};t(this.game?.variables),t(this.state?.variables)}static get PRESETS(){return et}}class se{game;defaultRoomSize;constructor(e,t=8){this.game=e,this.defaultRoomSize=t}setGame(e){this.game=e}get roomSize(){return this.game.roomSize}static createEmptyRoom(e,t=0,n=1){const a=t%n,i=Math.floor(t/n);return{size:e,bg:0,tiles:Array.from({length:e},()=>Array(e).fill(0)),walls:Array.from({length:e},()=>Array(e).fill(!1)),worldX:a,worldY:i}}createEmptyRoom(e=this.roomSize,t=0,n=1){return se.createEmptyRoom(e,t,n)}static createWorldRooms(e,t,n){return Array.from({length:e*t},(a,i)=>se.createEmptyRoom(n,i,t))}createWorldRooms(e,t,n=this.roomSize){return se.createWorldRooms(e,t,n)}static createEmptyTileMap(e){return{ground:Array.from({length:e},()=>Array(e).fill(null)),overlay:Array.from({length:e},()=>Array(e).fill(null))}}createEmptyTileMap(e=this.roomSize){return se.createEmptyTileMap(e)}normalizeRooms(e,t,n){const a=this.roomSize,i=Array.from({length:t},(r,s)=>se.createEmptyRoom(a,s,n));return Array.isArray(e)&&e.forEach((r,s)=>{if(s>=i.length)return;const l=i[s];l.bg=typeof r.bg=="number"?r.bg:l.bg,l.tiles=Array.isArray(r.tiles)?r.tiles.map((o,c)=>Array.from({length:a},(d,u)=>{const h=o[u];return Number.isFinite(h)?h:l.tiles[c][u]})):l.tiles,l.walls=Array.isArray(r.walls)?r.walls.map((o,c)=>Array.from({length:a},(d,u)=>!!o[u])):l.walls}),i}normalizeTileMaps(e,t){const n=this.roomSize,a=Array.from({length:t},()=>se.createEmptyTileMap(n));if(!e)return a;const i=(s,l)=>{s.ground=Array.from({length:n},(o,c)=>Array.from({length:n},(d,u)=>l.ground?.[c]?.[u]??null)),s.overlay=Array.from({length:n},(o,c)=>Array.from({length:n},(d,u)=>l.overlay?.[c]?.[u]??null))};if(Array.isArray(e))return e.forEach((s,l)=>{l>=a.length||(s.ground||s.overlay)&&i(a[l],s)}),a;const r=e;return(r.ground||r.overlay)&&i(a[0],r),a}clampRoomIndex(e){const t=this.game.rooms,n=Math.max(0,t.length-1),a=Number(e);return Number.isFinite(a)?Math.max(0,Math.min(n,Math.floor(a))):0}clampCoordinate(e){const t=this.roomSize,n=Number(e);return Number.isFinite(n)?Math.max(0,Math.min(t-1,Math.floor(n))):0}getWorldRows(){return this.game.world.rows||1}getWorldCols(){return this.game.world.cols||1}getRoomCoords(e){const t=this.getWorldCols(),n=Math.floor(e/t),a=e%t;return{row:n,col:a}}getRoomIndex(e,t){const n=this.getWorldRows(),a=this.getWorldCols();return e<0||e>=n||t<0||t>=a?null:e*a+t}}class dn{game;state;testSettings;worldManager;variableManager;objectManager;enemyManager;skillManager;playerManager;dialogManager;itemManager;worldFacade;screenManager;dataManager;dataFacade;playing;lifecycle;reviveSnapshot;editorMode;constructor(){const e=E.world.rows,t=E.world.cols,n=E.world.roomSize,a=e*t,i=Array.from({length:a},()=>se.createEmptyTileMap(n)),r={tiles:[],maps:i,map:i[0]||se.createEmptyTileMap(n)};this.game={title:"My Tiny RPG Game",author:"",palette:["#000000","#1D2B53","#FFF1E8"],roomSize:n,world:{rows:e,cols:t},rooms:se.createWorldRooms(e,t,n),start:{x:E.player.startX,y:E.player.startY,roomIndex:E.player.startRoomIndex},sprites:[],enemies:[],items:[],objects:[],variables:[],exits:[],tileset:r},this.state={player:{x:E.player.startX,y:E.player.startY,lastX:E.player.startX,roomIndex:E.player.startRoomIndex,level:E.player.startLevel,maxLives:E.player.baseMaxLives,currentLives:E.player.startLives,lives:E.player.startLives,keys:0,experience:0,damageShield:0,damageShieldMax:0,swordType:null,lastDamageReduction:0,godMode:!1},dialog:{active:!1,text:"",page:1,maxPages:1,meta:null},enemies:[],variables:[],gameOver:!1,gameOverReason:null,pickupOverlay:{active:!1,name:"",spriteGroup:null,spriteType:null,effect:null},levelUpOverlay:{active:!1,choices:[],cursor:0},levelUpCelebration:{active:!1,level:null,startTime:0,timeoutId:null,durationMs:E.timing.levelUpCelebration},skillRuntime:null},this.testSettings=this.createDefaultTestSettings(),this.worldManager=new se(this.game,n),this.variableManager=new cn(this.game,this.state),this.objectManager=new B(this.game,this.worldManager,this.variableManager),this.enemyManager=new an(this.game,this.state,this.worldManager),this.skillManager=new ln(this.state),this.playerManager=new sn(this.state,this.worldManager,this.skillManager),this.playerManager.setSkillManager(this.skillManager),this.dialogManager=new nn(this.state),this.itemManager=new rn(this.game),this.worldFacade=new en(this,this.worldManager),this.screenManager=new Zt(this),this.dataManager=new tn({game:this.game,worldManager:this.worldManager,objectManager:this.objectManager,variableManager:this.variableManager}),this.dataFacade=new Qt(this,this.dataManager),this.playing=!1,this.lifecycle=new Jt(this,this.screenManager,{timeToResetAfterGameOver:E.timing.resetAfterGameOver}),this.ensureDefaultVariables(),this.resetGame(),this.reviveSnapshot=null,this.editorMode=!1,document.addEventListener("game-tab-activated",()=>{this.setEditorMode(!1)}),document.addEventListener("editor-tab-activated",()=>{this.setEditorMode(!0)})}createEmptyRoom(e,t=0,n=1){return this.worldFacade.createEmptyRoom(e,t,n)}createWorldRooms(e,t,n){return this.worldFacade.createWorldRooms(e,t,n)}createEmptyTileMap(e){return this.worldFacade.createEmptyTileMap(e)}getGame(){return this.game}getState(){return this.state}getCurrentRoom(){const e=this.worldManager.clampRoomIndex(this.state.player.roomIndex);return this.state.player.roomIndex=e,this.game.rooms[e]}getPlayer(){return this.playerManager.getPlayer()}getSkills(){return this.skillManager.getOwnedSkills()}hasSkill(e){return this.skillManager.hasSkill(e)}getPendingLevelUpChoices(){return this.skillManager.getPendingSelections()}getMaxPlayerLevel(){return this.playerManager.maxLevel}isLevelUpOverlayActive(){return this.skillManager.isOverlayActive()}getLevelUpOverlay(){return this.skillManager.getOverlay()}startLevelUpSelectionIfNeeded(){this.isLevelUpCelebrationActive()||this.skillManager.hasPendingSelections()&&!this.skillManager.isOverlayActive()&&this.skillManager.startLevelSelection()&&this.pauseGame("level-up")}queueLevelUpChoices(e=1,t=null){return this.skillManager.queueLevelUps(e,t),this.startLevelUpSelectionIfNeeded(),this.skillManager.getPendingSelections()}moveLevelUpCursor(e=0){return this.skillManager.moveCursor(e)}selectLevelUpSkill(e=null){if(!this.skillManager.isOverlayActive())return null;const t=this.skillManager.completeSelection(e);return t?.id==="max-life"&&this.playerManager.healToFull(),t?.id,this.skillManager.hasPendingSelections()?this.skillManager.startLevelSelection()&&this.pauseGame("level-up"):this.resumeGame("level-up"),t}consumeRecentReviveFlag(){return this.skillManager.consumeRecentReviveFlag()}getDialog(){return this.dialogManager.getDialog()}setPlayerPosition(e,t,n=null){this.playerManager.setPosition(e,t,n)}setDialog(e,t="",n=null){this.dialogManager.setDialog(e,t,n)}setDialogPage(e){this.dialogManager.setPage(e)}setEditorMode(e=!1){this.editorMode=!!e}isEditorModeActive(){return!!this.editorMode}createDefaultTestSettings(){return{startLevel:1,skills:[],godMode:!1}}getTestSettings(){return{startLevel:Number.isFinite(this.testSettings.startLevel)?Math.floor(this.testSettings.startLevel):1,skills:Array.isArray(this.testSettings.skills)?this.testSettings.skills.slice():[],godMode:!!this.testSettings.godMode}}setTestSettings(e={}){const t=this.getTestSettings(),n=this.playerManager.maxLevel,a=e.startLevel,i=typeof a=="number"&&Number.isFinite(a)?Math.max(1,Math.min(n,Math.floor(a))):t.startLevel,r=de.getAll(),s=new Set(r.map(d=>d.id).filter(d=>typeof d=="string")),l=Array.isArray(e.skills)?e.skills.map(d=>typeof d=="string"?d:null).filter(d=>typeof d=="string"&&s.has(d)):t.skills,o=Array.from(new Set(l)),c=e.godMode!==void 0?!!e.godMode:t.godMode;return this.testSettings={startLevel:i,skills:o,godMode:c},this.getTestSettings()}applyTestSettingsRuntime(){const e=this.getTestSettings(),t=Number.isFinite(e.startLevel)?e.startLevel:1;this.playerManager.setLevel(t),Array.isArray(e.skills)&&e.skills.length&&e.skills.forEach(n=>this.skillManager.addSkill(n)),this.playerManager.ensurePlayerStats(),this.playerManager.setGodMode(e.godMode)}resetGame(){this.screenManager.reset(),this.skillManager.resetRuntime(),this.playerManager.reset(this.game.start),this.dialogManager.reset(),this.enemyManager.resetRuntime(),this.variableManager.resetRuntime(),this.itemManager.resetItems(),this.objectManager.resetRuntime(),this.objectManager.ensurePlayerStartObject(),this.applyTestSettingsRuntime(),this.setGameOver(!1),this.hidePickupOverlay(),this.clearNecromancerRevive(),this.hideLevelUpCelebration({skipResume:!0}),this.resumeGame("game-over")}exportGameData(){return this.dataFacade.exportGameData()}importGameData(e){this.dataFacade.importGameData(e)}normalizeRooms(e,t,n){return this.worldFacade.normalizeRooms(e,t,n)}normalizeTileMaps(e,t){return this.worldFacade.normalizeTileMaps(e,t)}normalizeObjects(e){return this.objectManager.normalizeObjects(e)}cloneEnemies(e){return this.enemyManager.cloneEnemies(e)}generateObjectId(e,t){return this.objectManager.generateObjectId(e,t)}getObjects(){return this.objectManager.getObjects()}getObjectsForRoom(e){return this.objectManager.getObjectsForRoom(e)}getObjectAt(e,t,n){return this.objectManager.getObjectAt(e,t,n)}setObjectPosition(e,t,n,a){return this.objectManager.setObjectPosition(e,t,n,a)}removeObject(e,t){this.objectManager.removeObject(e,t)}setObjectVariable(e,t,n){return this.objectManager.setObjectVariable(e,t,n)}setPlayerEndText(e,t){return this.objectManager.setPlayerEndText(e,t)}getPlayerEndText(e=null){return this.objectManager.getPlayerEndText(e)}setActiveEndingText(e=""){return this.screenManager.setActiveEndingText(e)}getActiveEndingText(){return this.screenManager.getActiveEndingText()}addKeys(e=1){return this.playerManager.addKeys(e)}addLife(e=1){return this.playerManager.gainLives(e)}addBonusMaxLife(e=1){const t=this.skillManager.addBonusMaxLife(e);return this.healPlayerToFull(),t}addDamageShield(e=1,t=null){return this.playerManager.addDamageShield(e,t)}getDamageShield(){return this.playerManager.getDamageShield()}getDamageShieldMax(){return this.playerManager.getDamageShieldMax()}getSwordType(){return this.playerManager.getSwordType()}consumeKey(){return this.playerManager.consumeKey()}getKeys(){return this.playerManager.getKeys()}getMaxKeys(){return this.playerManager.getMaxKeys()}consumeLastDamageReduction(){return this.playerManager.consumeLastDamageReduction()}ensureDefaultVariables(){return this.variableManager.ensureDefaultVariables()}cloneVariables(e){return this.variableManager.cloneVariables(e)}normalizeVariables(e){return this.variableManager.normalizeVariables(e)}getVariableDefinitions(){return this.variableManager.getVariableDefinitions()}getVariables(){return this.variableManager.getVariables()}normalizeVariableId(e){return this.variableManager.normalizeVariableId(e)}getVariable(e){return this.variableManager.getVariable(e)}isVariableOn(e){return this.variableManager.isVariableOn(e)}setVariableValue(e,t,n=!1){const a=typeof e=="string"?e:String(e),i=this.variableManager.setVariableValue(a,t,n);let r=!1;return i&&(r=this.objectManager.checkOpenedMagicDoor(a,t),this.objectManager.syncSwitchState(a,t)),[i,r]}getEnemies(){return this.enemyManager.getEnemies()}getEnemyDefinitions(){return this.enemyManager.getEnemyDefinitions()}clampRoomIndex(e){return this.worldManager.clampRoomIndex(e)}clampCoordinate(e){return this.worldManager.clampCoordinate(e)}getWorldRows(){return this.worldManager.getWorldRows()}getWorldCols(){return this.worldManager.getWorldCols()}getRoomCoords(e){return this.worldManager.getRoomCoords(e)}getRoomIndex(e,t){return this.worldManager.getRoomIndex(e,t)}addEnemy(e){return this.enemyManager.addEnemy(e)}removeEnemy(e){const t=typeof e=="string"?e:String(e);this.enemyManager.removeEnemy(t)}setEnemyPosition(e,t,n,a=null){this.enemyManager.setEnemyPosition(e,t,n,a)}setEnemyVariable(e,t=null){const n=this.normalizeVariableId(t),a=typeof e=="string"?e:String(e);return this.enemyManager.setEnemyVariable(a,n)}damagePlayer(e=1){return this.playerManager.damage(e)}isPlayerOnDamageCooldown(){return this.playerManager.isOnDamageCooldown()}getLives(){return this.playerManager.getLives()}getMaxLives(){return this.playerManager.getMaxLives()}getLevel(){return this.playerManager.getLevel()}healPlayerToFull(){return this.playerManager.healToFull()}getExperience(){return this.playerManager.getExperience()}getExperienceToNext(){return this.playerManager.getExperienceToNext()}addExperience(e=0){const t=this.playerManager.addExperience(e);return this.processLevelUpResult(t)}handleEnemyDefeated(e=0){const t=this.playerManager.handleEnemyDefeated(e);return this.processLevelUpResult(t)}processLevelUpResult(e=null){if(e?.leveledUp){this.showLevelUpCelebration(e.level??null);const t=typeof e.levelsGained=="number"&&Number.isFinite(e.levelsGained)?Math.max(1,Math.floor(e.levelsGained)):1;this.queueLevelUpChoices(t,e.level??null)}return e}getPickupOverlay(){return this.state.pickupOverlay}showPickupOverlay(e={}){const t=this.getPickupOverlay();t.active=!0,t.name=e.name||e.title||"",t.spriteGroup=e.spriteGroup||null,t.spriteType=e.spriteType||null,t.effect=typeof e.effect=="function"?e.effect:null,this.pauseGame("pickup-overlay")}hidePickupOverlay(){const e=this.getPickupOverlay();if(!e.active)return;e.active=!1;const t=e.effect;if(e.effect=null,e.name="",e.spriteGroup=null,e.spriteType=null,typeof t=="function")try{t()}catch(n){console.error("Pickup overlay effect error:",n)}this.resumeGame("pickup-overlay")}isPickupOverlayActive(){return!!this.getPickupOverlay().active}getLevelUpCelebration(){return this.state.levelUpCelebration}showLevelUpCelebration(e=null,t={}){const n=this.getLevelUpCelebration(),a=typeof e=="number"&&Number.isFinite(e)?Math.max(1,Math.floor(e)):this.getLevel();n.active=!0,n.level=a,n.startTime=this.getNow();const i=t.durationMs;n.durationMs=typeof i=="number"&&Number.isFinite(i)?Math.max(300,Math.floor(i)):n.durationMs||3e3,n.timeoutId!==null&&(clearTimeout(n.timeoutId),n.timeoutId=null);const r=n.durationMs||3e3;n.timeoutId=setTimeout(()=>this.hideLevelUpCelebration(),r),this.pauseGame("level-up-celebration")}hideLevelUpCelebration({skipResume:e=!1}={}){const t=this.getLevelUpCelebration();t.timeoutId!==null&&(clearTimeout(t.timeoutId),t.timeoutId=null);const n=t.active;t.active=!1,t.level=null,t.startTime=0,t.durationMs=t.durationMs||3e3,n&&!e&&(this.resumeGame("level-up-celebration"),this.startLevelUpSelectionIfNeeded())}isLevelUpCelebrationActive(){return!!this.getLevelUpCelebration().active}getNow(){const e=globalThis.performance;return e?e.now():Date.now()}enableGameOverInteraction(){this.screenManager.clearGameOverCooldown(),this.screenManager.canResetAfterGameOver=!0}prepareNecromancerRevive(){return this.skillManager.hasPendingManualRevive()?(this.reviveSnapshot=this.captureReviveSnapshot(),!!this.reviveSnapshot):!1}hasNecromancerReviveReady(){return!!(this.skillManager.hasPendingManualRevive()&&this.reviveSnapshot)}reviveFromNecromancer(){if(!this.hasNecromancerReviveReady())return!1;const e=this.restoreReviveSnapshot(this.reviveSnapshot);if(this.reviveSnapshot=null,!e||!this.skillManager.consumeManualRevive())return!1;const n=Number.isFinite(this.state.player.maxLives)?Math.max(1,Math.floor(this.state.player.maxLives)):1;return this.state.player.currentLives=n,this.state.player.lives=n,this.lifecycle.setGameOver(!1),this.lifecycle.resumeGame("game-over"),this.screenManager.clearGameOverCooldown(),!0}clearNecromancerRevive(){this.reviveSnapshot=null,this.skillManager.clearManualReviveFlag()}captureReviveSnapshot(){try{const e=this.safeClone(this.game),t=this.safeClone(this.state);return{game:e,state:t}}catch(e){return console.error("Failed to capture revive snapshot",e),null}}restoreReviveSnapshot(e=null){if(!e)return!1;try{return this.assignData(this.game,e.game),this.assignData(this.state,e.state),this.worldManager.setGame(this.game),this.objectManager.setGame(this.game),this.variableManager.setGame(this.game),this.itemManager.setGame(this.game),!0}catch(t){return console.error("Failed to restore revive snapshot",t),!1}}assignData(e,t){!e||!t||(Object.keys(e).forEach(n=>{delete e[n]}),Object.keys(t).forEach(n=>{e[n]=this.safeClone(t[n])}))}safeClone(e){return typeof structuredClone=="function"?structuredClone(e):JSON.parse(JSON.stringify(e))}pauseGame(e="manual"){this.lifecycle.pauseGame(e)}resumeGame(e="manual"){this.lifecycle.resumeGame(e)}setGameOver(e=!0,t="defeat"){this.lifecycle.setGameOver(e,t)}isGameOver(){return this.lifecycle.isGameOver()}getGameOverReason(){return this.lifecycle.getGameOverReason()}get canResetAfterGameOver(){return this.screenManager.canResetAfterGameOver}}class un{gameEngine;touchStart;constructor(e){this.gameEngine=e,this.touchStart=null,this.setupEventListeners()}isGameModeActive(){return typeof document>"u"?!1:document.body.classList.contains("game-mode")}setupEventListeners(){document.addEventListener("keydown",e=>this.handleKeyDown(e)),document.addEventListener("touchstart",e=>this.handleTouchStart(e),{passive:!1}),document.addEventListener("touchmove",e=>this.handleTouchMove(e),{passive:!1}),document.addEventListener("touchend",e=>this.handleTouchEnd(e),{passive:!1}),document.addEventListener("click",e=>this.handleClick(e))}handleKeyDown(e){if(this.gameEngine.isGameOver?.()){e.preventDefault(),this.gameEngine.handleGameOverInteraction?.();return}if(this.gameEngine.isIntroVisible?.()){e.preventDefault(),this.gameEngine.dismissIntroScreen?.();return}if(this.gameEngine.isLevelUpOverlayActive?.()){e.preventDefault(),this.handleLevelUpKey(e);return}if(this.gameEngine.isPickupOverlayActive?.()){e.preventDefault(),this.gameEngine.dismissPickupOverlay?.();return}const t=this.gameEngine.gameState.getDialog();if(t.active){switch(e.key.toLowerCase()){case"z":case"enter":case" ":e.preventDefault(),t.page>=t.maxPages?this.gameEngine.closeDialog():(this.gameEngine.gameState.setDialogPage(t.page+1),this.gameEngine.renderer.draw());break}return}const n=e.target,a=n?.tagName.toLowerCase()||"",i=a==="input"||a==="textarea"||a==="select"||n?.isContentEditable;if(!this.isGameModeActive()||i)return;const s=e.key.toLowerCase(),o={arrowleft:[-1,0],a:[-1,0],arrowright:[1,0],d:[1,0],arrowup:[0,-1],w:[0,-1],arrowdown:[0,1],s:[0,1]}[s];o&&(e.preventDefault(),this.gameEngine.tryMove(o[0],o[1]))}handleTouchStart(e){if(!this.isGameModeActive()){this.touchStart=null;return}if(this.gameEngine.isGameOver?.()){e.preventDefault(),this.gameEngine.handleGameOverInteraction?.(),this.touchStart=null;return}if(this.gameEngine.isIntroVisible?.()){e.preventDefault(),this.gameEngine.dismissIntroScreen?.(),this.touchStart=null;return}if(this.gameEngine.isLevelUpOverlayActive?.()){e.preventDefault();const n=e.changedTouches.item(0);n&&this.chooseLevelUpByPointer(n.clientX,n.clientY),this.touchStart=null;return}if(this.gameEngine.isPickupOverlayActive?.()){e.preventDefault(),this.gameEngine.dismissPickupOverlay?.(),this.touchStart=null;return}const t=e.changedTouches.item(0);t&&(this.touchStart={x:t.clientX,y:t.clientY,time:Date.now(),prevented:!1})}handleTouchMove(e){if(!this.isGameModeActive()){this.touchStart=null;return}const t=this.touchStart;if(!t)return;const n=e.changedTouches.item(0);if(!n)return;const a=n.clientX-t.x,i=n.clientY-t.y;Math.sqrt(a*a+i*i)>=12?(e.preventDefault(),t.prevented=!0):t.prevented&&e.preventDefault()}handleTouchEnd(e){if(!this.isGameModeActive()){this.touchStart=null;return}if(this.gameEngine.isGameOver?.()){e.preventDefault(),this.gameEngine.handleGameOverInteraction?.(),this.touchStart=null;return}if(this.gameEngine.isIntroVisible?.()){e.preventDefault(),this.gameEngine.dismissIntroScreen?.(),this.touchStart=null;return}if(this.gameEngine.isLevelUpOverlayActive?.()){e.preventDefault();const u=e.changedTouches.item(0);u&&this.chooseLevelUpByPointer(u.clientX,u.clientY),this.touchStart=null;return}if(this.gameEngine.isPickupOverlayActive?.()){e.preventDefault(),this.gameEngine.dismissPickupOverlay?.(),this.touchStart=null;return}const t=this.touchStart;if(!t)return;const n=e.changedTouches.item(0);if(!n){this.touchStart=null;return}const a=n.clientX-t.x,i=n.clientY-t.y,r=Math.abs(a),s=Math.abs(i),l=Math.sqrt(a*a+i*i),o=Date.now()-t.time;this.touchStart=null;const c=24,d=E.input.maxDuration;l<c||o>d||(e.preventDefault(),r>s?a>0?this.gameEngine.tryMove(1,0):this.gameEngine.tryMove(-1,0):i>0?this.gameEngine.tryMove(0,1):this.gameEngine.tryMove(0,-1))}handleClick(e){this.isGameModeActive()&&this.gameEngine.isLevelUpOverlayActive?.()&&(e.preventDefault(),this.chooseLevelUpByPointer(e.clientX,e.clientY))}handleLevelUpKey(e){const t=e.key.toLowerCase();if(t==="1"){this.gameEngine.chooseLevelUpSkill?.(0);return}if(t==="2"){this.gameEngine.chooseLevelUpSkill?.(1);return}if(t==="arrowup"||t==="w"){this.gameEngine.moveLevelUpCursor?.(-1),this.gameEngine.draw?.();return}if(t==="arrowdown"||t==="s"){this.gameEngine.moveLevelUpCursor?.(1),this.gameEngine.draw?.();return}(t==="enter"||t===" "||t==="z")&&this.gameEngine.confirmLevelUpSelection?.()}chooseLevelUpByPointer(e,t){const n=this.gameEngine.pickLevelUpChoiceFromPointer?.(e,t);n!=null&&this.gameEngine.chooseLevelUpSkill?.(n)}setupEditorInputs(e,t){let n=!1;e.addEventListener("mousedown",a=>{n=!0,t(a)}),e.addEventListener("mousemove",a=>{n&&t(a)}),document.addEventListener("mouseup",()=>{n&&(n=!1)})}setupTileEditorInputs(e,t){let n=!1;e.addEventListener("mousedown",a=>{n=!0,t(a)}),e.addEventListener("mousemove",a=>{n&&t(a)}),document.addEventListener("mouseup",()=>{n=!1})}}const Me=Ee.definitions,tt=m=>Ee.getNpcDefinition(m),Oe="npc-",Ge=new Map;for(let m=0;m<Me.length;m++)Ge.set(Me[m].type,m+1);let ke=Me.length+1;const ve=(m,e="")=>K.get(m,e)||e||m||"",Ue=m=>m?m.nameKey?ve(m.nameKey,m.name||"NPC"):m.name||ve("npc.defaultName","NPC"):ve("npc.defaultName","NPC"),ze=m=>m?m.defaultTextKey?ve(m.defaultTextKey,m.defaultText||""):m.defaultText||"":"",hn=(m,e)=>{const t=ze(e),n=e&&e.defaultTextKey?e.defaultTextKey:null,a=Object.prototype.hasOwnProperty.call(m,"text"),i=l=>l==null?"":String(l),r=a?typeof m.text=="string"?m.text:i(m.text):"",s=typeof m.textKey=="string"&&m.textKey.trim()?m.textKey.trim():null;return s?{textKey:s,text:ve(s,r||t)}:!a&&n?{textKey:n,text:ve(n,t)}:{textKey:null,text:a?r:t}};function xe(m,e,t,n){return Number.isFinite(m)?Math.max(e,Math.min(t,m)):n}function mn(m){if(typeof m!="string"||!m.startsWith(Oe))return null;const e=Number(m.slice(Oe.length));return Number.isFinite(e)&&e>0?e:null}function nt(m){typeof m=="number"&&Number.isFinite(m)&&m>=ke&&(ke=m+1)}function at(m){if(!Ge.has(m))return null;const e=Ge.get(m);return typeof e!="number"?null:(nt(e),`${Oe}${e}`)}function gn(){const m=`${Oe}${ke}`;return ke+=1,m}class pn{gameState;constructor(e){this.gameState=e}get sprites(){return this.gameState.game.sprites}set sprites(e){this.gameState.game.sprites=e}generateId(){return gn()}getDefinitions(){return Me.slice()}getNPCs(){return this.sprites}getNPC(e){return this.sprites.find(t=>t.id===e)||null}getNPCByType(e){return this.sprites.find(t=>t.type===e)||null}ensureDefaultNPCs(){const e=new Set(Me.map(a=>a.type)),t=[],n=new Set;for(const a of this.sprites)!a.type||!e.has(a.type)||n.has(a.type)||(t.push(this.normalizeNPC(a)),n.add(a.type));for(const a of Me)n.has(a.type)||t.push(this.createFromDefinition(a));return this.sprites=t,this.sprites}normalizeNPC(e){const t=tt(e.type||null),n=t?at(t.type):null,a=typeof e.id=="string"?e.id.trim():"",i=mn(a);i&&nt(i);const r=n||a||this.generateId(),s=t?Ue(t):null,l=e.name||s||ve("npc.defaultName","NPC"),{text:o,textKey:c}=hn(e,t),d=Math.max(0,this.gameState.game.rooms.length-1),u=xe(Number(e.roomIndex),0,d,0),h=xe(Number(e.x),0,7,1),g=xe(Number(e.y),0,7,1),f=e.initialX!==void 0?e.initialX:h,v=e.initialY!==void 0?e.initialY:g,S=e.initialRoomIndex!==void 0?e.initialRoomIndex:u,M=e.placed!==void 0?!!e.placed:!0,x=e.conditionVariableId??e.conditionalVariableId??null,T=e.conditionText??e.conditionalText??"",L=e.rewardVariableId??e.activateVariableId??e.onCompleteVariableId??null,C=e.conditionalRewardVariableId??e.alternativeRewardVariableId??null,_=this.gameState.normalizeVariableId(x),z=typeof T=="string"?T:"",Y=this.gameState.normalizeVariableId(L),H=this.gameState.normalizeVariableId(C);return{id:r,type:t?.type||e.type||r,name:l,text:o,textKey:c,roomIndex:u,x:h,y:g,initialX:f,initialY:v,initialRoomIndex:S,placed:M,conditionVariableId:_,conditionText:z,rewardVariableId:Y,conditionalRewardVariableId:H}}createFromDefinition(e){const t=e.defaultTextKey||null;return{id:at(e.type)||this.generateId(),type:e.type,name:Ue(e),text:ze(e),textKey:t,roomIndex:0,x:1,y:1,initialX:1,initialY:1,initialRoomIndex:0,placed:!1,conditionVariableId:null,conditionText:"",rewardVariableId:null,conditionalRewardVariableId:null}}resetNPCs(){for(const e of this.sprites)e.x=e.initialX,e.y=e.initialY,e.roomIndex=e.initialRoomIndex}addNPC(e){const t=e.type?tt(e.type):null;if(!t)return null;const n=this.getNPCByType(t.type);if(n)return Object.assign(n,this.normalizeNPC({...n,...e,id:n.id,type:t.type})),n.id;const a=this.normalizeNPC({id:t.id,type:t.type,name:Ue(t),text:e.text??ze(t),textKey:e.text?null:t.defaultTextKey||null,x:e.x??1,y:e.y??1,roomIndex:e.roomIndex??0,placed:!!e.placed});return this.sprites.push(a),a.id}updateNPC(e,t){const n=this.getNPC(e);if(!n)return;const a=this.normalizeNPC({...n,...t,id:n.id,type:n.type});Object.assign(n,a)}removeNPC(e){const t=this.getNPC(e);return t?(t.placed=!1,t.x=1,t.y=1,t.roomIndex=0,!0):!1}setNPCPosition(e,t,n,a=null){const i=this.getNPC(e);if(i){if(i.x=xe(Number(t),0,7,i.x),i.y=xe(Number(n),0,7,i.y),i.initialX=i.x,i.initialY=i.y,a!==null){const r=Math.max(0,this.gameState.game.rooms.length-1);i.roomIndex=xe(Number(a),0,r,i.roomIndex),i.initialRoomIndex=i.roomIndex}return i.placed=!0,!0}}updateNPCDialog(e,t){if(typeof t=="object"){this.updateNPC(e,t);return}this.updateNPC(e,{text:t})}}class fn{gameState;customPalette=null;constructor(e){this.gameState=e}setCustomPalette(e){this.customPalette=e}getPalette(){return this.customPalette||this.getPicoPalette()}getPicoPalette(){return Ye}getColor(e){return this.getPalette()[e]||"#f4f4f8"}isUsingCustomPalette(){return this.customPalette!==null}resetToDefault(){this.customPalette=null}}class yn{paletteManager;gameState;playerSprite;enemySprite;enemySprites;npcSprites;objectSprites;constructor(e,t=null){this.paletteManager=e,this.gameState=t,this.playerSprite=null,this.enemySprite=null,this.enemySprites=null,this.npcSprites=null,this.objectSprites=null}invalidate(){this.playerSprite=null,this.enemySprite=null,this.enemySprites=null,this.npcSprites=null,this.objectSprites=null}getPlayerSprite(){return this.playerSprite||(this.playerSprite=this.buildPlayerSprite()),this.playerSprite}getEnemySprite(e=null){this.enemySprites||(this.enemySprites=this.buildEnemySprites());const t=this.enemySprites;if(e&&t[e])return t[e];if(e){const n=te.normalizeType(e);if(t[n])return t[n]}return this.enemySprite||(this.enemySprite=t.default||this.buildEnemySprite()),this.enemySprite}getEnemySprites(){return this.enemySprites||(this.enemySprites=this.buildEnemySprites()),this.enemySprites}getNpcSprites(){return this.npcSprites||(this.npcSprites=this.buildNpcSprites()),this.npcSprites}getObjectSprites(){return this.objectSprites||(this.objectSprites=this.buildObjectSprites()),this.objectSprites}buildPlayerSprite(){const e=this.paletteManager.getPalette(),t=I.get("player");return this.mapPixels(t,e)}buildNpcSprites(){const e=this.paletteManager.getPalette(),t={};for(const n of Ne.NPC_DEFINITIONS){const a=n.sprite;t[n.type]=this.mapPixels(a,e,()=>this.buildDefaultNpcSprite(e))}return t.default=this.buildDefaultNpcSprite(e),t}buildObjectSprites(){const e=this.paletteManager.getPalette(),t={};for(const n of Ne.OBJECT_DEFINITIONS)Array.isArray(n.sprite)&&(t[n.type]=this.mapPixels(n.sprite,e),Array.isArray(n.spriteOn)&&(t[`${n.type}--on`]=this.mapPixels(n.spriteOn,e)));return t}buildEnemySprites(){const e=this.paletteManager.getPalette(),t=this.buildDefaultEnemySprite(e),n={default:t},a=Ne.ENEMY_DEFINITIONS;if(Array.isArray(a))for(const i of a){if(!Array.isArray(i.sprite))continue;const r=this.mapPixels(i.sprite,e,()=>t);if(n[i.type]=r,Array.isArray(i.aliases))for(const s of i.aliases)n[s]=r}return n}buildDefaultNpcSprite(e){const t=I.get("npc");return this.mapPixels(t,e)}buildEnemySprite(){const e=this.buildEnemySprites();return this.enemySprites=e,this.enemySprite=e.default??null,this.enemySprite}buildDefaultEnemySprite(e){const t=e||this.paletteManager.getPalette(),n=I.get("enemy");return this.mapPixels(n,t)}mapPixels(e,t,n){return Array.isArray(e)?e.map(a=>a.map(i=>i===null?null:t[i]??null)):n?n():null}turnSpriteHorizontally(e){return e?e.map(t=>[...t].reverse()):null}}class vn{canvas;ctx;tileManager;constructor(e,t,n){this.canvas=e,this.ctx=t,this.tileManager=n}getTilePixelSize(){return Math.floor(this.canvas.width/8)}drawSprite(e,t,n,a,i){for(let r=0;r<t.length;r++){const s=t[r];for(let l=0;l<s.length;l++){const o=s[l];o&&(e.fillStyle=o,e.fillRect(n+l*i,a+r*i,i,i))}}}resolveTilePixels(e,t=null){return this.tileManager?.getTilePixels&&e?this.tileManager.getTilePixels(e,t):Array.isArray(e?.frames)&&e.frames.length?e.frames[0]:Array.isArray(e?.pixels)?e.pixels:null}drawCustomTile(e,t,n,a,i=null){if(!this.tileManager)return;const r=this.tileManager.getTile(e);if(!r)return;const s=this.resolveTilePixels(r,i);if(!s)return;const l=Math.max(1,Math.floor(a/8));for(let o=0;o<8;o++)for(let c=0;c<8;c++){const d=s[o]?.[c];!d||d==="transparent"||(this.ctx.fillStyle=d,this.ctx.fillRect(t+c*l,n+o*l,l,l))}}drawTileOnCanvas(e,t,n=null){const a=e.getContext("2d");if(!a)return;a.clearRect(0,0,e.width,e.height);const i=this.resolveTilePixels(t,n);if(!i)return;const r=Math.max(1,Math.floor(e.width/8));for(let s=0;s<8;s++)for(let l=0;l<8;l++){const o=i[s]?.[l];!o||o==="transparent"||(a.fillStyle=o,a.fillRect(l*r,s*r,r,r))}}drawTilePreview(e,t,n,a,i=this.ctx,r=null){if(!this.tileManager)return;const s=this.tileManager.getTile(e);if(!s)return;const l=this.resolveTilePixels(s,r);if(!l)return;const o=Math.max(1,Math.floor(a/8));for(let c=0;c<8;c++)for(let d=0;d<8;d++){const u=l[c]?.[d];!u||u==="transparent"||(i.fillStyle=u,i.fillRect(t+d*o,n+c*o,o,o))}}}class bn{gameState;tileManager;paletteManager;canvasHelper;constructor(e,t,n,a){this.gameState=e,this.tileManager=t,this.paletteManager=n,this.canvasHelper=a}clearCanvas(e,t){const n=this.gameState.getCurrentRoom(),a=this.paletteManager.getColor(n.bg);e.fillStyle=a,e.fillRect(0,0,t.width,t.height)}drawBackground(e,t){const n=this.gameState.getCurrentRoom(),a=this.paletteManager.getColor(n.bg);e.fillStyle=a,e.fillRect(0,0,t.width,t.height)}drawTiles(e,t){const n=this.gameState.getCurrentRoom(),a=this.canvasHelper.getTilePixelSize(),i=this.gameState.getPlayer?.()??{roomIndex:0},r=this.tileManager.getTileMap(i.roomIndex??0),s=r?.ground||[],l=r?.overlay||[];for(let o=0;o<8;o++)for(let c=0;c<8;c++){const d=s[o]?.[c];if(d!==null)this.canvasHelper.drawCustomTile(d,c*a,o*a,a);else{const h=n.tiles[o][c];e.fillStyle=this.paletteManager.getColor(h),e.fillRect(c*a,o*a,a,a)}const u=l[o]?.[c];u!==null&&this.canvasHelper.drawCustomTile(u,c*a,o*a,a)}}drawWalls(e){const t=this.gameState.getCurrentRoom(),n=this.canvasHelper.getTilePixelSize();e.fillStyle=this.paletteManager.getColor(1);for(let a=0;a<8;a++)for(let i=0;i<8;i++)t.walls[a][i]&&e.fillRect(i*n,a*n,n,n)}}class Sn{gameState;tileManager;spriteFactory;canvasHelper;paletteManager;viewportOffsetY;constructor(e,t,n,a,i){this.gameState=e,this.tileManager=t,this.spriteFactory=n,this.canvasHelper=a,this.paletteManager=i}setViewportOffset(e=0){this.viewportOffsetY=Number.isFinite(e)?Math.max(0,e):0}drawObjects(e){const t=this.gameState.getGame(),n=this.gameState.getPlayer(),a=this.canvasHelper.getTilePixelSize(),i=a/8,r=Array.isArray(t.objects)?t.objects:[],s=this.spriteFactory.getObjectSprites(),l=$;for(const o of r){if(o.roomIndex!==n.roomIndex||o.hiddenInRuntime||o.hideWhenCollected&&o.collected||o.hideWhenOpened&&o.opened||o.hideWhenVariableOpen&&(o.variableId?this.gameState.isVariableOn?.(o.variableId):!1))continue;let c=s[o.type];if(o.type===l.SWITCH&&o.on&&(c=s[`${o.type}--on`]||c),!c)continue;const d=o.x*a,u=o.isCollectible&&!o.collected?this.getFloatingOffset(o.x,o.y,a):0,h=Math.round(o.y*a+u);this.canvasHelper.drawSprite(e,c,d,h,i)}}drawItems(e){const t=this.gameState.getGame(),n=this.gameState.getPlayer(),a=this.canvasHelper.getTilePixelSize(),i=this.getNow();e.fillStyle=this.paletteManager.getColor(2);for(const r of t.items){if(r.roomIndex!==n.roomIndex||r.collected)continue;const s=(r.x*.75+r.y*1.15)*.6,l=Math.sin(i*.004+s)*a*.1,o=.5+Math.sin(i*.006+s)*.03,c=a*o,d=(a*.5-c)/2,u=Math.round(r.x*a+a*.25+d),h=Math.round(r.y*a+a*.25+l+d);e.fillRect(u,h,Math.round(c),Math.round(c))}}drawNPCs(e){const t=this.gameState.getGame(),n=this.gameState.getPlayer(),a=this.canvasHelper.getTilePixelSize(),i=a/8,r=this.spriteFactory.getNpcSprites();for(const s of t.sprites){if(!s.placed||s.roomIndex!==n.roomIndex)continue;const l=s.x*a,o=s.y*a;let c=r[s.type]||r.default;c&&(c=this.adjustSpriteHorizontally(n.x,s.x,c),this.canvasHelper.drawSprite(e,c,l,o,i))}}drawEnemies(e){const t=this.gameState.getEnemies?.();if(!t?.length)return;const n=this.gameState.getPlayer(),a=this.canvasHelper.getTilePixelSize(),i=a/8;t.forEach(r=>{if(r.roomIndex!==n.roomIndex)return;const s=this.spriteFactory.getEnemySprite(r.type);if(!s)return;const l=this.adjustSpriteHorizontally(r.x,r.lastX??r.x,s),o=r.x*a,c=r.y*a;this.canvasHelper.drawSprite(e,l,o,c,i),this.drawEnemyAlert(e,r,o,c,a);const d=this.getEnemyDamage(r.type);this.drawEnemyDamageMarkers(e,o,c,a,d)})}drawPlayer(e){const t=this.gameState.getPlayer(),n=this.canvasHelper.getTilePixelSize(),a=n/8,i=t.x*n,r=t.y*n;let s=this.spriteFactory.getPlayerSprite();if(!s)return;s=this.adjustSpriteHorizontally(t.x,t.lastX??t.x,s);const l=this.shouldFadePlayerForStealth();l&&e.save(),l&&(e.globalAlpha=.45),this.canvasHelper.drawSprite(e,s,i,r,a),l&&e.restore()}drawTileIconOnPlayer(e,t){const a=this.spriteFactory.getObjectSprites()[t];if(!a)return;const i=this.gameState.getPlayer();let r=this.canvasHelper.getTilePixelSize();r=r/2;const s=r/8,l=(i.x+.2)*r*2,o=(i.y-1)*r*2;this.canvasHelper.drawSprite(e,a,l,o,s)}adjustSpriteHorizontally(e,t,n){return e<t?this.spriteFactory.turnSpriteHorizontally(n):n}getFloatingOffset(e,t,n){const a=(e*.7+t*1.3)*.6;return Math.sin(this.getNow()*.003+a)*n*.12}getNow(){const e=globalThis.performance;return e?e.now():Date.now()}getEnemyDamage(e){const t=te.getEnemyDefinition(e);if(t&&Number.isFinite(t.damage))return Math.max(1,t.damage);const n=te.normalizeType(e),a=te.getEnemyDefinition(n);return a&&Number.isFinite(a.damage)?Math.max(1,a.damage):1}shouldFadePlayerForStealth(){if(!this.gameState.hasSkill?.("stealth"))return!1;const e=this.gameState.getEnemies?.()??[],t=this.gameState.getPlayer().roomIndex;return e.some(n=>n.roomIndex===t&&this.getEnemyDamage(n.type)<=3)}drawEnemyDamageMarkers(e,t,n,a,i){const r=Math.max(1,Math.floor(i)),s=Math.max(2,Math.floor(a/8)),l=Math.max(1,Math.floor(s/2)),o=r*s+(r-1)*l,c=Math.round(t+a/2-o/2),d=Math.round(n-s-l),u="#000000",h=this.paletteManager.getColor(6)||"#5F574F";e.fillStyle=u,e.strokeStyle=h,e.lineWidth=1;for(let g=0;g<r;g++){const f=c+g*(s+l);e.fillRect(f,d,s,s),e.strokeRect(f+.5,d+.5,s-1,s-1)}}drawEnemyAlert(e,t,n,a,i){const r=E.enemy.vision.alertDuration,s=typeof t.alertStart=="number"?t.alertStart:null,l=typeof t.alertUntil=="number"?t.alertUntil:null;if(s===null||l===null||r<=0)return;const o=this.getNow();if(o>=l)return;const c=Math.max(0,Math.min(1,(o-s)/r)),d=.6+Math.sin(c*Math.PI)*.4,u=Math.max(i*.8,i*.6),h=n+i/2,g=a-i*.5;e.save(),e.globalAlpha=d;const f=this.paletteManager.getColor(9)||"#FFD600";e.fillStyle=f;const v=`${Math.max(12,Math.round(u))}px "Press Start 2P", monospace`;e.font=v,e.textAlign="center",e.textBaseline="middle",e.fillText("!",h,g),e.restore()}cleanupEnemyLabels(){}}class En{gameState;paletteManager;constructor(e,t){this.gameState=e,this.paletteManager=t}drawDialog(e,t){const n=this.gameState.getDialog();!n.active||!n.text||((!n.page||n.page<1)&&(n.page=1),this.drawDialogBox(e,t,n))}drawDialogBox(e,t,n){const i=t.width-12,r=40,s=6,l=t.height-r-6;e.fillStyle="rgba(0,0,0,0.7)",e.fillRect(s,l,i,r);const o=this.paletteManager.getColor(7)||"#FFF1E8";e.strokeStyle=o,e.strokeRect(s,l,i,r),e.fillStyle=o,e.font="10px monospace";const c=12,d=i-16,u=this.calculateDialogPages(n,e,d,c,r-8),h=Math.max(1,u.length);n.maxPages!==h&&(n.maxPages=h);const g=Math.min(Math.max((n.page??1)-1,0),h-1);n.page!==g+1&&(n.page=g+1);const f=u[g]||[];let v=l+14;for(const S of f)e.fillText(S,s+8,v),v+=c}calculateDialogPages(e,t,n,a,i){const r=(e.text||"").split(/\s+/);let s="";const l=[];for(let d=0;d<r.length;d++){const u=s+r[d]+" ";t.measureText(u).width>n&&d>0?(l.push(s.trim()),s=r[d]+" "):s=u}l.push(s.trim());const o=Math.max(1,Math.floor(i/a)),c=[];for(let d=0;d<l.length;d+=o)c.push(l.slice(d,d+o));return c}}class Mn{gameState;entityRenderer;paletteManager;padding;gap;backgroundColor;viewportOffsetY;canvasHelper;healthIconDefinitions;objectSprites;constructor(e,t,n){this.gameState=e,this.entityRenderer=t,this.paletteManager=n,this.padding=E.hud.padding,this.gap=E.hud.gap,this.backgroundColor=E.hud.backgroundColor,this.viewportOffsetY=0,this.canvasHelper=t.canvasHelper,this.healthIconDefinitions={},this.objectSprites=this.entityRenderer.spriteFactory?.getObjectSprites?.()||{},this.setupHealthIcons()}drawHUD(e,t={}){const n=t.width??e.canvas.width,a=t.height??16,i=t.padding??this.padding,r=this.paletteManager.getColor(7);if(e.save(),e.fillStyle=this.backgroundColor,e.fillRect(0,0,n,a),this.gameState.isGameOver()){e.restore();return}const s=this.getLevelLabel(),l=t.fontSize??Math.max(6,Math.floor(a*.4));e.font=`${l}px monospace`,e.textBaseline="middle";const o=Math.max(4,Math.floor((a-i*2)/3)),c=o*3,d=n-i-c,u=Math.round(a/2-c/2),h=s?e.measureText(s).width:0,g=s?this.gap:0,f=c+this.gap+h+g,v=Math.max(0,n-i-f),S=this.canvasHelper.getTilePixelSize?.()??16,M=this.gameState.getMaxLives?.()??0,x=Math.max(6,Math.min(a-i*2,S/2)),T=x+2,L=M>0?Math.max(1,Math.ceil(M/2)):1,C=Math.max(L,Math.floor(v/Math.max(T,1)));this.drawHealth(e,{offsetX:i-4,offsetY:i+Math.max(0,(a-i*2-x)/2)-2,heartsPerRow:C,heartSize:x,gap:2}),s&&(e.fillStyle=r,e.textAlign="right",e.fillText(s,d-this.gap,a/2)),this.drawMiniMap(e,d,u,o,c),this.drawXpBar(e,d-30,u+c),e.restore()}drawInventory(e,t={}){const n=t.width??e.canvas.width,a=t.height??16,i=t.padding??this.padding,r=t.x??0,s=t.y??0,l=Number.isFinite(t.gap)?Math.max(0,t.gap):2,o=Math.min(9,this.gameState.getMaxKeys());let c=this.gameState.getKeys();c=Math.max(0,Math.min(o,c));const d=Math.max(0,this.gameState.getDamageShield()),u=Math.max(0,this.gameState.getDamageShieldMax()),h=this.gameState.getSwordType?.()||null;if(e.save(),e.translate(r,s),e.fillStyle=this.backgroundColor,e.fillRect(0,0,n,a),this.gameState.isGameOver()){e.restore();return}const g=this.canvasHelper.getTilePixelSize?.()??16,f=Math.max(0,a-i*2),v=Math.max(6,Math.min(f,g/2)),S=Math.min(v,Math.floor((f+l)/3-l)),M=Math.max(6,S),x=M+l,T=3,C=3*x-l,_=i,z=i+Math.max(0,(a-i*2-C)/2),Y=this.objectSprites[$.KEY];if(c>0&&Y){const w=Math.min(c,o);for(let k=0;k<w;k++){const Z=Math.floor(k/T),J=k%T,N=_+J*x,b=z+Z*x,W=M/8;this.canvasHelper.drawSprite(e,Y,N,b,W)}}const H=this.getSwordHudSprite(h);if(d>0&&H){const k=this.canvasHelper.getTilePixelSize?.()??16,Z=n-i-k,J=i+Math.max(0,Math.round((a-i*2-k)/2)),N=k/8,b=u>0?Math.max(.25,Math.min(1,d/u)):1;e.save(),e.globalAlpha=b,this.canvasHelper.drawSprite(e,H,Z,J,N),e.restore()}e.restore()}getSwordHudSprite(e){const t=this.objectSprites;return e&&t[e]?t[e]:null}drawHealth(e,t={}){const n=this.gameState.getLives?.()??0,a=this.gameState.getMaxLives?.()??0,i=Number.isFinite(t.offsetX)?t.offsetX:0,r=Number.isFinite(t.offsetY)?t.offsetY:0,s=Number.isFinite(t.gap)?Math.max(0,t.gap):0,l=Number.isFinite(t.heartsPerRow)?Math.max(1,Math.floor(t.heartsPerRow)):5,o=this.canvasHelper.getTilePixelSize?.()??16;let c=Number.isFinite(t.heartSize)&&t.heartSize>0?t.heartSize:o/2;c=Math.max(4,c);const d=c/8;for(let u=0;u<a;u++){const h=u<n?this.healthIconDefinitions.full:this.healthIconDefinitions.empty,g=Math.floor(u/l),f=u%l,v=i+f*(c+s),S=r+g*(c+s);this.canvasHelper.drawSprite(e,h,v,S,d)}}getLevelLabel(){const e=this.gameState.getLevel?.();return!Number.isFinite(e)||e===void 0?null:`LVL ${Math.max(1,Math.floor(e))}`}drawMiniMap(e,t,n,a,i){const l="rgba(255,255,255,0.08)",o="rgba(255,255,255,0.25)",c="#64b5f6";e.save(),e.translate(t,n),e.strokeStyle="rgba(255,255,255,0.12)",e.strokeRect(-2,-2,i+4,i+4);const d=this.gameState.getGame?.(),u=Math.max(1,d?.world?.rows||1),h=Math.max(1,d?.world?.cols||1),g=this.gameState.getPlayer?.().roomIndex??0,f=Math.floor(g/h),v=g%h,S=Math.max(1,Math.ceil(u/3)),M=Math.max(1,Math.ceil(h/3)),x=Math.min(2,Math.floor(f/S)),T=Math.min(2,Math.floor(v/M));for(let L=0;L<3;L++)for(let C=0;C<3;C++){const _=C*a,z=L*a;e.fillStyle=L===x&&C===T?c:l,e.fillRect(_,z,a,a),e.strokeStyle=o,e.strokeRect(_+.5,z+.5,a-1,a-1)}e.restore()}drawXpBar(e,t,n){const a=this.gameState.getExperienceToNext?.()??0;if(!Number.isFinite(a)||a<=0)return;const i=24;e.strokeStyle="rgba(204, 204, 204, 0.25)",e.lineWidth=3,e.lineCap="round",e.beginPath(),e.moveTo(t,n),e.lineTo(t+i,n),e.stroke();const r=this.gameState.getExperience?.()??0;if(r===0)return;const s=r*i/a;e.strokeStyle=this.paletteManager.getColor(13),e.lineWidth=3,e.lineCap="round",e.beginPath(),e.moveTo(t,n),e.lineTo(t+s,n),e.stroke()}setupHealthIcons(){const e=this.paletteManager.getColor(7),t=this.paletteManager.getColor(8);this.healthIconDefinitions={full:[[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,t,t,null,t,t,null],[null,t,t,t,t,t,e,t],[null,t,t,t,t,t,t,t],[null,null,t,t,t,t,t,null],[null,null,null,t,t,t,null,null],[null,null,null,null,t,null,null,null]],empty:[[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,t,t,null,t,t,null],[null,t,null,null,t,null,null,t],[null,t,null,null,null,null,null,t],[null,null,t,null,null,null,t,null],[null,null,null,t,null,t,null,null],[null,null,null,null,t,null,null,null]]}}}class He{renderer;constructor(e){this.renderer=e}get canvas(){return this.renderer.canvas}get ctx(){return this.renderer.ctx}get gameState(){return this.renderer.gameState}get gameEngine(){return this.renderer.gameEngine}get tileManager(){return this.renderer.tileManager}get paletteManager(){return this.renderer.paletteManager}get spriteFactory(){return this.renderer.spriteFactory}get canvasHelper(){return this.renderer.canvasHelper}get entityRenderer(){return this.renderer.entityRenderer}}class xn extends He{edgeFlash;combatIndicatorElement;combatIndicatorTimeout;screenFlashElement;screenFlashTimeout;constructor(e){super(e),this.edgeFlash={direction:"",expiresAt:0,color:"rgba(255,255,255,0.35)",tileX:null,tileY:null},this.combatIndicatorElement=typeof document<"u"?document.getElementById("combat-indicator"):null,this.combatIndicatorTimeout=null,this.screenFlashElement=typeof document<"u"?document.getElementById("screen-flash"):null,this.screenFlashTimeout=null,this.combatIndicatorElement&&(this.combatIndicatorElement.classList.remove("visible"),this.combatIndicatorElement.setAttribute("data-visible","false")),this.screenFlashElement&&this.screenFlashElement.classList.remove("visible")}get effectsGameState(){return this.gameState}get effectsCanvasHelper(){return this.canvasHelper}showCombatIndicator(e,t={}){const n=this.combatIndicatorElement;if(!n)return;const a=Number.isFinite(t.duration)?Math.max(0,t.duration):E.effects.combatIndicatorDuration;this.combatIndicatorTimeout&&(clearTimeout(this.combatIndicatorTimeout),this.combatIndicatorTimeout=null),n.classList.remove("visible"),n.setAttribute("data-visible","false"),n.textContent="",n.offsetWidth,n.textContent=e,n.classList.add("visible"),n.setAttribute("data-visible","true"),this.combatIndicatorTimeout=setTimeout(()=>{n.classList.remove("visible"),n.setAttribute("data-visible","false"),n.textContent="",this.combatIndicatorTimeout=null},a)}flashScreen(e={}){const t=this.screenFlashElement;if(!t)return;const n=Number.isFinite(e.duration)?Math.max(E.effects.screenFlashMinDuration,e.duration):E.effects.screenFlashDuration;if(typeof e.intensity=="number"&&Number.isFinite(e.intensity)){const a=Math.max(0,Math.min(1,e.intensity));t.style.setProperty("--screen-flash-opacity",a.toString())}typeof e.color=="string"&&e.color.trim()&&t.style.setProperty("--screen-flash-color",e.color.trim()),this.screenFlashTimeout&&(clearTimeout(this.screenFlashTimeout),this.screenFlashTimeout=null),t.classList.remove("visible"),t.offsetWidth,t.classList.add("visible"),this.screenFlashTimeout=setTimeout(()=>{t.classList.remove("visible"),this.screenFlashTimeout=null},n)}flashEdge(e,t={}){if(typeof e!="string"||!e.trim())return;const n=e.trim().toLowerCase(),a=Number.isFinite(t.duration)?Math.max(E.effects.edgeFlashMinDuration,t.duration):E.effects.edgeFlashDuration,i=typeof t.color=="string"&&t.color.trim()?t.color.trim():"rgba(255,255,255,0.35)",r=o=>{if(!Number.isFinite(o))return null;const c=Math.floor(o);return Math.max(0,Math.min(7,c))},s=r(t.tileX),l=r(t.tileY);this.edgeFlash={direction:n,expiresAt:Date.now()+a,color:i,tileX:s,tileY:l}}drawEdgeFlash(e,t){const n=this.edgeFlash;if(!n.direction)return;const a=Date.now();if(!Number.isFinite(n.expiresAt)||n.expiresAt<=a){this.edgeFlash.direction="";return}const i=Math.max(1,this.effectsCanvasHelper.getTilePixelSize()),r=Math.max(2,Math.floor(i/4)),s=i,l=(u,h=0)=>Number.isFinite(u)?Math.max(0,Math.min(7,Math.floor(u))):Math.max(0,Math.min(7,Math.floor(h))),o=this.effectsGameState.getPlayer(),c=l(n.tileX,o.x),d=l(n.tileY,o.y);switch(e.save(),e.fillStyle=n.color||"rgba(255,255,255,0.35)",n.direction){case"left":e.fillRect(0,d*s,r,s);break;case"right":e.fillRect(t.width-r,d*s,r,s);break;case"up":e.fillRect(c*s,0,s,r);break;case"down":e.fillRect(c*s,t.height-r,s,r);break;default:e.fillRect(0,0,t.width,r);break}e.restore()}}class Tn extends He{transition;constructor(e){super(e),this.transition={active:!1}}get transitionGameState(){return this.gameState}get transitionTileManager(){return this.tileManager}get transitionPalette(){return this.paletteManager}get transitionSpriteFactory(){return this.spriteFactory}get transitionCanvasHelper(){return this.canvasHelper}get transitionRenderer(){return this.renderer}isActive(){return!!this.transition.active}start(e={}){const t=e.fromFrame,n=e.toFrame;if(!t||!n)return e.onComplete?.(),!1;const a=e.direction||"right",i=Number.isFinite(e.duration)?Math.max(E.transitions.roomMinDuration,e.duration):E.transitions.roomDuration,r=performance.now();return this.transition.rafId&&globalThis.cancelAnimationFrame(this.transition.rafId),this.removePlayerFromFrame(t,e.playerPath?.from),this.removePlayerFromFrame(n,e.playerPath?.to),this.transition={active:!0,direction:a,fromFrame:t,toFrame:n,duration:i,startTime:r,playerPath:e.playerPath||null,onComplete:e.onComplete??null,rafId:null},this.transitionGameState.pauseGame("room-transition"),this.transitionRenderer.draw(),this.scheduleTick(),!0}scheduleTick(){const e=()=>{if(!this.isActive())return;if(this.getProgress()>=1){this.finish();return}this.transitionRenderer.draw(),this.transition.rafId=globalThis.requestAnimationFrame(e)};this.transition.rafId=globalThis.requestAnimationFrame(e)}getProgress(){if(!this.transition.active)return 1;const e=performance.now(),t=e-(this.transition.startTime??e);return Math.max(0,Math.min(1,t/(this.transition.duration??1)))}drawFrame(e,t){const n=this.transition;if(!n.active)return;const a=t.width,i=t.height,r=this.getProgress(),s=r*a,l=r*i;let o=0,c=0,d=0,u=0;switch(n.direction){case"left":o=s,d=s-a;break;case"right":o=-s,d=a-s;break;case"up":c=l,u=l-i;break;case"down":c=-l,u=i-l;break;default:o=-s,d=a-s;break}e.save(),e.fillStyle=this.transitionPalette.getColor(this.transitionGameState.getCurrentRoom().bg??0),e.fillRect(0,0,a,i),n.fromFrame&&e.drawImage(n.fromFrame,Math.round(o),Math.round(c)),n.toFrame&&e.drawImage(n.toFrame,Math.round(d),Math.round(u)),this.drawTransitionPlayer(e,t,r),e.restore(),r>=1&&this.finish()}removePlayerFromFrame(e,t){if(!t)return;const n=e.getContext("2d");if(!n)return;const a=Math.max(1,Math.floor(e.width/8)),i=Math.max(0,Math.min(7,Math.floor(t.x))),r=Math.max(0,Math.min(7,Math.floor(t.y))),s=Math.max(0,Math.floor(Number(Number.isFinite(t.roomIndex)?t.roomIndex:this.transitionGameState.getPlayer().roomIndex))),l=this.transitionGameState.getGame(),d=(Array.isArray(l.rooms)?l.rooms:[])[s]?.bg,u=typeof d=="number"?d:0;n.fillStyle=this.transitionPalette.getColor(u),n.fillRect(i*a,r*a,a,a),this.drawTileStackOnContext(n,s,i,r,a)}drawTransitionPlayer(e,t,n){const i=this.transition.playerPath;if(!i)return;const r=Math.max(1,Math.floor(t.width/8)),s=r/8,l=i.from.x+(i.to.x-i.from.x)*n,o=i.from.y+(i.to.y-i.from.y)*n;let c=this.transitionSpriteFactory.getPlayerSprite(),d=i.facingLeft;d===void 0&&(d=i.to.x<i.from.x),d&&(c=this.transitionSpriteFactory.turnSpriteHorizontally(c)),this.transitionCanvasHelper.drawSprite(e,c,l*r,o*r,s)}drawTileStackOnContext(e,t,n,a,i){const r=this.transitionTileManager.getTileMap(t);if(!r)return;const s=n*i,l=a*i,o=r.ground?.[a]?.[n];o!=null&&this.drawTilePixelsOnContext(e,o,s,l,i);const c=r.overlay?.[a]?.[n];c!=null&&this.drawTilePixelsOnContext(e,c,s,l,i)}drawTilePixelsOnContext(e,t,n,a,i){const r=this.transitionTileManager.getTilePixels(t);if(!r)return;const s=Math.max(1,Math.floor(i/8));for(let l=0;l<8;l++)for(let o=0;o<8;o++){const c=r[l]?.[o];!c||c==="transparent"||(e.fillStyle=c,e.fillRect(n+o*s,a+l*s,s,s))}}finish(){if(!this.transition.active)return;this.transition.rafId&&globalThis.cancelAnimationFrame(this.transition.rafId);const e=this.transition.onComplete;this.transition={active:!1},this.transitionGameState.resumeGame("room-transition"),e?.()}}const ge=(m,e="")=>K.get(m,e)||e||"",it=(m,e={},t="")=>K.format(m,e,t)||t||"";class wn extends He{introData;pickupFx;pickupAnimationHandle;levelUpAnimationHandle;constructor(e){super(e),this.introData={title:"Tiny RPG Studio",author:""},this.pickupFx={id:null,startTime:0},this.pickupAnimationHandle=0,this.levelUpAnimationHandle=0}get overlayGameState(){return this.gameState}get overlayPalette(){return this.paletteManager}get overlaySpriteFactory(){return this.spriteFactory}get overlayCanvasHelper(){return this.canvasHelper}get overlayEntityRenderer(){return this.entityRenderer}get overlayRenderer(){return this.renderer}setIntroData(e={}){this.introData={title:e.title||"Tiny RPG Studio",author:e.author||""}}drawIntroOverlay(e,t){this.overlayEntityRenderer.cleanupEnemyLabels();const n=this.introData.title||"Tiny RPG Studio",a=(this.introData.author||"").trim(),i=t.width,r=t.height;e.save(),e.fillStyle="rgba(4, 6, 14, 0.78)",e.fillRect(0,0,i,r),e.textAlign="center",e.textBaseline="middle";const s=i/2,l=r/2;if(e.fillStyle="#FFFFFF",e.font=`${Math.max(12,Math.floor(r/12))}px monospace`,e.fillText(n,s,l-r*.12),a){const c=it("intro.byline",{author:a},`por ${a}`);e.fillStyle="rgba(255,255,255,0.8)",e.font=`${Math.max(10,Math.floor(r/18))}px monospace`,e.fillText(c,s,l)}if(this.overlayRenderer.gameEngine?.canDismissIntroScreen){const c=Date.now()/E.animation.blinkInterval%2>1?E.animation.blinkMinOpacity:E.animation.blinkMaxOpacity;e.fillStyle=`rgba(100, 181, 246, ${c.toFixed(2)})`;const d=ge("intro.startAdventure","Iniciar aventura");e.font=`${Math.max(9,Math.floor(r/20))}px monospace`,e.fillText(d,s,l+r*.18)}e.restore()}drawLevelUpOverlay(e,t){const n=this.overlayGameState,a=n.getLevelUpOverlay?.();if(!a?.active)return;this.overlayEntityRenderer.cleanupEnemyLabels();const i=Array.isArray(a.choices)?a.choices:[],r=t.width,s=t.height,l=r/2,o=ge("skills.levelUpTitle","Level Up!"),c=Math.max(0,n.getPendingLevelUpChoices?.()||0),d=this.overlayPalette.getColor(7),u=this.overlayPalette.getColor(13)||d,h=Math.max(7,Math.floor(s/42)),g=Math.max(5,Math.floor(s/70)),f=this.getLevelUpCardLayout({width:r,height:s,choicesLength:i.length,hasPendingText:c>0,titleFont:h,pendingFont:g});e.save(),e.fillStyle="rgba(5, 7, 12, 0.88)",e.fillRect(0,0,r,s),e.textAlign="center",e.textBaseline="top",e.fillStyle=d;const v=Math.floor(s*.05);e.font=`${h}px "Press Start 2P", "VT323", monospace`;const S=v;e.fillText(o,l,S);let M=S+h+Math.floor(s*.02);if(c>0){const T=it("skills.pendingLabel",{value:c},"");T&&(e.font=`${g}px monospace`,e.fillStyle=u,e.fillText(T,l,M),M+=g+Math.floor(s*.02))}if(M+=Math.floor(s*.06),!i.length){const T=ge("skills.allUnlocked","");if(T){e.font=`${Math.max(9,Math.floor(s/20))}px monospace`,e.fillStyle=u;const{cardArea:L}=f,C=L.cardYStart+L.cardHeight/2;e.fillText(T,l,C)}e.restore();return}f.rects.forEach((T,L)=>{this.drawLevelUpCard(e,{x:T.x,y:T.y,width:T.width,height:T.height,active:a.cursor===L,data:i[L]})}),e.restore()}getLevelUpCardLayout({width:e=0,height:t=0,choicesLength:n=0,hasPendingText:a=!1,titleFont:i=null,pendingFont:r=null}={}){const s=Math.max(1,n||1),l=Number.isFinite(i)?i:Math.max(8,Math.floor(t/34)),o=Number.isFinite(r)?r:Math.max(6,Math.floor(t/58));let u=Math.floor(t*.05)+l+Math.floor(t*.02);a&&(u+=o+Math.floor(t*.02)),u+=Math.floor(t*.06);const h=s===2?1:s,g=Math.max(1,Math.ceil(s/h)),f=Math.max(4,Math.floor(e*.025)),v=Math.max(5,Math.floor(e*.02)),S=Math.max(6,Math.floor(t*.018)),M=Math.max(70,e-f*2),x=Math.max(105,Math.min(Math.floor(M/h),Math.floor(e*.9))),T=x*h+v*Math.max(0,h-1),L=Math.round((e-T)/2),C=Math.round(Math.max(u+Math.floor(t*.01),t*.18)),_=Math.max(100,Math.floor((t-C-S*(g-1))/g)),z=Math.min(Math.max(100,_),Math.floor(t*.36));return{rects:Array.from({length:s},(H,w)=>{const k=Math.floor(w/h),Z=w%h,J=Math.round(L+Z*(x+v)),N=Math.round(C+k*(z+S));return{x:J,y:N,width:x,height:z}}),cardArea:{startX:L,cardYStart:C,cardWidth:x,cardHeight:z,gapX:v,gapY:S,perRow:h,rows:g}}}drawLevelUpCard(e,{x:t,y:n,width:a,height:i,active:r=!1,data:s=null}){e.save();const l=r?this.overlayPalette.getColor(13)||"#64b5f6":this.overlayPalette.getColor(6)||"#C2C3C7";e.fillStyle=r?"rgba(100, 181, 246, 0.16)":"rgba(0, 0, 0, 0.55)",e.strokeStyle=l,e.lineWidth=Math.max(2,Math.floor(a*.015)),e.shadowColor=r?"rgba(100, 181, 246, 0.4)":"rgba(0,0,0,0.35)",e.shadowBlur=r?Math.max(8,Math.floor(a*.05)):Math.max(4,Math.floor(a*.02)),e.fillRect(t,n,a,i),e.strokeRect(t+.5,n+.5,a-1,i-1);const o=Math.max(6,Math.floor(a*.05)),c=s?.nameKey?ge(s.nameKey,s.id||""):s?.id||"",d=s?.descriptionKey?ge(s.descriptionKey,""):"";e.shadowColor="transparent",e.fillStyle="#FFFFFF",e.textAlign="left",e.textBaseline="top";const u=Math.max(8,Math.floor(i/16));e.font=`${u}px "Press Start 2P", "VT323", monospace`,e.fillText(c,t+o,n+o),s?.icon&&(e.font=`${Math.max(8,Math.floor(i/14))}px monospace`,e.textAlign="right",e.fillText(s.icon,t+a-o,n+o+Math.max(0,Math.floor(i*.02))),e.textAlign="left"),e.font=`${Math.max(7,Math.floor(i/22))}px monospace`,e.fillStyle="rgba(255,255,255,0.9)";const h=Math.max(5,Math.floor(i*.06)),g=n+o+u+h,f=Math.max(8,Math.floor(i/20));this.drawWrappedText(e,d,t+o,g,a-o*2,f,2),e.restore()}drawWrappedText(e,t,n,a,i,r,s=null){if(!t)return;const l=t.split(/\s+/).filter(Boolean);let o="",c=a,d=0;for(let u=0;u<l.length;u++){const h=l[u],g=o?`${o} ${h}`:h,v=e.measureText(g).width>i&&o,S=s&&d>=s-1;if(v||S){if(e.fillText(o,n,c),o=h,c+=r,d+=1,s&&d>=s){const x=`${l.slice(u).join(" ")}`.slice(0,32).trim(),T=x?`${x}...`:"...";e.fillText(T,n,c);return}}else o=g}o&&e.fillText(o,n,c)}drawLevelUpOverlayFull(e){this.drawLevelUpOverlay(e,{width:e.canvas.width,height:e.canvas.height})}drawLevelUpCelebrationOverlay(e,t){const a=this.overlayGameState.getLevelUpCelebration?.();if(!a?.active){this.stopLevelUpAnimationLoop();return}this.ensureLevelUpAnimationLoop(),this.overlayEntityRenderer.cleanupEnemyLabels();const i=t.width,r=t.height,s=this.getNow(),l=Number.isFinite(a.startTime)?a.startTime:s,o=Math.max(0,(s-l)/1e3),c=Math.min(i,r),d=Math.floor(c*.62),u=this.easeOutBack(Math.min(1,o/.42)),h=1+Math.sin(o*5.2)*.035,g=Math.round(d*(.76+u*.22)*h),f=i/2,v=r/2,S=Math.sin(o*2.1)*6,M=Math.round(f-g/2),x=Math.round(v-g/2+S),T=this.overlayPalette.getColor(13)||"#F8E7A1";e.save(),this.drawPickupFrame(e,{x:M,y:x,size:g,elapsed:o,accent:T}),e.restore();const L=ge("player.levelUp","Level Up!");e.save(),e.textAlign="center",e.textBaseline="middle";const C=Math.max(12,Math.floor(r/12));e.font=`${C}px "Press Start 2P", "VT323", monospace`,e.fillStyle="#FFF1E8",e.fillText(L,f,v+S),e.restore()}drawPickupOverlay(e,t){const a=this.overlayGameState.getPickupOverlay?.();if(!a?.active){this.stopPickupAnimationLoop();return}this.stopPickupAnimationLoop(),this.ensurePickupAnimationLoop();const i=t.width,r=t.height,s=this.getNow(),l=this.ensurePickupFx(a,s),o=Math.max(0,(s-l.startTime)/1e3),c=Math.min(i,r),d=Math.floor(c*.62),u=this.easeOutBack(Math.min(1,o/.35)),h=1+Math.sin(o*5.2)*.04,g=Math.round(d*(.78+u*.22)*h),f=i/2,v=r/2,S=Math.sin(o*2.4)*6,M=Math.round(f-g/2),x=Math.round(v-g/2+S);e.save(),this.drawPickupFrame(e,{x:M,y:x,size:g,elapsed:o}),e.restore();const T=this.getPickupSprite(a);if(T){const L=Math.floor(g*.48),C=Math.max(2,Math.floor(L/8)),_=1+Math.sin(o*8.2)*.1,z=Math.max(2,Math.floor(C*_)),Y=z*8,H=Math.round(f-Y/2),w=Math.round(x+g/2-Y/2);this.overlayCanvasHelper.drawSprite(e,T,H,w,z)}}drawPickupFrame(e,{x:t,y:n,size:a,elapsed:i=0,accent:r=null}){const s=r||this.overlayPalette.getColor(2)||"#FFF1E8";e.save();const l=e.createLinearGradient(t,n,t+a,n+a);l.addColorStop(0,"rgba(7, 11, 26, 0.96)"),l.addColorStop(.55,"rgba(14, 25, 48, 0.96)"),l.addColorStop(1,"rgba(9, 14, 32, 0.96)"),e.fillStyle=l,e.fillRect(t,n,a,a),e.shadowColor="rgba(0, 0, 0, 0.45)",e.shadowBlur=Math.max(10,Math.floor(a*.08)),e.shadowOffsetY=Math.max(4,Math.floor(a*.02));const o=Math.max(2,Math.floor(a*.025));e.lineWidth=o,e.strokeStyle=`rgba(255, 241, 232, ${(.35+.25*Math.sin(i*4)).toFixed(2)})`,e.strokeRect(t+o/2,n+o/2,a-o,a-o);const c=Math.max(10,Math.floor(a*.08)),d=Math.max(6,Math.floor(a*.05));e.globalAlpha=.18,e.fillStyle=s,e.fillRect(t+c,n+c,a-c*2,d),e.fillRect(t+c,n+a-c-d,a-c*2,d),e.restore()}drawPickupRings(e,{centerX:t,centerY:n,size:a,elapsed:i=0}){e.save();const r=a*.35+Math.sin(i*3.2)*a*.05,s=Math.max(2,Math.floor(a*.02)),l=.35+.15*Math.sin(i*5.4);e.lineWidth=s,e.strokeStyle=`rgba(255, 241, 232, ${l.toFixed(2)})`;for(let o=0;o<2;o++)e.beginPath(),e.arc(t,n,r+o*a*.07,0,Math.PI*2),e.stroke();e.globalAlpha=.18,e.fillStyle="rgba(100, 181, 246, 0.5)",e.beginPath(),e.arc(t,n,r*.65,0,Math.PI*2),e.fill(),e.restore()}ensurePickupFx(e,t=this.getNow()){const n=`${e.spriteGroup||""}:${e.spriteType||""}:${e.name||""}`;return this.pickupFx.id!==n&&(this.pickupFx={id:n,startTime:t}),this.pickupFx}ensureLevelUpAnimationLoop(){if(this.levelUpAnimationHandle)return;const e=()=>{if(!this.overlayGameState.isLevelUpCelebrationActive?.()){this.stopLevelUpAnimationLoop(),this.overlayRenderer.draw?.();return}this.levelUpAnimationHandle=this.schedulePickupFrame(e),this.overlayRenderer.draw?.()};this.levelUpAnimationHandle=this.schedulePickupFrame(e)}stopLevelUpAnimationLoop(){this.levelUpAnimationHandle&&(this.cancelPickupFrame(this.levelUpAnimationHandle),this.levelUpAnimationHandle=0)}ensurePickupAnimationLoop(){if(this.pickupAnimationHandle)return;const e=()=>{if(!this.overlayGameState.isPickupOverlayActive?.()){this.stopPickupAnimationLoop();return}this.pickupAnimationHandle=this.schedulePickupFrame(e),this.overlayRenderer.draw?.()};this.pickupAnimationHandle=this.schedulePickupFrame(e)}stopPickupAnimationLoop(){this.pickupAnimationHandle&&(this.cancelPickupFrame(this.pickupAnimationHandle),this.pickupAnimationHandle=0)}schedulePickupFrame(e){return typeof requestAnimationFrame=="function"?requestAnimationFrame(e):setTimeout(e,1e3/E.animation.overlayFPS)}cancelPickupFrame(e){typeof cancelAnimationFrame=="function"?cancelAnimationFrame(e):clearTimeout(e)}easeOutBack(e=0){const a=this.clamp(e,0,1);return 1+2.70158*Math.pow(a-1,3)+1.70158*Math.pow(a-1,2)}easeOutQuad(e=0){const t=this.clamp(e,0,1);return 1-(1-t)*(1-t)}clamp(e,t,n){return Math.max(t,Math.min(n,e))}getNow(){const e=globalThis.performance;return e?e.now():Date.now()}getPickupSprite(e=null){if(!e?.spriteGroup)return null;const t=this.overlaySpriteFactory;if(e.spriteGroup==="object"){const n=t.getObjectSprites(),a=e.spriteType||"";return a&&n[a]||null}else return null}drawGameOverScreen(){const e=this.ctx;if(!e)return;this.overlayEntityRenderer.cleanupEnemyLabels(),e.save(),e.fillStyle="#000000",e.fillRect(0,0,this.canvas.width,this.canvas.height);const t=this.overlayGameState,a=t.getGameOverReason()==="victory",i=a&&t.getActiveEndingText?.()||"",r=a&&i.trim().length>0,s=Math.round(this.canvas.width/2)+.5,l=Math.round(this.canvas.height/2)+.5;if(r){e.save();const g=Math.floor(this.canvas.width*.08),f=Math.max(32,this.canvas.width-g*2),v=Math.max(7,Math.floor(this.canvas.height/30)),S=Math.round(v*1.4),M=`${v}px "Press Start 2P", "VT323", monospace`;e.font=M,e.textAlign="center",e.textBaseline="top",e.fillStyle="#F8FAFC";const T=(Y=>{const H=Y.replace(/\r\n/g,`
`).split(/\n+/).map(k=>k.trim()).filter(Boolean);if(!H.length)return[];const w=[];return H.forEach((k,Z)=>{const J=k.split(/\s+/);let N="";J.forEach(b=>{const W=N?`${N} ${b}`:b;e.measureText(W).width>f&&N?(w.push(N),N=b):N=W}),N&&w.push(N),Z<H.length-1&&w.push("")}),w.length?w:[""]})(i),L=T.length*S,C=Math.max(S,Math.floor(v*1.2));let _=Math.max(g,Math.floor(l-L-C));Number.isFinite(_)||(_=g);let z=_;T.forEach(Y=>{if(Y.trim().length){const H=Math.round(z)+.5;e.fillText(Y,s,H)}z+=S}),e.restore()}e.fillStyle="#FFFFFF";let o=Math.max(5,Math.floor(this.canvas.height/22));const c=`${o}px "Press Start 2P", monospace`;if(e.font=c,e.textAlign="center",e.textBaseline="middle",e.fillText(a?"The End":"Game Over",s,l),!t.canResetAfterGameOver){e.restore();return}e.save();const d=Date.now()/E.animation.blinkInterval%2>1?E.animation.blinkMinOpacity:E.animation.blinkMaxOpacity;e.fillStyle=`rgba(100, 181, 246, ${d.toFixed(2)})`,o=Math.max(4,Math.floor(this.canvas.height/26)),e.font=`${o}px "Press Start 2P", monospace`,e.textAlign="center",e.textBaseline="middle";const u=Math.round(this.canvas.height/1.5)+.5,h=t.hasNecromancerReviveReady?.()?ge("skills.necromancer.revivePrompt",""):ge(a?"gameOver.retryVictory":"gameOver.retryDefeat","");e.fillText(h,s,u),e.restore(),e.restore()}}class In{canvas;ctx;hudBarHeight;inventoryBarHeight;totalHudHeight;gameplayHeight;gameplayOffsetY;inventoryOffsetY;gameplayCanvasBounds;gameState;gameEngine;tileManager;npcManager;paletteManager;spriteFactory;canvasHelper;tileRenderer;entityRenderer;dialogRenderer;hudRenderer;effectsManager;transitionManager;overlayRenderer;playerSprite;npcSprites;enemySprites;enemySprite;objectSprites;drawIconIdNextFrame;timeIconOverPlayer;tileAnimationInterval;tileAnimationTimer;constructor(e,t,n,a,i=null){this.canvas=e;const r=Math.max(E.canvas.minTileSize,Math.floor(this.canvas.width/E.world.roomSize));this.hudBarHeight=Math.max(E.canvas.minHudHeight,Math.round(r*E.canvas.hudHeightMultiplier)),this.inventoryBarHeight=Math.max(E.canvas.minInventoryHeight,Math.round(r*E.canvas.inventoryHeightMultiplier)),this.totalHudHeight=this.hudBarHeight+this.inventoryBarHeight,this.gameplayHeight=r*E.world.roomSize;const s=this.gameplayHeight+this.totalHudHeight;this.canvas.height!==s&&(this.canvas.height=s),this.ctx=e.getContext("2d"),this.ctx&&(this.ctx.imageSmoothingEnabled=!1),this.gameplayOffsetY=this.hudBarHeight,this.inventoryOffsetY=this.hudBarHeight+this.gameplayHeight,this.gameplayCanvasBounds={width:this.canvas.width,height:this.gameplayHeight},this.gameState=t,this.gameEngine=i,this.tileManager=n,this.npcManager=a,this.paletteManager=new fn(t),this.spriteFactory=new yn(this.paletteManager,t),this.canvasHelper=new vn(e,this.ctx,n),this.tileRenderer=new bn(t,n,this.paletteManager,this.canvasHelper),this.entityRenderer=new Sn(t,n,this.spriteFactory,this.canvasHelper,this.paletteManager),this.entityRenderer.setViewportOffset(this.gameplayOffsetY),this.dialogRenderer=new En(t,this.paletteManager),this.hudRenderer=new Mn(t,this.entityRenderer,this.paletteManager),this.effectsManager=new xn(this),this.transitionManager=new Tn(this),this.overlayRenderer=new wn(this),this.playerSprite=this.spriteFactory.getPlayerSprite(),this.npcSprites=this.spriteFactory.getNpcSprites(),this.enemySprites=this.spriteFactory.getEnemySprites(),this.enemySprite=this.spriteFactory.getEnemySprite(),this.objectSprites=this.spriteFactory.getObjectSprites(),this.drawIconIdNextFrame="",this.timeIconOverPlayer=E.animation.iconOverPlayerDuration,this.tileAnimationInterval=E.animation.tileInterval,this.tileAnimationTimer=null,this.startTileAnimationLoop()}draw(){const e=this.ctx;if(!e)return;e.clearRect(0,0,this.canvas.width,this.canvas.height);const t=this.gameplayCanvasBounds,n=this.isIntroOverlayActive(),a=this.gameState.isPickupOverlayActive?.(),i=this.gameState.isLevelUpCelebrationActive?.(),r=this.gameState.isLevelUpOverlayActive?.();e.save(),e.translate(0,this.gameplayOffsetY),this.transitionManager.isActive()?this.transitionManager.drawFrame(e,t):(this.tileRenderer.clearCanvas(e,t),this.tileRenderer.drawBackground(e,t),this.tileRenderer.drawTiles(e,t),this.tileRenderer.drawWalls(e),this.effectsManager.drawEdgeFlash(e,t),!n&&!this.gameState.isGameOver()&&(this.entityRenderer.drawObjects(e),this.entityRenderer.drawItems(e),this.entityRenderer.drawNPCs(e),this.entityRenderer.drawEnemies(e),this.entityRenderer.drawPlayer(e),this.drawIconIdNextFrame&&this.drawTileIconOnPlayer(e,this.drawIconIdNextFrame),!a&&!r&&!i&&this.dialogRenderer.drawDialog(e,t))),n?this.overlayRenderer.drawIntroOverlay(e,t):i?this.overlayRenderer.drawLevelUpCelebrationOverlay(e,t):a&&this.overlayRenderer.drawPickupOverlay(e,t),e.restore();const s={width:this.canvas.width,height:this.hudBarHeight},l={x:0,y:this.inventoryOffsetY,width:this.canvas.width,height:this.inventoryBarHeight};if(n?(e.save(),e.fillStyle="#000000",e.fillRect(0,0,s.width,s.height),e.fillRect(l.x,l.y,l.width,l.height),e.restore()):r||(this.hudRenderer.drawHUD(e,s),this.hudRenderer.drawInventory(e,l)),this.gameState.isGameOver()){this.overlayRenderer.drawGameOverScreen();return}r&&this.overlayRenderer.drawLevelUpOverlayFull(e)}getTilePixelSize(){return this.canvasHelper.getTilePixelSize()}getColor(e){return this.paletteManager.getColor(e)}setIconOverPlayer(e){this.drawIconIdNextFrame=e,setTimeout(()=>{this.drawIconIdNextFrame=""},this.timeIconOverPlayer)}drawCustomTile(e,t,n,a){this.canvasHelper.drawCustomTile(e,t,n,a)}drawSprite(e,t,n,a,i){this.canvasHelper.drawSprite(e,t,n,a,i)}drawTileOnCanvas(e,t){this.canvasHelper.drawTileOnCanvas(e,t)}drawTileIconOnPlayer(e,t){this.entityRenderer.drawTileIconOnPlayer(e,t)}drawTilePreviewAt(e,t,n,a,i){this.canvasHelper.drawTilePreview(e,t,n,a,i)}setIntroData(e={}){this.overlayRenderer.setIntroData(e)}isIntroOverlayActive(){return!!this.gameEngine?.isIntroVisible?.()}captureGameplayFrame(){if(typeof document>"u")return null;const e=this.gameplayCanvasBounds.width,t=this.gameplayCanvasBounds.height,n=document.createElement("canvas");n.width=e,n.height=t;const a=n.getContext("2d");return a?(a.drawImage(this.canvas,0,this.gameplayOffsetY,e,t,0,0,e,t),n):null}isRoomTransitionActive(){return this.transitionManager.isActive()}startRoomTransition(e={}){return this.transitionManager.start(e)}flashEdge(e,t={}){this.effectsManager.flashEdge(e,t)}startTileAnimationLoop(){this.tileAnimationTimer&&(clearInterval(this.tileAnimationTimer),this.tileAnimationTimer=null);const e=Math.max(E.animation.minInterval,this.tileAnimationInterval||0);this.tileAnimationTimer=setInterval(()=>this.tickTileAnimation(),e)}tickTileAnimation(){if(this.gameState.isEditorModeActive?.())return;const e=this.tileManager;if(e.getAnimationFrameCount()<=1)return;const n=e.advanceAnimationFrame();this.draw();try{typeof globalThis.dispatchEvent=="function"?globalThis.dispatchEvent(new CustomEvent("tile-animation-frame",{detail:{frameIndex:n}})):typeof document<"u"&&document.dispatchEvent(new CustomEvent("tile-animation-frame",{detail:{frameIndex:n}}))}catch{typeof globalThis.dispatchEvent=="function"?globalThis.dispatchEvent(new Event("tile-animation-frame")):typeof document<"u"&&document.dispatchEvent(new Event("tile-animation-frame"))}}showCombatIndicator(e,t={}){this.effectsManager.showCombatIndicator(e,t)}flashScreen(e={}){this.effectsManager.flashScreen(e)}drawObjectSprite(e,t,n,a,i){const s=this.spriteFactory.getObjectSprites()[t];if(!s)return;const l=i||this.canvasHelper.getTilePixelSize()/8;this.canvasHelper.drawSprite(e,s,n,a,l)}buildPlayerSprite(){return this.playerSprite=this.spriteFactory.getPlayerSprite(),this.playerSprite}buildNpcSprites(){return this.npcSprites=this.spriteFactory.getNpcSprites(),this.npcSprites}buildEnemySprite(){return this.enemySprites=this.spriteFactory.getEnemySprites(),this.enemySprite=this.spriteFactory.getEnemySprite(),this.enemySprite}buildObjectSprites(){return this.objectSprites=this.spriteFactory.getObjectSprites(),this.objectSprites}}const rt=Array.isArray(Xe)?Xe:[];class Pn{gameState;presets;animationFrameIndex;maxAnimationFrames;constructor(e){this.gameState=e,this.presets=this.buildPresetTiles(),this.animationFrameIndex=0,this.maxAnimationFrames=1}generateTileId(){const e=typeof crypto<"u"?crypto:globalThis.crypto;if(e){const t=e.randomUUID;if(typeof t=="function")return t.call(e)}return`tile-${Math.random().toString(36).slice(2,10)}`}buildPresetTiles(){return Array.isArray(rt)?rt.map(e=>this.cloneTile(e)).sort((e,t)=>typeof e.id=="number"&&typeof t.id=="number"?e.id-t.id:String(e.id).localeCompare(String(t.id))):[]}cloneTile(e){const t=e.frames?.map(i=>i.map(r=>r.slice())),n=e.pixels?e.pixels.map(i=>i.slice()):void 0,a=e.layouts?.map(i=>i.map(r=>r.slice()));return{...e,frames:t,pixels:n,layouts:a}}regenerateTilesWithPalette(e){const t=this.gameState.game.tileset.tiles;if(Array.isArray(t)){for(const n of t)if(Array.isArray(n.layouts)&&n.layouts.length){const a=n.layouts.map(i=>ye.toPixels(i,e));n.frames=a,n.pixels=a[0]??n.pixels}}}ensureDefaultTiles(){const e=this.gameState.game.tileset,t=8,n=(this.gameState.game.world?.rows||1)*(this.gameState.game.world?.cols||1);if((!Array.isArray(e.tiles)||e.tiles.length===0)&&(e.tiles=this.presets.map(a=>this.cloneTile(a))),!Array.isArray(e.maps)||e.maps.length===0){const a=e.tiles[0]?.id??null,i=r=>Array.from({length:t},()=>Array.from({length:t},()=>r));e.maps=Array.from({length:n},()=>({ground:i(a),overlay:i(null)}))}else{const a=e.tiles[0]?.id??null;if(a!==null){const i=s=>Array.isArray(s)&&s.every(l=>Array.isArray(l)&&l.every(o=>o==null)),r=s=>Array.from({length:t},()=>Array.from({length:t},()=>s));e.maps.forEach(s=>{i(s.ground)&&i(s.overlay)&&(s.ground=r(a),s.overlay=r(null))})}}e.map=e.maps[0],this.refreshAnimationMetadata()}getPresetTileNames(){return this.presets.map(e=>e.name||"")}getTiles(){return this.gameState.game.tileset.tiles}getTile(e){return this.gameState.game.tileset.tiles.find(t=>t.id===e)||null}updateTile(e,t){const n=this.getTile(e);n&&(Object.assign(n,t),Array.isArray(t.frames)?(n.pixels=t.frames[0],n.animated=t.frames.length>1):Array.isArray(t.pixels)&&(n.frames=void 0,n.animated=!1),this.refreshAnimationMetadata())}setMapTile(e,t,n,a=0){if(t<0||t>=8||e<0||e>=8)return;const i=this.gameState.game.tileset.maps,r=Array.isArray(i)?i[a]:null;if(!r)return;if(n===null){r.overlay[t][e]=null,r.ground[t][e]=null;return}const s=this.getTile(n);s&&(s.collision?r.overlay[t][e]=n:(r.ground[t][e]=n,r.overlay[t][e]=null))}getTileMap(e=0){const t=this.gameState.game.tileset.maps;return Array.isArray(t)&&t[e]?t[e]:this.gameState.game.tileset.map}refreshAnimationMetadata(){const e=this.getTiles();let t=1;for(const n of e){const a=Array.isArray(n.frames)&&n.frames.length?n.frames.length:1;a>t&&(t=a)}this.maxAnimationFrames=Math.max(1,t)}getAnimationFrameCount(){return Math.max(1,this.maxAnimationFrames||1)}getAnimationFrameIndex(){return Math.max(0,this.animationFrameIndex||0)}setAnimationFrameIndex(e=0){if(!Number.isFinite(e))return this.animationFrameIndex;const t=this.getAnimationFrameCount(),n=(Math.floor(e)%t+t)%t;return this.animationFrameIndex=n,this.animationFrameIndex}advanceAnimationFrame(){const e=this.getAnimationFrameCount();return e<=1?this.animationFrameIndex:(this.animationFrameIndex=(this.getAnimationFrameIndex()+1)%e,this.animationFrameIndex)}getTilePixels(e,t=null){const n=typeof e=="object"?e:this.getTile(e);if(!n)return null;const a=Array.isArray(n.frames)&&n.frames.length?n.frames:n.pixels?[n.pixels]:[];if(!a.length)return null;const i=typeof t=="number"&&Number.isFinite(t)?t:this.getAnimationFrameIndex(),r=(Math.floor(i)%a.length+a.length)%a.length;return a[r]}}class Rn{canvas;gameState;tileManager;npcManager;renderer;dialogManager;interactionManager;enemyManager;movementManager;inputManager;awaitingRestart;introVisible;introStartTime;introData;canDismissIntroScreen;timeToResetAfterIntro;constructor(e){this.canvas=e,this.gameState=new dn,this.tileManager=new Pn(this.gameState),this.npcManager=new pn(this.gameState),this.npcManager.ensureDefaultNPCs(),this.renderer=new In(e,this.gameState,this.tileManager,this.npcManager,this),this.dialogManager=new Kt(this.gameState,this.renderer),this.interactionManager=new Xt(this.gameState,this.dialogManager,{onPlayerVictory:()=>this.handleGameCompletion()}),this.enemyManager=new Yt(this.gameState,this.renderer,this.tileManager,{onPlayerDefeated:()=>this.handlePlayerDefeat(),dialogManager:this.dialogManager}),this.movementManager=new qt({gameState:this.gameState,tileManager:this.tileManager,renderer:this.renderer,dialogManager:this.dialogManager,interactionManager:this.interactionManager,enemyManager:this.enemyManager}),this.inputManager=new un(this),this.awaitingRestart=!1,this.introVisible=!1,this.introStartTime=0,this.introData={title:"Tiny RPG Studio",author:""},this.canDismissIntroScreen=!1,this.timeToResetAfterIntro=E.timing.resetAfterIntro,this.setupIntroScreen(),this.tileManager.ensureDefaultTiles(),this.syncDocumentTitle(),this.renderer.draw(),this.showIntroScreen(),this.startEnemyLoop()}tryMove(e,t){this.movementManager.tryMove(e,t)}checkInteractions(){this.interactionManager.handlePlayerInteractions()}showDialog(e,t={}){this.dialogManager.showDialog(e,t)}completeDialog(){this.dialogManager.completeDialog()}closeDialog(){this.dialogManager.closeDialog()}isPickupOverlayActive(){return!!this.gameState.isPickupOverlayActive()}dismissPickupOverlay(){this.gameState.isPickupOverlayActive()&&(this.gameState.hidePickupOverlay(),this.renderer.draw())}isLevelUpCelebrationActive(){return!!this.gameState.isLevelUpCelebrationActive()}dismissLevelUpCelebration(){this.gameState.isLevelUpCelebrationActive()&&(this.gameState.hideLevelUpCelebration(),this.renderer.draw())}isLevelUpOverlayActive(){return!!this.gameState.isLevelUpOverlayActive()}moveLevelUpCursor(e=0){this.isLevelUpOverlayActive()&&(this.gameState.moveLevelUpCursor(e),this.renderer.draw())}confirmLevelUpSelection(){if(!this.isLevelUpOverlayActive())return;const e=this.gameState.getLevelUpOverlay(),t=Number.isFinite(e.cursor)?e.cursor:0;this.chooseLevelUpSkill(t)}chooseLevelUpSkill(e=null){if(!this.isLevelUpOverlayActive())return;const t=this.gameState.selectLevelUpSkill(e);if(t){const n=this.getSkillDisplayName(t),a=K.format("skills.pickupMessage",{name:n},"")||`VocÃª aprendeu ${n}`;this.dialogManager.showDialog(a)}this.renderer.draw()}getSkillDisplayName(e=null){if(!e)return"skill";if(e.nameKey){const t=K.get(e.nameKey,e.id||"skill");if(t)return t}return e.id?e.id:"skill"}pickLevelUpChoiceFromPointer(e,t){const n=this.gameState.getLevelUpOverlay();if(!n.active)return null;const a=Array.isArray(n.choices)?n.choices:[];if(!a.length)return null;const i=this.canvas.getBoundingClientRect();if(!Number.isFinite(e)||!Number.isFinite(t))return typeof n.cursor=="number"&&Number.isFinite(n.cursor)?n.cursor:0;const r=this.canvas.width/(i.width||1),s=this.canvas.height/(i.height||1),l=(e-i.left)*r,o=(t-i.top)*s,c=Math.max(0,this.gameState.getPendingLevelUpChoices()||0),u=this.renderer.overlayRenderer.getLevelUpCardLayout({width:this.canvas.width,height:this.canvas.height,choicesLength:a.length,hasPendingText:c>0}).rects,h=u.findIndex(g=>l>=g.x&&l<=g.x+g.width&&o>=g.y&&o<=g.y+g.height);if(h>=0)return h;if(u.length){let g=0,f=Number.POSITIVE_INFINITY;return u.forEach((v,S)=>{const M=v.x+v.width/2,x=v.y+v.height/2,T=l-M,L=o-x,C=T*T+L*L;C<f&&(f=C,g=S)}),g}return typeof n.cursor=="number"&&Number.isFinite(n.cursor)?n.cursor:0}resetGame(){this.awaitingRestart=!1,this.gameState.setGameOver(!1),this.gameState.resumeGame("game-over"),this.gameState.resetGame(),this.startEnemyLoop(),this.dialogManager.reset(),this.renderer.draw(),this.showIntroScreen()}exportGameData(){return this.gameState.exportGameData()}importGameData(e){this.gameState.importGameData(e),this.npcManager.ensureDefaultNPCs(),this.tileManager.ensureDefaultTiles();const t=this.gameState.getGame();Array.isArray(t.customPalette)&&t.customPalette.length===16?this.setCustomPalette(t.customPalette):this.resetPaletteToDefault(),this.syncDocumentTitle(),this.startEnemyLoop(),this.dialogManager.reset(),this.renderer.draw(),this.showIntroScreen()}getTestSettings(){return this.gameState.getTestSettings()}updateTestSettings(e={}){this.gameState.setTestSettings(e),this.resetGame()}getMaxPlayerLevel(){return this.gameState.getMaxPlayerLevel()||1}getState(){return this.gameState.getState()}getGame(){return this.gameState.getGame()}setCustomPalette(e){const t=this.gameState.getGame();t.customPalette=e||void 0,this.renderer.paletteManager.setCustomPalette(e),e?this.tileManager.regenerateTilesWithPalette(e):this.tileManager.regenerateTilesWithPalette(ye.PICO8_COLORS),this.renderer.spriteFactory.invalidate(),this.renderer.buildPlayerSprite(),this.renderer.buildNpcSprites(),this.renderer.buildEnemySprite(),this.renderer.buildObjectSprites(),this.draw()}getCustomPalette(){return this.gameState.getGame().customPalette}resetPaletteToDefault(){this.setCustomPalette(null)}get rendererPalette(){return this.renderer.paletteManager}draw(){this.renderer.draw()}clamp(e,t,n){return Math.max(t,Math.min(n,e))}syncDocumentTitle(){const e=this.gameState.getGame();document.title=e.title||"Tiny RPG Studio"}setupIntroScreen(){typeof document>"u"||this.refreshIntroScreen()}showIntroScreen(){this.canDismissIntroScreen=!0,this.refreshIntroScreen(),this.introVisible=!0,this.introStartTime=this.gameState.getNow(),this.gameState.pauseGame("intro-screen"),this.renderer.draw()}dismissIntroScreen(){return!this.introVisible||!this.canDismissIntroScreen?!1:(this.introVisible=!1,this.gameState.resumeGame("intro-screen"),this.renderer.draw(),!0)}isIntroVisible(){return!!this.introVisible}refreshIntroScreen(){const e=this.getGame();this.introData={title:e.title||"Tiny RPG Studio",author:(e.author||"").trim()},this.renderer.setIntroData(this.introData)}getIntroData(){return this.introData}getTiles(){return this.tileManager.getTiles()}getTileMap(e=null){const t=this.gameState.getPlayer()?.roomIndex??0,n=e??t;return this.tileManager.getTileMap(n)}getTilePresetNames(){return this.tileManager.getPresetTileNames()}getVariableDefinitions(){return this.gameState.getVariableDefinitions()}getRuntimeVariables(){return this.gameState.getVariables()}setVariableDefault(e,t){const[n]=this.gameState.setVariableValue(e,t,!0);return n&&this.renderer.draw(),n}isVariableOn(e){return this.gameState.isVariableOn(e)}getObjects(){return this.gameState.getObjects()}getObjectsForRoom(e=null){const t=this.gameState.getPlayer()?.roomIndex??0,n=e??t;return this.gameState.getObjectsForRoom(n)}setObjectPosition(e,t,n,a){const i=this.gameState.setObjectPosition(e,t,n,a);return this.renderer.draw(),i}setObjectVariable(e,t,n){const a=typeof n=="string"?n:null,i=this.gameState.setObjectVariable(e,t,a);return this.renderer.draw(),i}setPlayerEndText(e,t){const n=this.gameState.setPlayerEndText(e,t);return this.renderer.draw(),n}getPlayerEndText(e=null){return this.gameState.getPlayerEndText(e)}removeObject(e,t){this.gameState.removeObject(e,t),this.renderer.draw()}getKeyCount(){return this.gameState.getKeys()}getSprites(){return this.npcManager.ensureDefaultNPCs(),this.npcManager.getNPCs()}updateTile(e,t){this.tileManager.updateTile(e,t)}setMapTile(e,t,n,a=null){const i=this.gameState.getPlayer()?.roomIndex??0,r=a??i;this.tileManager.setMapTile(e,t,n,r)}addSprite(e){return this.npcManager.addNPC(e)}getEnemyDefinitions(){return this.enemyManager.getEnemyDefinitions()}getActiveEnemies(){return this.enemyManager.getActiveEnemies()}addEnemy(e){return this.enemyManager.addEnemy(e)}removeEnemy(e){this.enemyManager.removeEnemy(String(e))}generateEnemyId(){return this.enemyManager.generateEnemyId()}setEnemyVariable(e,t=null){if(typeof this.gameState.setEnemyVariable!="function")return!1;const n=typeof t=="string"?t:null,a=this.gameState.setEnemyVariable(e,n);return a&&this.renderer.draw(),a}startEnemyLoop(){this.enemyManager.start()}tickEnemies(){this.enemyManager.tick()}handleEnemyCollision(e){this.enemyManager.handleEnemyCollision(e)}checkEnemyCollisionAt(e,t){this.enemyManager.checkCollisionAt(e,t)}handlePlayerDefeat(){this.gameState.prepareNecromancerRevive(),this.enemyManager.stop(),this.gameState.pauseGame("game-over"),this.gameState.setGameOver(!0,"defeat"),this.awaitingRestart=!0,this.renderer.draw()}handleGameCompletion(){this.isGameOver()||(this.enemyManager.stop(),this.gameState.pauseGame("game-over"),this.gameState.setGameOver(!0,"victory"),this.awaitingRestart=!0,this.renderer.draw())}isGameOver(){return this.gameState.isGameOver()}handleGameOverInteraction(){if(!(!this.isGameOver()||!this.gameState.canResetAfterGameOver)){if(this.gameState.hasNecromancerReviveReady()&&this.gameState.reviveFromNecromancer()){this.awaitingRestart=!1,this.enemyManager.start(),this.renderer.draw();return}this.resetGame()}}}const be=(m,e="")=>K.get(m,e)||e||m||"";class st{static boot(){document.addEventListener("DOMContentLoaded",()=>{this.initializeApplication(),this.setupResponsiveCanvas()})}static initializeApplication(){this.setupTabs();const e=document.getElementById("game-canvas");if(!(e instanceof HTMLCanvasElement))return;const t=new Rn(e);this.loadSharedGameIfAvailable(t);const n=!!globalThis.__TINY_RPG_EXPORT_MODE;let a=null;document.addEventListener("game-tab-activated",r=>{r.detail.initial||t.resetGame()}),document.addEventListener("editor-tab-activated",r=>{r.detail.initial||t.resetGame()}),zt({exportGameData:()=>t.exportGameData(),importGameData:r=>t.importGameData(r),getState:()=>t.getState(),draw:()=>t.draw(),resetGame:()=>t.resetGame(),updateTile:(r,s)=>t.updateTile(r,s),setMapTile:(r,s,l)=>t.setMapTile(r,s,l),getTiles:()=>t.getTiles(),getTileMap:()=>t.getTileMap(),getTilePresetNames:()=>t.getTilePresetNames(),getVariables:()=>t.getVariableDefinitions(),setVariableDefault:(r,s)=>t.setVariableDefault(typeof r=="string"?r:String(r),s),addSprite:r=>t.addSprite(r),getSprites:()=>t.getSprites(),resetNPCs:()=>t.npcManager.resetNPCs(),renderAll:()=>a?.renderAll()}),n||(a=new Ut(t)),new Ht,this.bindResetButton(t),this.bindTouchPad(t),this.bindLanguageSelector(),console.log(be("log.engineReady"))}static getLocation(){return globalThis.location??null}static bindResetButton(e){const t=document.getElementById("btn-reset");if(!(t instanceof HTMLButtonElement))return;const n=()=>{const s=this.getLocation();return s?`${s.origin}${s.pathname}`:""},a=s=>{if(globalThis.open(s,"_blank","noopener"))return!0;const o=document.createElement("a");return o.href=s,o.target="_blank",o.rel="noopener noreferrer",o.style.position="absolute",o.style.left="-9999px",document.body.appendChild(o),o.click(),requestAnimationFrame(()=>o.remove()),!0},i=s=>{if(document.body.classList.contains("editor-mode")){s.preventDefault(),s.stopImmediatePropagation();const o=n();return a(o),t.blur(),!1}return e.resetGame(),t.blur(),!1},r=()=>{document.body.classList.contains("editor-mode")?(t.textContent=be("buttons.newGame"),t.setAttribute("aria-label",be("aria.newGame"))):(t.textContent=be("buttons.reset"),t.setAttribute("aria-label",be("aria.reset")))};t.addEventListener("click",i),document.addEventListener("game-tab-activated",r),document.addEventListener("editor-tab-activated",r),document.addEventListener("language-changed",r),r()}static bindTouchPad(e){const t=document.querySelectorAll(".game-touch-pad .pad-button[data-direction]"),n=document.getElementById("touch-controls-toggle"),a=document.getElementById("touch-controls-hide"),i=document.getElementById("mobile-touch-pad");if(!t.length||!(n instanceof HTMLButtonElement)||!i)return;const r={left:[-1,0],right:[1,0],up:[0,-1],down:[0,1]};t.forEach(u=>{u.addEventListener("touchstart",h=>{h.preventDefault();const g=u.dataset.direction;if(!g)return;const f=r[g];e.tryMove(f[0],f[1])},{passive:!1})});let s="",l="";const o=()=>{s=be("touchControls.show"),l=be("touchControls.hide"),n.textContent=s,a instanceof HTMLButtonElement&&(a.textContent=l,a.setAttribute("aria-label",l))};o();const c=()=>{const u=document.body.classList.contains("touch-controls-visible");n.setAttribute("aria-expanded",u?"true":"false"),n.setAttribute("aria-pressed",u?"true":"false"),i.setAttribute("aria-hidden",u?"false":"true"),u||(n.textContent=s),a instanceof HTMLButtonElement&&(a.hidden=!u,u&&(a.textContent=l))};n.addEventListener("click",()=>{document.body.classList.add("touch-controls-visible"),c()}),a instanceof HTMLButtonElement&&a.addEventListener("click",()=>{document.body.classList.remove("touch-controls-visible"),c()});const d=()=>{document.body.classList.remove("touch-controls-visible"),c()};document.addEventListener("editor-tab-activated",d),document.addEventListener("game-tab-activated",c),document.addEventListener("language-changed",()=>{o(),c()}),c()}static bindLanguageSelector(){const e=document.getElementById("language-select");if(!(e instanceof HTMLSelectElement))return;const t=()=>{e.value=K.getLocale()};t(),e.addEventListener("change",()=>{const n=e.value;if(!n)return;K.setLocale(n)||t()}),document.addEventListener("language-changed",t)}static setupTabs(){const e=document.querySelectorAll(".tab-button[data-tab]"),t=document.querySelectorAll(".tab-content"),n=r=>{const s=r==="editor",l=r==="game";document.body.classList.toggle("editor-mode",s),document.body.classList.toggle("game-mode",l)},a=r=>{if(r.classList.contains("active"))return;const s=r.dataset.tab;if(!s)return;e.forEach(c=>{c.classList.remove("active"),c.setAttribute("aria-selected","false")}),t.forEach(c=>c.classList.remove("active")),r.classList.add("active"),r.setAttribute("aria-selected","true");const l=`tab-${s}`,o=document.getElementById(l);if(o&&o.classList.add("active"),n(s),s==="game"&&document.dispatchEvent(new CustomEvent("game-tab-activated",{detail:{initial:!1}})),s==="editor"){const c=Qe();if(!c)return;c.resetNPCs(),c.draw(),document.dispatchEvent(new CustomEvent("editor-tab-activated",{detail:{initial:!1}})),c.renderAll();const d=c.exportGameData();c.importGameData(d)}};e.forEach(r=>{r.addEventListener("pointerdown",s=>{s.preventDefault(),a(r)}),r.addEventListener("keydown",s=>{(s.key==="Enter"||s.key===" ")&&(s.preventDefault(),a(r))})});const i=document.querySelector(".tab-button.active[data-tab]");i?.dataset.tab&&(n(i.dataset.tab),i.dataset.tab==="game"&&document.dispatchEvent(new CustomEvent("game-tab-activated",{detail:{initial:!0}})),i.dataset.tab==="editor"&&document.dispatchEvent(new CustomEvent("editor-tab-activated",{detail:{initial:!0}})))}static loadSharedGameIfAvailable(e){const t=Le.extractGameDataFromLocation(globalThis.location);if(t){e.importGameData(t);return}const n=globalThis.__TINY_RPG_SHARED_CODE;if(typeof n=="string"&&n.trim().length>0)try{const a=Le.decode(n);a&&e.importGameData(a)}catch(a){console.warn("[TinyRPG] Unable to decode shared game data from inline code.",a)}}static setupResponsiveCanvas(){const e=document.getElementById("game-canvas"),t=document.getElementById("game-container");if(!(e instanceof HTMLCanvasElement)||!t)return;const n=()=>{const i=t.getBoundingClientRect(),r=i.width||globalThis.innerWidth,s=i.height||globalThis.innerHeight,l=(e.height||1)/(e.width||1),o=Math.max(128,r*.9),d=Math.max(128,s*.9)/l,u=Math.min(o,d),h=u*l;e.style.width=`${u}px`,e.style.height=`${h}px`},a=()=>globalThis.requestAnimationFrame(n);globalThis.addEventListener("resize",a),document.addEventListener("game-tab-activated",a),a()}}return st.boot(),Fe.TinyRPGApplication=st,Object.defineProperty(Fe,Symbol.toStringTag,{value:"Module"}),Fe})({});
